<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Orbit v7 - Connect, Share, Thrive</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase SDK + public config -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // Supabase Configuration (inline for Vercel compatibility)
      window.SUPABASE_URL = 'https://cohjxujvdfbsohhlvnus.supabase.co';
      window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNvaGp4dWp2ZGZic29oaGx2bnVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNTAyNTcsImV4cCI6MjA3OTcyNjI1N30.FCmAi1McUKYV4y5tgBxKhY-Yku95JMu8-rtc2TJhdzs';
      
      // Try to load from external config file (fallback)
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
        const configScript = document.createElement('script');
        configScript.src = './config.supabase.js';
        configScript.onerror = () => console.warn('[Supabase] config.supabase.js not found, using inline config');
        document.head.appendChild(configScript);
      }
    </script>
    <script src="./services.supabase.js"></script>
    <!-- OpenAI config -->
    <script>
      // OpenAI Configuration - Load from external file or use environment variable
      // For Vercel: Set OPENAI_API_KEY as environment variable
      window.OPENAI_API_KEY = window.OPENAI_API_KEY || '';
      window.OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';
      window.OPENAI_CONFIG = {
        model: 'gpt-4o-mini',
        temperature: 0.7,
        max_tokens: 500
      };
      // Try to load from external config file
      const openaiScript = document.createElement('script');
      openaiScript.src = './config.openai.js';
      openaiScript.onerror = () => console.warn('[OpenAI] config.openai.js not found');
      document.head.appendChild(openaiScript);
    </script>
    <script>
      // Initialize Supabase client (global)
      try {
        if (window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
          const createClient = window.supabase && window.supabase.createClient;
          if (!createClient) {
            console.error(
              "[Supabase] createClient not found on window.supabase",
            );
          } else {
            window.supabaseClient = createClient(
              window.SUPABASE_URL,
              window.SUPABASE_ANON_KEY,
            );
            console.log("[Supabase] Client initialized", {
              url: window.SUPABASE_URL,
              hasKey: !!window.SUPABASE_ANON_KEY
            });
            // Simple connectivity check
            window.supabaseClient.auth.getSession().then(({ data, error }) => {
              if (error)
                console.error("[Supabase] auth.getSession error:", error);
              else console.log("[Supabase] Session check OK", data);
            });
          }
        } else {
          console.error("[Supabase] Missing URL or Key", {
            hasUrl: !!window.SUPABASE_URL,
            hasKey: !!window.SUPABASE_ANON_KEY
          });
        }
      } catch (e) {
        console.error("[Supabase] init failed", e);
      }
    </script>
    <style>
      @keyframes progress {
        0% {
          width: 0%;
        }
        50% {
          width: 60%;
        }
        100% {
          width: 100%;
        }
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              // Brand palette unified to mint/teal
              primary: "#91B5B0", // Mint/Teal (unified)
              secondary: "#5BAE9B", // Deeper Mint/Teal
              accent: "#DFF3EC", // Light Mint
              mint: "#91B5B0", // Alias for mint usage
              // UI base
              background: "#FFFFFF",
              surface: "#F8F7FB",
              border: "#E6E3EE",
              // Text
              text: "#1D1D1F",
              textSecondary: "#6E6E73",
              placeholder: "#A1A1AA",
              // Actions
              like: "#FF6FAF",
              comment: "#8A80FF",
              save: "#F6B93B",
              share: "#4DD0E1",
              // Status
              success: "#A8E6CF",
              warning: "#FFD580",
              error: "#FFAAA5",
              info: "#A7C7E7",
            },
          },
        },
      };
    </script>
    <style>
      body {
        background-color: #fafafa;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif;
      }
      /* Relaxed typography (even softer + slightly smaller) */
      :root {
        --relax-leading: 1.8;
      }
      body,
      p {
        line-height: var(--relax-leading);
      }
      h1,
      h2,
      h3 {
        font-weight: 500;
        letter-spacing: -0.004em;
      }
      /* Softer heading/body colors (reduce harsh blacks) */
      .text-gray-900,
      .text-black {
        color: #475569 !important;
      } /* slate-600 */
      .text-gray-800 {
        color: #4b5563 !important;
      } /* gray-700 */
      .text-text {
        color: #475569 !important;
      }
      .text-textSecondary {
        color: #73808c !important;
      }
      .text-sm {
        font-size: 0.9rem;
        line-height: 1.65;
      }
      .text-base {
        font-size: 0.98rem;
        line-height: 1.75;
      }
      .text-lg {
        font-size: 1.08rem;
        line-height: 1.8;
      }
      .font-bold {
        font-weight: 600 !important;
      }
      .soft-card p {
        line-height: 1.7;
      }
      ::placeholder {
        color: #9aa3ad;
      }
      .ios-shadow {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      /* Soft card + buttons for Option A */
      .soft-card {
        background: #ffffff;
        border: 1px solid #e6e3ee;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
      }
      .btn {
        border-radius: 12px;
        font-weight: 600;
      }
      .btn-primary {
        background: #91b5b0;
        color: #fff;
      }
      .btn-primary:hover {
        filter: brightness(0.95);
      }
      .btn-secondary {
        background: #ffffff;
        color: #1d1d1f;
        border: 1px solid #e6e3ee;
      }
      .btn-secondary:hover {
        background: #f8f7fb;
      }
      .btn-ghost {
        background: transparent;
        color: #6e6e73;
      }
      .btn-ghost:hover {
        background: #f8f7fb;
      }
      .post-card {
        transition: transform 0.2s ease;
      }
      .post-card:active {
        transform: scale(0.98);
      }
      .coin-bounce {
        animation: coinBounce 0.6s ease-out;
      }
      @keyframes coinBounce {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }
      .slide-up {
        animation: slideUp 0.3s ease-out;
      }
      @keyframes slideUp {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .notification-badge {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .loading-pulse {
        animation: pulse 1.5s infinite;
      }

      /* Button Interactions */
      .btn-hover-lift {
        transition: all 0.2s ease;
      }
      .btn-hover-lift:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .btn-hover-lift:active {
        transform: translateY(0);
      }

      /* Smooth Focus States */
      .focus-ring {
        transition: all 0.2s ease;
      }
      .focus-ring:focus {
        outline: 2px solid rgba(165, 201, 202, 0.5);
        outline-offset: 2px;
      }

      /* Loading Skeleton */
      .skeleton {
        background: linear-gradient(
          90deg,
          #f0f0f0 25%,
          #e0e0e0 50%,
          #f0f0f0 75%
        );
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
      }

      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      /* Modal backdrop blur */
      .modal-backdrop {
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      /* Progress bar */
      .progress-bar {
        background: linear-gradient(90deg, #a5c9ca, #ffd6a5, #f5cac3);
        background-size: 200% 100%;
        animation: progressFlow 2s ease-in-out infinite;
      }

      @keyframes progressFlow {
        0%,
        100% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
      }

      /* Scrollbar hide styles */
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }

      /* Custom scrollbar for chat */
      .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
      }
      
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 2px;
      }
      
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.3);
      }
    </style>
  </head>
  <body class="bg-background text-text">
    <div id="root"></div>

    <script type="text/babel">
              const { useState, useEffect, useCallback, useRef, useMemo } = React;

              // â±ï¸ Time helpers
              const getTimestamp = (val) => {
                  if (!val && val !== 0) return null;
                  if (typeof val === 'number') return val;
                  if (val instanceof Date) return val.getTime();
                  if (typeof val === 'string') {
                      const parsed = Date.parse(val);
                      if (!isNaN(parsed)) return parsed;
                  }
                  return null;
              };

              // Simple Splash Screen with rotating logo
              const SplashScreen = () => {
                  const [animationPhase, setAnimationPhase] = useState(0);

                  useEffect(() => {
                      const timer = setTimeout(() => {
                          setAnimationPhase(1);
                      }, 800);
                      return () => clearTimeout(timer);
                  }, []);

                  return (
                      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-primary/5 via-secondary/10 to-accent/5">
                      <div className="text-center">
                              {/* Animated Orbit Logo */}
                              <div className="relative inline-flex items-center justify-center w-32 h-32 mb-8">
                                  {/* Outer rotating ring */}
                                  <div className="absolute inset-0 rounded-full border-4 border-transparent border-t-primary animate-spin" style={{animationDuration:'2s'}}></div>
                                  <div className="absolute inset-2 rounded-full border-2 border-transparent border-b-secondary animate-spin" style={{animationDuration:'1.5s', animationDirection:'reverse'}}></div>

                                  {/* Center Logo SVG */}
                                  <div className="w-20 h-20 bg-gradient-to-br from-primary via-secondary to-accent rounded-2xl shadow-2xl flex items-center justify-center relative overflow-hidden">
                                      <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent animate-pulse"></div>
                                      <svg className="w-12 h-12 relative z-10" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                                          {/* Modern Orbit Logo */}
                                          {/* Outer elliptical orbit */}
                                          <ellipse cx="24" cy="24" rx="18" ry="10" stroke="white" strokeWidth="2" strokeOpacity="0.4" fill="none" transform="rotate(-15 24 24)"/>
                                          {/* Middle orbit path */}
                                          <path d="M 24 6 Q 38 24 24 42 Q 10 24 24 6" stroke="white" strokeWidth="2.5" strokeOpacity="0.6" fill="none" strokeLinecap="round"/>
                                          {/* Center planet with gradient effect */}
                                          <circle cx="24" cy="24" r="9" fill="white" fillOpacity="0.95"/>
                                          <circle cx="24" cy="24" r="6" fill="white" fillOpacity="0.7"/>
                                          {/* Inner core */}
                                          <circle cx="24" cy="24" r="3.5" fill="white"/>
                                          {/* Orbiting particle 1 */}
                                          <circle cx="24" cy="6" r="2" fill="white" opacity="0.9">
                                              <animateTransform attributeName="transform" type="rotate" values="0 24 24;360 24 24" dur="4s" repeatCount="indefinite"/>
                                          </circle>
                                          {/* Orbiting particle 2 */}
                                          <circle cx="42" cy="24" r="1.5" fill="white" opacity="0.7">
                                              <animateTransform attributeName="transform" type="rotate" values="0 24 24;360 24 24" dur="5s" repeatCount="indefinite"/>
                                          </circle>
                                          {/* Orbiting particle 3 */}
                                          <circle cx="24" cy="42" r="1.5" fill="white" opacity="0.7">
                                              <animateTransform attributeName="transform" type="rotate" values="0 24 24;-360 24 24" dur="6s" repeatCount="indefinite"/>
                                          </circle>
                                      </svg>
                              </div>

                                  {/* Floating particles */}
                                  <div className="absolute -top-2 -right-2 w-3 h-3 bg-primary rounded-full animate-bounce" style={{animationDelay:'0s'}}></div>
                                  <div className="absolute -bottom-1 -left-1 w-2 h-2 bg-secondary rounded-full animate-bounce" style={{animationDelay:'0.5s'}}></div>
                                  <div className="absolute top-1 -left-3 w-1.5 h-1.5 bg-accent rounded-full animate-bounce" style={{animationDelay:'1s'}}></div>
                          </div>

                              {/* Animated Orbit Text */}
                              <div className="mb-6">
                                  <h1 className="text-6xl font-bold text-gray-900 mb-2">
                                      <span className={`inline-block transition-all duration-1000 ${animationPhase >= 1 ? 'transform rotate-0 scale-100' : 'transform rotate-180 scale-0'}`} style={{transitionDelay:'0s'}}>O</span>
                                      <span className={`inline-block transition-all duration-1000 ${animationPhase >= 1 ? 'transform rotate-0 scale-100' : 'transform rotate-180 scale-0'}`} style={{transitionDelay:'0.1s'}}>r</span>
                                      <span className={`inline-block transition-all duration-1000 ${animationPhase >= 1 ? 'transform rotate-0 scale-100' : 'transform rotate-180 scale-0'}`} style={{transitionDelay:'0.2s'}}>b</span>
                                      <span className={`inline-block transition-all duration-1000 ${animationPhase >= 1 ? 'transform rotate-0 scale-100' : 'transform rotate-180 scale-0'}`} style={{transitionDelay:'0.3s'}}>i</span>
                                      <span className={`inline-block transition-all duration-1000 ${animationPhase >= 1 ? 'transform rotate-0 scale-100' : 'transform rotate-180 scale-0'}`} style={{transitionDelay:'0.4s'}}>t</span>
                                  </h1>
                                  <div className="flex items-center justify-center space-x-1">
                                      <div className={`w-2 h-2 bg-primary rounded-full animate-pulse ${animationPhase >= 1 ? 'opacity-100' : 'opacity-0'}`} style={{transitionDelay:'0.6s'}}></div>
                                      <div className={`w-2 h-2 bg-secondary rounded-full animate-pulse ${animationPhase >= 1 ? 'opacity-100' : 'opacity-0'}`} style={{transitionDelay:'0.7s'}}></div>
                                      <div className={`w-2 h-2 bg-accent rounded-full animate-pulse ${animationPhase >= 1 ? 'opacity-100' : 'opacity-0'}`} style={{transitionDelay:'0.8s'}}></div>
                                  </div>
                              </div>

                              {/* Loading text with typewriter effect */}
                              <div className="space-y-4">
                                  <p className={`text-gray-600 text-lg font-medium transition-all duration-500 ${animationPhase >= 1 ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4'}`} style={{transitionDelay:'0.9s'}}>
                                      Connecting to the universe...
                                  </p>

                                  {/* Progress Bar */}
                                  <div className={`w-64 mx-auto transition-all duration-500 ${animationPhase >= 1 ? 'opacity-100' : 'opacity-0'}`} style={{transitionDelay:'1.2s'}}>
                                      <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                          <div
                                              className="h-full bg-gradient-to-r from-primary via-secondary to-accent rounded-full"
                                              style={{
                                                  animation: 'progress 2.5s ease-in-out forwards',
                                                  width: '0%'
                                              }}
                                          ></div>
                                      </div>
                                  </div>

                                  <div className="flex items-center justify-center space-x-1">
                                      <div className="w-1 h-1 bg-primary rounded-full animate-bounce" style={{animationDelay:'0s'}}></div>
                                      <div className="w-1 h-1 bg-secondary rounded-full animate-bounce" style={{animationDelay:'0.1s'}}></div>
                                      <div className="w-1 h-1 bg-accent rounded-full animate-bounce" style={{animationDelay:'0.2s'}}></div>
                                  </div>
                          </div>
                      </div>
                  </div>
              );
              };

              // Auth Page (Login / Signup)
              const AuthPage = ({ onSuccess, onGuest }) => {
                  const [mode, setMode] = useState('login'); // 'login' | 'signup'
                  const [name, setName] = useState('');
                  const [username, setUsername] = useState('');
                  const [email, setEmail] = useState('');
                  const [password, setPassword] = useState('');
                  const [error, setError] = useState('');

                  const sanitizeUsername = (u) => {
                      let v = (u || '').trim();
                      if (!v) return '@user';
                      if (!v.startsWith('@')) v = '@' + v;
                      const body = v.slice(1).toLowerCase().replace(/[^a-z0-9_.]/g, '');
                      return '@' + (body || 'user');
                  };

                  const handleSignup = async () => {
                      try {
                          setError('');
                          const nm = name.trim();
                          const un = sanitizeUsername(username);
                          const em = (email || '').trim();
                          const pw = (password || '').trim();
                          if (!nm || !un || !em || !pw) { setError('LÃ¼tfen tÃ¼m alanlarÄ± doldurun'); return; }
                          
                          // Debug: Check Supabase connection
                          console.log('[Signup] Checking Supabase connection...', {
                              hasSupabaseClient: !!window.supabaseClient,
                              hasOrbitApi: !!window.OrbitApi,
                              hasAuth: !!window.OrbitApi?.auth,
                              supabaseUrl: window.SUPABASE_URL
                          });
                          
                          if (!window.supabaseClient) {
                              setError('Supabase baÄŸlantÄ±sÄ± kurulamadÄ±. SayfayÄ± yenileyin.');
                              console.error('[Signup] Supabase client not initialized');
                              return;
                          }
                          
                          if (!window.OrbitApi?.auth) { 
                              setError('Auth service not ready'); 
                              console.error('[Signup] OrbitApi.auth not available');
                              return; 
                          }
                          
                          console.log('[Signup] Calling signup with:', { email: em, username: un, displayName: nm });
                          const result = await window.OrbitApi.auth.signup({ email: em, password: pw, username: un, displayName: nm });
                          console.log('[Signup] Result:', result);
                          
                          // Check if email confirmation is required
                          if (result.error?.code === 'email_confirmation_required') {
                              setError(result.error.message || 'Email onayÄ± gerekiyor');
                              // Still proceed with login if session exists
                              if (result.data?.user) {
                                  const prof = await window.OrbitApi.auth.getProfile(result.data.user.id);
                                  const payload = { 
                                      name: prof?.data?.display_name || nm, 
                                      username: prof?.data?.username || un, 
                                      avatarColor: 'bg-primary', 
                                      avatarUrl: prof?.data?.avatar_url || null 
                                  };
                                  onSuccess && onSuccess(payload);
                              }
                              return;
                          }
                          
                          if (result.error) {
                              console.error('[Signup] Error from API:', result.error);
                              setError(result.error.message || 'KayÄ±t baÅŸarÄ±sÄ±z');
                              
                              // Check if user was created despite error (email confirmation case)
                              if (result.data?.user) {
                                  console.log('[Signup] User created but has error, checking if we can proceed...');
                                  // Try to get profile anyway
                                  try {
                                      const prof = await window.OrbitApi.auth.getProfile(result.data.user.id);
                                      if (prof?.data) {
                                          const payload = { 
                                              name: prof.data.display_name || nm, 
                                              username: prof.data.username || un, 
                                              avatarColor: 'bg-primary', 
                                              avatarUrl: prof.data.avatar_url || null 
                                          };
                                          onSuccess && onSuccess(payload);
                                          return;
                                      }
                                  } catch (profErr) {
                                      console.error('[Signup] Profile fetch failed:', profErr);
                                  }
                              }
                              return;
                          }
                          
                          if (!result.data?.user) {
                              console.error('[Signup] No user in result:', result);
                              setError('KayÄ±t baÅŸarÄ±sÄ±z. LÃ¼tfen tekrar deneyin.');
                              return;
                          }
                          
                          console.log('[Signup] Success! Fetching profile for user:', result.data.user.id);
                          const prof = await window.OrbitApi.auth.getProfile(result.data.user.id);
                          console.log('[Signup] Profile fetched:', prof);
                          
                          const payload = { 
                              name: prof?.data?.display_name || nm, 
                              username: prof?.data?.username || un, 
                              avatarColor: 'bg-primary', 
                              avatarUrl: prof?.data?.avatar_url || null 
                          };
                          
                          // Award first signup coins (will be called after onSuccess sets up the coin system)
                          setTimeout(() => {
                              if (window.earnCoinsForFirstSignup) {
                                  window.earnCoinsForFirstSignup();
                              }
                          }, 500);
                          
                          console.log('[Signup] Calling onSuccess with payload:', payload);
                          onSuccess && onSuccess(payload);
                      } catch (e) {
                          console.error(e);
                          setError(e?.message || 'Signup failed');
                      }
                  };

                  const handleLogin = async () => {
                      try {
                          setError('');
                          const em = (email || '').trim();
                          const pw = (password || '').trim();
                          if (!em || !pw) { setError('Enter email and password'); return; }
                          if (!window.OrbitApi?.auth) { setError('Auth service not ready'); return; }
                          
                          const result = await window.OrbitApi.auth.login({ email: em, password: pw });
                          
                          if (result.error) {
                              console.error('Login error:', result.error);
                              // More specific error messages
                              if (result.error.message?.includes('Invalid login credentials') || result.error.message?.includes('Email not confirmed')) {
                                  setError('Email veya ÅŸifre hatalÄ±. Email onayÄ±nÄ±zÄ± kontrol edin.');
                              } else if (result.error.message?.includes('Email not confirmed')) {
                                  setError('Email adresinizi onaylamanÄ±z gerekiyor. Email kutunuzu kontrol edin.');
                              } else {
                                  setError(result.error.message || 'GiriÅŸ baÅŸarÄ±sÄ±z. Email ve ÅŸifrenizi kontrol edin.');
                              }
                              return;
                          }
                          
                          if (!result.data?.user) { 
                              setError('GiriÅŸ baÅŸarÄ±sÄ±z. Email ve ÅŸifrenizi kontrol edin.'); 
                              return; 
                          }
                          
                          const prof = await window.OrbitApi.auth.getProfile(result.data.user.id);
                          const payload = { 
                              name: prof?.data?.display_name || 'User', 
                              username: prof?.data?.username || '@user', 
                              avatarColor: 'bg-primary', 
                              avatarUrl: prof?.data?.avatar_url || null 
                          };
                          onSuccess && onSuccess(payload);
                      } catch (e) {
                          console.error('Login exception:', e);
                          setError(e?.message || 'GiriÅŸ baÅŸarÄ±sÄ±z. LÃ¼tfen tekrar deneyin.');
                      }
                  };

                  return (
                      <div className="min-h-screen bg-white flex items-center justify-center px-4">
                          <div className="w-full max-w-md">
                              <div className="text-center mb-6">
                                  <div className="relative inline-flex items-center justify-center w-20 h-20">
                                      <div className="absolute inset-0 rounded-full border-4 border-gray-200 border-t-primary animate-spin" style={{animationDuration:'1.2s'}}></div>
                                      <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-primary to-secondary rounded-2xl shadow">
                                          <svg className="w-8 h-8" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                                              <ellipse cx="24" cy="24" rx="18" ry="10" stroke="white" strokeWidth="2" strokeOpacity="0.4" fill="none" transform="rotate(-15 24 24)"/>
                                              <path d="M 24 6 Q 38 24 24 42 Q 10 24 24 6" stroke="white" strokeWidth="2.5" strokeOpacity="0.6" fill="none" strokeLinecap="round"/>
                                              <circle cx="24" cy="24" r="9" fill="white" fillOpacity="0.95"/>
                                              <circle cx="24" cy="24" r="6" fill="white" fillOpacity="0.7"/>
                                              <circle cx="24" cy="24" r="3.5" fill="white"/>
                                          </svg>
                                      </div>
                                  </div>
                                  <h1 className="mt-3 text-2xl font-bold text-gray-900">Orbit</h1>
                                  <p className="text-gray-500 text-sm">Connect, Share, Thrive</p>
                              </div>

                              <div className="soft-card p-4">
                                  <div className="flex items-center gap-2 mb-4">
                                      {['login','signup'].map(m => (
                                          <button key={m} onClick={()=>{ setMode(m); setError(''); }} className={`flex-1 px-3 py-2 rounded-xl text-sm font-semibold ${mode===m ? 'bg-primary text-white' : 'bg-gray-100 text-gray-700'}`}>{m==='login'?'Login':'Sign Up'}</button>
                                      ))}
                                  </div>

                                  {mode === 'signup' && (
                                      <>
                                          <input value={name} onChange={(e)=>setName(e.target.value)} placeholder="Full name" className="w-full px-3 py-2 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none mb-2"/>
                                          <input value={email} onChange={(e)=>setEmail(e.target.value)} placeholder="Email (optional)" className="w-full px-3 py-2 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none mb-2"/>
                                      </>
                                  )}
                                  <input value={username} onChange={(e)=>setUsername(e.target.value)} placeholder="Username" className="w-full px-3 py-2 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none mb-2"/>
                                  <input type="password" value={password} onChange={(e)=>setPassword(e.target.value)} placeholder="Password" className="w-full px-3 py-2 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none mb-3"/>
                                  {error && <div className="text-rose-600 text-sm mb-2">{error}</div>}

                                  {mode === 'login' ? (
                                      <button onClick={handleLogin} className="w-full py-3 rounded-xl bg-primary text-white font-semibold">Login</button>
                                  ) : (
                                      <button onClick={handleSignup} className="w-full py-3 rounded-xl bg-primary text-white font-semibold">Create Account</button>
                                  )}

                                  <button onClick={onGuest} className="w-full mt-3 py-3 rounded-xl bg-gray-100 text-gray-700 font-semibold">Continue as Guest</button>
                              </div>

                              <p className="text-[11px] text-gray-400 text-center mt-4">By continuing, you agree to our Terms and Privacy Policy.</p>
                          </div>
                      </div>
                  );
              };

              const formatRelativeTime = (ts) => {
                  const time = getTimestamp(ts);
                  if (!time) return 'Just now';
                  const diff = Date.now() - time;
                  if (diff < 45 * 1000) return 'Just now';
                  const mins = Math.floor(diff / 60000);
                  if (mins < 60) return `${mins} min ago`;
                  const hours = Math.floor(mins / 60);
                  if (hours < 24) return `${hours} h ago`;
                  const days = Math.floor(hours / 24);
                  if (days < 7) return `${days} d ago`;
                  const weeks = Math.floor(days / 7);
                  if (weeks < 5) return `${weeks} w ago`;
                  const months = Math.floor(days / 30);
                  if (months < 12) return `${months} mo ago`;
                  const years = Math.floor(days / 365);
                  return `${years} y ago`;
              };

              const getRelativePostTime = (post) => {
                  // Prefer explicit createdAt, then numeric time, then id, then parse time string
                  if (post && post.createdAt) return formatRelativeTime(post.createdAt);
                  if (post && typeof post.time === 'number') return formatRelativeTime(post.time);
                  if (post && typeof post.id === 'number' && post.id > 1600000000000) return formatRelativeTime(post.id);
                  if (post && typeof post.time === 'string') {
                      if (post.time.toLowerCase() === 'just now') {
                          if (typeof post.id === 'number') return formatRelativeTime(post.id);
                      }
                      const parsed = getTimestamp(post.time);
                      if (parsed) return formatRelativeTime(parsed);
                      return post.time; // keep readable strings like '2 hours ago'
                  }
                  return 'Just now';
              };

              const getRelativeCommentTime = (comment) => {
                  if (comment && comment.createdAt) return formatRelativeTime(comment.createdAt);
                  if (comment && typeof comment.time === 'number') return formatRelativeTime(comment.time);
                  if (comment && typeof comment.id === 'number' && comment.id > 1600000000000) return formatRelativeTime(comment.id);
                  if (comment && typeof comment.time === 'string') {
                      const parsed = getTimestamp(comment.time);
                      if (parsed) return formatRelativeTime(parsed);
                      return comment.time;
                  }
                  return 'Just now';
              };

              // Locale-friendly date/time for events
              const formatEventDateTime = (dateStr, timeStr, locale = navigator.language || 'en-US') => {
                  try {
                      if (!dateStr) return '';
                      const iso = `${dateStr}${timeStr ? 'T'+timeStr : ''}`;
                      const d = new Date(iso);
                      const datePart = d.toLocaleDateString(locale, { weekday:'short', year:'numeric', month:'short', day:'numeric' });
                      const timePart = timeStr ? d.toLocaleTimeString(locale, { hour:'2-digit', minute:'2-digit' }) : '';
                      return timePart ? `${datePart} â€¢ ${timePart}` : datePart;
                  } catch { return `${dateStr}${timeStr ? (' â€¢ ' + timeStr) : ''}`; }
              };

              // ðŸ—„ï¸ Storage Manager - Data Persistence System
              const StorageManager = {
                  save: (key, data) => {
                      try {
                          localStorage.setItem(`orbit_${key}`, JSON.stringify(data));
                          console.log(`ðŸ’¾ Saved ${key}:`, data);
                      } catch (e) {
                          console.error('Storage save error:', e);
                      }
                  },

                  load: (key, defaultValue = null) => {
                      try {
                          const item = localStorage.getItem(`orbit_${key}`);
                          const loaded = item ? JSON.parse(item) : defaultValue;
                          console.log(`ðŸ“‚ Loaded ${key}:`, loaded);
                          return loaded;
                      } catch (e) {
                          console.error('Storage load error:', e);
                          return defaultValue;
                      }
                  },

                  remove: (key) => {
                      try {
                          localStorage.removeItem(`orbit_${key}`);
                          console.log(`ðŸ—‘ï¸ Removed ${key}`);
                      } catch (e) {
                          console.error('Storage remove error:', e);
                      }
                  },

                  clearAll: () => {
                      try {
                          Object.keys(localStorage).forEach(key => {
                              if (key.startsWith('orbit_')) {
                                  localStorage.removeItem(key);
                              }
                          });
                          console.log('ðŸ§¹ Cleared all Orbit data');
                      } catch (e) {
                          console.error('Storage clear error:', e);
                      }
                  }
              };

              // Utilities
              const sanitizeText = (s = '') => {
                  try {
                      return String(s)
                          .replace(/</g, '&lt;')
                          .replace(/>/g, '&gt;')
                          .replace(/on[a-z]+\s*=\s*/gi, '');
                  } catch { return s; }
              };

              // Loading Component
              const Loading = ({ size = 'md' }) => (
                  <div className={`loading-pulse rounded-lg bg-gray-200 ${
                      size === 'sm' ? 'h-4 w-16' :
                      size === 'md' ? 'h-6 w-24' :
                      'h-8 w-32'
                  }`}></div>
              );

              // Enhanced PostCard with persistence
              const PostCard = ({ post, onLike, onCoinEarned, onComment, onAddComment, onSave, onShare, onDelete, onUpdatePost, onGroupClick, onJoinGroup, savedContent = [], onUserClick, currentUser, blurred }) => {
                  // Initial like state from storage once
                  const getLikedStatus = () => {
                      try {
                          const likedPosts = StorageManager.load('likedPosts', []);
                          return Array.isArray(likedPosts) && likedPosts.includes(post.id);
                      } catch {
                          return false;
                      }
                  };

                  const [liked, setLiked] = useState(getLikedStatus());
                  const [likeCount, setLikeCount] = useState(post.likes);
                  useEffect(() => { setLikeCount(typeof post.likes === 'number' ? post.likes : 0); }, [post.likes]);
                  const [saved, setSaved] = useState(savedContent.some(item => item.id === post.id));
                  const [sensitiveAck, setSensitiveAck] = useState(() => {
                      try {
                          const ack = StorageManager.load('sensitiveAck', {});
                          return !!ack[post.id];
                      } catch { return false; }
                  });
                  const [pinnedComment, setPinnedComment] = useState(() => {
                      try {
                          const comments = StorageManager.load('comments', {}) || {};
                          const arr = Array.isArray(comments[post.id]) ? comments[post.id] : [];
                          return arr.find(c => c?.isPinned) || null;
                      } catch {
                          return null;
                      }
                  });

                  // Sync from storage changes without setting during render
                  useEffect(() => {
                      const onStorage = () => {
                          const lst = StorageManager.load('likedPosts', []);
                          const isLikedNow = Array.isArray(lst) && lst.includes(post.id);
                          setLiked(prev => (prev !== isLikedNow ? isLikedNow : prev));
                      };
                      window.addEventListener('storage', onStorage);
                      return () => window.removeEventListener('storage', onStorage);
                  }, [post.id]);

                  useEffect(() => {
                      const loadPinned = () => {
                          try {
                              const comments = StorageManager.load('comments', {}) || {};
                              const arr = Array.isArray(comments[post.id]) ? comments[post.id] : [];
                              const pinned = arr.find(c => c?.isPinned) || null;
                              setPinnedComment(prev => {
                                  if (!pinned && prev) return null;
                                  if (pinned && (!prev || prev.id !== pinned.id || prev.text !== pinned.text)) return pinned;
                                  return prev;
                              });
                          } catch (e) {
                              console.error('Failed to load pinned comment preview', e);
                          }
                      };
                      const handleCommentsUpdated = (evt) => {
                          if (!evt?.detail?.postId || evt.detail.postId === post.id) {
                              loadPinned();
                          }
                      };
                      loadPinned();
                      window.addEventListener('commentsUpdated', handleCommentsUpdated);
                      window.addEventListener('storage', loadPinned);
                      return () => {
                          window.removeEventListener('commentsUpdated', handleCommentsUpdated);
                          window.removeEventListener('storage', loadPinned);
                      };
                  }, [post.id]);

                  const handleLike = () => {
                      const newLikedState = !liked;
                      console.log('ðŸ”¥ LIKE CLICKED!', { postId: post.id, currentLiked: liked, newLiked: newLikedState });
                      setLiked(newLikedState);

                      // Update storage
                      const likedPosts = StorageManager.load('likedPosts', []);
                      if (newLikedState) {
                          // Add to liked posts
                          if (!likedPosts.includes(post.id)) {
                              likedPosts.push(post.id);
                              StorageManager.save('likedPosts', likedPosts);
                          }
                          setLikeCount(prev => Math.max(0, prev + 1));
                      } else {
                          // Remove from liked posts
                          const filtered = likedPosts.filter(id => id !== post.id);
                          StorageManager.save('likedPosts', filtered);
                          setLikeCount(prev => Math.max(0, prev - 1));
                      }

                      if (onLike) onLike(post.id, newLikedState);
                  };

                  const handleSave = () => {
                      setSaved(!saved);
                      if (onSave) onSave(post.id);
                  };

                  const handleUserClick = () => {
                      if (onUserClick) onUserClick(post.author);
                  };

                  // Resolve author avatar URL (prefer explicit on post, then current user, then known users list)
                  const authorAvatarUrl = (() => {
                      if (post.avatarUrl) return post.avatarUrl;
                      try {
                          const meStored = StorageManager.load('me', null);
                          if (
                              currentUser &&
                              (post.ownerUsername === currentUser.username || post.username === currentUser.username || post.author === currentUser.name)
                          ) {
                              return currentUser.avatarUrl || meStored?.avatarUrl || null;
                          }
                          const users = StorageManager.load('users', []);
                          const byUsername = users.find(u => u.username === post.username);
                          if (byUsername && byUsername.avatar) return byUsername.avatar;
                          const byName = users.find(u => u.name === post.author);
                          if (byName && byName.avatar) return byName.avatar;
                      } catch {}
                      return null;
                  })();

                  // Poll logic
                  const poll = post && post.poll;
                  const [votedOption, setVotedOption] = useState(() => {
                      const votes = StorageManager.load('pollVotes', {});
                      const key = `${post.id}`;
                      return votes[key] ?? null;
                  });

                  const handleVote = (optIndex) => {
                      if (!poll || votedOption !== null) return; // already voted
                      const updatedPost = { ...post, poll: { ...poll, options: poll.options.map((o, i) => ({ ...o, votes: (o.votes || 0) + (i === optIndex ? 1 : 0) })) } };
                      setVotedOption(optIndex);
                      const votes = StorageManager.load('pollVotes', {});
                      votes[`${post.id}`] = optIndex;
                      StorageManager.save('pollVotes', votes);
                      if (onUpdatePost) onUpdatePost(updatedPost);
                  };

                  const isOwner = currentUser && (
                      post.ownerUsername === currentUser.username ||
                      post.username === currentUser.username ||
                      post.author === currentUser.name
                  );

                  const [quickComment, setQuickComment] = useState('');
                  const submitQuickComment = (e) => {
                      if (e) e.preventDefault();
                      const text = (quickComment || '').trim();
                      if (!text) return;
                      if (onAddComment) onAddComment(post.id, text);
                      setQuickComment('');
                  };

                  // Derive title/details from legacy combined content if needed
                  const hasStructured = (post && (post.title || post.details));
                  let derivedTitle = null;
                  let derivedDetails = null;
                  if (!hasStructured && typeof post?.content === 'string') {
                      const parts = post.content.split(/\n\s*\n/);
                      if (parts.length > 1) {
                          derivedTitle = parts[0].trim();
                          derivedDetails = parts.slice(1).join('\n\n').trim();
                      }
                  }

                  const needsSensitiveGate = !!post?.sensitive && !sensitiveAck;
                  const overlayed = blurred || needsSensitiveGate;
                  return (
                      <div className="soft-card p-4 mb-4 post-card relative rounded-2xl overflow-hidden">
                          {overlayed && (
                              <div className="absolute inset-0 z-10 bg-white/60 backdrop-blur-sm flex items-center justify-center px-4 text-center">
                                  <div>
                                      {needsSensitiveGate ? (
                                          <>
                                              <div className="text-sm font-semibold text-gray-900 mb-1">Sensitive content</div>
                                              <p className="text-xs text-gray-600 mb-3">This post may include content that some people find disturbing. By continuing you acknowledge our community guidelines.</p>
                                              <button onClick={()=>{ const ack = StorageManager.load('sensitiveAck', {}) || {}; ack[post.id]=true; StorageManager.save('sensitiveAck', ack); setSensitiveAck(true); }} className="px-3 py-1.5 rounded-full bg-white border border-gray-300 text-gray-700 hover:shadow-sm text-xs">View anyway</button>
                                          </>
                                      ) : (
                                          <div className="space-y-2">
                                              <div className="text-gray-800 font-semibold">Join to view</div>
                                              <div className="text-gray-600 text-sm">This is a private group</div>
                                              <button onClick={() => onJoinGroup && onJoinGroup(post.groupId)} className="mt-2 px-3 py-1.5 rounded-full bg-primary text-white text-xs">Join Group</button>
                                          </div>
                                      )}
                                  </div>
                              </div>
                          )}
                          <div className={overlayed ? 'blur-sm opacity-60 select-none pointer-events-none' : ''}>
                          <div className="flex items-center mb-3">
                              <button type="button" onClick={handleUserClick} className="mr-3">
                                  {authorAvatarUrl ? (
                                      <img src={authorAvatarUrl} alt={post.author} className="w-10 h-10 rounded-full object-cover" />
                                  ) : (
                                      <div className={`w-10 h-10 ${post.avatarColor} rounded-full flex items-center justify-center`}>
                                          <span className="text-white font-bold text-sm">{post.authorInitial}</span>
                                      </div>
                                  )}
                              </button>
                              <div className="flex-1">
                                  {(() => { /* resolve group name once per render */ })()}
                                  <button
                                      onClick={handleUserClick}
                                      className="text-left hover:text-primary transition-colors"
                                  >
                                      <div className="flex items-center flex-wrap">
                                          <span className="font-semibold text-sm text-gray-900">{post.author}</span>
                                          {post.username && (
                                              <button
                                                  onClick={() => onUserClick && onUserClick(post.username)}
                                                  className="ml-2 text-xs text-gray-500 hover:underline"
                                                  title="View profile"
                                              >
                                                  {post.username}
                                              </button>
                                          )}
                                          { (() => {
                                              const groups = StorageManager.load('allGroups', []);
                                              const resolved = post.groupName || (post.groupId != null ? (groups || []).find(g => g.id === post.groupId)?.name : null);
                                              // Only show group context when browsing outside a specific group (i.e., when onGroupClick is provided)
                                              return (onGroupClick && resolved) ? (
                                                <>
                                                  <span className="mx-1 text-xs text-textSecondary">in</span>
                                                  {post.groupIcon && (
                                                      <span className="text-xs mr-1">{post.groupIcon}</span>
                                                  )}
                                                  <button
                                                      type="button"
                                                      onClick={(e) => { e.preventDefault(); onGroupClick && onGroupClick(post.groupId ?? null, resolved); }}
                                                      className="text-[#5BAE9B] text-xs font-medium hover:underline hover:text-[#4C9C8A] mr-1"
                                                  >
                                                      {resolved}
                                                  </button>
                                                </>
                                              ) : null;
                                          })() }
                                          <span className="mx-1 text-gray-300">â€¢</span>
                                          <span className="text-gray-500 text-xs">{getRelativePostTime(post)}</span>
                                      </div>
                                  </button>
                              </div>
                              {/* Removed overflow menu (three dots) as requested */}
                          </div>

                          {(post.title || post.details || derivedTitle || derivedDetails) ? (
                              <div className="mb-3">
                                  {(post.title || derivedTitle) && (
                                      <h3 className="text-gray-900 font-bold text-sm leading-snug mb-1">{post.title || derivedTitle}</h3>
                                  )}
                                  {(post.details || derivedDetails) && (
                                      <p className="text-gray-700 text-sm leading-relaxed whitespace-pre-line">{post.details || derivedDetails}</p>
                                  )}
                              </div>
                          ) : (
                              <p className="text-gray-700 text-sm mb-3 leading-relaxed whitespace-pre-line">{post.content}</p>
                          )}

                          {/* Poll */}
                          {poll && Array.isArray(poll.options) && (
                              <div className="space-y-2 mb-3">
                                  {poll.options.map((opt, idx) => {
                                      const total = poll.options.reduce((s, o) => s + (o.votes || 0), 0) || 0;
                                      const pct = total ? Math.round(((opt.votes || 0) / total) * 100) : 0;
                                      const isSelected = votedOption === idx;
                                      return (
                                          <button
                                              key={idx}
                                              onClick={() => handleVote(idx)}
                                              disabled={votedOption !== null}
                                              className={`w-full px-3 py-2 rounded-xl border ${isSelected ? 'border-like text-like' : 'border-gray-200 text-gray-700'} text-left`}
                                          >
                                              <div className="flex items-center justify-between">
                                                  <span className="text-sm">{opt.text}</span>
                                                  {votedOption !== null && (
                                                      <span className="text-xs text-gray-500">{pct}%</span>
                                                  )}
                                              </div>
                                              {votedOption !== null && (
                                                  <div className="w-full h-1 mt-2 bg-gray-100 rounded-full overflow-hidden">
                                                      <div className="h-full bg-like" style={{ width: `${pct}%` }}></div>
                                                  </div>
                                              )}
                                          </button>
                                      );
                                  })}
                                  {votedOption !== null && (
                                      <div className="text-xs text-gray-500">Total votes: {poll.options.reduce((s,o)=>s+(o.votes||0),0)}</div>
                                  )}
                              </div>
                          )}

                          {post.image && (
                              <div className="rounded-xl mb-3 overflow-hidden bg-gray-100 flex items-center justify-center">
                                  {post.image.type === 'file' ? (
                                      <img
                                          src={post.image.url}
                                          alt="Post image"
                                          className="w-full max-h-64 object-contain"
                                      />
                                  ) : (
                                      <div className={`${post.image.bgColor} rounded-xl h-32 flex items-center justify-center w-full`}>
                                          <span className="text-4xl">{post.image.emoji}</span>
                                      </div>
                                  )}
                              </div>
                          )}

                          <div className="flex items-center justify-between pt-3 border-t border-border">
                              <div className="flex items-center gap-3">
                                  <button
                                      onClick={handleLike}
                                      className="btn-ghost flex items-center gap-1 px-2 py-2 rounded-xl"
                                      aria-label={liked ? 'Unlike' : 'Like'}
                                  >
                                      <svg width="20" height="20" viewBox="0 0 24 24" className={`${liked ? 'text-like' : 'text-gray-500'}`} fill={liked ? "currentColor" : "none"} stroke="currentColor" strokeWidth={liked ? 1.5 : 2}>
                                          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                      </svg>
                                      <span className="text-sm font-medium text-gray-900">{likeCount}</span>
                                  </button>
                                  <button
                                      onClick={() => onComment && onComment(post.id)}
                                      className="btn-ghost flex items-center gap-1 text-gray-600 hover:text-comment px-2 py-2 rounded-xl"
                                      aria-label="Comment"
                                  >
                                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                      </svg>
                                      <span className="text-sm font-medium">{post.comments}</span>
                                  </button>
                              </div>

                              <div className="flex items-center gap-2">
                                  <button
                                      onClick={handleSave}
                                      className={`btn-ghost flex items-center gap-1 px-2 py-2 rounded-xl ${ saved ? 'text-save' : 'text-gray-600 hover:text-save'}`}
                                      aria-label={saved ? 'Unsave' : 'Save'}
                                  >
                                      <svg width="20" height="20" viewBox="0 0 24 24" fill={saved ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2">
                                          <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                                      </svg>
                                  </button>
                                  <button
                                      onClick={() => onShare && onShare(post.id)}
                                      className="btn-ghost flex items-center gap-1 text-gray-600 hover:text-share px-2 py-2 rounded-xl"
                                      title="Share"
                                      aria-label="Share"
                                  >
                                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                          <path d="M22 12l-8-5v10l8-5z"></path>
                                          <circle cx="6" cy="12" r="3"></circle>
                                      </svg>
                                  </button>
                                  {isOwner && (
                                      <button
                                          onClick={() => onDelete && onDelete(post.id)}
                                          className="btn-ghost flex items-center gap-1 text-rose-500 hover:bg-rose-50 px-2 py-2 rounded-xl"
                                          title="Delete post"
                                          aria-label="Delete post"
                                      >
                                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                              <polyline points="3 6 5 6 21 6"/>
                                              <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                                              <path d="M10 11v6M14 11v6"/>
                                              <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
                                          </svg>
                                      </button>
                                  )}
                              </div>
                          </div>

                          {pinnedComment && !blurred && (
                              <div className="mt-3 bg-secondary/10 border border-secondary/20 rounded-2xl px-3 py-3">
                                  <div className="flex items-center gap-2 mb-1">
                                      <span className="text-xs font-semibold text-secondary uppercase tracking-wide">Orbit Bot</span>
                                      <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-white/80 text-secondary text-[10px] font-semibold uppercase">Sabit</span>
                                      <span className="text-[10px] text-gray-400">{getRelativeCommentTime(pinnedComment)}</span>
                                  </div>
                                  <p className="text-sm text-gray-700 leading-relaxed whitespace-pre-line">{pinnedComment.text}</p>
                              </div>
                          )}

                          {/* Quick message input like screenshot */}
                          <div className="mt-3">
                              <div className="flex items-center gap-2">
                                  <button type="button" onClick={() => onUserClick && onUserClick(currentUser?.name || '')} className="flex-shrink-0">
                                      {currentUser && currentUser.avatarUrl ? (
                                          <img src={currentUser.avatarUrl} alt={currentUser.name || 'You'} className="w-7 h-7 rounded-full object-cover" />
                                      ) : (
                                          <div className={`w-7 h-7 ${(currentUser && currentUser.avatarColor) ? currentUser.avatarColor : 'bg-primary'} rounded-full flex items-center justify-center`}>
                                              <span className="text-white text-xs font-semibold">{(currentUser?.name && currentUser.name[0]) ? currentUser.name[0].toUpperCase() : 'U'}</span>
                                          </div>
                                      )}
                                  </button>
                                  <input
                                      type="text"
                                      value={quickComment}
                                      onChange={(e)=> setQuickComment(e.target.value)}
                                      onKeyDown={(e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); e.stopPropagation(); submitQuickComment(); } }}
                                      onClick={(e)=> e.stopPropagation()}
                                      placeholder="Message..."
                                      aria-label="Add a message"
                                      className="flex-1 px-3 py-2 rounded-full border border-gray-200 bg-white text-gray-700 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"
                                  />
                                  <button
                                      type="button"
                                      disabled={!quickComment.trim()}
                                      onClick={(e)=> { e.preventDefault(); e.stopPropagation(); submitQuickComment(); }}
                                      className={`px-3 py-2 rounded-full text-sm font-medium ${quickComment.trim() ? 'text-share' : 'text-gray-300 cursor-not-allowed'}`}
                                      title="Send"
                                      aria-label="Send message"
                                  >
                                      Send
                                  </button>
                              </div>
                          </div>
                          </div>
                      </div>
                  );
              };

              // Main App Component with Data Persistence
              const ORBIT_MOOD_OPTIONS = [
                  { id: 'tired', emoji: 'ðŸ˜©', label: 'Yorgun', tone: 'Bedenim yoruldu', color: '#8B5CF6', intensity: 3 },
                  { id: 'happy', emoji: 'ðŸ˜Š', label: 'Mutlu', tone: 'Ä°Ã§im kÄ±pÄ±r kÄ±pÄ±r', color: '#F59E0B', intensity: 5 },
                  { id: 'sad', emoji: 'ðŸ˜”', label: 'ÃœzgÃ¼n', tone: 'Biraz destek gerek', color: '#3B82F6', intensity: 2 },
                  { id: 'hopeful', emoji: 'ðŸ’ª', label: 'Umutlu', tone: 'BugÃ¼n gÃ¼Ã§lÃ¼yÃ¼m', color: '#10B981', intensity: 4 },
                  { id: 'neutral', emoji: 'ðŸ˜', label: 'NÃ¶tr', tone: 'Sakin bir gÃ¼n', color: '#6B7280', intensity: 3 },
                  { id: 'excited', emoji: 'ðŸ¤©', label: 'HeyecanlÄ±', tone: 'Enerji dolu', color: '#EF4444', intensity: 5 },
                  { id: 'calm', emoji: 'ðŸ˜Œ', label: 'Sakin', tone: 'Huzurlu hissediyorum', color: '#06B6D4', intensity: 4 },
                  { id: 'anxious', emoji: 'ðŸ˜°', label: 'EndiÅŸeli', tone: 'Biraz kaygÄ±lÄ±', color: '#F97316', intensity: 2 },
                  { id: 'grateful', emoji: 'ðŸ™', label: 'Minnettar', tone: 'ÅžÃ¼kÃ¼r dolu', color: '#84CC16', intensity: 4 },
                  { id: 'motivated', emoji: 'ðŸš€', label: 'Motiveli', tone: 'Hedeflerime odaklÄ±', color: '#EC4899', intensity: 5 }
              ];

              // Enhanced mood tracking data structures
              const MOOD_ACTIVITIES = [
                  { id: 'exercise', emoji: 'ðŸƒâ€â™‚ï¸', label: 'Egzersiz', category: 'physical' },
                  { id: 'meditation', emoji: 'ðŸ§˜â€â™€ï¸', label: 'Meditasyon', category: 'mental' },
                  { id: 'music', emoji: 'ðŸŽµ', label: 'MÃ¼zik Dinleme', category: 'entertainment' },
                  { id: 'reading', emoji: 'ðŸ“š', label: 'Okuma', category: 'mental' },
                  { id: 'social', emoji: 'ðŸ‘¥', label: 'Sosyal Aktivite', category: 'social' },
                  { id: 'nature', emoji: 'ðŸŒ³', label: 'DoÄŸa', category: 'physical' },
                  { id: 'creative', emoji: 'ðŸŽ¨', label: 'YaratÄ±cÄ±lÄ±k', category: 'mental' },
                  { id: 'rest', emoji: 'ðŸ˜´', label: 'Dinlenme', category: 'physical' }
              ];

              const MOOD_GOALS = [
                  { id: 'consistency', label: 'TutarlÄ±lÄ±k', description: '7 gÃ¼n Ã¼st Ã¼ste mood kaydÄ±', target: 7, type: 'streak' },
                  { id: 'positivity', label: 'Pozitiflik', description: 'Haftada 5 pozitif mood', target: 5, type: 'weekly' },
                  { id: 'selfcare', label: 'Ã–z BakÄ±m', description: 'GÃ¼nde 1 Ã¶z bakÄ±m aktivitesi', target: 1, type: 'daily' },
                  { id: 'reflection', label: 'DÃ¼ÅŸÃ¼nme', description: 'GÃ¼nde 1 mood notu', target: 1, type: 'daily' }
              ];

              // Social features data structures
              const MOOD_FRIENDS = [
                  { id: 'friend_1', name: 'AyÅŸe', avatar: 'ðŸ‘©â€ðŸ‘§', mood: 'happy', lastSeen: '2 saat Ã¶nce', streak: 5, mutualMoods: 12 },
                  { id: 'friend_2', name: 'Fatma', avatar: 'ðŸ‘©â€ðŸ‘¦', mood: 'calm', lastSeen: '1 gÃ¼n Ã¶nce', streak: 3, mutualMoods: 8 },
                  { id: 'friend_3', name: 'Zeynep', avatar: 'ðŸ‘©â€ðŸ‘¶', mood: 'tired', lastSeen: '3 saat Ã¶nce', streak: 7, mutualMoods: 15 }
              ];

              const MOOD_GROUPS = [
                  { id: 'group_1', name: 'Yorgun Anneler', emoji: 'ðŸ˜´', memberCount: 24, description: 'Gece nÃ¶betÃ§isi anneler', mood: 'tired' },
                  { id: 'group_2', name: 'Mutlu Anneler', emoji: 'ðŸ˜Š', memberCount: 18, description: 'Pozitif enerji paylaÅŸÄ±mÄ±', mood: 'happy' },
                  { id: 'group_3', name: 'Sakin Anneler', emoji: 'ðŸ˜Œ', memberCount: 15, description: 'Huzurlu anlar', mood: 'calm' },
                  { id: 'group_4', name: 'Motiveli Anneler', emoji: 'ðŸ’ª', memberCount: 22, description: 'Hedeflerine odaklÄ±', mood: 'motivated' }
              ];

              const SUPPORT_MESSAGES = [
                  { id: 'support_1', type: 'encouragement', text: 'Sen harika bir annesin! ðŸ’ª', emoji: 'ðŸ’•' },
                  { id: 'support_2', type: 'understanding', text: 'Bu duygularÄ± yaÅŸamak normal, yalnÄ±z deÄŸilsin ðŸ¤—', emoji: 'ðŸ¤' },
                  { id: 'support_3', type: 'motivation', text: 'Her gÃ¼n yeni bir baÅŸlangÄ±Ã§, sen bunu baÅŸarabilirsin! ðŸŒŸ', emoji: 'âœ¨' },
                  { id: 'support_4', type: 'comfort', text: 'Zor gÃ¼nler geÃ§er, sen gÃ¼Ã§lÃ¼sÃ¼n ðŸ’ª', emoji: 'ðŸ«‚' }
              ];

              const ACHIEVEMENTS = [
                  { id: 'first_mood', title: 'Ä°lk AdÄ±m', description: 'Ä°lk mood kaydÄ±nÄ± yaptÄ±n', icon: 'ðŸŽ¯', points: 10 },
                  { id: 'week_streak', title: 'HaftalÄ±k TutarlÄ±lÄ±k', description: '7 gÃ¼n Ã¼st Ã¼ste mood kaydÄ±', icon: 'ðŸ”¥', points: 50 },
                  { id: 'positive_week', title: 'Pozitif Hafta', description: 'Haftada 5 pozitif mood', icon: 'ðŸ˜Š', points: 30 },
                  { id: 'social_helper', title: 'Sosyal DestekÃ§i', description: '10 kiÅŸiye destek mesajÄ± gÃ¶nder', icon: 'ðŸ¤', points: 40 },
                  { id: 'mood_expert', title: 'Mood UzmanÄ±', description: '100 mood kaydÄ± tamamla', icon: 'ðŸ†', points: 100 }
              ];

              // Personalization features
              const MOOD_THEMES = [
                  { id: 'default', name: 'VarsayÄ±lan', colors: { primary: '#91b5b0', secondary: '#a8c8a3', accent: '#c4a484' } },
                  { id: 'sunset', name: 'GÃ¼n BatÄ±mÄ±', colors: { primary: '#ff6b6b', secondary: '#ffa726', accent: '#ffcc02' } },
                  { id: 'ocean', name: 'Okyanus', colors: { primary: '#2196f3', secondary: '#00bcd4', accent: '#4fc3f7' } },
                  { id: 'forest', name: 'Orman', colors: { primary: '#4caf50', secondary: '#8bc34a', accent: '#cddc39' } },
                  { id: 'lavender', name: 'Lavanta', colors: { primary: '#9c27b0', secondary: '#ba68c8', accent: '#e1bee7' } }
              ];

              const NOTIFICATION_TYPES = [
                  { id: 'daily_reminder', name: 'GÃ¼nlÃ¼k HatÄ±rlatÄ±cÄ±', description: 'Her gÃ¼n mood kaydÄ± iÃ§in bildirim', enabled: true },
                  { id: 'streak_reminder', name: 'Streak HatÄ±rlatÄ±cÄ±', description: 'Streak\'ini korumak iÃ§in bildirim', enabled: true },
                  { id: 'goal_progress', name: 'Hedef Ä°lerlemesi', description: 'Hedeflerindeki ilerleme iÃ§in bildirim', enabled: false },
                  { id: 'friend_activity', name: 'ArkadaÅŸ Aktivitesi', description: 'ArkadaÅŸlarÄ±nÄ±n mood gÃ¼ncellemeleri', enabled: true },
                  { id: 'achievement', name: 'BaÅŸarÄ± Bildirimi', description: 'Yeni baÅŸarÄ±lar iÃ§in bildirim', enabled: true }
              ];

              const PRIVACY_LEVELS = [
                  { id: 'private', name: 'Ã–zel', description: 'Sadece sen gÃ¶rebilirsin', icon: 'ðŸ”’' },
                  { id: 'friends', name: 'ArkadaÅŸlar', description: 'Sadece arkadaÅŸlarÄ±n gÃ¶rebilir', icon: 'ðŸ‘¥' },
                  { id: 'group', name: 'Grup', description: 'Sadece gruplarÄ±n gÃ¶rebilir', icon: 'ðŸ˜ï¸' },
                  { id: 'public', name: 'Herkese AÃ§Ä±k', description: 'Herkes gÃ¶rebilir', icon: 'ðŸŒ' }
              ];

              // Interaction features
              const MOOD_GAMES = [
                  { id: 'breathing', name: 'Nefes Egzersizi', emoji: 'ðŸ«', duration: 5, description: 'SakinleÅŸmek iÃ§in nefes egzersizi', category: 'relaxation' },
                  { id: 'gratitude', name: 'ÅžÃ¼kÃ¼r Oyunu', emoji: 'ðŸ™', duration: 3, description: 'GÃ¼nlÃ¼k ÅŸÃ¼kÃ¼rlerini yaz', category: 'mindfulness' },
                  { id: 'mood_match', name: 'Mood EÅŸleÅŸtirme', emoji: 'ðŸŽ¯', duration: 2, description: 'Mood kartlarÄ±nÄ± eÅŸleÅŸtir', category: 'cognitive' },
                  { id: 'color_therapy', name: 'Renk Terapisi', emoji: 'ðŸŽ¨', duration: 4, description: 'Renklerle ruh halini dÃ¼zenle', category: 'creative' }
              ];

              const MOOD_MUSIC = [
                  { id: 'calm', name: 'Sakin MÃ¼zik', emoji: 'ðŸŽµ', genre: 'Ambient', duration: 10, mood: 'calm' },
                  { id: 'energetic', name: 'Enerjik MÃ¼zik', emoji: 'ðŸŽ¶', genre: 'Upbeat', duration: 8, mood: 'motivated' },
                  { id: 'happy', name: 'Mutlu MÃ¼zik', emoji: 'ðŸŽ¼', genre: 'Pop', duration: 6, mood: 'happy' },
                  { id: 'meditation', name: 'Meditasyon MÃ¼ziÄŸi', emoji: 'ðŸ§˜â€â™€ï¸', genre: 'Nature Sounds', duration: 15, mood: 'peaceful' }
              ];

              const MEDITATION_SESSIONS = [
                  { id: 'quick_calm', name: 'HÄ±zlÄ± SakinleÅŸme', emoji: 'ðŸŒŠ', duration: 5, type: 'breathing', description: 'HÄ±zlÄ± nefes egzersizi' },
                  { id: 'body_scan', name: 'VÃ¼cut TaramasÄ±', emoji: 'ðŸ‘ï¸', duration: 10, type: 'body', description: 'VÃ¼cudunu dinle ve rahatla' },
                  { id: 'loving_kindness', name: 'Sevgi Meditasyonu', emoji: 'ðŸ’•', duration: 8, type: 'emotional', description: 'Kendine ve baÅŸkalarÄ±na sevgi gÃ¶nder' },
                  { id: 'mindful_walk', name: 'BilinÃ§li YÃ¼rÃ¼yÃ¼ÅŸ', emoji: 'ðŸš¶â€â™€ï¸', duration: 12, type: 'movement', description: 'YÃ¼rÃ¼rken farkÄ±ndalÄ±k' }
              ];

              const EXERCISE_ROUTINES = [
                  { id: 'morning_stretch', name: 'Sabah Germe', emoji: 'ðŸŒ…', duration: 10, intensity: 'light', mood: 'energized' },
                  { id: 'yoga_flow', name: 'Yoga AkÄ±ÅŸÄ±', emoji: 'ðŸ§˜â€â™€ï¸', duration: 20, intensity: 'medium', mood: 'balanced' },
                  { id: 'dance_break', name: 'Dans MolasÄ±', emoji: 'ðŸ’ƒ', duration: 5, intensity: 'high', mood: 'happy' },
                  { id: 'evening_wind', name: 'AkÅŸam RÃ¼zgarÄ±', emoji: 'ðŸŒ™', duration: 15, intensity: 'light', mood: 'calm' }
              ];

              // Analytics and statistics features
              const MOOD_REPORTS = [
                  { id: 'weekly_summary', name: 'HaftalÄ±k Ã–zet', emoji: 'ðŸ“Š', description: 'Bu haftanÄ±n mood analizi', frequency: 'weekly' },
                  { id: 'monthly_trend', name: 'AylÄ±k Trend', emoji: 'ðŸ“ˆ', description: 'AylÄ±k mood trendleri', frequency: 'monthly' },
                  { id: 'activity_impact', name: 'Aktivite Etkisi', emoji: 'ðŸŽ¯', description: 'Aktivitelerin mood Ã¼zerindeki etkisi', frequency: 'on-demand' },
                  { id: 'goal_progress', name: 'Hedef Ä°lerlemesi', emoji: 'ðŸŽ¯', description: 'Hedeflerindeki ilerleme raporu', frequency: 'weekly' }
              ];

              const MOOD_METRICS = [
                  { id: 'average_mood', name: 'Ortalama Mood', value: 3.8, unit: '/5', trend: '+0.2', period: 'Bu hafta' },
                  { id: 'streak_count', name: 'Streak SayÄ±sÄ±', value: 7, unit: 'gÃ¼n', trend: '+2', period: 'En uzun' },
                  { id: 'positive_days', name: 'Pozitif GÃ¼nler', value: 5, unit: '/7', trend: '+1', period: 'Bu hafta' },
                  { id: 'activity_score', name: 'Aktivite Skoru', value: 85, unit: '%', trend: '+5%', period: 'Bu hafta' }
              ];

              const CORRELATION_INSIGHTS = [
                  { id: 'exercise_mood', correlation: 0.75, insight: 'Egzersiz yaptÄ±ÄŸÄ±n gÃ¼nlerde mood skorun %25 daha yÃ¼ksek', confidence: 'high' },
                  { id: 'sleep_mood', correlation: 0.68, insight: '7-8 saat uyuduÄŸun gÃ¼nlerde daha pozitif hissediyorsun', confidence: 'medium' },
                  { id: 'social_mood', correlation: 0.82, insight: 'Sosyal aktiviteler mood\'unu Ã¶nemli Ã¶lÃ§Ã¼de iyileÅŸtiriyor', confidence: 'high' },
                  { id: 'weather_mood', correlation: 0.45, insight: 'GÃ¼neÅŸli gÃ¼nlerde biraz daha mutlu oluyorsun', confidence: 'low' }
              ];

              // Chat enhancements
              const CHAT_EMOJIS = [
                  { id: 'heart', emoji: 'â¤ï¸', name: 'Kalp' },
                  { id: 'laugh', emoji: 'ðŸ˜‚', name: 'GÃ¼lme' },
                  { id: 'thumbs_up', emoji: 'ðŸ‘', name: 'BeÄŸeni' },
                  { id: 'hug', emoji: 'ðŸ¤—', name: 'SarÄ±lmak' },
                  { id: 'fire', emoji: 'ðŸ”¥', name: 'AteÅŸ' },
                  { id: 'star', emoji: 'â­', name: 'YÄ±ldÄ±z' },
                  { id: 'clap', emoji: 'ðŸ‘', name: 'AlkÄ±ÅŸ' },
                  { id: 'pray', emoji: 'ðŸ™', name: 'Dua' }
              ];

              const CHAT_THEMES = [
                  { id: 'default', name: 'VarsayÄ±lan', colors: { bg: '#ffffff', text: '#374151', bubble: '#f3f4f6' } },
                  { id: 'dark', name: 'KaranlÄ±k', colors: { bg: '#1f2937', text: '#f9fafb', bubble: '#374151' } },
                  { id: 'sunset', name: 'GÃ¼n BatÄ±mÄ±', colors: { bg: '#fef3c7', text: '#92400e', bubble: '#fbbf24' } },
                  { id: 'ocean', name: 'Okyanus', colors: { bg: '#dbeafe', text: '#1e40af', bubble: '#3b82f6' } },
                  { id: 'forest', name: 'Orman', colors: { bg: '#dcfce7', text: '#166534', bubble: '#22c55e' } }
              ];

              const VOICE_MESSAGES = [
                  { id: 'voice_1', duration: 15, timestamp: '2024-01-15T10:30:00Z', sender: 'you' },
                  { id: 'voice_2', duration: 8, timestamp: '2024-01-15T10:32:00Z', sender: 'other' },
                  { id: 'voice_3', duration: 22, timestamp: '2024-01-15T10:35:00Z', sender: 'you' }
              ];

            const IMAGE_MESSAGES = [
                { id: 'img_1', url: 'https://via.placeholder.com/300x200', caption: 'BugÃ¼nkÃ¼ manzara', timestamp: '2024-01-15T10:30:00Z', sender: 'you' },
                { id: 'img_2', url: 'https://via.placeholder.com/300x200', caption: 'Yemek fotoÄŸrafÄ±', timestamp: '2024-01-15T10:32:00Z', sender: 'other' }
            ];

            // Gamification data structures
            const GAMIFICATION_BADGES = [
                { id: 'first_mood', name: 'Ä°lk AdÄ±m', description: 'Ä°lk mood kaydÄ±nÄ± yaptÄ±n', icon: 'ðŸŽ¯', rarity: 'common', points: 10, requirement: { type: 'mood_count', value: 1 } },
                { id: 'week_streak', name: 'HaftalÄ±k TutarlÄ±lÄ±k', description: '7 gÃ¼n Ã¼st Ã¼ste mood kaydÄ±', icon: 'ðŸ”¥', rarity: 'rare', points: 50, requirement: { type: 'streak', value: 7 } },
                { id: 'month_streak', name: 'AylÄ±k TutarlÄ±lÄ±k', description: '30 gÃ¼n Ã¼st Ã¼ste mood kaydÄ±', icon: 'ðŸ’Ž', rarity: 'epic', points: 200, requirement: { type: 'streak', value: 30 } },
                { id: 'positive_week', name: 'Pozitif Hafta', description: 'Haftada 5 pozitif mood', icon: 'ðŸ˜Š', rarity: 'rare', points: 30, requirement: { type: 'positive_week', value: 5 } },
                { id: 'social_helper', name: 'Sosyal DestekÃ§i', description: '10 kiÅŸiye destek mesajÄ± gÃ¶nder', icon: 'ðŸ¤', rarity: 'rare', points: 40, requirement: { type: 'support_messages', value: 10 } },
                { id: 'mood_expert', name: 'Mood UzmanÄ±', description: '100 mood kaydÄ± tamamla', icon: 'ðŸ†', rarity: 'legendary', points: 100, requirement: { type: 'mood_count', value: 100 } },
                { id: 'meditation_master', name: 'Meditasyon UstasÄ±', description: '50 meditasyon seansÄ± tamamla', icon: 'ðŸ§˜â€â™€ï¸', rarity: 'epic', points: 150, requirement: { type: 'meditation_sessions', value: 50 } },
                { id: 'exercise_champion', name: 'Egzersiz Åžampiyonu', description: '100 egzersiz seansÄ± tamamla', icon: 'ðŸ’ª', rarity: 'epic', points: 200, requirement: { type: 'exercise_sessions', value: 100 } },
                { id: 'early_bird', name: 'Erken KuÅŸ', description: 'Sabah 6-8 arasÄ± mood kaydÄ± yap', icon: 'ðŸŒ…', rarity: 'common', points: 20, requirement: { type: 'early_morning', value: 1 } },
                { id: 'night_owl', name: 'Gece KuÅŸu', description: 'Gece 22-24 arasÄ± mood kaydÄ± yap', icon: 'ðŸ¦‰', rarity: 'common', points: 20, requirement: { type: 'late_night', value: 1 } }
            ];

            const GAMIFICATION_LEVELS = [
                { level: 1, name: 'Yeni BaÅŸlayan', minPoints: 0, maxPoints: 99, color: '#6B7280', icon: 'ðŸŒ±' },
                { level: 2, name: 'Ã–ÄŸrenci', minPoints: 100, maxPoints: 299, color: '#3B82F6', icon: 'ðŸ“š' },
                { level: 3, name: 'UygulayÄ±cÄ±', minPoints: 300, maxPoints: 599, color: '#10B981', icon: 'ðŸ’¡' },
                { level: 4, name: 'Uzman', minPoints: 600, maxPoints: 999, color: '#F59E0B', icon: 'â­' },
                { level: 5, name: 'Usta', minPoints: 1000, maxPoints: 1999, color: '#EF4444', icon: 'ðŸ”¥' },
                { level: 6, name: 'Åžampiyon', minPoints: 2000, maxPoints: 3999, color: '#8B5CF6', icon: 'ðŸ‘‘' },
                { level: 7, name: 'Efsane', minPoints: 4000, maxPoints: 9999, color: '#EC4899', icon: 'ðŸŒŸ' },
                { level: 8, name: 'Efsanevi', minPoints: 10000, maxPoints: Infinity, color: '#F97316', icon: 'ðŸ’Ž' }
            ];

            const GAMIFICATION_COMPETITIONS = [
                { id: 'weekly_mood', name: 'HaftalÄ±k Mood YarÄ±ÅŸmasÄ±', description: 'Bu hafta en pozitif mood skoruna sahip ol', icon: 'ðŸ†', type: 'weekly', prize: { points: 100, badge: 'weekly_champion' }, participants: 156, endDate: '2024-01-21T23:59:59Z' },
                { id: 'streak_master', name: 'Streak UstasÄ±', description: 'En uzun mood streak\'ini koru', icon: 'ðŸ”¥', type: 'ongoing', prize: { points: 200, badge: 'streak_master' }, participants: 89, endDate: null },
                { id: 'social_butterfly', name: 'Sosyal Kelebek', description: 'En Ã§ok destek mesajÄ± gÃ¶nder', icon: 'ðŸ¦‹', type: 'monthly', prize: { points: 150, badge: 'social_butterfly' }, participants: 234, endDate: '2024-01-31T23:59:59Z' },
                { id: 'meditation_zen', name: 'Meditasyon Zen', description: 'En Ã§ok meditasyon seansÄ± tamamla', icon: 'ðŸ§˜â€â™€ï¸', type: 'monthly', prize: { points: 180, badge: 'meditation_zen' }, participants: 67, endDate: '2024-01-31T23:59:59Z' }
            ];

            const GAMIFICATION_DAILY_CHALLENGES = [
                { id: 'mood_variety', name: 'Mood Ã‡eÅŸitliliÄŸi', description: 'BugÃ¼n 3 farklÄ± mood kaydet', icon: 'ðŸŽ­', points: 25, completed: false, progress: 0, target: 3 },
                { id: 'positive_thinking', name: 'Pozitif DÃ¼ÅŸÃ¼nce', description: 'BugÃ¼n sadece pozitif mood\'lar kaydet', icon: 'ðŸ˜Š', points: 30, completed: false, progress: 0, target: 1 },
                { id: 'activity_mix', name: 'Aktivite KarÄ±ÅŸÄ±mÄ±', description: 'BugÃ¼n 4 farklÄ± aktivite yap', icon: 'ðŸŽ¯', points: 35, completed: false, progress: 0, target: 4 },
                { id: 'early_checkin', name: 'Erken KayÄ±t', description: 'Sabah 9\'dan Ã¶nce mood kaydÄ± yap', icon: 'ðŸŒ…', points: 20, completed: false, progress: 0, target: 1 },
                { id: 'reflection_time', name: 'DÃ¼ÅŸÃ¼nme ZamanÄ±', description: 'BugÃ¼n mood notu yaz', icon: 'ðŸ“', points: 15, completed: false, progress: 0, target: 1 }
            ];

            const GAMIFICATION_REWARDS = [
                { id: 'points_bonus', name: 'Puan Bonusu', description: 'Mood kaydÄ±ndan %50 fazla puan', icon: 'ðŸ’°', type: 'multiplier', value: 1.5, duration: 24 },
                { id: 'streak_protection', name: 'Streak KorumasÄ±', description: 'Bir gÃ¼n streak kaybetme', icon: 'ðŸ›¡ï¸', type: 'protection', value: 1, duration: 24 },
                { id: 'extra_coins', name: 'Ekstra Coin', description: 'Mood kaydÄ±ndan 2x coin', icon: 'ðŸª™', type: 'multiplier', value: 2, duration: 12 },
                { id: 'premium_theme', name: 'Premium Tema', description: 'Ã–zel tema eriÅŸimi', icon: 'ðŸŽ¨', type: 'unlock', value: 'premium', duration: 48 },
                { id: 'exclusive_badge', name: 'Ã–zel Rozet', description: 'Sadece bu hafta alÄ±nabilir rozet', icon: 'ðŸ…', type: 'unlock', value: 'exclusive', duration: 168 }
            ];

            // Integrations data structures
            const CALENDAR_EVENTS = [
                { id: 'event_1', title: 'Doktor Randevusu', date: '2024-01-20', time: '14:00', type: 'medical', mood: 'anxious' },
                { id: 'event_2', title: 'ArkadaÅŸ BuluÅŸmasÄ±', date: '2024-01-22', time: '19:00', type: 'social', mood: 'excited' },
                { id: 'event_3', title: 'Yoga Dersi', date: '2024-01-25', time: '10:00', type: 'wellness', mood: 'calm' },
                { id: 'event_4', title: 'Ä°ÅŸ ToplantÄ±sÄ±', date: '2024-01-26', time: '09:00', type: 'work', mood: 'motivated' }
            ];

            const WEATHER_CONDITIONS = [
                { id: 'sunny', name: 'GÃ¼neÅŸli', emoji: 'â˜€ï¸', temperature: 25, mood: 'happy', description: 'GÃ¼neÅŸli ve sÄ±cak' },
                { id: 'cloudy', name: 'Bulutlu', emoji: 'â˜ï¸', temperature: 18, mood: 'neutral', description: 'Bulutlu ve serin' },
                { id: 'rainy', name: 'YaÄŸmurlu', emoji: 'ðŸŒ§ï¸', temperature: 15, mood: 'sad', description: 'YaÄŸmurlu ve soÄŸuk' },
                { id: 'stormy', name: 'FÄ±rtÄ±nalÄ±', emoji: 'â›ˆï¸', temperature: 12, mood: 'anxious', description: 'FÄ±rtÄ±nalÄ± ve korkutucu' },
                { id: 'snowy', name: 'KarlÄ±', emoji: 'â„ï¸', temperature: 5, mood: 'calm', description: 'KarlÄ± ve huzurlu' }
            ];

            const ACTIVITY_TRACKING = [
                { id: 'steps', name: 'AdÄ±m SayÄ±sÄ±', unit: 'adÄ±m', target: 10000, current: 7500, icon: 'ðŸ‘Ÿ' },
                { id: 'sleep', name: 'Uyku SÃ¼resi', unit: 'saat', target: 8, current: 6.5, icon: 'ðŸ˜´' },
                { id: 'water', name: 'Su Ä°Ã§me', unit: 'bardak', target: 8, current: 5, icon: 'ðŸ’§' },
                { id: 'exercise', name: 'Egzersiz', unit: 'dakika', target: 30, current: 20, icon: 'ðŸƒâ€â™€ï¸' },
                { id: 'meditation', name: 'Meditasyon', unit: 'dakika', target: 15, current: 10, icon: 'ðŸ§˜â€â™€ï¸' }
            ];

            const SOCIAL_MEDIA_INTEGRATIONS = [
                { id: 'instagram', name: 'Instagram', icon: 'ðŸ“¸', connected: false, moodSharing: false, privacyLevel: 'private' },
                { id: 'facebook', name: 'Facebook', icon: 'ðŸ‘¥', connected: false, moodSharing: false, privacyLevel: 'private' },
                { id: 'twitter', name: 'Twitter', icon: 'ðŸ¦', connected: false, moodSharing: false, privacyLevel: 'private' },
                { id: 'linkedin', name: 'LinkedIn', icon: 'ðŸ’¼', connected: false, moodSharing: false, privacyLevel: 'private' },
                { id: 'whatsapp', name: 'WhatsApp', icon: 'ðŸ’¬', connected: false, moodSharing: false, privacyLevel: 'private' }
            ];

            const HEALTH_INTEGRATIONS = [
                { id: 'apple_health', name: 'Apple Health', icon: 'ðŸŽ', connected: false, syncSteps: true, syncSleep: true, syncHeartRate: false },
                { id: 'google_fit', name: 'Google Fit', icon: 'ðŸ¤–', connected: false, syncSteps: true, syncSleep: true, syncHeartRate: false },
                { id: 'fitbit', name: 'Fitbit', icon: 'âŒš', connected: false, syncSteps: true, syncSleep: true, syncHeartRate: true },
                { id: 'samsung_health', name: 'Samsung Health', icon: 'ðŸ“±', connected: false, syncSteps: true, syncSleep: true, syncHeartRate: false }
            ];

            const MOOD_CORRELATIONS = [
                { factor: 'weather', correlation: 0.65, description: 'Hava durumu mood\'unu etkiliyor' },
                { factor: 'sleep', correlation: 0.78, description: 'Uyku kalitesi mood\'unu etkiliyor' },
                { factor: 'exercise', correlation: 0.72, description: 'Egzersiz mood\'unu iyileÅŸtiriyor' },
                { factor: 'social', correlation: 0.68, description: 'Sosyal aktiviteler mood\'unu etkiliyor' },
                { factor: 'work', correlation: 0.45, description: 'Ä°ÅŸ stresi mood\'unu etkiliyor' }
            ];

              const ORBIT_MATCH_POOL = [
                  {
                      id: 'match_ayse',
                      name: 'AyÅŸe',
                      moodId: 'tired',
                      babyAge: '8 aylÄ±k',
                      distance: '3 km uzaklÄ±kta',
                      lastActive: '5 dk Ã¶nce',
                      badges: ['Gece nÃ¶betÃ§isi', 'Ä°lk kez anne'],
                      snippet: 'Bu gece neredeyse hiÃ§ uyumadÄ±m, sabah kahvesi bile fayda etmedi.',
                      openingMessage: 'Selam! Bu gece de kÃ¼Ã§Ã¼k hanÄ±m saat baÅŸÄ± uyandÄ±, sen nasÄ±lsÄ±n?',
                      replyLibrary: [
                          'Saat 04:00 civarÄ± bir 15 dakikalÄ±k nefes egzersizi yapÄ±nca biraz toparlÄ±yorum.',
                          'EÅŸime sabah vardiyasÄ± Ã¶ncesi 20 dakika devrettim, mini mini reset iÅŸe yaradÄ±.',
                          'Sende gece rutini iÅŸe yarÄ±yor mu? Ben hafif mÃ¼zik aÃ§Ä±nca biraz sakinliyor.'
                      ]
                  },
                  {
                      id: 'match_elif',
                      name: 'Elif',
                      moodId: 'tired',
                      babyAge: '10 aylÄ±k',
                      distance: 'Ã‡evrimiÃ§i',
                      lastActive: '12 dk Ã¶nce',
                      badges: ['Ä°kiz annesi', 'Ayakta emzirenler'],
                      snippet: 'Ä°kizler bu aralar diÅŸ Ã§Ä±karÄ±yor, uykusuzluk tavan.',
                      openingMessage: 'Merhaba! DiÅŸ dÃ¶nemi yÃ¼zÃ¼nden epey uykusuz kaldÄ±m, birbirimize iyi geliriz diye dÃ¼ÅŸÃ¼ndÃ¼m.',
                      replyLibrary: [
                          'DiÅŸ kaÅŸÄ±yÄ±cÄ±larÄ± kÄ±sa sÃ¼reli iÅŸe yarÄ±yor, sen neler denedin?',
                          'Bazen sadece â€œyalnÄ±z deÄŸilimâ€ demek bile inanÄ±lmaz rahatlatÄ±yor.',
                          'Gece kendime kÃ¼Ã§Ã¼k bir bitki Ã§ayÄ± hazÄ±rlÄ±yorum, seni de rahatlatabilir.'
                      ]
                  },
                  {
                      id: 'match_irem',
                      name: 'Ä°rem',
                      moodId: 'happy',
                      babyAge: '6 aylÄ±k',
                      distance: '2 km uzaklÄ±kta',
                      lastActive: 'Åžu an aktif',
                      badges: ['Yoga sever', 'Sabah insanÄ±'],
                      snippet: 'Sabah uykusunu alÄ±p kahvaltÄ±dan sonra gÃ¼lÃ¼msedi, moralim yÃ¼kseldi.',
                      openingMessage: 'Hey! BugÃ¼n Ã§ok iyi hissediyorum, biraz mutluluk paylaÅŸmaya var mÄ±sÄ±n? ðŸ’›',
                      replyLibrary: [
                          'Sabah rutinimiz sonunda yerine oturdu, sence neler fark yaratÄ±yor?',
                          'BugÃ¼n kendime 20 dakika yoga ayÄ±rdÄ±m, sana da iyi gelebilir.',
                          'MutluluÄŸu paylaÅŸÄ±nca Ã§oÄŸalÄ±yor, neler seni gÃ¼lÃ¼msetti?'
                      ]
                  },
                  {
                      id: 'match_zeynep',
                      name: 'Zeynep',
                      moodId: 'sad',
                      babyAge: '7 aylÄ±k',
                      distance: '5 km uzaklÄ±kta',
                      lastActive: '10 dk Ã¶nce',
                      badges: ['Duygu gÃ¼nlÃ¼ÄŸÃ¼ tutuyor', 'Terapi destekli'],
                      snippet: 'BugÃ¼n biraz duygusalÄ±m, her ÅŸey Ã¼st Ã¼ste geldi.',
                      openingMessage: 'Selam, bugÃ¼n duygusalÄ±m. AynÄ± hissi paylaÅŸÄ±yorsan konuÅŸmak iyi gelebilir.',
                      replyLibrary: [
                          'DuygularÄ±nÄ± yazÄ±ya dÃ¶kmek benim Ã§ok iÅŸime yarÄ±yor, denedin mi?',
                          'Bazen sadece fikir almak istemiyorum, dinleyen biri olsun istiyorum.',
                          'OrbitBotâ€™un meditasyon Ã¶nerilerini denedin mi? Birlikte bakabiliriz.'
                      ]
                  },
                  {
                      id: 'match_melis',
                      name: 'Melis',
                      moodId: 'hopeful',
                      babyAge: '5 aylÄ±k',
                      distance: '4 km uzaklÄ±kta',
                      lastActive: '30 dk Ã¶nce',
                      badges: ['AkÅŸam yÃ¼rÃ¼yÃ¼ÅŸÃ§Ã¼sÃ¼', 'Kitap kulÃ¼bÃ¼'],
                      snippet: 'BugÃ¼n bazÄ± ÅŸeyleri yoluna koydum, umutluyum.',
                      openingMessage: 'Merhaba! BugÃ¼n umutluyum, birlikte motivasyon yÃ¼kseltelim mi?',
                      replyLibrary: [
                          'AkÅŸam bebek arabasÄ±yla 10 dakikalÄ±k yÃ¼rÃ¼yÃ¼ÅŸ bana iyi geldi, Ã¶neririm.',
                          'Ufak hedefler belirlemek beni motive ediyor, senin bugÃ¼nkÃ¼ hedefin ne?',
                          'Dilerim yarÄ±n daha da iyi olur, birlikte plan yapmaya ne dersin?'
                      ]
                  },
                  {
                      id: 'match_hande',
                      name: 'Hande',
                      moodId: 'neutral',
                      babyAge: '9 aylÄ±k',
                      distance: 'Ã‡evrimiÃ§i',
                      lastActive: '1 saat Ã¶nce',
                      badges: ['DÃ¼zen seven', 'PlanlayÄ±cÄ±'],
                      snippet: 'BugÃ¼n her ÅŸey normal seyrinde, biraz sohbet iyi gider.',
                      openingMessage: 'Selam! GÃ¼nÃ¼m sakin geÃ§iyor, biraz muhabbet fena olmazdÄ±.',
                      replyLibrary: [
                          'GÃ¼nÃ¼ planlamak beni rahatlatÄ±yor, sen nasÄ±l organize oluyorsun?',
                          'Bazen nÃ¶tr hissetmek de gÃ¼zel, huzurlu hissediyorum.',
                          'BugÃ¼n sadece nefes alÄ±p rutinime devam etmeye Ã§alÄ±ÅŸÄ±yorum.'
                      ]
                  }
              ];

              const DEFAULT_ORBIT_REPLIES = [
                  'Burada olduÄŸun iÃ§in teÅŸekkÃ¼rler, birbirimize iyi geleceÄŸiz.',
                  'Benzer hisleri paylaÅŸÄ±yoruz, bu Ã§ok rahatlatÄ±cÄ±.',
                  'Ne yaÅŸarsan yaÅŸa, burada yalnÄ±z deÄŸilsin.',
                  'KÃ¼Ã§Ã¼k adÄ±mlar bile bÃ¼yÃ¼k deÄŸiÅŸikliklerin habercisi olabilir.'
              ];

              const enrichOrbitMatch = (match, moodId) => {
                  if (!match) return null;
                  const moodOption = ORBIT_MOOD_OPTIONS.find(option => option.id === moodId);
                  const timestamp = new Date().toISOString();
                  return {
                      ...match,
                      moodId: moodId || match.moodId,
                      moodLabel: moodOption?.label || match.moodLabel || '',
                      moodEmoji: moodOption?.emoji || match.moodEmoji || '',
                      generatedAt: timestamp
                  };
              };

              const formatOrbitTimeRemaining = (endIso) => {
                  if (!endIso) return '';
                  const diff = new Date(endIso).getTime() - Date.now();
                  if (Number.isNaN(diff) || diff <= 0) return '0 dk';
                  const hours = Math.floor(diff / 3600000);
                  const minutes = Math.floor((diff % 3600000) / 60000);
                  if (hours > 0) return `${hours} sa ${minutes.toString().padStart(2, '0')} dk`;
                  return `${Math.max(minutes, 1)} dk`;
              };

              const defaultOrbitMoodState = {
                  moodId: null,
                  moodLabel: '',
                  moodEmoji: '',
                  note: '',
                  lastCheckIn: null,
                  streak: 0,
                  lastCoinDate: null
              };

              const getDayKey = (value) => {
                  if (!value) return null;
                  if (typeof value === 'string' && value.length >= 10) return value.slice(0, 10);
                  const date = new Date(value);
                  if (Number.isNaN(date.getTime())) return null;
                  return date.toISOString().slice(0, 10);
              };

              const diffDays = (fromKey, toKey) => {
                  if (!fromKey || !toKey) return null;
                  const from = Date.parse(`${fromKey}T00:00:00Z`);
                  const to = Date.parse(`${toKey}T00:00:00Z`);
                  if (Number.isNaN(from) || Number.isNaN(to)) return null;
                  return Math.round((from - to) / 86400000);
              };

              const App = () => {
                  // Load initial data from storage
                  const loadInitialData = () => {
                      const storedView = StorageManager.load('currentView', 'community');
                      const normalizedView = storedView === 'home' ? 'community' : storedView;
                      return {
                          currentView: normalizedView,
                          joinedGroups: StorageManager.load('joinedGroups', []),
                          allGroups: StorageManager.load('allGroups', []),
                          coinCount: StorageManager.load('coinCount', 127),
                          savedContent: StorageManager.load('savedContent', []),
                          posts: StorageManager.load('posts', []),
                          users: StorageManager.load('users', [])
                      };
                  };

                  const initialData = loadInitialData();

                  const [currentView, setCurrentView] = useState(initialData.currentView);
                  const [currentGroupView, setCurrentGroupView] = useState(null);
                  const [groupPreview, setGroupPreview] = useState(null);
                  const [currentUserProfile, setCurrentUserProfile] = useState(null);
                  const [groupPosts, setGroupPosts] = useState(StorageManager.load('groupPosts', {}));
                  const [joinedGroups, setJoinedGroups] = useState(initialData.joinedGroups);
                  const [allGroups, setAllGroups] = useState(initialData.allGroups);
                  const [coinCount, setCoinCount] = useState(initialData.coinCount);
                  const [savedContent, setSavedContent] = useState(initialData.savedContent);
                  const [posts, setPosts] = useState(initialData.posts);
                  const [users] = useState(initialData.users);
                  const [orbitMoodState, setOrbitMoodState] = useState(() => {
                      const stored = StorageManager.load('orbitMoodState', null);
                      return stored ? { ...defaultOrbitMoodState, ...stored } : { ...defaultOrbitMoodState };
                  });
                  
                  // Enhanced mood tracking states
                  const [moodHistory, setMoodHistory] = useState(() => StorageManager.load('moodHistory', []));
                  const [moodActivities, setMoodActivities] = useState(() => StorageManager.load('moodActivities', []));
                  const [moodGoals, setMoodGoals] = useState(() => StorageManager.load('moodGoals', MOOD_GOALS));
                  const [moodAchievements, setMoodAchievements] = useState(() => StorageManager.load('moodAchievements', []));
                  const [moodAnalytics, setMoodAnalytics] = useState(() => StorageManager.load('moodAnalytics', {
                      weeklyTrend: [],
                      monthlyTrend: [],
                      activityCorrelations: {},
                      moodPatterns: {}
                  }));
                  const [moodSettings, setMoodSettings] = useState(() => StorageManager.load('moodSettings', {
                      notifications: true,
                      reminderTime: '09:00',
                      privacy: 'private',
                      theme: 'default',
                      customMoods: []
                  }));
                  
                  // Social features states
                  const [moodFriends, setMoodFriends] = useState(() => StorageManager.load('moodFriends', MOOD_FRIENDS));
                  const [moodGroups, setMoodGroups] = useState(() => StorageManager.load('moodGroups', MOOD_GROUPS));
                  const [supportMessages, setSupportMessages] = useState(() => StorageManager.load('supportMessages', []));
                  const [userAchievements, setUserAchievements] = useState(() => StorageManager.load('userAchievements', []));
                  const [moodPoints, setMoodPoints] = useState(() => StorageManager.load('moodPoints', 0));
                  const [userLevel, setUserLevel] = useState(() => StorageManager.load('userLevel', 1));
                  
                  // Personalization states
                  const [customMoods, setCustomMoods] = useState(() => StorageManager.load('customMoods', []));
                  const [selectedTheme, setSelectedTheme] = useState(() => StorageManager.load('selectedTheme', 'default'));
                  const [notificationSettings, setNotificationSettings] = useState(() => StorageManager.load('notificationSettings', NOTIFICATION_TYPES));
                  const [privacySettings, setPrivacySettings] = useState(() => StorageManager.load('privacySettings', { level: 'private', shareMood: false, shareActivities: false }));
                  const [reminderTime, setReminderTime] = useState(() => StorageManager.load('reminderTime', '09:00'));
                  
                  // Interaction features states
                  const [activeGame, setActiveGame] = useState(null);
                  const [activeMusic, setActiveMusic] = useState(null);
                  const [activeMeditation, setActiveMeditation] = useState(null);
                  const [activeExercise, setActiveExercise] = useState(null);
                  const [gameProgress, setGameProgress] = useState(() => StorageManager.load('gameProgress', {}));
                  const [musicHistory, setMusicHistory] = useState(() => StorageManager.load('musicHistory', []));
                  const [meditationHistory, setMeditationHistory] = useState(() => StorageManager.load('meditationHistory', []));
                  const [exerciseHistory, setExerciseHistory] = useState(() => StorageManager.load('exerciseHistory', []));
                  
                  // Analytics and statistics states
                  const [moodReports, setMoodReports] = useState(() => StorageManager.load('moodReports', []));
                  const [moodMetrics, setMoodMetrics] = useState(() => StorageManager.load('moodMetrics', MOOD_METRICS));
                  const [correlationInsights, setCorrelationInsights] = useState(() => StorageManager.load('correlationInsights', CORRELATION_INSIGHTS));
                  const [reportHistory, setReportHistory] = useState(() => StorageManager.load('reportHistory', []));
                  const [insightHistory, setInsightHistory] = useState(() => StorageManager.load('insightHistory', []));
                  
            // Chat enhancements states
            const [chatTheme, setChatTheme] = useState(() => StorageManager.load('chatTheme', 'default'));
            const [chatEmojis, setChatEmojis] = useState(() => StorageManager.load('chatEmojis', CHAT_EMOJIS));
            const [voiceMessages, setVoiceMessages] = useState(() => StorageManager.load('voiceMessages', []));
            const [imageMessages, setImageMessages] = useState(() => StorageManager.load('imageMessages', []));
            const [messageReactions, setMessageReactions] = useState(() => StorageManager.load('messageReactions', {}));
            const [chatSettings, setChatSettings] = useState(() => StorageManager.load('chatSettings', {
                showTimestamps: true,
                showReadReceipts: true,
                enableVoiceMessages: true,
                enableImageSharing: true,
                enableEmojiReactions: true
            }));

            // Gamification states
            const [gamificationBadges, setGamificationBadges] = useState(() => StorageManager.load('gamificationBadges', []));
            const [gamificationLevel, setGamificationLevel] = useState(() => StorageManager.load('gamificationLevel', 1));
            const [gamificationPoints, setGamificationPoints] = useState(() => StorageManager.load('gamificationPoints', 0));
            const [gamificationCompetitions, setGamificationCompetitions] = useState(() => StorageManager.load('gamificationCompetitions', GAMIFICATION_COMPETITIONS));
            const [dailyChallenges, setDailyChallenges] = useState(() => StorageManager.load('dailyChallenges', GAMIFICATION_DAILY_CHALLENGES));
            const [activeRewards, setActiveRewards] = useState(() => StorageManager.load('activeRewards', []));
            const [gamificationHistory, setGamificationHistory] = useState(() => StorageManager.load('gamificationHistory', []));
            const [leaderboard, setLeaderboard] = useState(() => StorageManager.load('leaderboard', []));
            const [gamificationSettings, setGamificationSettings] = useState(() => StorageManager.load('gamificationSettings', {
                showNotifications: true,
                enableCompetitions: true,
                enableDailyChallenges: true,
                enableLeaderboard: true,
                privacyLevel: 'friends'
            }));

            // Integrations states
            const [calendarEvents, setCalendarEvents] = useState(() => StorageManager.load('calendarEvents', CALENDAR_EVENTS));
            const [currentWeather, setCurrentWeather] = useState(() => StorageManager.load('currentWeather', WEATHER_CONDITIONS[0]));
            const [activityTracking, setActivityTracking] = useState(() => StorageManager.load('activityTracking', ACTIVITY_TRACKING));
            const [socialMediaIntegrations, setSocialMediaIntegrations] = useState(() => StorageManager.load('socialMediaIntegrations', SOCIAL_MEDIA_INTEGRATIONS));
            const [healthIntegrations, setHealthIntegrations] = useState(() => StorageManager.load('healthIntegrations', HEALTH_INTEGRATIONS));
            const [moodCorrelations, setMoodCorrelations] = useState(() => StorageManager.load('moodCorrelations', MOOD_CORRELATIONS));
            const [integrationSettings, setIntegrationSettings] = useState(() => StorageManager.load('integrationSettings', {
                autoSync: true,
                weatherNotifications: true,
                calendarNotifications: true,
                activityNotifications: false,
                socialSharing: false,
                privacyLevel: 'private'
            }));
                  const [orbitMatchCandidate, setOrbitMatchCandidate] = useState(() => StorageManager.load('orbitMatchCandidate', null));
                  const [orbitChatSession, setOrbitChatSession] = useState(() => StorageManager.load('orbitChatSession', null));
                  const orbitChatSessionRef = useRef(orbitChatSession);
                  const [me, setMe] = useState(
        StorageManager.load('me', {
          name: 'User',
          username: '@user',
          avatarColor: 'bg-primary',
        })
      );
                  // On first mount, prefer stored profile if present
                  useEffect(() => {
                    const stored = StorageManager.load('me', null);
                    if (stored) setMe(stored);
                  }, []);

                  // Modal states
                  const [isSearchModalOpen, setIsSearchModalOpen] = useState(false);
                  const [isNotificationsModalOpen, setIsNotificationsModalOpen] = useState(false);
                  const [isChatModalOpen, setIsChatModalOpen] = useState(false);
                  const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false);
                  const [isCreateGroupModalOpen, setIsCreateGroupModalOpen] = useState(false);
                  const [isCreatePostModalOpen, setIsCreatePostModalOpen] = useState(false);
                  const [isCommentModalOpen, setIsCommentModalOpen] = useState(false);
                  const [isShareModalOpen, setIsShareModalOpen] = useState(false);
                  const [postToShare, setPostToShare] = useState(null);
                  const [selectedPost, setSelectedPost] = useState(null);
                  const [groupShouldOpenPost, setGroupShouldOpenPost] = useState(false);
                  const [isInboxOpen, setIsInboxOpen] = useState(false);
                  const [sharedCount, setSharedCount] = useState(0);
                  const [groupNewPostFor, setGroupNewPostFor] = useState(null);
                  const [isGlobalNewPostOpen, setIsGlobalNewPostOpen] = useState(false);
                  const [pendingGroupPost, setPendingGroupPost] = useState(null);
                  const [isPickGroupOpen, setIsPickGroupOpen] = useState(false);
                  const [showSplash, setShowSplash] = useState(true);
                  const [isAuthenticated, setIsAuthenticated] = useState(StorageManager.load('isAuthenticated', false));

                  const curatedTips = useMemo(() => {
                      const findGroup = (name) => {
                          const match = (allGroups || []).find(g => (g?.name || '').toLowerCase() === (name || '').toLowerCase());
                          return match ? { id: match.id, name: match.name } : { id: null, name };
                      };
                      return [
                          {
                              id: 'lactation',
                              category: 'Emzirme',
                              focus: 'SÃ¼t YÃ¶netimi',
                              expert: 'IBCLC AyÅŸe Demir',
                              headline: 'Emzirme yolculuÄŸunda ritmini yakala',
                              insight: 'Ä°lk haftalarda gÃ¶ÄŸÃ¼sleri tamamen boÅŸaltmak ve ten-ten temasÄ±na zaman ayÄ±rmak sÃ¼t Ã¼retimini destekler.',
                              longInsight: 'Ä°lk Ã¼Ã§ ayda sÃ¼t arzÄ±nÄ± belirleyen en Ã¶nemli unsur gÃ¶ÄŸÃ¼slerin dÃ¼zenli boÅŸalmasÄ± ve bebeÄŸinle kurduÄŸun yakÄ±n temas. Her emzirme Ã¶ncesinde birkaÃ§ derin nefes alarak bedenini yumuÅŸatmak, sÃ¼t salÄ±nÄ±m refleksini hÄ±zlandÄ±rÄ±r. Seans bittikten sonra kalan sÃ¼tÃ¼ saÄŸmak ya da bebeÄŸin emziÄŸini deÄŸiÅŸtirerek gÃ¶ÄŸÃ¼sleri tekrar uyarmak, sÃ¼t Ã¼retimini uzun vadede dengede tutar.\n\nGece beslenmelerini tamamen gÃ¶z ardÄ± etmemeye Ã§alÄ±ÅŸ. Uykudan feda etmek zor gÃ¶rÃ¼nse de, Ã¶zellikle saat 02.00-05.00 arasÄ± yapÄ±lan kÄ±sa bir emzirme, prolaktin seviyeni artÄ±rarak sÃ¼t Ã¼retimini destekler. Bu saatlerde Ä±ÅŸÄ±klarÄ± loÅŸ tutmak, duygusal olarak daha rahatlatÄ±cÄ± bir deneyim yaratÄ±r.\n\nKendi beslenme ve su tÃ¼ketimi planÄ±n da bu sÃ¼recin ayrÄ±lmaz bir parÃ§asÄ±. GÃ¼nde en az sekiz bardak su iÃ§mek, protein ve lif aÃ§Ä±sÄ±ndan dengeli tabaklar hazÄ±rlamak, hem sÃ¼t miktarÄ±nÄ± hem de enerjini korumana yardÄ±mcÄ± olur.',
                              actions: [
                                  'Her emzirme sonrasÄ± 5 dakikalÄ±k skin-to-skin temas ekle.',
                                  'Geceleri en az bir kez beslenme sonrasÄ± gÃ¶ÄŸÃ¼s deÄŸiÅŸtir.'
                              ],
                              group: findGroup('New Mom Support')
                          },
                          {
                              id: 'nutrition',
                              category: 'Diyet',
                              focus: 'Anne & Bebek Beslenmesi',
                              expert: 'Dyt. Elif Karaca',
                              headline: 'Beslenmeni dengede tut, enerjini koru',
                              insight: 'Protein, kompleks karbonhidrat ve saÄŸlÄ±klÄ± yaÄŸlarÄ± dengede tutmak, hem sÃ¼t kalitesini hem de gÃ¼nlÃ¼k enerjiyi artÄ±rÄ±r.',
                              longInsight: 'AnneliÄŸin ilk aylarÄ±nda Ã¶ÄŸÃ¼n atlamak Ã§ok kolay, ancak daha uzun sÃ¼reli enerji iÃ§in Ã¼Ã§ ana Ã¶ÄŸÃ¼n ve iki kÃ¼Ã§Ã¼k ara Ã¶ÄŸÃ¼n planlamak Ã¶nemli. KahvaltÄ±da yumurta, yulaf veya tam tahÄ±l tostunu avokado ve taze sebzelerle eÅŸleÅŸtirerek hem protein hem de saÄŸlÄ±klÄ± yaÄŸ alÄ±rsÄ±n. Ara Ã¶ÄŸÃ¼nlerde ise tahinli yoÄŸurt, kuruyemiÅŸ ve taze meyve kombinasyonu kan ÅŸekerini dengede tutar.\n\nSÃ¼t Ã¼retimini destekleyen rezene, anason veya Ä±sÄ±rgan gibi bitki Ã§aylarÄ±nÄ± gÃ¼n iÃ§ine yayarak tÃ¼ketebilirsin. Ancak kafein alÄ±mÄ±nÄ± sÄ±nÄ±rlamak iÃ§in kahve ve Ã§ay hakkÄ±nÄ± Ã¶ÄŸleden Ã¶nceye yerleÅŸtir, akÅŸam saatlerinde kafeinsiz bitki Ã§aylarÄ±nÄ± tercih et.\n\nKendi tabaÄŸÄ±nÄ± hazÄ±rlarken â€œyarÄ±sÄ± sebze, Ã§eyreÄŸi protein, Ã§eyreÄŸi kompleks karbonhidratâ€ kuralÄ±nÄ± hatÄ±rla. Bu dÃ¼zen sÃ¼rdÃ¼rÃ¼lebilir olduÄŸunda hem sindirimin rahatlar hem de hormon dengen koruma altÄ±na alÄ±nÄ±r.',
                              actions: [
                                  'GÃ¼nde en az 2 litre su iÃ§meyi hatÄ±rlatacak alarmlar kur.',
                                  'Her Ã¶ÄŸÃ¼ne lif kaynaÄŸÄ± ekle: yulaf, chia veya yeÅŸil yapraklÄ±lar.'
                              ],
                              group: findGroup('Baby Food Recipes')
                          },
                          {
                              id: 'prenatal',
                              category: 'DoÄŸum Ã–ncesi',
                              focus: 'HazÄ±rlÄ±k',
                              expert: 'DoÃ§. Dr. Nil Birlik',
                              headline: 'DoÄŸuma hazÄ±rlÄ±kta bedenini ve zihnini eÄŸit',
                              insight: 'Meditasyon ve nefes egzersizleri, doÄŸumun aktif fazÄ±nda aÄŸrÄ± algÄ±sÄ±nÄ± azaltmaya yardÄ±mcÄ± olabilir.',
                              longInsight: 'DoÄŸuma hazÄ±rlÄ±k rutininin temelinde beden farkÄ±ndalÄ±ÄŸÄ± ve nefes kontrolÃ¼ yer alÄ±r. Haftada Ã¼Ã§ kez, 10 dakikalÄ±k odaklanmÄ±ÅŸ nefes Ã§alÄ±ÅŸmasÄ± yaparak diyaframÄ±nÄ± gÃ¼Ã§lendirmek, doÄŸum sÄ±rasÄ±nda dalgalar geldiÄŸinde zihninin daha sakin kalmasÄ±na yardÄ±m eder. Bu Ã§alÄ±ÅŸmayÄ±, omurganÄ± destekleyen bir yastÄ±kla oturarak veya bir doÄŸum topu Ã¼zerinde sallanarak yapabilirsin.\n\nDoÄŸum planÄ±nÄ± yazÄ±lÄ± hÃ¢le getirip partnerinle veya destek ekibinle paylaÅŸmak, herkesin rolÃ¼nÃ¼ netleÅŸtirir. Hangi pozisyonlarda kendini gÃ¼vende hissettiÄŸini, mÃ¼dahale sÄ±nÄ±rlarÄ±nÄ± ve doÄŸum sonrasÄ± ilk temas isteklerini plana eklemek, kontrol duygunu artÄ±rÄ±r.\n\nAyrÄ±ca doÄŸum kaslarÄ±nÄ± desteklemek iÃ§in pelvik taban egzersizlerini rutinine ekle. GÃ¼nde Ã¼Ã§ set 10 tekrar olacak ÅŸekilde Kegel egzersizleri yapabilir, her seferinde kaslarÄ± birkaÃ§ saniye sÄ±kÄ±p gevÅŸeterek kas tonusunu gÃ¼Ã§lendirebilirsin.',
                              actions: [
                                  'Haftada 3 kez 10 dakikalÄ±k nefes Ã§alÄ±ÅŸmasÄ± planla.',
                                  'DoÄŸum planÄ±nÄ± partnerinle ve ekibinle paylaÅŸ; herkesin gÃ¶revini netleÅŸtir.'
                              ],
                              group: findGroup('Working Moms')
                          },
                          {
                              id: 'postpartum',
                              category: 'DoÄŸum SonrasÄ±',
                              focus: 'Toparlanma',
                              expert: 'Uzm. Psikolog Zeynep Kurt',
                              headline: 'Postpartum dÃ¶nemde kendini dinlemeyi unutma',
                              insight: 'Ä°lk 12 hafta duygusal dalgalanmalar normal; destek almak toparlanmayÄ± hÄ±zlandÄ±rÄ±r.',
                              longInsight: 'DoÄŸum sonrasÄ± dÃ¶nem, hormonlarÄ±n dalgalandÄ±ÄŸÄ± ve kimliÄŸinin yeniden ÅŸekillendiÄŸi Ã¶zel bir sÃ¼reÃ§. Her gÃ¼n 10 dakikalÄ±k â€œduygu gÃ¼nlÃ¼ÄŸÃ¼â€ tutmak, yaÅŸadÄ±ÄŸÄ±n iniÅŸ Ã§Ä±kÄ±ÅŸlarÄ± daha net gÃ¶rmeni saÄŸlar. GÃ¼nlÃ¼ÄŸÃ¼ne sadece duygunu deÄŸil, bu duyguyu tetikleyen olayÄ±n ne olduÄŸunu ve bedeninde nasÄ±l hissettiÄŸini yazmayÄ± dene.\n\nDestek sistemini aktif hÃ¢le getirmek de iyileÅŸme yolculuÄŸunun Ã¶nemli bir parÃ§asÄ±. EÅŸinle haftalÄ±k gÃ¶rev paylaÅŸÄ±mÄ± konuÅŸmasÄ± yapmak, ev iÃ§indeki yÃ¼kÃ¼ dengeler. Bir arkadaÅŸÄ±nla veya annenle â€œbebek dÄ±ÅŸÄ± sohbetâ€ler planlamak ise sosyal kimliÄŸini canlÄ± tutar.\n\nBedenini dinlemek ve temel ihtiyaÃ§larÄ±nÄ± Ã¶nceliklendirmek, mental esenliÄŸini gÃ¼Ã§lendirir. Uyku aralarÄ±nÄ± bebeÄŸin uykusuna gÃ¶re ayarlamak, 20 dakikalÄ±k hafif yÃ¼rÃ¼yÃ¼ÅŸler yapmak ve haftada bir kez yalnÄ±z baÅŸÄ±na dÄ±ÅŸarÄ± Ã§Ä±kmak, sinir sistemini dÃ¼zenlemeye yardÄ±mcÄ± olur.',
                              actions: [
                                  'Haftada bir â€œcheck-inâ€ saati belirleyip duygularÄ±nÄ± not et.',
                                  'YakÄ±n bir destek kiÅŸisiyle gÃ¶rev paylaÅŸÄ±mÄ± yap; 20 dakikalÄ±k gÃ¼nlÃ¼k yÃ¼rÃ¼yÃ¼ÅŸ ayarla.'
                              ],
                              group: findGroup('Sleep Training')
                          },
                          {
                              id: 'fertility',
                              category: 'Hamilelik Planlama',
                              focus: 'TTC Destek',
                              expert: 'Prof. Dr. Murat Aksoy',
                              headline: 'Hamile kalma ÅŸansÄ±nÄ± artÄ±rmak iÃ§in kÃ¼Ã§Ã¼k adÄ±mlar',
                              insight: 'DÃ¼zenli ovÃ¼lasyon takibi ve stres yÃ¶netimi, doÄŸal yolla gebe kalma olasÄ±lÄ±ÄŸÄ±nÄ± artÄ±rÄ±r.',
                              longInsight: 'Ãœreme saÄŸlÄ±ÄŸÄ±nÄ± desteklemek iÃ§in dÃ¶ngÃ¼nÃ¼ yakÄ±ndan tanÄ±mak bÃ¼yÃ¼k fark yaratÄ±r. Adet gÃ¼nlÃ¼ÄŸÃ¼ tutarak kanama sÃ¼resini, rahim aÄŸzÄ± sÄ±vÄ±sÄ±ndaki deÄŸiÅŸimleri ve bazal vÃ¼cut sÄ±caklÄ±ÄŸÄ±nÄ± kaydetmek, ovÃ¼lasyon zamanÄ±nÄ± daha net gÃ¶rmeni saÄŸlar. Bu verileri 3 ay Ã¼st Ã¼ste kaydetmek, doktorunla yapacaÄŸÄ±n gÃ¶rÃ¼ÅŸmelerde deÄŸerli bir kaynak sunar.\n\nStres hormonlarÄ± doÄŸrudan Ã¼reme hormonlarÄ±nÄ± etkilediÄŸinden, dÃ¼zenli gevÅŸeme teknikleri eklemek faydalÄ±dÄ±r. Haftada iki kez yapacaÄŸÄ±n 20 dakikalÄ±k yin yoga veya rehberli meditasyon, parasempatik sinir sistemini aktive ederek hormon dengeni destekler.\n\nBeslenme tarafÄ±nda ise Omega-3, D vitamini ve Ã§inko aÃ§Ä±sÄ±ndan zengin bir plan izlemek yumurta kalitesini destekler. Doktoruna danÄ±ÅŸarak alacaÄŸÄ±n gerekli takviyelerle birlikte, iÅŸlenmiÅŸ gÄ±dalardan uzak durmak ve doÄŸal protein kaynaklarÄ±nÄ± artÄ±rmak bu yolculuÄŸu gÃ¼Ã§lendirir.',
                              actions: [
                                  '3 ay boyunca dÃ¶ngÃ¼ gÃ¼nlÃ¼ÄŸÃ¼ tut ve doktorunla paylaÅŸ.',
                                  'Stresi azaltmak iÃ§in haftada en az iki kez nefes veya yoga pratiÄŸi planla.'
                              ],
                              group: findGroup('Fertility & TTC Circles')
                          }
                      ];
                  }, [allGroups]);

                  // Load groups and memberships from Supabase when authenticated
                  useEffect(() => {
                      (async () => {
                          try {
                              if (!isAuthenticated) return;
                              if (window.OrbitApi?.groups?.listGroups) {
                                  const gs = await window.OrbitApi.groups.listGroups();
                                  const mapped = (gs || []).map(g => ({
                                      id: g.id,
                                      name: g.name,
                                      slug: g.slug,
                                      about: g.about,
                                      category: g.category,
                                      color: 'bg-primary',
                                      image: 'ðŸ‘¥',
                                      isPrivate: !!g.is_private,
                                      ownerUsername: me.username,
                                      recentActivity: '',
                                      iconUrl: g.icon_url || null,
                                      coverGradient: g.cover_gradient || null
                                  }));
                                  setAllGroups(mapped);
                                  StorageManager.save('allGroups', mapped);
                              }
                              if (window.OrbitApi?.groups?.listMyJoinedGroupIds) {
                                  const ids = await window.OrbitApi.groups.listMyJoinedGroupIds();
                                  setJoinedGroups(ids);
                                  StorageManager.save('joinedGroups', ids);
                              }
                          } catch (e) { console.error('load groups failed', e); }
                      })();
                  }, [isAuthenticated, me.username]);

                  // Load feed from Supabase when authenticated
                  useEffect(() => {
                      (async () => {
                          try {
                              if (!isAuthenticated) return;
                              if (window.OrbitApi?.posts?.listFeed) {
                                  const rows = await window.OrbitApi.posts.listFeed({ limit: 20 });
                                  const mapped = (rows || []).map(created => {
                                      const display = created.author?.display_name || created.author?.username || 'User';
                                      const uname = created.author?.username || '@user';
                                      const avatarUrl = created.author?.avatar_url || null;
                                      const initial = (display && display[0]) ? display[0].toUpperCase() : 'U';
                                      return {
                                          id: created.id,
                                          author: display,
                                          authorInitial: initial,
                                          avatarColor: 'bg-primary',
                                          avatarUrl,
                                          username: uname,
                                          ownerUsername: uname,
                                          createdAt: Date.parse(created.created_at),
                                          time: created.created_at,
                                          content: created.content,
                                          image: created.image_url,
                                          likes: created.likes_count || 0,
                                          comments: created.comments_count || 0,
                                          groupId: created.group_id || null
                                      };
                                  });
                                  setPosts(mapped);
                                  StorageManager.save('posts', mapped);
                              }
                          } catch (e) { console.error('load feed failed', e); }
                      })();
                  }, [isAuthenticated, me.name, me.username, me.avatarColor, me.avatarUrl]);

                  // One-time migration: clear Home posts as requested
                  useEffect(() => {
                      const cleared = StorageManager.load('__clearedHomePostsOnce', false);
                      if (!cleared) {
                          try {
                              StorageManager.save('posts', []);
                              setPosts([]);
                          } catch (e) { /* no-op */ }
                          StorageManager.save('__clearedHomePostsOnce', true);
                      }
                  }, []);

                  // Splash timing - Wait for full animation to complete
                  useEffect(() => {
                      const t = setTimeout(() => setShowSplash(false), 3000);
                      return () => clearTimeout(t);
                  }, []);

                  // ðŸ’¾ Auto-save all important data changes to localStorage
                  useEffect(() => {
                      StorageManager.save('currentView', currentView);
                  }, [currentView]);
                  useEffect(() => { StorageManager.save('isAuthenticated', isAuthenticated); }, [isAuthenticated]);

                  useEffect(() => {
                      StorageManager.save('joinedGroups', joinedGroups);
                  }, [joinedGroups]);

                  useEffect(() => {
                      StorageManager.save('allGroups', allGroups);
                  }, [allGroups]);

                  useEffect(() => {
                      StorageManager.save('coinCount', coinCount);
                  }, [coinCount]);

                  useEffect(() => {
                      StorageManager.save('orbitMoodState', orbitMoodState);
                  }, [orbitMoodState]);

                  useEffect(() => {
                      if (orbitMatchCandidate) StorageManager.save('orbitMatchCandidate', orbitMatchCandidate);
                      else StorageManager.remove('orbitMatchCandidate');
                  }, [orbitMatchCandidate]);

                  useEffect(() => {
                      if (orbitChatSession) StorageManager.save('orbitChatSession', orbitChatSession);
                      else StorageManager.remove('orbitChatSession');
                  }, [orbitChatSession]);

                  // Enhanced mood tracking persistence
                  useEffect(() => {
                      StorageManager.save('moodHistory', moodHistory);
                  }, [moodHistory]);

                  useEffect(() => {
                      StorageManager.save('moodActivities', moodActivities);
                  }, [moodActivities]);

                  useEffect(() => {
                      StorageManager.save('moodGoals', moodGoals);
                  }, [moodGoals]);

                  useEffect(() => {
                      StorageManager.save('moodAchievements', moodAchievements);
                  }, [moodAchievements]);

                  useEffect(() => {
                      StorageManager.save('moodAnalytics', moodAnalytics);
                  }, [moodAnalytics]);

                  useEffect(() => {
                      StorageManager.save('moodSettings', moodSettings);
                  }, [moodSettings]);

                  // Social features persistence
                  useEffect(() => {
                      StorageManager.save('moodFriends', moodFriends);
                  }, [moodFriends]);

                  useEffect(() => {
                      StorageManager.save('moodGroups', moodGroups);
                  }, [moodGroups]);

                  useEffect(() => {
                      StorageManager.save('supportMessages', supportMessages);
                  }, [supportMessages]);

                  useEffect(() => {
                      StorageManager.save('userAchievements', userAchievements);
                  }, [userAchievements]);

                  useEffect(() => {
                      StorageManager.save('moodPoints', moodPoints);
                  }, [moodPoints]);

                  useEffect(() => {
                      StorageManager.save('userLevel', userLevel);
                  }, [userLevel]);

                  // Personalization persistence
                  useEffect(() => {
                      StorageManager.save('customMoods', customMoods);
                  }, [customMoods]);

                  useEffect(() => {
                      StorageManager.save('selectedTheme', selectedTheme);
                  }, [selectedTheme]);

                  useEffect(() => {
                      StorageManager.save('notificationSettings', notificationSettings);
                  }, [notificationSettings]);

                  useEffect(() => {
                      StorageManager.save('privacySettings', privacySettings);
                  }, [privacySettings]);

                  useEffect(() => {
                      StorageManager.save('reminderTime', reminderTime);
                  }, [reminderTime]);

                  // Interaction features persistence
                  useEffect(() => {
                      StorageManager.save('gameProgress', gameProgress);
                  }, [gameProgress]);

                  useEffect(() => {
                      StorageManager.save('musicHistory', musicHistory);
                  }, [musicHistory]);

                  useEffect(() => {
                      StorageManager.save('meditationHistory', meditationHistory);
                  }, [meditationHistory]);

                  useEffect(() => {
                      StorageManager.save('exerciseHistory', exerciseHistory);
                  }, [exerciseHistory]);

                  // Analytics and statistics persistence
                  useEffect(() => {
                      StorageManager.save('moodReports', moodReports);
                  }, [moodReports]);

                  useEffect(() => {
                      StorageManager.save('moodMetrics', moodMetrics);
                  }, [moodMetrics]);

                  useEffect(() => {
                      StorageManager.save('correlationInsights', correlationInsights);
                  }, [correlationInsights]);

                  useEffect(() => {
                      StorageManager.save('reportHistory', reportHistory);
                  }, [reportHistory]);

                  useEffect(() => {
                      StorageManager.save('insightHistory', insightHistory);
                  }, [insightHistory]);

                  // Chat enhancements persistence
                  useEffect(() => { StorageManager.save('chatTheme', chatTheme); }, [chatTheme]);
                  useEffect(() => { StorageManager.save('chatEmojis', chatEmojis); }, [chatEmojis]);
                  useEffect(() => { StorageManager.save('voiceMessages', voiceMessages); }, [voiceMessages]);
                  useEffect(() => { StorageManager.save('imageMessages', imageMessages); }, [imageMessages]);
                  useEffect(() => { StorageManager.save('messageReactions', messageReactions); }, [messageReactions]);
                  useEffect(() => { StorageManager.save('chatSettings', chatSettings); }, [chatSettings]);

                  // Gamification persistence
                  useEffect(() => { StorageManager.save('gamificationBadges', gamificationBadges); }, [gamificationBadges]);
                  useEffect(() => { StorageManager.save('gamificationLevel', gamificationLevel); }, [gamificationLevel]);
                  useEffect(() => { StorageManager.save('gamificationPoints', gamificationPoints); }, [gamificationPoints]);
                  useEffect(() => { StorageManager.save('gamificationCompetitions', gamificationCompetitions); }, [gamificationCompetitions]);
                  useEffect(() => { StorageManager.save('dailyChallenges', dailyChallenges); }, [dailyChallenges]);
                  useEffect(() => { StorageManager.save('activeRewards', activeRewards); }, [activeRewards]);
                  useEffect(() => { StorageManager.save('gamificationHistory', gamificationHistory); }, [gamificationHistory]);
                  useEffect(() => { StorageManager.save('leaderboard', leaderboard); }, [leaderboard]);
                  useEffect(() => { StorageManager.save('gamificationSettings', gamificationSettings); }, [gamificationSettings]);

                  // Integrations persistence
                  useEffect(() => { StorageManager.save('calendarEvents', calendarEvents); }, [calendarEvents]);
                  useEffect(() => { StorageManager.save('currentWeather', currentWeather); }, [currentWeather]);
                  useEffect(() => { StorageManager.save('activityTracking', activityTracking); }, [activityTracking]);
                  useEffect(() => { StorageManager.save('socialMediaIntegrations', socialMediaIntegrations); }, [socialMediaIntegrations]);
                  useEffect(() => { StorageManager.save('healthIntegrations', healthIntegrations); }, [healthIntegrations]);
                  useEffect(() => { StorageManager.save('moodCorrelations', moodCorrelations); }, [moodCorrelations]);
                  useEffect(() => { StorageManager.save('integrationSettings', integrationSettings); }, [integrationSettings]);

                  useEffect(() => {
                      orbitChatSessionRef.current = orbitChatSession;
                  }, [orbitChatSession]);

                  useEffect(() => {
                      StorageManager.save('savedContent', savedContent);
                  }, [savedContent]);

                  useEffect(() => {
                      StorageManager.save('posts', posts);
                  }, [posts]);

                  // persist group posts per group id
                  useEffect(() => {
                      StorageManager.save('groupPosts', groupPosts);
                  }, [groupPosts]);

                  useEffect(() => {
                      StorageManager.save('users', users);
                  }, [users]);

                  useEffect(() => {
                  StorageManager.save('me', me);
                  }, [me]);

                  // Shared inbox counter and listener
                  useEffect(() => {
                    const myKey = (users.find(u => u.username === me.username)?.id) ?? 'me';
                    const calc = () => {
                      const inbox = StorageManager.load('sharedPostsByRecipient', {});
                      const count = Array.isArray(inbox[myKey]) ? inbox[myKey].length : 0;
                      setSharedCount(count);
                    };
                    calc();
                    const onStorage = () => calc();
                    window.addEventListener('storage', onStorage);
                    return () => window.removeEventListener('storage', onStorage);
                  }, [users, me.username, posts]);
                  // Keep profile in sync when navigating between views
                  useEffect(() => {
                    const stored = StorageManager.load('me', null);
                    if (stored && (
                      stored.name !== me.name ||
                      stored.username !== me.username ||
                      stored.avatarColor !== me.avatarColor
                    )) {
                      setMe(stored);
                    }
                  }, [currentView]);

                  // Passive migration: keep my posts/saved items in sync with current name/username and ensure timestamps
                  useEffect(() => {
                    const history = StorageManager.load('nameHistory', []);
                    const historySet = new Set(Array.isArray(history) ? history : []);
                    // Update posts
                    setPosts(prev => {
                      let changed = false;
                      const updated = prev.map(p => {
                        const isMine = (
                          p.username === me.username ||
                          p.author === me.name ||
                          historySet.has(p.author)
                        );
                        let next = p;
                        if (!p.createdAt) {
                          const inferred = (typeof p.time === 'number' && p.time) || (typeof p.id === 'number' && p.id > 1600000000000 ? p.id : null) || getTimestamp(p.time);
                          if (inferred) { next = { ...next, createdAt: inferred }; changed = true; }
                        }
                        if (isMine && (p.author !== me.name || p.username !== me.username)) {
                          changed = true;
                          next = { ...next, author: me.name, authorInitial: me.name[0] ? me.name[0].toUpperCase() : 'U', username: me.username };
                        }
                        return next;
                      });
                      if (changed) StorageManager.save('posts', updated);
                      return updated;
                    });
                    // Update saved content
                    setSavedContent(prev => {
                      let changed = false;
                      const updated = prev.map(it => {
                        const isMine = it.author === me.name || historySet.has(it.author);
                        let next = it;
                        if (!it.createdAt) {
                          const postRef = posts.find(p => p.id === it.id);
                          const inferred = (postRef && postRef.createdAt) || (typeof it.id === 'number' && it.id > 1600000000000 ? it.id : null) || getTimestamp(it.time);
                          if (inferred) { next = { ...next, createdAt: inferred }; changed = true; }
                        }
                        if (isMine && it.author !== me.name) { changed = true; next = { ...next, author: me.name }; }
                        return next;
                      });
                      if (changed) StorageManager.save('savedContent', updated);
                      return updated;
                    });
                  }, [me.name, me.username]);

                  // One-time migration: convert vivid group colors to softer pastels
                  useEffect(() => {
                    const done = StorageManager.load('__migratedPastelGroupColors', false);
                    if (done) return;
                    const map = {
                      'bg-pink-500': 'bg-rose-200',
                      'bg-orange-500': 'bg-amber-200',
                      'bg-green-500': 'bg-emerald-200',
                      'bg-blue-500': 'bg-sky-200',
                      'bg-purple-500': 'bg-violet-200',
                      'bg-red-500': 'bg-rose-200'
                    };
                    setAllGroups(prev => {
                      let changed = false;
                      const updated = (prev || []).map(g => {
                        const nextColor = map[g?.color] || g?.color || 'bg-primary';
                        if (nextColor !== g?.color) { changed = true; return { ...g, color: nextColor }; }
                        return g;
                      });
                      if (changed) StorageManager.save('allGroups', updated);
                      return changed ? updated : prev;
                    });
                    StorageManager.save('__migratedPastelGroupColors', true);
                  }, []);

                  // Show welcome toast on first load
      useEffect(() => {
        const hasShownWelcome = StorageManager.load('hasShownWelcome', false);
        if (!hasShownWelcome) {
          setTimeout(() => {
            StorageManager.save('hasShownWelcome', true);
          }, 1000);
        }
      }, []);

                  // Advanced Coin System with Daily/Weekly/Monthly Limits
                  const getCoinTracking = useCallback(() => {
                      const today = new Date().toISOString().split('T')[0];
                      const weekStart = new Date();
                      weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                      const weekKey = weekStart.toISOString().split('T')[0];
                      const monthStart = new Date();
                      monthStart.setDate(1);
                      const monthKey = monthStart.toISOString().split('T')[0];
                      
                      const isPremium = StorageManager.load('isPremium', false);
                      
                      const tracking = StorageManager.load('coinTracking', {
                          daily: {},
                          weekly: {},
                          monthly: {},
                          chatMessages: {}, // roomId -> count
                          answerLikes: {}, // answerId -> likeCount
                          oneTimeRewards: [] // ['first_signup', 'streak_7']
                      });
                      
                      // Limits: Free users have daily/weekly, Premium users have monthly
                      const dailyLimit = 60;
                      const weeklyLimit = 250;
                      const monthlyLimit = isPremium ? 5000 : null; // Premium users get 5,000 coins/month
                      
                      return {
                          tracking,
                          today,
                          weekKey,
                          monthKey,
                          isPremium,
                          getDailyEarned: () => tracking.daily[today] || 0,
                          getWeeklyEarned: () => tracking.weekly[weekKey] || 0,
                          getMonthlyEarned: () => tracking.monthly[monthKey] || 0,
                          canEarn: (amount) => {
                              if (isPremium && monthlyLimit) {
                                  // Premium: Check monthly limit (5,000 coins/month)
                                  const monthly = (tracking.monthly[monthKey] || 0) + amount;
                                  return monthly <= monthlyLimit;
                              } else {
                                  // Free: Check daily and weekly limits
                                  const daily = (tracking.daily[today] || 0) + amount;
                                  const weekly = (tracking.weekly[weekKey] || 0) + amount;
                                  return daily <= dailyLimit && weekly <= weeklyLimit;
                              }
                          },
                          recordEarned: (amount) => {
                              tracking.daily[today] = (tracking.daily[today] || 0) + amount;
                              tracking.weekly[weekKey] = (tracking.weekly[weekKey] || 0) + amount;
                              tracking.monthly[monthKey] = (tracking.monthly[monthKey] || 0) + amount;
                              StorageManager.save('coinTracking', tracking);
                          }
                      };
                  }, []);

                  const handleCoinEarned = useCallback((amount, reason = '') => {
                      if (amount <= 0) return;
                      
                      const coinTracking = getCoinTracking();
                      const actualAmount = coinTracking.canEarn(amount) ? amount : 0;
                      
                      if (actualAmount === 0) {
                          if (coinTracking.isPremium) {
                              console.log(`[Coin] Monthly limit reached. Requested: ${amount}, Monthly: ${coinTracking.getMonthlyEarned()}/5,000`);
                          } else {
                              console.log(`[Coin] Limit reached. Requested: ${amount}, Daily: ${coinTracking.getDailyEarned()}/60, Weekly: ${coinTracking.getWeeklyEarned()}/250`);
                          }
                          return;
                      }
                      
                      coinTracking.recordEarned(actualAmount);
                      
                      setCoinCount(prev => {
                          const newAmount = prev + actualAmount;
                          StorageManager.save('coinCount', newAmount);
                          return newAmount;
                      });

                      if (actualAmount > 0) {
                          const coinCounter = document.getElementById('coinCounter');
                          if (coinCounter) {
                              coinCounter.classList.add('coin-bounce');
                              setTimeout(() => coinCounter.classList.remove('coin-bounce'), 600);
                          }
                          if (reason) {
                              console.log(`[Coin] Earned ${actualAmount} coins: ${reason}`);
                          }
                      }
                  }, [getCoinTracking]);
                  
                  // Specific coin earning functions
                  const earnCoinsForQuestion = useCallback(() => {
                      handleCoinEarned(5, 'Question asked (AI responded)');
                  }, [handleCoinEarned]);
                  
                  const earnCoinsForChatMessage = useCallback((roomId) => {
                      const tracking = StorageManager.load('coinTracking', {
                          chatMessages: {}
                      });
                      const messageCount = tracking.chatMessages[roomId] || 0;
                      
                      if (messageCount < 10) {
                          tracking.chatMessages[roomId] = messageCount + 1;
                          StorageManager.save('coinTracking', tracking);
                          handleCoinEarned(1, `Chat message in room ${roomId} (${messageCount + 1}/10)`);
                      }
                  }, [handleCoinEarned]);
                  
                  const earnCoinsForChatEvaluation = useCallback((isPositive) => {
                      if (isPositive) {
                          handleCoinEarned(5, 'Chat evaluation: ðŸ‘');
                      } else {
                          handleCoinEarned(0, 'Chat evaluation: ðŸ‘Ž');
                      }
                  }, [handleCoinEarned]);
                  
                  const earnCoinsForSolutionShare = useCallback(() => {
                      handleCoinEarned(15, 'Anonymous solution share (Orbit room summary)');
                  }, [handleCoinEarned]);
                  
                  const earnCoinsForAnswer = useCallback(() => {
                      handleCoinEarned(3, 'Meaningful answer to question');
                  }, [handleCoinEarned]);
                  
                  const earnCoinsForBestAnswer = useCallback(() => {
                      handleCoinEarned(10, 'Answer marked as most helpful');
                  }, [handleCoinEarned]);
                  
                  const earnCoinsForAnswerLike = useCallback((answerId) => {
                      const tracking = StorageManager.load('coinTracking', {
                          answerLikes: {}
                      });
                      const likeCount = tracking.answerLikes[answerId] || 0;
                      
                      if (likeCount < 10) {
                          tracking.answerLikes[answerId] = likeCount + 1;
                          StorageManager.save('coinTracking', tracking);
                          handleCoinEarned(1, `Answer like (${likeCount + 1}/10)`);
                      }
                  }, [handleCoinEarned]);
                  
                  const earnCoinsForFirstSignup = useCallback(() => {
                      const tracking = StorageManager.load('coinTracking', {
                          oneTimeRewards: []
                      });
                      
                      if (!tracking.oneTimeRewards.includes('first_signup')) {
                          tracking.oneTimeRewards.push('first_signup');
                          StorageManager.save('coinTracking', tracking);
                          handleCoinEarned(10, 'First signup + profile completion');
                      }
                  }, [handleCoinEarned]);
                  
                  const earnCoinsForReferral = useCallback(() => {
                      handleCoinEarned(30, 'Referral: Friend installed app and asked first question');
                  }, [handleCoinEarned]);
                  
                  const earnCoinsForStreak = useCallback(() => {
                      const tracking = StorageManager.load('coinTracking', {
                          oneTimeRewards: []
                      });
                      
                      if (!tracking.oneTimeRewards.includes('streak_7')) {
                          tracking.oneTimeRewards.push('streak_7');
                          StorageManager.save('coinTracking', tracking);
                          handleCoinEarned(20, '7-day streak badge (mood + reflection)');
                      }
                  }, [handleCoinEarned]);
                  
                  // Expose coin functions globally for use in other components
                  window.earnCoinsForFirstSignup = earnCoinsForFirstSignup;
                  window.earnCoinsForQuestion = earnCoinsForQuestion;
                  window.earnCoinsForChatMessage = earnCoinsForChatMessage;
                  window.earnCoinsForChatEvaluation = earnCoinsForChatEvaluation;
                  window.earnCoinsForSolutionShare = earnCoinsForSolutionShare;
                  window.earnCoinsForAnswer = earnCoinsForAnswer;
                  window.earnCoinsForBestAnswer = earnCoinsForBestAnswer;
                  window.earnCoinsForAnswerLike = earnCoinsForAnswerLike;
                  window.earnCoinsForReferral = earnCoinsForReferral;
                  window.earnCoinsForStreak = earnCoinsForStreak;

                  const findOrbitMatchForMood = useCallback((moodId, excludeId = null) => {
                      const pool = ORBIT_MATCH_POOL.filter(candidate => !moodId || candidate.moodId === moodId);
                      const usable = excludeId ? pool.filter(candidate => candidate.id !== excludeId) : pool;
                      if (!usable.length) return null;
                      const index = Math.floor(Math.random() * usable.length);
                      return usable[index];
                  }, []);

                  const handleOrbitGenerateMatch = useCallback((moodId, excludeId = null) => {
                      if (!moodId) {
                          setOrbitMatchCandidate(null);
                          return;
                      }
                      const activeChat = orbitChatSessionRef.current;
                      if (activeChat && activeChat.status === 'active') return;
                      const match = enrichOrbitMatch(findOrbitMatchForMood(moodId, excludeId), moodId);
                      setOrbitMatchCandidate(match);
                  }, [findOrbitMatchForMood]);

                  const handleOrbitMatchAccept = useCallback(() => {
                      if (!orbitMatchCandidate) return;
                      const now = new Date();
                      const endsAt = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                      const baseMessages = [
                          {
                              id: `sys-${now.getTime()}`,
                              sender: 'system',
                              text: 'Sohbet baÅŸladÄ±. 24 saat boyunca metin tabanlÄ± ve anonimsiniz. Medya paylaÅŸÄ±mÄ± kapalÄ±dÄ±r.',
                              timestamp: now.toISOString()
                          },
                          {
                              id: `them-${now.getTime() + 1}`,
                              sender: 'them',
                              text: orbitMatchCandidate.openingMessage || 'Merhaba! AynÄ± duygularÄ± paylaÅŸÄ±yoruz galiba ðŸ’›',
                              timestamp: now.toISOString()
                          }
                      ];
                      setOrbitChatSession({
                          id: `chat-${now.getTime()}`,
                          startedAt: now.toISOString(),
                          endsAt: endsAt.toISOString(),
                          status: 'active',
                          match: orbitMatchCandidate,
                          messages: baseMessages
                      });
                      setOrbitMatchCandidate(null);
                      ToastManager?.show?.('Anonim sohbet aÃ§Ä±ldÄ±. 24 saat iÃ§inde destekleÅŸebilirsiniz ðŸ’›', 'success');
                  }, [orbitMatchCandidate]);

                  const handleOrbitMatchSkip = useCallback(() => {
                      const moodId = orbitMoodState?.moodId;
                      if (!moodId) {
                          setOrbitMatchCandidate(null);
                          return;
                      }
                      if (!orbitMatchCandidate) {
                          handleOrbitGenerateMatch(moodId);
                          return;
                      }
                      const next = enrichOrbitMatch(findOrbitMatchForMood(moodId, orbitMatchCandidate.id), moodId);
                      if (next) {
                          setOrbitMatchCandidate(next);
                          ToastManager?.show?.('BaÅŸka bir anne bulduk ðŸ’›', 'info');
                      } else {
                          setOrbitMatchCandidate(null);
                          ToastManager?.show?.('BugÃ¼n iÃ§in baÅŸka eÅŸleÅŸme yok. YarÄ±n yeniden deneriz.', 'info');
                      }
                  }, [orbitMatchCandidate, orbitMoodState?.moodId, findOrbitMatchForMood, handleOrbitGenerateMatch]);

                  const handleOrbitChatSend = useCallback((text) => {
                      const trimmed = (text || '').trim();
                      if (!trimmed) return;
                      setOrbitChatSession(prev => {
                          if (!prev || prev.status !== 'active') return prev;
                          const now = new Date();
                          const message = {
                              id: `you-${now.getTime()}`,
                              sender: 'you',
                              text: trimmed,
                              timestamp: now.toISOString()
                          };
                          return { ...prev, messages: [...prev.messages, message] };
                      });
                      setTimeout(() => {
                          setOrbitChatSession(prev => {
                              if (!prev || prev.status !== 'active') return prev;
                              const replies = prev.match?.replyLibrary?.length ? prev.match.replyLibrary : DEFAULT_ORBIT_REPLIES;
                              const replyText = replies[Math.floor(Math.random() * replies.length)];
                              const now = new Date();
                              const replyMessage = {
                                  id: `them-${now.getTime()}`,
                                  sender: 'them',
                                  text: replyText,
                                  timestamp: now.toISOString()
                              };
                              return { ...prev, messages: [...prev.messages, replyMessage] };
                          });
                      }, 1400);
                  }, []);

                  const handleOrbitChatEnd = useCallback(() => {
                      setOrbitChatSession(prev => {
                          if (!prev || prev.status === 'ended') return prev;
                          const now = new Date();
                          const closingMessage = {
                              id: `sys-${now.getTime()}`,
                              sender: 'system',
                              text: 'Birbirinize iyi geldiniz ðŸ’›',
                              timestamp: now.toISOString()
                          };
                          return { ...prev, status: 'ended', endedAt: now.toISOString(), messages: [...prev.messages, closingMessage] };
                      });
                  }, []);

                  const handleOrbitChatReport = useCallback(() => {
                      ToastManager?.show?.('Sohbet moderasyon ekibine iletildi. Gerekli inceleme yapÄ±lacak.', 'warning');
                  }, []);

                  const handleOrbitChatCloseView = useCallback(() => {
                      orbitChatSessionRef.current = null;
                      setOrbitChatSession(null);
                      if (orbitMoodState?.moodId) handleOrbitGenerateMatch(orbitMoodState.moodId);
                  }, [orbitMoodState?.moodId, handleOrbitGenerateMatch]);

                  useEffect(() => {
                      if (!orbitChatSession || orbitChatSession.status !== 'active') return;
                      const checkExpiry = () => {
                          if (new Date(orbitChatSession.endsAt).getTime() <= Date.now()) {
                              handleOrbitChatEnd();
                          }
                      };
                      const timer = setInterval(checkExpiry, 60000);
                      checkExpiry();
                      return () => clearInterval(timer);
                  }, [orbitChatSession, handleOrbitChatEnd]);

                  // Enhanced mood tracking functions
                  const addMoodToHistory = useCallback((moodData) => {
                      const now = new Date();
                      const moodEntry = {
                          id: `mood-${now.getTime()}`,
                          moodId: moodData.moodId,
                          moodLabel: moodData.moodLabel,
                          moodEmoji: moodData.moodEmoji,
                          note: moodData.note,
                          activities: moodData.activities || [],
                          intensity: moodData.intensity || 3,
                          timestamp: now.toISOString(),
                          date: now.toDateString(),
                          week: getWeekKey(now),
                          month: getMonthKey(now)
                      };
                      
                      setMoodHistory(prev => {
                          const updated = [...prev, moodEntry];
                          // Keep only last 365 days
                          const cutoff = new Date();
                          cutoff.setDate(cutoff.getDate() - 365);
                          return updated.filter(entry => new Date(entry.timestamp) > cutoff);
                      });
                  }, []);

                  const updateMoodAnalytics = useCallback((moodData) => {
                      const now = new Date();
                      const weekKey = getWeekKey(now);
                      const monthKey = getMonthKey(now);
                      
                      setMoodAnalytics(prev => {
                          const updated = { ...prev };
                          
                          // Update weekly trend
                          const weekIndex = updated.weeklyTrend.findIndex(w => w.week === weekKey);
                          if (weekIndex >= 0) {
                              updated.weeklyTrend[weekIndex].moods.push(moodData.moodId);
                              updated.weeklyTrend[weekIndex].averageIntensity = 
                                  updated.weeklyTrend[weekIndex].moods.reduce((sum, moodId) => {
                                      const mood = ORBIT_MOOD_OPTIONS.find(m => m.id === moodId);
                                      return sum + (mood?.intensity || 3);
                                  }, 0) / updated.weeklyTrend[weekIndex].moods.length;
                          } else {
                              updated.weeklyTrend.push({
                                  week: weekKey,
                                  moods: [moodData.moodId],
                                  averageIntensity: moodData.intensity || 3
                              });
                          }
                          
                          // Update monthly trend
                          const monthIndex = updated.monthlyTrend.findIndex(m => m.month === monthKey);
                          if (monthIndex >= 0) {
                              updated.monthlyTrend[monthIndex].moods.push(moodData.moodId);
                          } else {
                              updated.monthlyTrend.push({
                                  month: monthKey,
                                  moods: [moodData.moodId]
                              });
                          }
                          
                          // Update activity correlations
                          if (moodData.activities && moodData.activities.length > 0) {
                              moodData.activities.forEach(activityId => {
                                  if (!updated.activityCorrelations[activityId]) {
                                      updated.activityCorrelations[activityId] = [];
                                  }
                                  updated.activityCorrelations[activityId].push(moodData.moodId);
                              });
                          }
                          
                          return updated;
                      });
                  }, []);

                  const checkMoodGoals = useCallback((moodData) => {
                      const now = new Date();
                      const todayKey = getDayKey(now);
                      const weekKey = getWeekKey(now);
                      
                      setMoodGoals(prev => {
                          return prev.map(goal => {
                              let progress = goal.progress || 0;
                              let completed = goal.completed || false;
                              
                              switch (goal.id) {
                                  case 'consistency':
                                      // Check streak
                                      const streak = orbitMoodState?.streak || 0;
                                      progress = Math.min(streak, goal.target);
                                      completed = streak >= goal.target;
                                      break;
                                  case 'positivity':
                                      // Check positive moods this week
                                      const positiveMoods = moodHistory.filter(entry => 
                                          entry.week === weekKey && 
                                          ['happy', 'excited', 'grateful', 'motivated'].includes(entry.moodId)
                                      ).length;
                                      progress = Math.min(positiveMoods, goal.target);
                                      completed = positiveMoods >= goal.target;
                                      break;
                                  case 'selfcare':
                                      // Check activities today
                                      const todayActivities = moodData.activities?.length || 0;
                                      progress = Math.min(todayActivities, goal.target);
                                      completed = todayActivities >= goal.target;
                                      break;
                                  case 'reflection':
                                      // Check if note was added
                                      progress = moodData.note ? 1 : 0;
                                      completed = !!moodData.note;
                                      break;
                              }
                              
                              return { ...goal, progress, completed };
                          });
                      });
                  }, [orbitMoodState?.streak, moodHistory]);

                  const handleOrbitCheckIn = useCallback(({ moodId, moodLabel, moodEmoji, note, activities = [], intensity }) => {
                      const now = new Date();
                      const todayKey = getDayKey(now);
                      const trimmedNote = note?.trim() || '';
                      let awardCoins = false;

                      // Enhanced mood data
                      const moodData = {
                          moodId,
                          moodLabel,
                          moodEmoji,
                          note: trimmedNote,
                          activities,
                          intensity: intensity || ORBIT_MOOD_OPTIONS.find(m => m.id === moodId)?.intensity || 3
                      };

                      // Add to history
                      addMoodToHistory(moodData);
                      
                      // Update analytics
                      updateMoodAnalytics(moodData);
                      
                      // Check goals
                      checkMoodGoals(moodData);
                      
                      // Check achievements
                      checkAchievements(moodData);

                      setOrbitMoodState(prev => {
                          const prevKey = getDayKey(prev?.lastCheckIn);
                          let streak = 1;
                          if (prevKey) {
                              const dayGap = diffDays(todayKey, prevKey);
                              if (dayGap === 0) {
                                  streak = prev?.streak || 1;
                              } else if (dayGap === 1) {
                                  streak = (prev?.streak || 0) + 1;
                              } else {
                                  streak = 1;
                              }
                          }

                          awardCoins = prev?.lastCoinDate !== todayKey;
                          
                          // Check for 7-day streak reward
                          if (streak === 7 && prev?.streak !== 7) {
                              setTimeout(() => {
                                  if (earnCoinsForStreak) {
                                      earnCoinsForStreak();
                                  }
                              }, 100);
                          }

                          return {
                              moodId,
                              moodLabel,
                              moodEmoji,
                              note: trimmedNote,
                              activities,
                              intensity: moodData.intensity,
                              lastCheckIn: now.toISOString(),
                              streak,
                              lastCoinDate: awardCoins ? todayKey : prev?.lastCoinDate || todayKey
                          };
                      });

                      if (awardCoins) {
                          handleCoinEarned(5, 'Daily mood check-in');
                          ToastManager?.show?.('Mood kaydÄ± tamamlandÄ±! +5 coin kazandÄ±n ðŸ’›', 'success');
                      } else {
                          ToastManager?.show?.('Mood kaydÄ±n gÃ¼ncellendi.', 'info');
                      }

                      handleOrbitGenerateMatch(moodId);
                  }, [handleOrbitGenerateMatch, addMoodToHistory, updateMoodAnalytics, checkMoodGoals, checkAchievements, handleCoinEarned, earnCoinsForStreak]);

                  // Social features functions
                  const sendSupportMessage = useCallback((friendId, messageType) => {
                      console.log('sendSupportMessage Ã§aÄŸrÄ±ldÄ±:', friendId, messageType);
                      const message = SUPPORT_MESSAGES.find(m => m.type === messageType) || SUPPORT_MESSAGES[0];
                      console.log('Bulunan mesaj:', message);
                      const supportMessage = {
                          id: `support-${Date.now()}`,
                          friendId,
                          message: message.text,
                          emoji: message.emoji,
                          timestamp: new Date().toISOString()
                      };
                      
                      console.log('Destek mesajÄ± oluÅŸturuldu:', supportMessage);
                      setSupportMessages(prev => {
                          const newMessages = [...prev, supportMessage];
                          console.log('Yeni mesaj listesi:', newMessages);
                          return newMessages;
                      });
                      setMoodPoints(prev => {
                          const newPoints = prev + 5;
                          console.log('Yeni puan:', newPoints);
                          return newPoints;
                      });
                      
                      ToastManager?.show?.('Destek mesajÄ± gÃ¶nderildi! +5 puan kazandÄ±n ðŸ’•', 'success');
                  }, []);

                  const joinMoodGroup = useCallback((groupId) => {
                      setMoodGroups(prev => prev.map(group => 
                          group.id === groupId 
                              ? { ...group, memberCount: group.memberCount + 1, isJoined: true }
                              : group
                      ));
                      setMoodPoints(prev => prev + 10);
                      ToastManager?.show?.('Gruba katÄ±ldÄ±n! +10 puan kazandÄ±n ðŸŽ‰', 'success');
                  }, []);

                  const checkAchievements = useCallback((moodData) => {
                      const newAchievements = [];
                      
                      // Check for new achievements
                      if (moodHistory.length === 0 && moodData) {
                          newAchievements.push(ACHIEVEMENTS.find(a => a.id === 'first_mood'));
                      }
                      
                      if (orbitMoodState?.streak >= 7) {
                          newAchievements.push(ACHIEVEMENTS.find(a => a.id === 'week_streak'));
                      }
                      
                      if (moodHistory.length >= 100) {
                          newAchievements.push(ACHIEVEMENTS.find(a => a.id === 'mood_expert'));
                      }
                      
                      // Add new achievements
                      newAchievements.forEach(achievement => {
                          if (achievement && !userAchievements.find(a => a.id === achievement.id)) {
                              setUserAchievements(prev => [...prev, achievement]);
                              setMoodPoints(prev => prev + achievement.points);
                              ToastManager?.show?.(`Yeni baÅŸarÄ±: ${achievement.title}! +${achievement.points} puan ðŸ†`, 'success');
                          }
                      });
                      
                      // Update user level
                      const newLevel = Math.floor(moodPoints / 100) + 1;
                      if (newLevel > userLevel) {
                          setUserLevel(newLevel);
                          ToastManager?.show?.(`Tebrikler! Seviye ${newLevel}'e yÃ¼kseldin! ðŸŽ‰`, 'success');
                      }
                  }, [moodHistory.length, orbitMoodState?.streak, userAchievements, moodPoints, userLevel]);

                  // Personalization functions
                  const addCustomMood = useCallback((moodData) => {
                      const newMood = {
                          id: `custom-${Date.now()}`,
                          emoji: moodData.emoji,
                          label: moodData.label,
                          tone: moodData.tone,
                          color: moodData.color || '#6B7280',
                          intensity: moodData.intensity || 3,
                          isCustom: true
                      };
                      setCustomMoods(prev => [...prev, newMood]);
                      ToastManager?.show?.('Ã–zel mood eklendi! ðŸŽ¨', 'success');
                  }, []);

                  const updateTheme = useCallback((themeId) => {
                      setSelectedTheme(themeId);
                      const theme = MOOD_THEMES.find(t => t.id === themeId);
                      if (theme) {
                          // Apply theme colors to CSS variables
                          document.documentElement.style.setProperty('--primary-color', theme.colors.primary);
                          document.documentElement.style.setProperty('--secondary-color', theme.colors.secondary);
                          document.documentElement.style.setProperty('--accent-color', theme.colors.accent);
                      }
                      ToastManager?.show?.('Tema deÄŸiÅŸtirildi! ðŸŽ¨', 'success');
                  }, []);

                  const updateNotificationSetting = useCallback((notificationId, enabled) => {
                      setNotificationSettings(prev => prev.map(notif => 
                          notif.id === notificationId ? { ...notif, enabled } : notif
                      ));
                  }, []);

                  const updatePrivacySetting = useCallback((setting, value) => {
                      setPrivacySettings(prev => ({ ...prev, [setting]: value }));
                  }, []);

                  const scheduleReminder = useCallback(() => {
                      if (notificationSettings.find(n => n.id === 'daily_reminder')?.enabled) {
                          // In a real app, this would schedule a local notification
                          console.log(`Reminder scheduled for ${reminderTime}`);
                      }
                  }, [reminderTime, notificationSettings]);

                  // Interaction features functions
                  const startGame = useCallback((gameId) => {
                      const game = MOOD_GAMES.find(g => g.id === gameId);
                      if (game) {
                          setActiveGame(game);
                          ToastManager?.show?.(`${game.name} baÅŸladÄ±! ðŸŽ®`, 'success');
                      }
                  }, []);

                  const playMusic = useCallback((musicId) => {
                      const music = MOOD_MUSIC.find(m => m.id === musicId);
                      if (music) {
                          setActiveMusic(music);
                          setMusicHistory(prev => [...prev, { ...music, timestamp: new Date().toISOString() }]);
                          ToastManager?.show?.(`${music.name} Ã§alÄ±yor ðŸŽµ`, 'success');
                      }
                  }, []);

                  const startMeditation = useCallback((meditationId) => {
                      const meditation = MEDITATION_SESSIONS.find(m => m.id === meditationId);
                      if (meditation) {
                          setActiveMeditation(meditation);
                          setMeditationHistory(prev => [...prev, { ...meditation, timestamp: new Date().toISOString() }]);
                          ToastManager?.show?.(`${meditation.name} baÅŸladÄ± ðŸ§˜â€â™€ï¸`, 'success');
                      }
                  }, []);

                  const startExercise = useCallback((exerciseId) => {
                      const exercise = EXERCISE_ROUTINES.find(e => e.id === exerciseId);
                      if (exercise) {
                          setActiveExercise(exercise);
                          setExerciseHistory(prev => [...prev, { ...exercise, timestamp: new Date().toISOString() }]);
                          ToastManager?.show?.(`${exercise.name} baÅŸladÄ± ðŸ’ª`, 'success');
                      }
                  }, []);

                  const stopActivity = useCallback((activityType) => {
                      switch (activityType) {
                          case 'game':
                              setActiveGame(null);
                              break;
                          case 'music':
                              setActiveMusic(null);
                              break;
                          case 'meditation':
                              setActiveMeditation(null);
                              break;
                          case 'exercise':
                              setActiveExercise(null);
                              break;
                      }
                      ToastManager?.show?.('Aktivite durduruldu', 'info');
                  }, []);

                  // Analytics and statistics functions
                  const generateReport = useCallback((reportType) => {
                      const report = MOOD_REPORTS.find(r => r.id === reportType);
                      if (report) {
                          const newReport = {
                              id: `report-${Date.now()}`,
                              type: reportType,
                              name: report.name,
                              emoji: report.emoji,
                              description: report.description,
                              data: generateReportData(reportType),
                              timestamp: new Date().toISOString()
                          };
                          setMoodReports(prev => [...prev, newReport]);
                          setReportHistory(prev => [...prev, newReport]);
                          ToastManager?.show?.(`${report.name} raporu oluÅŸturuldu! ðŸ“Š`, 'success');
                      }
                  }, []);

                  const generateReportData = useCallback((reportType) => {
                      switch (reportType) {
                          case 'weekly_summary':
                              return {
                                  totalMoods: moodHistory.filter(entry => 
                                      new Date(entry.timestamp) >= new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
                                  ).length,
                                  averageMood: calculateAverageMood(7),
                                  mostCommonMood: getMostCommonMood(7),
                                  streak: orbitMoodState?.streak || 0
                              };
                          case 'monthly_trend':
                              return {
                                  monthlyTrend: moodAnalytics.monthlyTrend,
                                  averageIntensity: calculateAverageIntensity(30),
                                  moodDistribution: getMoodDistribution(30)
                              };
                          case 'activity_impact':
                              return {
                                  activityCorrelations: moodAnalytics.activityCorrelations,
                                  topActivities: getTopActivities(),
                                  impactScore: calculateImpactScore()
                              };
                          case 'goal_progress':
                              return {
                                  goals: moodGoals,
                                  completionRate: calculateGoalCompletionRate(),
                                  nextGoals: getNextGoals()
                              };
                          default:
                              return {};
                      }
                  }, [moodHistory, moodAnalytics, moodGoals, orbitMoodState]);

                  const calculateAverageMood = useCallback((days) => {
                      const recentMoods = moodHistory.filter(entry => 
                          new Date(entry.timestamp) >= new Date(Date.now() - days * 24 * 60 * 60 * 1000)
                      );
                      if (recentMoods.length === 0) return 0;
                      return recentMoods.reduce((sum, entry) => sum + (entry.intensity || 3), 0) / recentMoods.length;
                  }, [moodHistory]);

                  const getMostCommonMood = useCallback((days) => {
                      const recentMoods = moodHistory.filter(entry => 
                          new Date(entry.timestamp) >= new Date(Date.now() - days * 24 * 60 * 60 * 1000)
                      );
                      const moodCounts = {};
                      recentMoods.forEach(entry => {
                          moodCounts[entry.moodId] = (moodCounts[entry.moodId] || 0) + 1;
                      });
                      return Object.keys(moodCounts).reduce((a, b) => moodCounts[a] > moodCounts[b] ? a : b, 'happy');
                  }, [moodHistory]);

                  const calculateAverageIntensity = useCallback((days) => {
                      const recentMoods = moodHistory.filter(entry => 
                          new Date(entry.timestamp) >= new Date(Date.now() - days * 24 * 60 * 60 * 1000)
                      );
                      if (recentMoods.length === 0) return 0;
                      return recentMoods.reduce((sum, entry) => sum + (entry.intensity || 3), 0) / recentMoods.length;
                  }, [moodHistory]);

                  const getMoodDistribution = useCallback((days) => {
                      const recentMoods = moodHistory.filter(entry => 
                          new Date(entry.timestamp) >= new Date(Date.now() - days * 24 * 60 * 60 * 1000)
                      );
                      const distribution = {};
                      recentMoods.forEach(entry => {
                          distribution[entry.moodId] = (distribution[entry.moodId] || 0) + 1;
                      });
                      return distribution;
                  }, [moodHistory]);

                  const getTopActivities = useCallback(() => {
                      const activityCounts = {};
                      moodHistory.forEach(entry => {
                          if (entry.activities) {
                              entry.activities.forEach(activityId => {
                                  activityCounts[activityId] = (activityCounts[activityId] || 0) + 1;
                              });
                          }
                      });
                      return Object.entries(activityCounts)
                          .sort(([,a], [,b]) => b - a)
                          .slice(0, 5)
                          .map(([activityId, count]) => ({
                              activityId,
                              count,
                              activity: MOOD_ACTIVITIES.find(a => a.id === activityId)
                          }));
                  }, [moodHistory]);

                  const calculateImpactScore = useCallback(() => {
                      const activityCorrelations = moodAnalytics.activityCorrelations;
                      let totalScore = 0;
                      let count = 0;
                      Object.values(activityCorrelations).forEach(moods => {
                          if (moods.length > 0) {
                              const avgMood = moods.reduce((sum, moodId) => {
                                  const mood = ORBIT_MOOD_OPTIONS.find(m => m.id === moodId);
                                  return sum + (mood?.intensity || 3);
                              }, 0) / moods.length;
                              totalScore += avgMood;
                              count++;
                          }
                      });
                      return count > 0 ? Math.round((totalScore / count) * 20) : 0;
                  }, [moodAnalytics]);

                  const calculateGoalCompletionRate = useCallback(() => {
                      if (moodGoals.length === 0) return 0;
                      const completedGoals = moodGoals.filter(goal => goal.completed).length;
                      return Math.round((completedGoals / moodGoals.length) * 100);
                  }, [moodGoals]);

                  const getNextGoals = useCallback(() => {
                      return moodGoals.filter(goal => !goal.completed).slice(0, 3);
                  }, [moodGoals]);

                  // Chat enhancements functions
                  const updateChatTheme = useCallback((themeId) => {
                      setChatTheme(themeId);
                      const theme = CHAT_THEMES.find(t => t.id === themeId);
                      if (theme) {
                          // Apply chat theme colors
                          document.documentElement.style.setProperty('--chat-bg', theme.colors.bg);
                          document.documentElement.style.setProperty('--chat-text', theme.colors.text);
                          document.documentElement.style.setProperty('--chat-bubble', theme.colors.bubble);
                      }
                      ToastManager?.show?.('Chat temasÄ± deÄŸiÅŸtirildi! ðŸ’¬', 'success');
                  }, []);

                  const addMessageReaction = useCallback((messageId, emojiId) => {
                      const emoji = CHAT_EMOJIS.find(e => e.id === emojiId);
                      if (emoji) {
                          setMessageReactions(prev => {
                              const reactions = prev[messageId] || [];
                              const existingReaction = reactions.find(r => r.emojiId === emojiId);
                              if (existingReaction) {
                                  existingReaction.count += 1;
                              } else {
                                  reactions.push({ emojiId, emoji: emoji.emoji, count: 1 });
                              }
                              return { ...prev, [messageId]: reactions };
                          });
                      }
                  }, []);

                  const sendVoiceMessage = useCallback((audioBlob, duration) => {
                      const voiceMessage = {
                          id: `voice-${Date.now()}`,
                          duration,
                          timestamp: new Date().toISOString(),
                          sender: 'you',
                          audioBlob
                      };
                      setVoiceMessages(prev => [...prev, voiceMessage]);
                      ToastManager?.show?.('Sesli mesaj gÃ¶nderildi! ðŸŽ¤', 'success');
                  }, []);

                  const sendImageMessage = useCallback((imageFile, caption) => {
                      const imageMessage = {
                          id: `img-${Date.now()}`,
                          url: URL.createObjectURL(imageFile),
                          caption: caption || '',
                          timestamp: new Date().toISOString(),
                          sender: 'you'
                      };
                      setImageMessages(prev => [...prev, imageMessage]);
                      ToastManager?.show?.('GÃ¶rsel mesaj gÃ¶nderildi! ðŸ“¸', 'success');
                  }, []);

                  const updateChatSetting = useCallback((setting, value) => {
                      setChatSettings(prev => ({ ...prev, [setting]: value }));
                  }, []);

                  const getMessageReactions = useCallback((messageId) => {
                      return messageReactions[messageId] || [];
                  }, [messageReactions]);

                  // Gamification functions
                  const checkBadgeEligibility = useCallback((badge, userStats) => {
                      const { requirement } = badge;
                      switch (requirement.type) {
                          case 'mood_count':
                              return userStats.moodCount >= requirement.value;
                          case 'streak':
                              return userStats.streak >= requirement.value;
                          case 'positive_week':
                              return userStats.positiveWeekCount >= requirement.value;
                          case 'support_messages':
                              return userStats.supportMessagesSent >= requirement.value;
                          case 'meditation_sessions':
                              return userStats.meditationSessions >= requirement.value;
                          case 'exercise_sessions':
                              return userStats.exerciseSessions >= requirement.value;
                          case 'early_morning':
                              return userStats.earlyMorningCheckins >= requirement.value;
                          case 'late_night':
                              return userStats.lateNightCheckins >= requirement.value;
                          default:
                              return false;
                      }
                  }, []);

                  const awardBadge = useCallback((badgeId) => {
                      const badge = GAMIFICATION_BADGES.find(b => b.id === badgeId);
                      if (!badge) return;

                      const existingBadge = gamificationBadges.find(b => b.id === badgeId);
                      if (existingBadge) return;

                      const newBadge = {
                          ...badge,
                          earnedAt: new Date().toISOString(),
                          points: badge.points
                      };

                      setGamificationBadges(prev => [...prev, newBadge]);
                      setGamificationPoints(prev => prev + badge.points);
                      
                      ToastManager?.show?.(`Yeni rozet kazandÄ±n: ${badge.name}! ðŸ†`, 'success');
                  }, [gamificationBadges]);

                  const updateLevel = useCallback((points) => {
                      const newLevel = GAMIFICATION_LEVELS.find(level => 
                          points >= level.minPoints && points <= level.maxPoints
                      );
                      
                      if (newLevel && newLevel.level > gamificationLevel) {
                          setGamificationLevel(newLevel.level);
                          ToastManager?.show?.(`Seviye atladÄ±n! ${newLevel.name} ðŸŽ‰`, 'success');
                      }
                  }, [gamificationLevel]);

                  const joinCompetition = useCallback((competitionId) => {
                      setGamificationCompetitions(prev => 
                          prev.map(comp => 
                              comp.id === competitionId 
                                  ? { ...comp, participants: comp.participants + 1 }
                                  : comp
                          )
                      );
                      ToastManager?.show?.('YarÄ±ÅŸmaya katÄ±ldÄ±n! ðŸ†', 'success');
                  }, []);

                  const updateDailyChallenge = useCallback((challengeId, progress) => {
                      setDailyChallenges(prev => 
                          prev.map(challenge => {
                              if (challenge.id === challengeId) {
                                  const newProgress = Math.min(progress, challenge.target);
                                  const completed = newProgress >= challenge.target;
                                  
                                  if (completed && !challenge.completed) {
                                      setGamificationPoints(prev => prev + challenge.points);
                                      ToastManager?.show?.(`GÃ¼nlÃ¼k gÃ¶rev tamamlandÄ±: ${challenge.name}! ðŸŽ¯`, 'success');
                                  }
                                  
                                  return { ...challenge, progress: newProgress, completed };
                              }
                              return challenge;
                          })
                      );
                  }, []);

                  const activateReward = useCallback((rewardId) => {
                      const reward = GAMIFICATION_REWARDS.find(r => r.id === rewardId);
                      if (!reward) return;

                      const activeReward = {
                          ...reward,
                          activatedAt: new Date().toISOString(),
                          expiresAt: new Date(Date.now() + reward.duration * 60 * 60 * 1000).toISOString()
                      };

                      setActiveRewards(prev => [...prev, activeReward]);
                      ToastManager?.show?.(`Ã–dÃ¼l aktif: ${reward.name}! ðŸŽ`, 'success');
                  }, []);

                  const updateLeaderboard = useCallback((userStats) => {
                      const leaderboardEntry = {
                          userId: 'current_user',
                          name: 'Sen',
                          points: gamificationPoints,
                          level: gamificationLevel,
                          badges: gamificationBadges.length,
                          streak: userStats.streak,
                          lastUpdated: new Date().toISOString()
                      };

                      setLeaderboard(prev => {
                          const existingIndex = prev.findIndex(entry => entry.userId === 'current_user');
                          if (existingIndex >= 0) {
                              const updated = [...prev];
                              updated[existingIndex] = leaderboardEntry;
                              return updated.sort((a, b) => b.points - a.points);
                          } else {
                              return [...prev, leaderboardEntry].sort((a, b) => b.points - a.points);
                          }
                      });
                  }, [gamificationPoints, gamificationLevel, gamificationBadges.length]);

                  const updateGamificationSetting = useCallback((setting, value) => {
                      setGamificationSettings(prev => ({ ...prev, [setting]: value }));
                  }, []);

                  // Integrations functions
                  const addCalendarEvent = useCallback((eventData) => {
                      const newEvent = {
                          id: `event_${Date.now()}`,
                          ...eventData,
                          createdAt: new Date().toISOString()
                      };
                      setCalendarEvents(prev => [...prev, newEvent]);
                      ToastManager?.show?.('Takvim etkinliÄŸi eklendi! ðŸ“…', 'success');
                  }, []);

                  const updateWeather = useCallback((weatherData) => {
                      setCurrentWeather(weatherData);
                      ToastManager?.show?.(`Hava durumu gÃ¼ncellendi: ${weatherData.name} ${weatherData.emoji}`, 'info');
                  }, []);

                  const updateActivityTracking = useCallback((activityId, value) => {
                      setActivityTracking(prev => 
                          prev.map(activity => 
                              activity.id === activityId 
                                  ? { ...activity, current: value }
                                  : activity
                          )
                      );
                  }, []);

                  const connectSocialMedia = useCallback((platformId) => {
                      setSocialMediaIntegrations(prev => 
                          prev.map(platform => 
                              platform.id === platformId 
                                  ? { ...platform, connected: true }
                                  : platform
                          )
                      );
                      ToastManager?.show?.('Sosyal medya baÄŸlantÄ±sÄ± kuruldu! ðŸ”—', 'success');
                  }, []);

                  const disconnectSocialMedia = useCallback((platformId) => {
                      setSocialMediaIntegrations(prev => 
                          prev.map(platform => 
                              platform.id === platformId 
                                  ? { ...platform, connected: false, moodSharing: false }
                                  : platform
                          )
                      );
                      ToastManager?.show?.('Sosyal medya baÄŸlantÄ±sÄ± kesildi! ðŸ”Œ', 'info');
                  }, []);

                  const toggleMoodSharing = useCallback((platformId) => {
                      setSocialMediaIntegrations(prev => 
                          prev.map(platform => 
                              platform.id === platformId 
                                  ? { ...platform, moodSharing: !platform.moodSharing }
                                  : platform
                          )
                      );
                  }, []);

                  const connectHealthApp = useCallback((appId) => {
                      setHealthIntegrations(prev => 
                          prev.map(app => 
                              app.id === appId 
                                  ? { ...app, connected: true }
                                  : app
                          )
                      );
                      ToastManager?.show?.('SaÄŸlÄ±k uygulamasÄ± baÄŸlandÄ±! ðŸ’ª', 'success');
                  }, []);

                  const disconnectHealthApp = useCallback((appId) => {
                      setHealthIntegrations(prev => 
                          prev.map(app => 
                              app.id === appId 
                                  ? { ...app, connected: false }
                                  : app
                          )
                      );
                      ToastManager?.show?.('SaÄŸlÄ±k uygulamasÄ± baÄŸlantÄ±sÄ± kesildi! ðŸ”Œ', 'info');
                  }, []);

                  const updateMoodCorrelation = useCallback((factor, correlation) => {
                      setMoodCorrelations(prev => 
                          prev.map(item => 
                              item.factor === factor 
                                  ? { ...item, correlation }
                                  : item
                          )
                      );
                  }, []);

                  const updateIntegrationSetting = useCallback((setting, value) => {
                      setIntegrationSettings(prev => ({ ...prev, [setting]: value }));
                  }, []);

                  const syncWithExternalData = useCallback(async () => {
                      // Simulate API calls for external data sync
                      try {
                          // Weather sync
                          const randomWeather = WEATHER_CONDITIONS[Math.floor(Math.random() * WEATHER_CONDITIONS.length)];
                          updateWeather(randomWeather);
                          
                          // Activity sync
                          activityTracking.forEach(activity => {
                              const randomValue = Math.floor(Math.random() * activity.target);
                              updateActivityTracking(activity.id, randomValue);
                          });
                          
                          ToastManager?.show?.('DÄ±ÅŸ veriler senkronize edildi! ðŸ”„', 'success');
                      } catch (error) {
                          ToastManager?.show?.('Senkronizasyon hatasÄ±! âŒ', 'error');
                      }
                  }, [activityTracking, updateWeather, updateActivityTracking]);

                  const handleCreatePost = useCallback(async (postData) => {
                      try {
                          if (window.OrbitApi?.posts?.createPost) {
                              const created = await window.OrbitApi.posts.createPost({
                                  groupId: postData.groupId || null,
                                  title: postData.title || null,
                                  content: (postData.content || postData || '').toString(),
                                  image_url: postData.image || null,
                                  is_sensitive: !!postData.sensitive
                              });
                              // Map server post to UI shape
                              const uiPost = {
                                  id: created.id,
                                  author: me.name,
                                  authorInitial: (me.name && me.name[0] ? me.name[0].toUpperCase() : 'U'),
                                  avatarColor: me.avatarColor || 'bg-primary',
                                  avatarUrl: me.avatarUrl || null,
                                  username: me.username,
                                  ownerUsername: me.username,
                                  createdAt: Date.parse(created.created_at),
                                  time: created.created_at,
                                  content: created.content,
                                  image: created.image_url,
                                  likes: created.likes_count || 0,
                                  comments: created.comments_count || 0,
                                  groupId: created.group_id || null
                              };
                              setPosts(prev => [uiPost, ...prev]);
                              // Note: Post creation coins are handled separately for questions vs regular posts
                              // For questions, use earnCoinsForQuestion() when AI responds
                              return;
                          }
                      } catch (e) {
                          console.error('createPost failed', e);
                      }
                      // Fallback local (if services not ready)
                      const nowTs = Date.now();
                      const newPost = {
                          id: Date.now(),
                          author: me.name,
                          authorInitial: (me.name && me.name[0] ? me.name[0].toUpperCase() : 'U'),
                          avatarColor: me.avatarColor || 'bg-primary',
                          avatarUrl: me.avatarUrl || null,
                          username: me.username,
                          ownerUsername: me.username,
                          createdAt: nowTs,
                          time: new Date(nowTs).toISOString(),
                          content: postData.content || postData,
                          image: postData.image || null,
                          likes: 0,
                          comments: 0
                      };
                      setPosts(prev => {
                          const updated = [newPost, ...prev];
                          StorageManager.save('posts', updated);
                          return updated;
                      });
                      // Note: Post creation coins are handled separately for questions vs regular posts
                      // For questions, use earnCoinsForQuestion() when AI responds
                  }, [handleCoinEarned, me.name, me.username, me.avatarColor, me.avatarUrl]);

                  const handleToggleSaveTip = useCallback((tip) => {
                      if (!tip?.id) return;
                      setSavedContent(prev => {
                          const exists = prev.some(item => item.type === 'tip' && item.id === tip.id);
                          const updated = exists
                              ? prev.filter(item => !(item.type === 'tip' && item.id === tip.id))
                              : [
                                  {
                                      id: tip.id,
                                      type: 'tip',
                                      category: tip.category,
                                      focus: tip.focus,
                                      headline: tip.headline,
                                      insight: tip.longInsight || tip.insight,
                                      image: tip.image || null,
                                      actions: tip.actions,
                                      expert: tip.expert,
                                      group: tip.group || null,
                                      savedAt: Date.now()
                                  },
                                  ...prev
                              ];
                          StorageManager.save('savedContent', updated);
                          try {
                              const toast = exists ? 'Tip kayÄ±ttan Ã§Ä±karÄ±ldÄ±' : 'Tip kaydedildi';
                              const tone = exists ? 'info' : 'success';
                              ToastManager?.show?.(toast, tone);
                          } catch (err) {
                              console.warn('Toast failed', err);
                          }
                          return updated;
                      });
                  }, []);

                  const handleJoinGroup = useCallback(async (groupId, isLeaving = false) => {
                      try {
                          if (window.OrbitApi?.groups) {
                              if (isLeaving) await window.OrbitApi.groups.leaveGroup(groupId);
                              else await window.OrbitApi.groups.joinGroup(groupId);
                          }
                      } catch (e) { console.error('join/leave group failed', e); }
                      // optimistic UI update
                      setJoinedGroups(prev => {
                          const updated = isLeaving
                              ? prev.filter(id => id !== groupId)
                              : [...new Set([...prev, groupId])];
                          StorageManager.save('joinedGroups', updated);
                          return updated;
                      });
                  }, []);

                  const handleCreateGroup = useCallback(async (newGroup) => {
                      try {
                          if (window.OrbitApi?.groups?.createGroup) {
                              const created = await window.OrbitApi.groups.createGroup({
                                  name: newGroup.name,
                                  slug: newGroup.slug,
                                  about: newGroup.about,
                                  category: newGroup.category,
                                  cover_gradient: newGroup.coverGradient,
                                  icon_url: newGroup.iconUrl,
                                  is_private: newGroup.isPrivate || newGroup.privacy === 'private'
                              });
                              const ui = {
                                  id: created.id,
                                  name: created.name,
                                  slug: created.slug,
                                  about: created.about,
                                  category: created.category,
                                  color: newGroup.color || 'bg-primary',
                                  image: newGroup.image || 'ðŸ‘¥',
                                  isPrivate: created.is_private,
                                  ownerUsername: me.username,
                                  recentActivity: 'Just now',
                                  iconUrl: created.icon_url || null,
                                  coverGradient: created.cover_gradient || newGroup.coverGradient
                              };
                              setAllGroups(prev => { const upd = [...prev, ui]; StorageManager.save('allGroups', upd); return upd; });
                              // Auto-join handled server-side; reflect locally
                              setJoinedGroups(prev => { const upd = [...new Set([...prev, ui.id])]; StorageManager.save('joinedGroups', upd); return upd; });
                              setIsCreateGroupModalOpen(false);
                              return;
                          }
                      } catch (e) { console.error('createGroup failed', e); }
                      // Fallback: local only
                      if (!newGroup.ownerUsername) newGroup.ownerUsername = me.username;
                      setAllGroups(prev => { const updated = [...prev, newGroup]; StorageManager.save('allGroups', updated); return updated; });
                      setJoinedGroups(prev => { const updated = [...prev, newGroup.id]; StorageManager.save('joinedGroups', updated); return updated; });
                      setIsCreateGroupModalOpen(false);
                  }, [me.username]);

                  const handleSave = useCallback((postId) => {
                      const post = posts.find(p => p.id === postId);
                      if (post) {
                          const savedItem = {
                              id: post.id,
                              author: post.author,
                              authorColor: post.avatarColor,
                              title: post.title || undefined,
                              details: post.details || undefined,
                              content: post.content,
                              time: post.time,
                              createdAt: post.createdAt || (typeof post.id === 'number' ? post.id : Date.now()),
                              image: post.image,
                              type: 'post'
                          };
                          setSavedContent(prev => {
                              const exists = prev.find(item => item.id === postId);
                              const updated = exists
                                  ? prev.filter(item => item.id !== postId)
                                  : [savedItem, ...prev];
                              StorageManager.save('savedContent', updated);
                              return updated;
                          });
                      }
                  }, [posts]);

                  // Additional handlers for UI interactions
                  const handlePurchase = useCallback((amount) => {
                      setCoinCount(prev => {
                          const newAmount = prev - amount;
                          StorageManager.save('coinCount', newAmount);
                          return newAmount;
                      });
                  }, []);

                  const handleComment = useCallback((postId) => {
                      let post = posts.find(p => p.id === postId);
                      if (!post) {
                          const gp = StorageManager.load('groupPosts', {});
                          for (const gid of Object.keys(gp)) {
                              const found = (gp[gid] || []).find(p => p.id === postId);
                              if (found) { post = found; break; }
                          }
                      }
                      if (post) {
                          setSelectedPost(post);
                          setIsCommentModalOpen(true);
                      }
                  }, [posts]);

                  const handleAddComment = useCallback(async (postId, commentText, parentId = null) => {
                      const text = (commentText || '').trim();
                      if (!text) return;
                      const nowTs = Date.now();
                      // optimistic local
                      const optimistic = {
                          id: nowTs + Math.random(),
                          postId,
                          parentId,
                          text,
                          author: me.name,
                          authorInitial: (me.name && me.name[0]) ? me.name[0].toUpperCase() : 'U',
                          avatarColor: me.avatarColor || 'bg-primary',
                          avatarUrl: me.avatarUrl || null,
                          createdAt: nowTs,
                          time: new Date(nowTs).toISOString(),
                          likes: 0,
                          isLiked: false,
                          replies: []
                      };

                      try {
                          if (window.OrbitApi?.comments?.addComment) {
                              const created = await window.OrbitApi.comments.addComment({ postId, text, parentId });
                              // Replace optimistic with server id if we are in a comment list component
                              optimistic.id = created.id;
                              optimistic.time = created.created_at;
                              optimistic.createdAt = Date.parse(created.created_at);
                          }
                      } catch (e) {
                          console.error('addComment failed (keeping optimistic locally)', e);
                      }

                      const currentComments = StorageManager.load('comments', {}) || {};
                      const existing = Array.isArray(currentComments[postId]) ? currentComments[postId] : [];
                      const pinned = existing.filter(c => c?.isPinned);
                      const regular = existing.filter(c => !c?.isPinned);
                      currentComments[postId] = [...pinned, optimistic, ...regular];
                      StorageManager.save('comments', currentComments);

                      window.dispatchEvent(new CustomEvent('commentsUpdated', {
                          detail: { postId, commentId: optimistic.id }
                      }));

                      let updatedInHome = false;
                      setPosts(prev => {
                          const updated = prev.map(post =>
                              post.id === postId
                                  ? (updatedInHome = true, { ...post, comments: (post.comments || 0) + 1 })
                                  : post
                          );
                          if (updatedInHome) StorageManager.save('posts', updated);
                          return updated;
                      });
                      if (!updatedInHome) {
                          setGroupPosts(prev => {
                              const copy = { ...(prev || {}) };
                              let changed = false;
                              for (const gid of Object.keys(copy)) {
                                  const arr = copy[gid] || [];
                                  const newArr = arr.map(p => p.id === postId ? { ...p, comments: (p.comments || 0) + 1 } : p);
                                  if (JSON.stringify(newArr) !== JSON.stringify(arr)) { copy[gid] = newArr; changed = true; }
                              }
                              if (changed) StorageManager.save('groupPosts', copy);
                              return copy;
                          });
                      }

                      // Award coins for meaningful answer (community answer)
                      if (earnCoinsForAnswer) {
                          earnCoinsForAnswer();
                      }
                  }, [posts, me.name, me.avatarColor, me.avatarUrl, earnCoinsForAnswer]);

                  const handleLikeComment = useCallback((postId, commentId) => {
                      console.log('â¤ï¸ LIKING COMMENT:', { postId, commentId });

                      const currentComments = StorageManager.load('comments', {});
                      console.log('ðŸ“‚ CURRENT COMMENTS BEFORE LIKE:', currentComments);

                      if (currentComments[postId]) {
                          // Find the comment first to check current state
                          const comment = currentComments[postId].find(c => c.id === commentId);
                          console.log('ðŸ” FOUND COMMENT:', comment);

                          if (comment) {
                              const wasLiked = comment.isLiked;
                              console.log('ðŸ’– WAS LIKED BEFORE:', wasLiked);

                              // Update the comment
                              currentComments[postId] = currentComments[postId].map(c => {
                                  if (c.id === commentId) {
                                      const updated = {
                                          ...c,
                                          isLiked: !wasLiked,
                                          likes: wasLiked ? c.likes - 1 : c.likes + 1
                                      };
                                      console.log('ðŸ”„ UPDATED COMMENT:', updated);
                                      return updated;
                                  }
                                  return c;
                              });

                              console.log('ðŸ’¾ SAVING UPDATED COMMENTS:', currentComments);
                              StorageManager.save('comments', currentComments);

                              // Small coin reward for liking comments
                              if (!wasLiked) {
                                  handleCoinEarned(1);
                                  console.log('ðŸª™ EARNED 1 COIN FOR LIKING');
                              } else {
                                  handleCoinEarned(-1);
                                  console.log('ðŸª™ LOST 1 COIN FOR UNLIKING');
                              }

                              console.log('âœ… LIKE COMMENT COMPLETED SUCCESSFULLY');
                          } else {
                              console.log('âŒ COMMENT NOT FOUND');
                          }
                      } else {
                          console.log('âŒ NO COMMENTS FOR THIS POST');
                      }
                  }, [handleCoinEarned]);

                  const handleUpdateCommentCount = useCallback((postId, newCount) => {
                      setPosts(prev => {
                          const updated = prev.map(post =>
                              post.id === postId
                                  ? { ...post, comments: newCount }
                                  : post
                          );
                          StorageManager.save('posts', updated);
                          return updated;
                      });
                  }, []);

                  const handleShare = useCallback((postId) => {
                      let post = posts.find(p => p.id === postId);
                      if (!post) {
                          const gp = StorageManager.load('groupPosts', {});
                          for (const gid of Object.keys(gp)) {
                              const found = (gp[gid] || []).find(p => p.id === postId);
                              if (found) { post = found; break; }
                          }
                      }
                      if (post) {
                          setPostToShare(post);
                          setIsShareModalOpen(true);
                      }
                  }, [posts]);

                  // Delete flow with confirm modal
                  const [isDeleteOpen, setIsDeleteOpen] = useState(false);
                  const [postToDelete, setPostToDelete] = useState(null);
                  const requestDeletePost = useCallback((postId) => {
                      const p = posts.find(pp => pp.id === postId);
                      setPostToDelete(p || { id: postId });
                      setIsDeleteOpen(true);
                  }, [posts]);

                  // Delete Group (owner only)
                  const [isDeleteGroupOpen, setIsDeleteGroupOpen] = useState(false);
                  const [groupToDelete, setGroupToDelete] = useState(null);
                  const handleDeleteGroupConfirm = useCallback((groupId) => {
                      const grp = (allGroups || []).find(g => g.id === groupId);
                      setGroupToDelete(grp || { id: groupId });
                      setIsDeleteGroupOpen(true);
                  }, [allGroups]);
                  const handleDeleteGroup = useCallback((groupId) => {
                      setAllGroups(prev => { const upd = prev.filter(g => g.id !== groupId); StorageManager.save('allGroups', upd); return upd; });
                      setJoinedGroups(prev => { const upd = prev.filter(id => id !== groupId); StorageManager.save('joinedGroups', upd); return upd; });
                      setGroupPosts(prev => { const cp = { ...(prev||{}) }; if (cp[groupId]) delete cp[groupId]; StorageManager.save('groupPosts', cp); return cp; });
                      const invites = StorageManager.load('groupInvites', {}); if (invites[groupId]) { delete invites[groupId]; StorageManager.save('groupInvites', invites); }
                      const events = StorageManager.load('groupEvents', {}); if (events[groupId]) { delete events[groupId]; StorageManager.save('groupEvents', events); }
                      const members = StorageManager.load('groupMembers', {}); if (members[groupId]) { delete members[groupId]; StorageManager.save('groupMembers', members); }
                      if (currentGroupView && currentGroupView.id === groupId) setCurrentGroupView(null);
                      setIsDeleteGroupOpen(false); setGroupToDelete(null);
                  }, [currentGroupView]);

                  const handleDeletePost = useCallback((postId) => {
                      // Remove post
                      setPosts(prev => {
                          const updated = prev.filter(p => p.id !== postId);
                          StorageManager.save('posts', updated);
                          return updated;
                      });
                      // Remove from group posts if exists
                      setGroupPosts(prev => {
                          const copy = { ...(prev || {}) };
                          let changed = false;
                          for (const gid of Object.keys(copy)) {
                              const arr = copy[gid] || [];
                              const filtered = arr.filter(p => p.id !== postId);
                              if (filtered.length !== arr.length) { copy[gid] = filtered; changed = true; }
                          }
                          if (changed) StorageManager.save('groupPosts', copy);
                          return copy;
                      });
                      // Remove saved entry
                      setSavedContent(prev => {
                          const updated = prev.filter(it => it.id !== postId);
                          StorageManager.save('savedContent', updated);
                          return updated;
                      });
                      // Remove comments for this post
                      const allComments = StorageManager.load('comments', {});
                      if (allComments[postId]) {
                          delete allComments[postId];
                          StorageManager.save('comments', allComments);
                      }
                      // Remove like id from likedPosts
                      const likedPosts = StorageManager.load('likedPosts', []);
                      if (Array.isArray(likedPosts) && likedPosts.includes(postId)) {
                          const updated = likedPosts.filter(id => id !== postId);
                          StorageManager.save('likedPosts', updated);
                      }
                      setIsDeleteOpen(false);
                      setPostToDelete(null);
                  }, []);

                  const handleUpdatePost = useCallback((updatedPost) => {
                      if (updatedPost.groupId) {
                          setGroupPosts(prev => {
                              const copy = { ...(prev || {}) };
                              const arr = copy[updatedPost.groupId] || [];
                              copy[updatedPost.groupId] = arr.map(p => p.id === updatedPost.id ? updatedPost : p);
                              StorageManager.save('groupPosts', copy);
                              return copy;
                          });
                      } else {
                          setPosts(prev => {
                              const upd = prev.map(p => p.id === updatedPost.id ? updatedPost : p);
                              StorageManager.save('posts', upd);
                              return upd;
                          });
                      }
                  }, []);

                  const handleConfirmShare = useCallback((recipientIds) => {
                      if (!postToShare) return;
                      const now = Date.now();
                      // Persist per-recipient inbox
                      const inbox = StorageManager.load('sharedPostsByRecipient', {});
                      recipientIds.forEach(id => {
                          const arr = inbox[id] || [];
                          arr.unshift({ postId: postToShare.id, from: me.username, at: now });
                          inbox[id] = arr;
                      });
                      StorageManager.save('sharedPostsByRecipient', inbox);

                      // History per post
                      const history = StorageManager.load('shareHistory', {});
                      history[postToShare.id] = Array.from(new Set([...(history[postToShare.id] || []), ...recipientIds]));
                      StorageManager.save('shareHistory', history);

                      const names = users.filter(u => recipientIds.includes(u.id)).map(u => u.name);
                      setIsShareModalOpen(false);
                      setPostToShare(null);
                  }, [postToShare, me, users]);

                  const handleLike = useCallback(async (postId, isLikedNow) => {
                      // Try server first (optimistic)
                      try {
                          if (window.OrbitApi?.posts) {
                              if (isLikedNow) await window.OrbitApi.posts.likePost(postId);
                              else await window.OrbitApi.posts.unlikePost(postId);
                          }
                      } catch (e) {
                          console.error('like/unlike failed, rolling back UI', e);
                          // Flip the flag to undo optimistic effect
                          isLikedNow = !isLikedNow;
                      }
                      let foundInHome = false;
                      setPosts(prev => {
                          const updated = prev.map(p => {
                              if (p.id === postId) {
                                  foundInHome = true;
                                  return { ...p, likes: Math.max(0, (typeof p.likes === 'number' ? p.likes : 0) + (isLikedNow ? 1 : -1)) };
                              }
                              return p;
                          });
                          if (foundInHome) StorageManager.save('posts', updated);
                          return updated;
                      });
                      if (!foundInHome) {
                          setGroupPosts(prev => {
                              const copy = { ...(prev || {}) };
                              let changed = false;
                              for (const gid of Object.keys(copy)) {
                                  const arr = copy[gid] || [];
                                  const newArr = arr.map(p => p.id === postId ? { ...p, likes: Math.max(0, (p.likes || 0) + (isLikedNow ? 1 : -1)) } : p);
                                  if (JSON.stringify(newArr) !== JSON.stringify(arr)) { copy[gid] = newArr; changed = true; }
                              }
                              if (changed) StorageManager.save('groupPosts', copy);
                              return copy;
                          });
                      }
                  }, []);

                  const handleNavigateToGroup = useCallback((group) => {
                      // Always navigate to group detail if it's a joined group
                      if (joinedGroups.includes(group.id)) {
                          setCurrentGroupView(group);
                      } else {
                          // For non-joined groups, still show detail but with join prompt
                          setCurrentGroupView(group);
                      }
                  }, [joinedGroups]);

                  const handleOpenGroupForPost = useCallback((group) => {
                      setCurrentGroupView(group);
                      setGroupShouldOpenPost(true);
                      setGroupNewPostFor(group);
                  }, []);
                  const handleOpenGroupByRef = useCallback((groupId, groupName) => {
                      const grp = (allGroups || []).find(g => (groupId != null ? g.id === groupId : g.name === groupName));
                      if (grp) setCurrentGroupView(grp);
                  }, [allGroups]);

                  const handleUserClick = useCallback((userRef) => {
                      // If it's me (by name or @username), open my profile
                      if (userRef === me.name || userRef === me.username) {
                          const profileData = {
                              name: me.name,
                              username: me.username,
                              bio: StorageManager.load('userProfile', null)?.bio || '',
                              location: StorageManager.load('userProfile', null)?.location || '',
                              joinDate: StorageManager.load('userProfile', null)?.joinDate || '',
                              website: StorageManager.load('userProfile', null)?.website || '',
                              followers: StorageManager.load('userProfile', null)?.followers || 0,
                              following: StorageManager.load('userProfile', null)?.following || 0,
                              avatarUrl: me.avatarUrl || null
                          };
                          StorageManager.save('userProfile', profileData);
                          setCurrentView('profile');
                          return;
                      }
                      // If starts with @, search by username first
                      let user = null;
                      if (typeof userRef === 'string' && userRef.startsWith('@')) {
                          user = users.find(u => u.username === userRef);
                      }
                      if (!user) {
                          user = users.find(u => u.name === userRef);
                      }
                      if (user) {
                          StorageManager.save('userProfile', user);
                          setCurrentView('profile');
                      }
                  }, [users, me.name, me.username, me.avatarUrl]);

                  // Settings modal with data management
                  const SettingsModal = ({ isOpen, onClose, onOpenOrders }) => {
                      if (!isOpen) return null;
                      const [nameInput, setNameInput] = useState(me.name);
      const [usernameInput, setUsernameInput] = useState(me.username);

      const saveProfile = () => {
        const oldName = me.name;
        const oldUsername = me.username;
        const newName = (nameInput || '').trim() || oldName;
        const newUsernameRaw = (usernameInput || '').trim() || me.username;
        const newUsername = (() => {
          let u = newUsernameRaw;
          if (!u.startsWith('@')) u = '@' + u;
          const body = u.slice(1).toLowerCase().replace(/[^a-z0-9_.]/g, '');
          return '@' + (body || oldUsername.replace('@','').toLowerCase());
        })();

        // 1) Profil state
        setMe(prev => ({ ...prev, name: newName, username: newUsername }));

        // 2) Bu kullanÄ±cÄ±nÄ±n yazdÄ±ÄŸÄ± TÃœM postlarda ad & initial gÃ¼ncelle
        // Maintain name history for broader post updates
        const nameHistory = StorageManager.load('nameHistory', []);
        if (!nameHistory.includes(oldName)) nameHistory.push(oldName);
        StorageManager.save('nameHistory', nameHistory);

        setPosts(prev => {
          const updated = prev.map(p => {
            const isMine = (
              p.author === oldName ||
              p.author === me.name ||
              p.username === oldUsername ||
              (Array.isArray(nameHistory) && nameHistory.includes(p.author))
            );
            return isMine
              ? { ...p, author: newName, authorInitial: newName[0] ? newName[0].toUpperCase() : 'U', username: newUsername }
              : p;
          });
          StorageManager.save('posts', updated);
          return updated;
        });

        // 3) Kaydedilen iÃ§eriklerde (savedContent) yazar adÄ±nÄ± gÃ¼ncelle
        setSavedContent(prev => {
          const updated = prev.map(it => {
            const isMine = it.author === oldName || (Array.isArray(nameHistory) && nameHistory.includes(it.author));
            return isMine ? { ...it, author: newName } : it;
          });
          StorageManager.save('savedContent', updated);
          return updated;
        });

        // 4) Bu kullanÄ±cÄ±nÄ±n yazdÄ±ÄŸÄ± TÃœM yorumlarda (comments) yazar ve initial gÃ¼ncelle
        const allComments = StorageManager.load('comments', {});
        let anyChanged = false;
        Object.keys(allComments || {}).forEach(pid => {
          const list = allComments[pid] || [];
          let changedHere = false;
          const updatedList = list.map(c => {
            if (c.author === oldName) {
              changedHere = true; anyChanged = true;
              return {
                ...c,
                author: newName,
                authorInitial: newName[0] ? newName[0].toUpperCase() : 'U'
              };
            }
            return c;
          });
          if (changedHere) {
            allComments[pid] = updatedList;
          }
        });
        if (anyChanged) {
          StorageManager.save('comments', allComments);
          // UI gÃ¼ncellemesi iÃ§in ilgili postlara event yayÄ±nla
          Object.keys(allComments).forEach(pid => {
            window.dispatchEvent(new CustomEvent('commentsUpdated', { detail: { postId: Number(pid) } }));
          });
        }

        // 5) EÄŸer ekranda bir profil aÃ§Ä±k/sekiliyse ve o benim profilimse, onu da gÃ¼ncelle
      setCurrentUserProfile(prev => {
        if (!prev) return prev;
        if (prev.name === oldName) {
          return { ...prev, name: newName, username: newUsername };
        }
        return prev;
      });

      // Uygulama genelinde profil gÃ¼ncellendi sinyali
      // Sync public users and auth users stores
      try {
        const pub = StorageManager.load('users', []);
        if (Array.isArray(pub)) {
          const idx = pub.findIndex(u => (u.username === oldUsername) || (u.name === oldName));
          if (idx >= 0) { pub[idx] = { ...pub[idx], name: newName, username: newUsername }; StorageManager.save('users', pub); }
        }
        const auth = StorageManager.load('authUsers', []);
        if (Array.isArray(auth)) {
          const j = auth.findIndex(u => u.username === oldUsername);
          if (j >= 0) { auth[j] = { ...auth[j], name: newName, username: newUsername }; StorageManager.save('authUsers', auth); }
        }
      } catch {}

      window.dispatchEvent(new CustomEvent('profileUpdated', { detail: { name: newName, username: newUsername } }));
        onClose();
      };


                      const handleClearData = () => {
                          if (window.confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                              StorageManager.clearAll();
                              window.location.reload();
                          }
                      };

                      const handleDeleteCreatedGroups = () => {
                          if (!window.confirm('Delete all created groups (id > 6)? This will remove their posts, events and invites.')) return;

                          // Keep only default/sample groups (id <= 6)
                          setAllGroups(prev => {
                              const kept = (prev || []).filter(g => (g?.id ?? 0) <= 6);
                              StorageManager.save('allGroups', kept);
                              return kept;
                          });

                          // Remove joined flags for created groups
                          setJoinedGroups(prev => {
                              const kept = (prev || []).filter(id => Number(id) <= 6);
                              StorageManager.save('joinedGroups', kept);
                              return kept;
                          });

                          // Remove posts of created groups
                          setGroupPosts(prev => {
                              const copy = {};
                              Object.keys(prev || {}).forEach(k => {
                                  const id = Number(k);
                                  if (id <= 6) copy[id] = prev[id] || [];
                              });
                              StorageManager.save('groupPosts', copy);
                              return copy;
                          });

                          // Clean invites for created groups
                          const invites = StorageManager.load('groupInvites', {});
                          Object.keys(invites || {}).forEach(k => { if (Number(k) > 6) delete invites[k]; });
                          StorageManager.save('groupInvites', invites);

                          // Clean events for created groups
                          const events = StorageManager.load('groupEvents', {});
                          Object.keys(events || {}).forEach(k => { if (Number(k) > 6) delete events[k]; });
                          StorageManager.save('groupEvents', events);

                          // If currently viewing a created group, exit
                          if (currentGroupView && currentGroupView.id > 6) setCurrentGroupView(null);

                          onClose();
                      };

                      const handleExportData = () => {
                          const allData = {
                              posts: StorageManager.load('posts'),
                              groups: StorageManager.load('allGroups'),
                              savedContent: StorageManager.load('savedContent'),
                              coinCount: StorageManager.load('coinCount'),
                              joinedGroups: StorageManager.load('joinedGroups')
                          };

                          const dataStr = JSON.stringify(allData, null, 2);
                          const dataBlob = new Blob([dataStr], {type: 'application/json'});
                          const url = URL.createObjectURL(dataBlob);
                          const link = document.createElement('a');
                          link.href = url;
                          link.download = 'orbit-data-backup.json';
                          link.click();
                          URL.revokeObjectURL(url);

                      };

                      const handleDeleteCreatedPosts = () => {
                          if (!window.confirm('Delete all posts you created? This removes related saved items, comments and likes.')) return;

                          // Determine my posts in main feed
                          const allPosts = StorageManager.load('posts', posts);
                          const myMainPosts = (allPosts || []).filter(p => (p?.ownerUsername ?? p?.username) === me.username || p?.username === me.username);
                          const myMainIds = new Set(myMainPosts.map(p => p.id));

                          // Determine my posts in groups
                          const gpAll = StorageManager.load('groupPosts', groupPosts) || {};
                          const myGroupIds = new Set();
                          Object.values(gpAll).forEach(arr => {
                              (arr || []).forEach(p => { if ((p?.ownerUsername ?? p?.username) === me.username || p?.username === me.username) myGroupIds.add(p.id); });
                          });

                          // Union of all my post ids
                          const idsToDelete = new Set([...myMainIds, ...myGroupIds]);

                          // Update posts (main)
                          setPosts(prev => {
                              const updated = (prev || []).filter(p => !idsToDelete.has(p.id));
                              StorageManager.save('posts', updated);
                              return updated;
                          });

                          // Update group posts (remove my posts across all groups)
                          setGroupPosts(prev => {
                              const copy = { ...(prev || {}) };
                              let changed = false;
                              Object.keys(copy).forEach(k => {
                                  const arr = copy[k] || [];
                                  const filtered = arr.filter(p => !idsToDelete.has(p.id));
                                  if (filtered.length !== arr.length) { copy[k] = filtered; changed = true; }
                              });
                              if (changed) StorageManager.save('groupPosts', copy);
                              return copy;
                          });

                          // Remove saved entries referencing my posts
                          setSavedContent(prev => {
                              const updated = (prev || []).filter(it => !idsToDelete.has(it.id));
                              StorageManager.save('savedContent', updated);
                              return updated;
                          });

                          // Remove comments for these posts
                          const allComments = StorageManager.load('comments', {});
                          let commentsChanged = false;
                          idsToDelete.forEach(id => {
                              if (allComments[id]) { delete allComments[id]; commentsChanged = true; }
                          });
                          if (commentsChanged) StorageManager.save('comments', allComments);

                          // Remove like ids from likedPosts
                          const likedPosts = StorageManager.load('likedPosts', []);
                          if (Array.isArray(likedPosts) && likedPosts.length) {
                              const updatedLikes = likedPosts.filter(id => !idsToDelete.has(id));
                              StorageManager.save('likedPosts', updatedLikes);
                          }

                          onClose();
                      };

                      return (
                          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onMouseDown={(e) => { if (e.target === e.currentTarget) onClose(); }} role="dialog" aria-modal="true">
                              <div className="bg-white rounded-3xl w-full max-w-md mx-4 max-h-[80vh] overflow-hidden slide-up">
                                  <div className="flex items-center justify-between p-4 border-b border-gray-200">
                                      <h2 className="text-lg font-bold">Settings</h2>
                                      <button onClick={onClose} className="text-gray-500">âœ•</button>
                                  </div>

                                  <div className="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
                                      {/* Account Section */}
                                      <div className="space-y-4">
                                          <div className="flex items-center gap-2">
                                              <div className="w-1 h-5 bg-gradient-to-b from-primary to-secondary rounded-full"></div>
                                              <h3 className="font-bold text-gray-900 text-base">Account</h3>
                                          </div>
                                          <div className="space-y-3 pl-3">
          <label className="block">
                                                  <span className="text-sm font-medium text-gray-700 mb-1.5 block">Display Name</span>
            <input
              value={nameInput}
              onChange={(e) => setNameInput(e.target.value)}
                                                      className="w-full px-4 py-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary/50 transition-all"
              placeholder="Your name"
            />
          </label>
          <label className="block">
                                                  <span className="text-sm font-medium text-gray-700 mb-1.5 block">Username</span>
            <input
              value={usernameInput}
              onChange={(e) => setUsernameInput(e.target.value)}
                                                      className="w-full px-4 py-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary/50 transition-all"
              placeholder="@username"
            />
          </label>
                                              <button 
                                                  onClick={saveProfile} 
                                                  className="w-full px-4 py-2.5 rounded-xl bg-gradient-to-r from-primary to-secondary text-white font-semibold hover:opacity-90 transition-all shadow-sm hover:shadow-md"
                                              >
                                                  Save Changes
            </button>
          </div>
        </div>

                                      {/* Quick Actions */}
                                      <div className="space-y-4">
                                          <div className="flex items-center gap-2">
                                              <div className="w-1 h-5 bg-gradient-to-b from-primary to-secondary rounded-full"></div>
                                              <h3 className="font-bold text-gray-900 text-base">Quick Actions</h3>
                                          </div>
                                          <div className="grid grid-cols-2 gap-3 pl-3">
                                          <button
                                              onClick={() => onOpenOrders()}
                                                  className="flex flex-col items-center justify-center p-4 rounded-xl bg-gradient-to-br from-green-50 to-green-100 border border-green-200 hover:border-green-300 hover:shadow-sm transition-all"
                                              >
                                                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-green-600 mb-2">
                                                      <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                                      <path d="M1 10h22"/>
                                              </svg>
                                                  <span className="text-sm font-semibold text-green-700">My Orders</span>
                                          </button>

                                          <button
                                              onClick={handleExportData}
                                                  className="flex flex-col items-center justify-center p-4 rounded-xl bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 hover:border-blue-300 hover:shadow-sm transition-all"
                                              >
                                                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-blue-600 mb-2">
                                                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                                      <polyline points="7 10 12 15 17 10"/>
                                                      <line x1="12" y1="15" x2="12" y2="3"/>
                                              </svg>
                                                  <span className="text-sm font-semibold text-blue-700">Export Data</span>
                                          </button>
                                          </div>
                                      </div>

                                      {/* Data Management */}
                                      <div className="space-y-4">
                                          <div className="flex items-center gap-2">
                                              <div className="w-1 h-5 bg-gradient-to-b from-primary to-secondary rounded-full"></div>
                                              <h3 className="font-bold text-gray-900 text-base">Data Management</h3>
                                          </div>
                                          <div className="space-y-2 pl-3">
                                          <button
                                              onClick={handleDeleteCreatedGroups}
                                                  className="w-full flex items-center justify-between p-3 rounded-xl bg-gray-50 hover:bg-red-50 border border-gray-200 hover:border-red-200 transition-all group"
                                              >
                                                  <div className="flex items-center gap-3">
                                                      <div className="w-9 h-9 bg-red-100 rounded-lg flex items-center justify-center group-hover:bg-red-200 transition-colors">
                                                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-red-600">
                                                              <polyline points="3 6 5 6 21 6"/>
                                                              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                                          </svg>
                                                  </div>
                                                      <span className="font-medium text-gray-700 group-hover:text-red-700">Delete All Created Groups</span>
                                              </div>
                                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-400">
                                                  <path d="M9 18l6-6-6-6"/>
                                              </svg>
                                          </button>

                                          <button
                                              onClick={handleDeleteCreatedPosts}
                                                  className="w-full flex items-center justify-between p-3 rounded-xl bg-gray-50 hover:bg-amber-50 border border-gray-200 hover:border-amber-200 transition-all group"
                                              >
                                                  <div className="flex items-center gap-3">
                                                      <div className="w-9 h-9 bg-amber-100 rounded-lg flex items-center justify-center group-hover:bg-amber-200 transition-colors">
                                                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-amber-600">
                                                              <polyline points="3 6 5 6 21 6"/>
                                                              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                                          </svg>
                                                  </div>
                                                      <span className="font-medium text-gray-700 group-hover:text-amber-700">Delete All Created Posts</span>
                                              </div>
                                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-400">
                                                  <path d="M9 18l6-6-6-6"/>
                                              </svg>
                                          </button>

                                          <button
                                              onClick={handleClearData}
                                                  className="w-full flex items-center justify-between p-3 rounded-xl bg-gray-50 hover:bg-red-50 border-2 border-red-200 hover:border-red-300 transition-all group"
                                              >
                                                  <div className="flex items-center gap-3">
                                                      <div className="w-9 h-9 bg-red-100 rounded-lg flex items-center justify-center group-hover:bg-red-200 transition-colors">
                                                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" className="text-red-600">
                                                              <circle cx="12" cy="12" r="10"/>
                                                              <line x1="15" y1="9" x2="9" y2="15"/>
                                                              <line x1="9" y1="9" x2="15" y2="15"/>
                                                          </svg>
                                                  </div>
                                                      <span className="font-semibold text-red-600">Clear All Data</span>
                                              </div>
                                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-red-400">
                                                  <path d="M9 18l6-6-6-6"/>
                                              </svg>
                                          </button>
                                          </div>
                                      </div>

                                      {/* Storage Info */}
                                      <div className="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 border border-gray-200">
                                          <h4 className="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                                              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-primary">
                                                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                                  <circle cx="9" cy="9" r="2"/>
                                                  <path d="M21 15l-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                                              </svg>
                                              Storage Info
                                          </h4>
                                          <div className="grid grid-cols-2 gap-3">
                                              <div className="bg-white rounded-lg p-2.5 text-center border border-gray-200">
                                                  <div className="text-lg font-bold text-gray-900">{posts.length}</div>
                                                  <div className="text-xs text-gray-600 mt-0.5">Posts</div>
                                              </div>
                                              <div className="bg-white rounded-lg p-2.5 text-center border border-gray-200">
                                                  <div className="text-lg font-bold text-gray-900">{allGroups.length}</div>
                                                  <div className="text-xs text-gray-600 mt-0.5">Groups</div>
                                              </div>
                                              <div className="bg-white rounded-lg p-2.5 text-center border border-gray-200">
                                                  <div className="text-lg font-bold text-gray-900">{savedContent.length}</div>
                                                  <div className="text-xs text-gray-600 mt-0.5">Saved</div>
                                              </div>
                                              <div className="bg-white rounded-lg p-2.5 text-center border border-gray-200">
                                                  <div className="text-lg font-bold text-primary">{coinCount || 0}</div>
                                                  <div className="text-xs text-gray-600 mt-0.5">Coins</div>
                                              </div>
                                          </div>
                                      </div>

                                      {/* App Settings */}
                                      <div className="space-y-4">
                                          <div className="flex items-center gap-2">
                                              <div className="w-1 h-5 bg-gradient-to-b from-primary to-secondary rounded-full"></div>
                                              <h3 className="font-bold text-gray-900 text-base">App Settings</h3>
                                          </div>
                                          <div className="space-y-2 pl-3">
                                          <button
                                                  className="w-full flex items-center justify-between p-3 rounded-xl bg-gray-50 hover:bg-gray-100 border border-gray-200 transition-all"
                                              >
                                                  <div className="flex items-center gap-3">
                                                      <div className="w-9 h-9 bg-purple-100 rounded-lg flex items-center justify-center">
                                                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-purple-600">
                                                              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                                                              <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                                                      </svg>
                                                  </div>
                                                      <span className="font-medium text-gray-700">Notifications</span>
                                                  </div>
                                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-400">
                                                  <path d="M9 18l6-6-6-6"/>
                                              </svg>
                                          </button>

                                          <button
                                                  className="w-full flex items-center justify-between p-3 rounded-xl bg-gray-50 hover:bg-gray-100 border border-gray-200 transition-all"
                                              >
                                                  <div className="flex items-center gap-3">
                                                      <div className="w-9 h-9 bg-green-100 rounded-lg flex items-center justify-center">
                                                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-green-600">
                                                              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                                              <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                                                          </svg>
                                                  </div>
                                                      <span className="font-medium text-gray-700">Privacy</span>
                                              </div>
                                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-400">
                                                  <path d="M9 18l6-6-6-6"/>
                                              </svg>
                                          </button>

                                          <button
                                                  className="w-full flex items-center justify-between p-3 rounded-xl bg-gray-50 hover:bg-gray-100 border border-gray-200 transition-all"
                                              >
                                                  <div className="flex items-center gap-3">
                                                      <div className="w-9 h-9 bg-orange-100 rounded-lg flex items-center justify-center">
                                                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-orange-600">
                                                              <circle cx="12" cy="12" r="10"/>
                                                              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                                              <line x1="12" y1="17" x2="12.01" y2="17"/>
                                              </svg>
                                                  </div>
                                                      <span className="font-medium text-gray-700">Help & Support</span>
                                              </div>
                                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-400">
                                                  <path d="M9 18l6-6-6-6"/>
                                              </svg>
                                          </button>

                                              {isAuthenticated && (
                                          <button
                                              onClick={async () => {
                                                  if (!confirm('Log out of your account?')) return;
                                                  try { await window.OrbitApi?.auth?.logout?.(); } catch(e) { console.warn('logout warn', e); }
                                                  setIsAuthenticated(false);
                                                  StorageManager.save('isAuthenticated', false);
                                                  onClose();
                                              }}
                                                      className="w-full flex items-center justify-between p-3 rounded-xl bg-gray-50 hover:bg-red-50 border border-gray-200 hover:border-red-200 transition-all group"
                                                  >
                                                      <div className="flex items-center gap-3">
                                                          <div className="w-9 h-9 bg-red-100 rounded-lg flex items-center justify-center group-hover:bg-red-200 transition-colors">
                                                              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-red-600">
                                                                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                                                  <polyline points="16 17 21 12 16 7"/>
                                                                  <line x1="21" y1="12" x2="9" y2="12"/>
                                                              </svg>
                                                  </div>
                                                          <span className="font-medium text-gray-700 group-hover:text-red-700">Log out</span>
                                              </div>
                                                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-400">
                                                  <path d="M9 18l6-6-6-6"/>
                                              </svg>
                                          </button>
                                              )}
                                                  </div>
                                              </div>

                                      {/* About */}
                                      <div className="pt-4 border-t border-gray-200">
                                          <div className="text-center space-y-1">
                                              <div className="text-sm font-semibold text-gray-900">Orbit v6</div>
                                              <div className="text-xs text-gray-500">Connect, Share, Thrive</div>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      );
                  };

                  // ðŸ” Advanced Search Modal
                  const SearchModal = ({ isOpen, onClose }) => {
                      const [searchQuery, setSearchQuery] = useState('');
                      const [searchResults, setSearchResults] = useState([]);
                      // Load recent searches - only show defaults if never been initialized
                      const getInitialRecentSearches = () => {
                          const stored = StorageManager.load('recentSearches', null);
                          if (stored === null) {
                              // First time user - show some examples
                              const defaults = ['baby food', 'playground', 'first time mom', 'support'];
                              StorageManager.save('recentSearches', defaults);
                              return defaults;
                          }
                          return stored; // Could be empty array if user cleared
                      };

                      const [recentSearches, setRecentSearches] = useState(getInitialRecentSearches());
                      const [activeFilter, setActiveFilter] = useState('all');
                      const [isSearching, setIsSearching] = useState(false);

                      if (!isOpen) return null;

                      // Perform search
                      const handleSearch = async (query) => {
                          setSearchQuery(query);

                          if (!query.trim()) {
                              setSearchResults([]);
                              return;
                          }

                          setIsSearching(true);

                          // Simulate API delay
                          await new Promise(resolve => setTimeout(resolve, 300));

                          const lowercaseQuery = query.toLowerCase();
                          const results = [];

                          // Posts and polls intentionally excluded from search results

                          // Search in users
                          const sanitizedUsers = (users || []);
                          sanitizedUsers.forEach(user => {
                              if (user.name.toLowerCase().includes(lowercaseQuery) ||
                                  user.username.toLowerCase().includes(lowercaseQuery) ||
                                  (user.bio && user.bio.toLowerCase().includes(lowercaseQuery))) {
                                  results.push({
                                      type: 'user',
                                      id: user.id,
                                      title: user.name,
                                      subtitle: user.username,
                                      bio: user.bio,
                                      avatar: user.avatar,
                                      relevance: 0.8
                                  });
                              }
                          });

                          // Search in groups
                          allGroups.forEach(group => {
                              if (group.name.toLowerCase().includes(lowercaseQuery)) {
                                  const gm = StorageManager.load('groupMembers', {}) || {};
                                  const count = Array.isArray(gm[group.id]) ? gm[group.id].length : (Array.isArray(gm[String(group.id)]) ? gm[String(group.id)].length : 0);
                                  results.push({
                                      type: 'group',
                                      id: group.id,
                                      title: group.name,
                                      subtitle: count,
                                      image: group.image,
                                      color: group.color,
                                      relevance: 0.7
                                  });
                              }
                          });

                          // Search in shop (static catalog)
                          const shopCatalog = [
                              { id: 'shop-1', name: 'Organic Baby Food Pack', price: '$19.99', category: 'Baby Food', icon: 'ðŸ¼', url: 'https://example.com/shop/baby-food' },
                              { id: 'shop-2', name: 'Soft Swaddle Blanket', price: '$12.50', category: 'Sleep', icon: 'ðŸ›Œ', url: 'https://example.com/shop/swaddle' },
                              { id: 'shop-3', name: 'Eco Diapers (40 pcs)', price: '$24.00', category: 'Diaper', icon: 'ðŸ§·', url: 'https://example.com/shop/diapers' },
                              { id: 'shop-4', name: 'Stroller Cup Holder', price: '$8.90', category: 'Accessories', icon: 'ðŸ›’', url: 'https://example.com/shop/cup-holder' },
                          ];
                          shopCatalog.forEach(item => {
                              const hay = `${item.name} ${item.category}`.toLowerCase();
                              if (hay.includes(lowercaseQuery)) {
                                  results.push({
                                      type: 'shop',
                                      id: item.id,
                                      title: item.name,
                                      subtitle: `${item.category} â€¢ ${item.price}`,
                                      icon: item.icon,
                                      url: item.url,
                                      relevance: 0.75
                                  });
                              }
                          });

                          // Sort by relevance
                          results.sort((a, b) => b.relevance - a.relevance);

                          setSearchResults(results);
                          setIsSearching(false);

                          // Add to recent searches if not already there
                          if (query.trim() && !recentSearches.includes(query.trim())) {
                              const updated = [query.trim(), ...recentSearches.slice(0, 4)];
                              setRecentSearches(updated);
                              StorageManager.save('recentSearches', updated);
                          }
                      };

                      // Filter results
                      const getFilteredResults = () => {
                          if (activeFilter === 'all') return searchResults;
                          return searchResults.filter(result => result.type === activeFilter);
                      };

                      const handleRecentSearchClick = (search) => {
                          handleSearch(search);
                      };

                      const clearRecentSearches = () => {
                          setRecentSearches([]);
                          StorageManager.save('recentSearches', []);
                      };

                      const handleResultClick = (result) => {
                          if (result.type === 'post') {
                              // Find post in home or group collections
                              let p = posts.find(pp => pp.id === result.id);
                              if (!p) {
                                  const gp = groupPosts || {};
                                  outer: for (const gid of Object.keys(gp)) {
                                      const arr = gp[gid] || [];
                                      const found = arr.find(pp => pp.id === result.id);
                                      if (found) { p = found; break outer; }
                                  }
                              }
                              if (p) {
                                  setSelectedPost(p);
                                  setIsCommentModalOpen(true);
                                  onClose();
                                  return;
                              }
                          } else if (result.type === 'poll') {
                              // Treat as a post open
                              let p = null;
                              const gp = groupPosts || {};
                              for (const gid of Object.keys(gp)) {
                                  const arr = gp[gid] || [];
                                  const found = arr.find(pp => pp.id === result.id);
                                  if (found) { p = found; break; }
                              }
                              if (p) {
                                  setSelectedPost(p);
                                  setIsCommentModalOpen(true);
                                  onClose();
                                  return;
                              }
                          } else if (result.type === 'group') {
                              const grp = (allGroups || []).find(g => g.id === result.id);
                              if (grp) {
                                  setCurrentGroupView(grp);
                                  onClose();
                                  return;
                              }
                          } else if (result.type === 'user') {
                              const user = (users || []).find(u => u.id === result.id);
                              if (user) {
                                  // Navigate to profile by loading this user into profile view
                                  const profileData = {
                                      name: user.name,
                                      username: user.username,
                                      bio: user.bio || '',
                                      location: user.location || '',
                                      joinDate: user.joinDate || '',
                                      website: user.website || '',
                                      followers: user.followers || 0,
                                      following: user.following || 0,
                                      avatarUrl: user.avatar || null,
                                  };
                                  StorageManager.save('userProfile', profileData);
                                  setCurrentView('profile');
                                  onClose();
                                  return;
                              }
                          } else if (result.type === 'shop') {
                              if (result.url) {
                                  window.open(result.url, '_blank');
                                  onClose();
                                  return;
                              }
                              onClose();
                              return;
                          }
                          onClose();
                      };

                      const filters = ['all', 'user', 'group', 'shop'];

                      return (
                          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onMouseDown={(e) => { if (e.target === e.currentTarget) onClose(); }} role="dialog" aria-modal="true">
                              <div className="bg-white rounded-3xl w-full max-w-md mx-4 max-h-[85vh] overflow-hidden flex flex-col slide-up">
                                  {/* Header with Search Input */}
                                  <div className="p-4 border-b border-gray-200">
                                      <div className="flex items-center space-x-3">
                                          <button onClick={onClose} className="text-gray-500">
                                              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                                  <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" strokeWidth="2" />
                                              </svg>
                                          </button>
                                          <div className="flex-1 relative">
                                              <input
                                                  type="text"
                                                  value={searchQuery}
                                                  onChange={(e) => handleSearch(e.target.value)}
                                                  placeholder="Search Orbit..."
                                                  className="w-full bg-gray-100 px-4 py-3 rounded-xl text-base focus:outline-none focus:bg-white focus:ring-2 focus:ring-primary"
                                                  autoFocus
                                              />
                                              <div className="absolute right-3 top-3">
                                                  {isSearching ? (
                                                      <div className="w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
                                                  ) : (
                                                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#A1A1AA">
                                                          <circle cx="11" cy="11" r="8"/>
                                                          <path d="M21 21l-4.35-4.35"/>
                                                      </svg>
                                                  )}
                                              </div>
                                          </div>
                                      </div>

                                      {/* Filter Tabs */}
                                      {searchQuery && (
                                          <div className="flex space-x-2 mt-3 overflow-x-auto scrollbar-hide">
                                              {filters.map(filter => (
                                                  <button
                                                      key={filter}
                                                      onClick={() => setActiveFilter(filter)}
                                                      className={`px-3 py-1 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${
                                                          activeFilter === filter
                                                              ? 'bg-primary text-white'
                                                              : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                                      }`}
                                                  >
                                                      {filter.charAt(0).toUpperCase() + filter.slice(1)}
                                                      {filter !== 'all' && (
                                                          <span className="ml-1 text-xs opacity-75">
                                                              ({searchResults.filter(r => r.type === filter).length})
                                                          </span>
                                                      )}
                                                  </button>
                                              ))}
                                          </div>
                                      )}
                                  </div>

                                  {/* Search Results */}
                                  <div className="flex-1 overflow-y-auto">
                                      {searchQuery.trim() === '' ? (
                                          /* Recent Searches */
                                          <div className="p-4">
                                              <div className="flex items-center justify-between mb-3">
                                                  <h3 className="font-semibold text-gray-900">Recent Searches</h3>
                                                  {recentSearches.length > 0 && (
                                                      <button
                                                          onClick={clearRecentSearches}
                                                          className="text-primary text-sm hover:text-primary-dark"
                                                      >
                                                          Clear
                                                      </button>
                                                  )}
                                              </div>
                                              {recentSearches.length > 0 ? (
                                                  <div className="space-y-2">
                                                      {recentSearches.map((search, index) => (
                                                          <button
                                                              key={index}
                                                              onClick={() => handleRecentSearchClick(search)}
                                                              className="w-full text-left p-3 rounded-lg hover:bg-gray-50 flex items-center space-x-3 transition-colors"
                                                          >
                                                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#A1A1AA">
                                                                  <circle cx="12" cy="12" r="3"/>
                                                                  <path d="M12 1v6m0 6v6m6-6H1"/>
                                                              </svg>
                                                              <span className="text-gray-700">{search}</span>
                                                          </button>
                                                      ))}
                                                  </div>
                                              ) : (
                                                  <p className="text-gray-500 text-sm">No recent searches</p>
                                              )}

                                              {/* Ã–ne Ã‡Ä±kanlar Topics */}
                                              <div className="mt-6">
                                                  <h3 className="font-semibold text-gray-900 mb-3">Ã–ne Ã‡Ä±kanlar Now</h3>
                                                  <div className="space-y-2">
                                                      {['#NewMom', '#BabyFood', '#Playground', '#MomLife', '#Support'].map((tag, index) => (
                                                          <button
                                                              key={index}
                                                              onClick={() => handleSearch(tag.slice(1))}
                                                              className="w-full text-left p-3 rounded-lg hover:bg-gray-50 flex items-center justify-between transition-colors"
                                                          >
                                                              <div className="flex items-center space-x-3">
                                                                  <div className="w-8 h-8 bg-gradient-to-br from-primary to-secondary rounded-lg flex items-center justify-center">
                                                                      <span className="text-white text-sm">#</span>
                                                                  </div>
                              <span className="font-medium text-gray-700">{tag}</span>
                          </div>
                          <span className="text-placeholder text-sm">â†—</span>
                      </button>
                                                      ))}
                                                  </div>
                                              </div>
                                          </div>
                                      ) : (
                                          /* Search Results */
                                          <div className="p-4">
                                              {isSearching ? (
                                                  <div className="space-y-3">
                                                      {[1,2,3].map(i => (
                                                          <div key={i} className="flex items-center space-x-3 p-3">
                                                              <div className="w-10 h-10 bg-gray-200 rounded-lg loading-pulse"></div>
                                                              <div className="flex-1 space-y-2">
                                                                  <div className="h-4 bg-gray-200 rounded loading-pulse"></div>
                                                                  <div className="h-3 bg-gray-200 rounded w-3/4 loading-pulse"></div>
                                                              </div>
                                                          </div>
                                                      ))}
                                                  </div>
                                              ) : getFilteredResults().length > 0 ? (
                                                  <div className="space-y-3">
                                                      <div className="flex items-center justify-between mb-3">
                                                          <h3 className="font-semibold text-gray-900">
                                                              {getFilteredResults().length} result{getFilteredResults().length !== 1 ? 's' : ''}
                                                          </h3>
                                                      </div>
                                                      {getFilteredResults().map((result, index) => (
                                                          <button
                                                              key={`${result.type}-${result.id}-${index}`}
                                                              onClick={() => handleResultClick(result)}
                                                              className="w-full p-3 rounded-lg hover:bg-gray-50 transition-colors"
                                                          >
                                                              <div className="flex items-start space-x-3">
                                                                  {/* Result Icon/Avatar */}
                                                                  <div className="flex-shrink-0">
                                                                      {result.type === 'user' ? (
                                                                          <div className="w-10 h-10 bg-primary rounded-full flex items-center justify-center">
                                                                              <span className="text-white font-bold text-sm">
                                                                                  {result.title[0]}
                                                                              </span>
                                                                          </div>
                                                                      ) : result.type === 'group' ? (
                                                                          <div className={`w-10 h-10 ${result.color} rounded-lg flex items-center justify-center`}>
                                                                              <span className="text-white text-lg">{result.image}</span>
                                                                          </div>
                                                                      ) : result.type === 'shop' ? (
                                                                          <div className="w-10 h-10 bg-emerald-100 text-emerald-700 rounded-lg flex items-center justify-center">
                                                                              <span className="text-sm">{result.icon || 'ðŸ›ï¸'}</span>
                                                                          </div>
                                                                      ) : result.type === 'poll' ? (
                                                                          <div className="w-10 h-10 bg-like/20 text-like rounded-lg flex items-center justify-center">
                                                                              <span className="text-sm">ðŸ“Š</span>
                                                                          </div>
                                                                      ) : result.type === 'trending' ? (
                                                                          <div className="w-10 h-10 bg-gradient-to-br from-orange-400 to-red-400 rounded-lg flex items-center justify-center">
                                                                              <span className="text-white text-sm">ðŸ”¥</span>
                                                                          </div>
                                                                      ) : (
                                                                          <div className="w-10 h-10 bg-accent rounded-lg flex items-center justify-center">
                                                                              <span className="text-white text-sm">ðŸ“</span>
                                                                          </div>
                                                                      )}
                                                                  </div>

                                                                  {/* Result Content */}
                                                                  <div className="flex-1 text-left">
                                                                      <h4 className="font-medium text-gray-900 text-sm leading-tight">
                                                                          {result.title}
                                                                      </h4>
                                                                      <p className="text-gray-500 text-xs mt-1">
                                                                          {result.subtitle}
                                                                      </p>
                                                                      {result.type === 'post' && (
                                                                          <p className="text-gray-400 text-xs mt-1">
                                                                              {result.time}
                                                                          </p>
                                                                      )}
                                                                  </div>

                                                                  {/* Result Type Badge */}
                                                                  <div className="flex-shrink-0">
                                                                      <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                                                          result.type === 'user' ? 'bg-blue-100 text-blue-600' :
                                                                          result.type === 'group' ? 'bg-green-100 text-green-600' :
                                                                          result.type === 'post' ? 'bg-gray-100 text-gray-600' :
                                                                          result.type === 'poll' ? 'bg-purple-100 text-purple-600' :
                                                                          result.type === 'shop' ? 'bg-emerald-100 text-emerald-700' :
                                                                          'bg-orange-100 text-orange-600'
                                                                      }`}>
                                                                          {result.type}
                                                                      </span>
                                                                  </div>
                                                              </div>
                                                          </button>
                                                      ))}
                                                  </div>
                                              ) : (
                                                  /* No Results */
                                                  <div className="text-center py-8">
                                                      <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                                          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#A1A1AA">
                                                              <circle cx="11" cy="11" r="8"/>
                                                              <path d="M21 21l-4.35-4.35"/>
                                                          </svg>
                                                      </div>
                                                      <h3 className="text-lg font-semibold text-gray-900 mb-2">No results found</h3>
                                                      <p className="text-gray-500 text-sm mb-4">
                                                          Try searching with different keywords
                                                      </p>
                                                      <button
                                                          onClick={() => {
                                                              setSearchQuery('');
                                                              setSearchResults([]);
                                                          }}
                                                          className="text-primary hover:text-primary-dark text-sm font-medium"
                                                      >
                                                          Clear search
                                                      </button>
                                                  </div>
                                              )}
                                          </div>
                                  )}
                              </div>

                          </div>
                      </div>
                  );
                  };

                  // ðŸ“¤ Share Modal
                  const ShareModal = ({ isOpen, onClose, users = [], post, onConfirm }) => {
                      const [query, setQuery] = useState('');
                      const [selected, setSelected] = useState([]);

                      if (!isOpen || !post) return null;

                      const candidates = users
                          .filter(u => u && u.name && u.username)
                          .filter(u => (u.name + ' ' + u.username).toLowerCase().includes(query.toLowerCase()));

                      const toggle = (id) => {
                          setSelected(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
                      };

                      const handleSend = () => {
                          if (selected.length === 0) return;
                          onConfirm && onConfirm(selected);
                      };

                      return (
                          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onMouseDown={(e) => { if (e.target === e.currentTarget) onClose(); }} role="dialog" aria-modal="true">
                              <div className="bg-white rounded-3xl w-full max-w-md mx-4 max-h-[80vh] overflow-hidden slide-up">
                                  {/* Header */}
                                  <div className="flex items-center justify-between p-4 border-b border-gray-200">
                                      <h2 className="text-lg font-bold">Share Post</h2>
                                      <button onClick={onClose} className="text-gray-500">âœ•</button>
                                  </div>

                                  {/* Post snippet */}
                                  <div className="px-4 py-3 border-b border-gray-100">
                                      {(() => {
                                          const hasStructured = post && (post.title || post.details);
                                          let t = post?.title || null;
                                          let d = post?.details || null;
                                          if (!hasStructured && typeof post?.content === 'string') {
                                              const parts = post.content.split(/\n\s*\n/);
                                              if (parts.length > 1) { t = parts[0].trim(); d = parts.slice(1).join('\n\n').trim(); }
                                          }
                                          return (
                                              <div>
                                                  {t && <div className="text-sm font-bold text-gray-900 mb-1">{t}</div>}
                                                  <p className="text-gray-700 text-sm line-clamp-2 whitespace-pre-line">{d || post.content}</p>
                                              </div>
                                          );
                                      })()}
                                  </div>

                                  {/* Search */}
                                  <div className="px-4 py-3">
                                      <input
                                          value={query}
                                          onChange={(e) => setQuery(e.target.value)}
                                          placeholder="Search members..."
                                          className="w-full bg-gray-100 px-4 py-3 rounded-xl text-base focus:outline-none focus:bg-white focus:ring-2 focus:ring-primary"
                                      />
                                  </div>

                                  {/* List */}
                                  <div className="overflow-y-auto max-h-80 px-2 pb-2">
                                      {candidates.map(u => (
                                          <button
                                              key={u.id}
                                              onClick={() => toggle(u.id)}
                                              className={`w-full flex items-center justify-between p-3 rounded-xl mx-2 mb-2 transition-colors ${selected.includes(u.id) ? 'bg-primary/10' : 'hover:bg-gray-50'}`}
                                          >
                                              <div className="flex items-center space-x-3">
                                                  <div className="w-10 h-10 rounded-full overflow-hidden bg-primary text-white flex items-center justify-center">
                                                      {u.avatar ? (
                                                          <img src={u.avatar} alt={u.name} className="w-full h-full object-cover" />
                                                      ) : (
                                                          <span className="font-bold">{u.name[0]}</span>
                                                      )}
                                                  </div>
                                                  <div className="text-left">
                                                      <div className="font-semibold text-sm text-gray-900">{u.name}</div>
                                                      <div className="text-xs text-gray-500">{u.username}</div>
                                                  </div>
                                              </div>
                                              <div className={`w-5 h-5 rounded-full border ${selected.includes(u.id) ? 'bg-primary border-primary' : 'border-gray-300'}`}></div>
                                          </button>
                                      ))}
                                      {candidates.length === 0 && (
                                          <div className="text-center text-gray-500 text-sm py-6">No members found</div>
                                      )}
                                  </div>

                                  {/* Footer */}
                                  <div className="p-4 border-t border-gray-200 flex items-center justify-end space-x-3">
                                      <button onClick={onClose} className="px-4 py-2 rounded-xl text-gray-600 hover:bg-gray-100">Cancel</button>
                                      <button
                                          onClick={handleSend}
                                          disabled={selected.length === 0}
                                          className={`px-4 py-2 rounded-xl font-semibold ${selected.length === 0 ? 'bg-gray-200 text-gray-400' : 'bg-primary text-white hover:bg-primary-dark'}`}
                                      >
                                          Send
                                      </button>
                                  </div>
                              </div>
                          </div>
                      );
                  };

                  // Group Picker Modal
                  const GroupPickerModal = ({ isOpen, onClose, groups = [], onConfirm }) => {
                      const [selected, setSelected] = useState(null);
                      if (!isOpen) return null;
                      const canConfirm = !!selected;
                      return (
                          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onMouseDown={(e)=>{ if (e.target === e.currentTarget) onClose(); }}>
                              <div className="bg-white rounded-3xl w-full max-w-md mx-4 overflow-hidden">
                                  <div className="flex items-center justify-between p-4 border-b border-gray-200">
                                      <h2 className="text-lg font-bold">Choose Group</h2>
                                      <button onClick={onClose} className="text-gray-500">âœ•</button>
                                  </div>
                                  <div className="p-4 space-y-2 max-h-[60vh] overflow-y-auto">
                                      {groups.length === 0 ? (
                                          <div className="text-center text-gray-500 py-12">Join a group to post</div>
                                      ) : groups.map(g => (
                                          <button key={g.id} onClick={()=>setSelected(g.id)} className={`w-full flex items-center justify-between p-3 rounded-xl border ${selected===g.id?'border-primary bg-primary/5':'border-gray-200 hover:bg-gray-50'}`}>
                                              <div className="flex items-center space-x-3">
                                                  <div className={`w-10 h-10 ${g.color} rounded-xl flex items-center justify-center overflow-hidden`}>
                                                      {g.iconUrl ? <img src={g.iconUrl} alt={g.name} className="w-full h-full object-cover"/> : <span className="text-white">{g.image}</span>}
                                                  </div>
                                                  <div className="text-left">
                                                      <div className="font-semibold text-sm text-gray-900">{g.name}</div>
                                                      <div className="text-xs text-gray-500 capitalize">{g.category}</div>
                                                  </div>
                                              </div>
                                              <div className={`w-5 h-5 rounded-full border ${selected===g.id?'bg-primary border-primary':'border-gray-300'}`}></div>
                                          </button>
                                      ))}
                                  </div>
                                  <div className="p-4 border-t border-gray-200 flex items-center justify-end space-x-2">
                                      <button onClick={onClose} className="px-4 py-2 rounded-xl text-gray-600 hover:bg-gray-100">Cancel</button>
                                      <button onClick={()=> onConfirm && onConfirm(selected)} disabled={!canConfirm} className={`px-4 py-2 rounded-xl font-semibold ${canConfirm ? 'bg-primary text-white hover:bg-primary-dark' : 'bg-gray-200 text-gray-400'}`}>Post</button>
                                  </div>
                              </div>
                          </div>
                      );
                  };

                  // ðŸ“¥ Inbox Modal (Shared with you)
                  const InboxModal = ({ isOpen, onClose }) => {
                      const myKey = (users.find(u => u.username === me.username)?.id) ?? 'me';
                      const [items, setItems] = useState([]);

                      useEffect(() => {
                          if (!isOpen) return;
                          const inbox = StorageManager.load('sharedPostsByRecipient', {});
                          setItems(inbox[myKey] || []);
                          const onStorage = () => {
                              const ib = StorageManager.load('sharedPostsByRecipient', {});
                              setItems(ib[myKey] || []);
                          };
                          window.addEventListener('storage', onStorage);
                          return () => window.removeEventListener('storage', onStorage);
                      }, [isOpen, myKey]);

                      if (!isOpen) return null;

                      const clearAll = () => {
                          const inbox = StorageManager.load('sharedPostsByRecipient', {});
                          inbox[myKey] = [];
                          StorageManager.save('sharedPostsByRecipient', inbox);
                          setItems([]);
                      };

                      const openPost = (postId) => {
                          const p = posts.find(pp => pp.id === postId);
                          if (p) {
                              setSelectedPost(p);
                              setIsCommentModalOpen(true);
                              onClose();
                          }
                      };

                      const renderSender = (from) => {
                          const u = users.find(uu => uu.username === from);
                          return u ? u.name : from;
                      };

                      return (
                          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onMouseDown={(e) => { if (e.target === e.currentTarget) onClose(); }} role="dialog" aria-modal="true">
                              <div className="bg-white rounded-3xl w-full max-w-md mx-4 max-h-[80vh] overflow-hidden slide-up">
                                  <div className="flex items-center justify-between p-4 border-b border-gray-200">
                                      <h2 className="text-lg font-bold">Shared With You</h2>
                                      <button onClick={onClose} className="text-gray-500" aria-label="Close inbox">âœ•</button>
                                  </div>
                                  <div className="p-4 space-y-3 max-h-[60vh] overflow-y-auto">
                                      {items.length === 0 ? (
                                          <div className="text-center text-gray-500 py-12">No shared posts yet</div>
                                      ) : (
                                          items.map((it, idx) => (
                                              <div key={idx} className="flex items-center justify-between p-3 rounded-xl hover:bg-gray-50">
                                                  <div className="flex-1 min-w-0">
                                                      <div className="text-sm font-semibold text-gray-900 truncate">{renderSender(it.from)}</div>
                                                      <div className="text-xs text-gray-500">{formatRelativeTime(it.at)}</div>
                                                  </div>
                                                  <button onClick={() => openPost(it.postId)} className="px-3 py-1 text-sm rounded-full bg-primary text-white hover:bg-primary-dark">Open</button>
                                              </div>
                                          ))
                                      )}
                                  </div>
                                  <div className="p-4 border-t border-gray-200 flex items-center justify-end space-x-2">
                                      <button onClick={clearAll} disabled={items.length === 0} className={`px-4 py-2 rounded-xl ${items.length === 0 ? 'bg-gray-200 text-gray-400' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>Clear All</button>
                                      <button onClick={onClose} className="px-4 py-2 rounded-xl bg-primary text-white hover:bg-primary-dark">Close</button>
                                  </div>
                              </div>
                          </div>
                      );
                  };

                  // ðŸŽ¨ Enhanced Create Post Modal
                      const EnhancedCreatePostModal = ({ isOpen, onClose, onCreatePost, onCoinEarned, currentUser }) => {
                      const [content, setContent] = useState('');
                      const [isPosting, setIsPosting] = useState(false);
                      const [wordCount, setWordCount] = useState(0);
                      const [showPreview, setShowPreview] = useState(false);
                      const [selectedImage, setSelectedImage] = useState(null);
                      const galleryInputRef = useRef(null);
                      const cameraInputRef = useRef(null);

                      if (!isOpen) return null;

                      const handleContentChange = (e) => {
                          const text = e.target.value;
                          setContent(text);
                          setWordCount(text.trim().split(/\s+/).filter(word => word.length > 0).length);
                      };

                      const handleImageSelect = (e, source) => {
                          const file = e.target.files && e.target.files[0];
                          if (!file) return;
                          const reader = new FileReader();
                          reader.onload = () => {
                              setSelectedImage({ type: 'file', url: reader.result, source });
                              setShowPreview(false);
                          };
                          reader.readAsDataURL(file);
                          e.target.value = '';
                      };

                      const openGallery = () => { if (galleryInputRef.current) galleryInputRef.current.click(); };
                      const openCamera = () => { if (cameraInputRef.current) cameraInputRef.current.click(); };

                      const handleSubmit = async () => {
                          if (!content.trim() && !selectedImage) {
                              return;
                          }

                          setIsPosting(true);

                          try {
                              // Simulate processing time
                              await new Promise(resolve => setTimeout(resolve, 1500));

                              onCreatePost({ content: content.trim(), image: selectedImage });
                              onCoinEarned(5);

                              // Reset and close
                              setContent('');
                              setWordCount(0);
                              setShowPreview(false);
                              setSelectedImage(null);
                              onClose();
                          } catch (error) {
                              // Error handling
                          } finally {
                              setIsPosting(false);
                          }
                      };

                      const handleKeyDown = (e) => {
                          if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
                              e.preventDefault();
                              handleSubmit();
                          }
                      };

                      const maxChars = 280;
                      const isOverLimit = content.length > maxChars;
                      const progressPercent = (content.length / maxChars) * 100;

                      return (
                          <div className="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50" onMouseDown={(e) => { if (e.target === e.currentTarget) onClose(); }} role="dialog" aria-modal="true">
                              <div className="bg-white rounded-3xl w-full max-w-md mx-4 max-h-[85vh] overflow-hidden slide-up">
                                  {/* Header */}
                                  <div className="flex items-center justify-between p-4 border-b border-gray-200">
                                      <div className="flex items-center space-x-3">
                                          <button
                                              onClick={onClose}
                                              disabled={isPosting}
                                              className="text-gray-500 hover:text-gray-700 disabled:opacity-50"
                                          >
                                              âœ•
                                          </button>
                                          <h2 className="text-lg font-bold">Create Post</h2>
                                      </div>
                                      <div className="flex items-center space-x-2">
                                          <button
                                              onClick={() => setShowPreview(!showPreview)}
                                              className={`px-3 py-1 rounded-full text-sm font-medium transition-colors ${
                                                  showPreview
                                                      ? 'bg-primary text-white'
                                                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                              }`}
                                          >
                                              {showPreview ? 'Edit' : 'Preview'}
                                          </button>
                                      </div>
                                  </div>

                                  {/* Content (scrollable) */}
                                  <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                      {showPreview ? (
                                          /* Preview Mode */
                                          <div className="bg-gray-50 rounded-xl p-4 min-h-32">
                                              <div className="flex items-center mb-3">
                                                  <div className="w-8 h-8 bg-primary rounded-full flex items-center justify-center mr-3">
      <span className="text-white font-bold text-xs">{(currentUser?.name && currentUser.name[0]) ? currentUser.name[0].toUpperCase() : 'U'}</span>
                                                  </div>
                                                  <div>
                                              <h4 className="font-semibold text-sm">{currentUser?.name || 'You'}</h4>
                                              <p className="text-gray-500 text-xs">{formatRelativeTime(Date.now())}</p>
                                                  </div>
                                              </div>
                                              <p className="text-gray-700 text-sm leading-relaxed">
                                                  {content || 'Your post preview will appear here...'}
                                              </p>
                                          </div>
                                      ) : (
                                          /* Edit Mode */
                                          <div className="space-y-3">
                                              <textarea
                                                  value={content}
                                                  onChange={handleContentChange}
                                                  onKeyDown={handleKeyDown}
                                                  placeholder="What's on your mind? Share your moment with the community..."
                                                  className="w-full h-32 p-4 border border-gray-200 rounded-xl resize-none focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 text-base transition-all focus-ring"
                                                  autoFocus
                                                  disabled={isPosting}
                                              />

                                              {/* Image preview */}
                                              {selectedImage && (
                                                  <div className="relative bg-gray-100 rounded-xl overflow-hidden flex items-center justify-center">
                                                      <img src={selectedImage.url} alt="Selected" className="w-full max-h-80 object-contain" />
                                                      <button
                                                          onClick={() => setSelectedImage(null)}
                                                          className="absolute top-2 right-2 bg-white/80 hover:bg-white text-gray-700 rounded-full p-1"
                                                          title="Remove image"
                                                      >âœ•</button>
                                                  </div>
                                              )}

                                              {/* Character Counter */}
                                              <div className="flex items-center justify-between text-sm">
                                                  <div className="flex items-center space-x-3">
                                                      <span className="text-gray-500">
                                                          {wordCount} word{wordCount !== 1 ? 's' : ''}
                                                      </span>
                                                      <span className="text-gray-300">â€¢</span>
                                                      <span className={`${isOverLimit ? 'text-red-500' : 'text-gray-500'}`}>
                                                          {content.length}/{maxChars}
                                                      </span>
                                                  </div>
                                                  <div className="flex items-center space-x-2">
                                                      <div className="w-16 h-1 bg-gray-200 rounded-full overflow-hidden">
                                                          <div
                                                              className={`h-full transition-all duration-300 ${
                                                                  progressPercent > 90 ? 'progress-bar' :
                                                                  progressPercent > 75 ? 'bg-yellow-500' : 'bg-primary'
                                                              }`}
                                                              style={{ width: `${Math.min(progressPercent, 100)}%` }}
                                                          />
                                                      </div>
                                                  </div>
                                              </div>
                                          </div>
                                      )}

                                      {/* Quick Actions */}
                                      <div className="flex items-center justify-between pt-2 border-t border-gray-100">
                                          <div className="flex items-center space-x-4">
                                              <button onClick={openGallery} className="flex items-center space-x-2 text-gray-500 hover:text-primary transition-colors">
                                                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                                      <circle cx="9" cy="9" r="2"/>
                                                      <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                                                  </svg>
                                                  <span className="text-sm">Gallery</span>
                                              </button>
                                              <button onClick={openCamera} className="flex items-center space-x-2 text-gray-500 hover:text-primary transition-colors">
                                                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                      <path d="M3 7h4l2-3h6l2 3h4v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"/>
                                                      <circle cx="12" cy="13" r="4"/>
                                                  </svg>
                                                  <span className="text-sm">Camera</span>
                                              </button>
                                          </div>
                                      </div>

                                      {/* Hidden file inputs for image selection */}
                                      <input ref={galleryInputRef} type="file" accept="image/*" className="hidden" onChange={(e) => handleImageSelect(e, 'gallery')} />
                                      <input ref={cameraInputRef} type="file" accept="image/*" capture="environment" className="hidden" onChange={(e) => handleImageSelect(e, 'camera')} />

                                      {/* Coin Reward Info */}
                                      <div className="bg-gradient-to-r from-primary/10 to-secondary/10 rounded-xl p-3">
                                          <div className="flex items-center space-x-2">
                                              <span className="text-lg">ðŸª™</span>
                                              <span className="text-sm font-medium text-gray-700">
                                                  Earn 5 coins for sharing a post!
                                              </span>
                                          </div>
                                      </div>

                                  </div>
                              </div>
                          </div>
                      );
                  };


                  // ðŸŽ¨ Create Group Modal
                  const CreateGroupModal = ({ isOpen, onClose, onCreateGroup }) => {
                      const [name, setName] = useState('');
                      const [description, setDescription] = useState('');
                      const [category, setCategory] = useState('Support');
                      const [isPrivate, setIsPrivate] = useState(false);
                      const [privacy, setPrivacy] = useState('public'); // public | private | invite
                      const [selectedColor, setSelectedColor] = useState('bg-primary');
                      const [rules, setRules] = useState('Be respectful and supportive.');
                      const [iconUrl, setIconUrl] = useState(null);
                      const [coverUrl, setCoverUrl] = useState(null);
                      const [coverFit, setCoverFit] = useState('cover');
                      const [coverMode, setCoverMode] = useState('gradient');
                      const [coverGradient, setCoverGradient] = useState('from-rose-400 via-pink-300 to-rose-200');
                      const iconInputRef = useRef(null);
                      const coverInputRef = useRef(null);
                      const [isCreating, setIsCreating] = useState(false);
                      const [dupError, setDupError] = useState('');
                      const [dupNotice, setDupNotice] = useState('');
                      const [dupMatches, setDupMatches] = useState([]);

                      if (!isOpen) return null;

                      const categories = ['Support', 'Food', 'Local', 'Career', 'Sleep', 'Activities'];
                      const colors = [
                          'bg-primary', 'bg-secondary', 'bg-accent',
                          // Softer pastel palette
                          'bg-emerald-200', 'bg-teal-200', 'bg-sky-200',
                          'bg-rose-200', 'bg-violet-200', 'bg-amber-200'
                      ];
                      const gradients = [
                          'from-primary/30 via-secondary/30 to-mint/30',
                          'from-[#FFD5DC] via-[#9797CA] to-[#91B5B0]',
                          'from-[#FFE3CC] via-[#F5CAC3] to-[#A5C9CA]',
                          'from-[#C7F9CC] via-[#80ED99] to-[#57CC99]'
                      ];

                      // simplified submit (no duplicate guard)

                      const handleSubmit = async () => {
                          if (!name.trim() || !description.trim()) return;

                          // Soft duplicate check (not too strict): warn, only block exact slug match
                          const safeNorm = (s='') => {
                              try { return (s || '').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,''); }
                              catch { return (s || '').toLowerCase(); }
                          };
                          const slugify = (s='') => safeNorm(s).replace(/[^a-z0-9\s]/gi,' ').replace(/\s+/g,'-').replace(/^-+|-+$/g,'');
                          const normalize = (s='') => safeNorm(s).replace(/[^a-z0-9\s]/gi,' ').replace(/\s+/g,' ').trim();
                          const alias = (w) => ({
                              'mom':'mom','moms':'mom','mother':'mom','anne':'mom',
                              'support':'support','destek':'support','help':'support',
                              'new':'new','first':'new','first-time':'new',
                              'playground':'playground','park':'playground',
                              'sleep':'sleep','uyku':'sleep',
                              'recipe':'recipe','tarif':'recipe','food':'food'
                          }[w] || w);
                          const stop = new Set(['group','grup','and','&','of','the','a','an','for','with','in']);
                          const tokenize = (s='') => Array.from(new Set(normalize(s).split(' ').map(alias).filter(w=>w && !stop.has(w))));
                          const jaccard = (a,b)=>{ const A=new Set(a), B=new Set(b); const inter=[...A].filter(x=>B.has(x)).length; const uni=new Set([...A,...B]).size||1; return inter/uni; };
                          const levenshtein = (a,b)=>{ const A=normalize(a), B=normalize(b); const m=A.length,n=B.length; if(!m) return n; if(!n) return m; const dp=Array.from({length:m+1},(_,i)=>Array(n+1).fill(0)); for(let i=0;i<=m;i++) dp[i][0]=i; for(let j=0;j<=n;j++) dp[0][j]=j; for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){ const c=A[i-1]===B[j-1]?0:1; dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+c);} } return dp[m][n]; };
                          const levSim = (a,b)=>{ const d=levenshtein(a,b); const L=Math.max(normalize(a).length, normalize(b).length)||1; return 1 - (d/L); };

                          const existing = (allGroups && allGroups.length>0) ? allGroups : [];
                          const targetSlug = slugify(name);
                          const targetNorm = normalize(name);
                          const targetTok = tokenize(name);
                          const matches = [];
                          let hardBlock = false;
                          existing.forEach(g => {
                              const gSlug = g.slug || slugify(g.name);
                              const gNorm = normalize(g.name);
                              const gTok = tokenize(g.name);
                              const sameSlug = gSlug === targetSlug;
                              const exact = gNorm === targetNorm;
                              const sub = gNorm.includes(targetNorm) || targetNorm.includes(gNorm);
                              const jac = jaccard(gTok, targetTok) >= 0.6;
                              const lev = levSim(g.name, name) >= 0.78;
                              const similar = sameSlug || exact || sub || jac || lev;
                              if (similar) matches.push(g);
                              if (sameSlug) hardBlock = true;
                          });
                          if (matches.length > 0) {
                              setDupNotice('Benzer grup isimleri bulundu. LÃ¼tfen mevcut gruplarÄ± kontrol edin.');
                              setDupMatches(matches.slice(0,5));
                              if (hardBlock) { return; } // exact duplicate slug -> block
                          } else {
                              setDupNotice(''); setDupMatches([]);
                          }

                          setIsCreating(true);
                          try {
                              await new Promise(r=>setTimeout(r,300));
                              const newGroup = {
                                  id: Date.now(),
                                  name: name.trim(),
                                  description: description.trim(),
                                  image: "",
                                  color: selectedColor,
                                  slug: targetSlug,
                                  members: 1,
                                  category,
                                  isPrivate: privacy !== 'public',
                                  privacy,
                                  recentActivity: 'Just now',
                                  ownerUsername: me.username,
                                  about: description.trim(),
                                  rules: (rules || '').trim(),
                                  iconUrl: iconUrl || null,
                                  coverGradient
                              };
                              onCreateGroup({ ...newGroup, __coverUrl: coverMode==='image' ? (coverUrl || null) : null, __coverFit: coverMode==='image' ? coverFit : 'cover' });
                              setName(''); setDescription(''); setCategory('Support'); setIsPrivate(false); setPrivacy('public'); setSelectedColor('bg-primary');
                              setRules('Be respectful and supportive.'); setIconUrl(null); setCoverUrl(null); setCoverMode('gradient'); setCoverGradient('from-rose-400 via-pink-300 to-rose-200');
                              onClose();
                          } finally {
                              setIsCreating(false);
                          }
                      };

                      return (
                          <div className="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50" onMouseDown={(e) => { if (e.target === e.currentTarget) onClose(); }}>
                              <div className="bg-white rounded-3xl w-full max-w-md mx-4 max-h-[90vh] overflow-hidden slide-up">
                                  {/* Header */}
                                  <div className="flex items-center justify-between p-4 border-b border-gray-200">
                                      <h2 className="text-lg font-bold">Create Group</h2>
                                      <button
                                          onClick={onClose}
                                          disabled={isCreating}
                                          className="text-gray-500 hover:text-gray-700 disabled:opacity-50"
                                      >
                                          âœ•
                                      </button>
                                  </div>

                                  {/* Content */}
                                  <div className="p-4 space-y-6 max-h-[70vh] overflow-y-auto">
                                      {/* Preview */}
                                      <div className="bg-gray-50 rounded-xl p-4">
                                          <h3 className="text-sm font-semibold text-gray-700 mb-3">Preview</h3>
                                          <div className="flex items-center space-x-3">
                                              <div className={`w-12 h-12 ${selectedColor} rounded-xl flex items-center justify-center`}>
                                                  <div className="w-6 h-6 bg-white/20 rounded-full"></div>
                                              </div>
                                              <div>
                                                  <h4 className="font-semibold text-gray-900">
                                                      {name || 'Group Name'}
                                                  </h4>
                                                  <p className="text-gray-500 text-sm">
                                                      {description || 'Group description will appear here...'}
                                                  </p>
                                              </div>
                                          </div>
                                          {dupNotice && (
                                              <div className="mt-3 p-2 rounded-lg bg-amber-50 text-amber-800 text-xs">
                                                  <div className="mb-1">{dupNotice}</div>
                                                  {dupMatches && dupMatches.length > 0 && (
                                                      <div className="space-y-1">
                                                          {dupMatches.map(g => (
                                                              <div key={g.id} className="flex items-center justify-between">
                                                                  <span className="truncate pr-2">{g.name}</span>
                                                                  <button className="text-comment hover:underline" onClick={() => { setCurrentGroupView(g); onClose(); }}>
                                                                      View Group
                                                                  </button>
                                                              </div>
                                                          ))}
                                                      </div>
                                                  )}
                                              </div>
                                          )}
                                      </div>

                                      {/* Group Name */}
                                      <div>
                                          <label className="block text-sm font-medium text-gray-700 mb-2">
                                              Group Name *
                                          </label>
                                          <input
                                              type="text"
                                              value={name}
                                              onChange={(e) => setName(e.target.value)}
                                              placeholder="Enter group name..."
                                              className="w-full px-3 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 text-base"
                                              disabled={isCreating}
                                              maxLength={50}
                                          />
                                          <p className="text-xs text-gray-500 mt-1">{name.length}/50</p>
                                      </div>

                                      {/* Description */}
                                      <div>
                                          <label className="block text-sm font-medium text-gray-700 mb-2">
                                              Description *
                                          </label>
                                          <textarea
                                              value={description}
                                              onChange={(e) => setDescription(e.target.value)}
                                              placeholder="Describe what your group is about..."
                                              className="w-full px-3 py-3 border border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 text-base resize-none"
                                              rows={3}
                                              disabled={isCreating}
                                              maxLength={150}
                                          />
                                          <p className="text-xs text-gray-500 mt-1">{description.length}/150</p>
                                      </div>

                                      {/* Category */}
                                      <div>
                                          <label className="block text-sm font-medium text-gray-700 mb-2">
                                              Category
                                          </label>
                                          <div className="grid grid-cols-3 gap-2">
                                              {categories.map(cat => (
                                                  <button
                                                      key={cat}
                                                      onClick={() => setCategory(cat)}
                                                      disabled={isCreating}
                                                      className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                                                          category === cat
                                                              ? 'bg-primary text-white'
                                                              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                      }`}
                                                  >
                                                      {cat}
                                                  </button>
                                              ))}
                                          </div>
                                      </div>

                                      {/* Icon Selection */}
                                      <div>
                                          <label className="block text-sm font-medium text-gray-700 mb-2">
                                              Group Icon
                                          </label>
                                          <div className="flex items-center space-x-3">
                                              <div className={`w-12 h-12 ${selectedColor} rounded-xl flex items-center justify-center`}>
                                                  <div className="w-6 h-6 bg-white/20 rounded-full"></div>
                                          </div>
                                              <div>
                                                  <p className="text-sm text-gray-600">Group will use a colored icon</p>
                                                  <button onClick={()=> iconInputRef.current && iconInputRef.current.click()} className="text-sm text-primary hover:text-primary-dark">or upload a picture</button>
                                              <input ref={iconInputRef} type="file" accept="image/*" className="hidden" onChange={(e)=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=> setIconUrl(r.result); r.readAsDataURL(f); e.target.value=''; }} />
                                              </div>
                                          </div>
                                      </div>

                                      {/* Color Selection */}
                                      <div>
                                          <label className="block text-sm font-medium text-gray-700 mb-2">
                                              Choose Color
                                          </label>
                                          <div className="grid grid-cols-6 gap-2">
                                              {colors.map(color => (
                                                  <button
                                                      key={color}
                                                      onClick={() => setSelectedColor(color)}
                                                      disabled={isCreating}
                                                      className={`aspect-square rounded-lg transition-all ${color} ${
                                                          selectedColor === color
                                                              ? 'ring-2 ring-gray-900 scale-110'
                                                              : 'hover:scale-105'
                                                      }`}
                                                  />
                                              ))}
                                          </div>
                                      </div>


                                      {/* Group Privacy */}
                                      <div>
                                          <h4 className="text-xs font-semibold text-gray-500 tracking-wide mb-2">Group Privacy</h4>
                                          <div className="soft-card divide-y divide-gray-100">
                                              {[
                                                  {key:'public', label:'Public', help:'Visible to everyone'},
                                                  {key:'private', label:'Private', help:'Visible, approval required'},
                                                  {key:'invite', label:'Invite only', help:'Only members can view'}
                                              ].map(opt => (
                                                  <button key={opt.key} onClick={()=>setPrivacy(opt.key)} className="w-full flex items-center justify-between p-3 hover:bg-gray-50">
                                                      <div>
                                                          <div className="text-sm text-gray-900 font-medium">{opt.label}</div>
                                                          <div className="text-xs text-gray-500">{opt.help}</div>
                                                      </div>
                                                      <span className={`w-5 h-5 rounded-full border ${privacy===opt.key ? 'bg-primary border-primary' : 'border-gray-300'}`}></span>
                                                  </button>
                                              ))}
                                          </div>
                                      </div>

                                      {/* Cover Setting */}
                                      <div>
                                          <label className="block text-sm font-medium text-gray-700 mb-2">Cover</label>
                                          <div className="flex items-center space-x-3 mb-2">
                                              <label className="flex items-center space-x-2 text-sm">
                                                  <input type="radio" checked={coverMode==='gradient'} onChange={()=> setCoverMode('gradient')} />
                                                  <span>Gradient</span>
                                              </label>
                                              <label className="flex items-center space-x-2 text-sm">
                                                  <input type="radio" checked={coverMode==='image'} onChange={()=> setCoverMode('image')} />
                                                  <span>Image</span>
                                              </label>
                                          </div>
                                          {coverMode==='gradient' ? (
                                              <div className="grid grid-cols-4 gap-3">
                                                  {[
                                                      'from-rose-400 via-pink-300 to-rose-200',
                                                      'from-amber-400 via-orange-300 to-yellow-200',
                                                      'from-emerald-400 via-green-300 to-teal-200',
                                                      'from-sky-400 via-blue-300 to-indigo-200',
                                                      'from-violet-400 via-purple-300 to-fuchsia-200',
                                                      'from-pink-400 via-rose-300 to-red-200',
                                                      'from-cyan-400 via-blue-300 to-indigo-200',
                                                      'from-lime-400 via-green-300 to-emerald-200'
                                                  ].map(g => (
                                                      <button key={g} onClick={()=> setCoverGradient(g)} className={`h-12 rounded-xl border-2 transition-all hover:scale-105 ${coverGradient===g?'ring-2 ring-primary border-primary':'border-gray-200 hover:border-gray-300'}`}>
                                                          <div className={`w-full h-full rounded-lg bg-gradient-to-br ${g}`} />
                                                      </button>
                                                  ))}
                                              </div>
                                          ) : (
                                              <div className="space-y-2">
                                                  <button onClick={()=> coverInputRef.current && coverInputRef.current.click()} className="px-3 py-2 rounded-lg bg-gray-100 text-sm">Upload cover</button>
                                                  <input ref={coverInputRef} type="file" accept="image/*" className="hidden" onChange={(e)=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=> setCoverUrl(r.result); r.readAsDataURL(f); e.target.value=''; }} />
                                                  {coverUrl && (
                                                      <div>
                                                          <img src={coverUrl} alt="cover" className={`w-full max-h-32 ${coverFit==='contain' ? 'object-contain' : 'object-cover'} rounded-lg`} />
                                                          <div className="mt-2 flex items-center space-x-2 text-xs">
                                                              <span className="text-gray-600">Fit:</span>
                                                              <button onClick={()=>setCoverFit('cover')} className={`px-2 py-1 rounded ${coverFit==='cover'?'bg-primary text-white':'bg-gray-100 text-gray-700'}`}>Cover</button>
                                                              <button onClick={()=>setCoverFit('contain')} className={`px-2 py-1 rounded ${coverFit==='contain'?'bg-primary text-white':'bg-gray-100 text-gray-700'}`}>Contain</button>
                                                          </div>
                                                      </div>
                                                  )}
                                              </div>
                                          )}
                                      </div>

                                      {/* Rules */}
                                      <div>
                                          <label className="block text-sm font-medium text-gray-700 mb-2">Rules</label>
                                          <textarea value={rules} onChange={(e)=>setRules(e.target.value)} rows={3} className="w-full px-3 py-2 rounded-xl border border-gray-200 focus:outline-none" placeholder="Group rules (one per line)" />
                                      </div>

                                      {/* Coin Reward Info */}
                                      <div className="bg-gradient-to-r from-primary/10 to-secondary/10 rounded-xl p-3">
                                          <div className="flex items-center space-x-2">
                                              <span className="text-lg">ðŸª™</span>
                                              <span className="text-sm font-medium text-gray-700">
                                                  Earn 15 coins for creating a group!
                                              </span>
                                          </div>
                                      </div>
                                  </div>

                                  {/* Footer */}
                                  <div className="p-4 border-t border-gray-200">
                                      <button
                                          onClick={handleSubmit}
                                          disabled={!name.trim() || !description.trim() || isCreating}
                                          className={`w-full py-3 rounded-xl font-semibold transition-all btn-hover-lift ${
                                              (!name.trim() || !description.trim() || isCreating)
                                                  ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                                  : 'bg-primary text-white hover:bg-primary-dark'
                                          }`}
                                      >
                                          {isCreating ? (
                                              <div className="flex items-center justify-center space-x-2">
                                                  <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                  <span>Creating Group...</span>
                                              </div>
                                          ) : (
                                              'Create Group'
                                          )}
                                      </button>
                                  </div>
                              </div>
                          </div>

                      );
                  };

                  // ðŸ’¬ Enhanced Comment Modal with Full Features
                  const EnhancedCommentModal = ({ isOpen, onClose, post, onAddComment, onLikeComment, onUserClick }) => {
                      const [commentText, setCommentText] = useState('');
                      const [sortBy, setSortBy] = useState('newest');
                      const [isCommenting, setIsCommenting] = useState(false);
                      const [showEmojiPicker, setShowEmojiPicker] = useState(false);
                      const [comments, setComments] = useState([]);
                      const [replyingTo, setReplyingTo] = useState(null);

                      // Refresh comments: prefer Supabase, fallback to local storage
                      const refreshComments = useCallback(async () => {
                          if (!post?.id) return;
                          try {
                              if (window.OrbitApi?.comments?.listComments) {
                                  const rows = await window.OrbitApi.comments.listComments(post.id);
                                  const mapped = (rows || []).map(r => ({
                                      id: r.id,
                                      postId: r.post_id,
                                      parentId: r.parent_id || null,
                                      text: r.text,
                                      author: (StorageManager.load('me', null)?.name) || 'User',
                                      authorInitial: ((StorageManager.load('me', null)?.name || 'U')[0] || 'U').toUpperCase(),
                                      avatarColor: (StorageManager.load('me', null)?.avatarColor) || 'bg-primary',
                                      avatarUrl: (StorageManager.load('me', null)?.avatarUrl) || null,
                                      createdAt: Date.parse(r.created_at),
                                      time: r.created_at,
                                      likes: r.likes_count || 0,
                                      isLiked: false,
                                      replies: []
                                  }));
                                  const pinnedLocal = (() => {
                                      try {
                                          const local = StorageManager.load('comments', {}) || {};
                                          return Array.isArray(local[post.id]) ? local[post.id].filter(c => c?.isPinned) : [];
                                      } catch {
                                          return [];
                                      }
                                  })();
                                  const merged = [
                                      ...pinnedLocal,
                                      ...mapped.filter(c => !pinnedLocal.some(p => p.id === c.id))
                                  ];
                                  setComments(merged);
                                  return;
                              }
                          } catch (e) {
                              console.error('load comments from supabase failed, fallback to local', e);
                          }
                          const allComments = StorageManager.load('comments', {});
                          const postComments = allComments[post.id] || [];
                          setComments([...postComments]);
                      }, [post?.id]);

                      // Load comments initially and when modal opens
                      useEffect(() => {
                          if (isOpen && post?.id) {
                              refreshComments();
                          }
                      }, [isOpen, post?.id, refreshComments]);

                      // Force refresh when modal opens and every 1 second
                      useEffect(() => {
                          if (!isOpen || !post?.id) return;
                          refreshComments();
                          const interval = setInterval(() => { refreshComments(); }, 2000);
                          return () => clearInterval(interval);
                      }, [isOpen, post?.id, refreshComments]);

                      // Listen for storage changes (when comments are added)
                      useEffect(() => {
                          if (!isOpen || !post?.id) return;

                          const handleStorageChange = () => {
                              console.log('ðŸ”„ STORAGE CHANGED - Refreshing comments...');
                              refreshComments();
                          };

                          // Listen for storage events
                          window.addEventListener('storage', handleStorageChange);

                          // Also listen for custom events we'll dispatch when adding comments
                          window.addEventListener('commentsUpdated', handleStorageChange);

                          return () => {
                              window.removeEventListener('storage', handleStorageChange);
                              window.removeEventListener('commentsUpdated', handleStorageChange);
                          };
                      }, [isOpen, post?.id, refreshComments]);

                      if (!isOpen || !post) return null;

                      const quickEmojis = ['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ™', 'ðŸ¤”', 'ðŸ‘'];

                      const handleSubmitComment = async () => {
                          console.log('ðŸŽ¯ SUBMIT COMMENT CLICKED!');
                          console.log('ðŸ’­ Comment Text:', commentText);
                          console.log('ðŸ“ Post:', post);
                          console.log('âš¡ onAddComment function:', onAddComment);

                          if (!commentText.trim()) {
                              console.log('âŒ Comment text is empty');
                              return;
                          }

                          if (!onAddComment) {
                              console.log('âŒ onAddComment function is missing!');
                              return;
                          }

                          setIsCommenting(true);
                          console.log('ðŸ”„ Starting comment submission...');

                          try {
                              await new Promise(resolve => setTimeout(resolve, 800));

                              console.log('ðŸ“ž Calling onAddComment...');
                              onAddComment(post.id, commentText, replyingTo);

                              console.log('âœ… onAddComment called successfully');

                              // Reset form
                              setCommentText('');
                              setReplyingTo(null);
                              setShowEmojiPicker(false);
                          } catch (error) {
                              console.log('âŒ Error in handleSubmitComment:', error);
                          } finally {
                              setIsCommenting(false);
                          }
                      };

                      const handleEmojiClick = (emoji) => {
                          setCommentText(prev => prev + emoji);
                          setShowEmojiPicker(false);
                      };

                      const handleKeyDown = (e) => {
                          if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
                              e.preventDefault();
                              handleSubmitComment();
                          }
                      };

                      const getSortedComments = () => {
                          const pinned = comments.filter(c => c?.isPinned);
                          const regular = comments.filter(c => !c?.isPinned);
                          const sortByTimeDesc = (a, b) => {
                              const at = a.createdAt ?? Date.parse(a.time) ?? 0;
                              const bt = b.createdAt ?? Date.parse(b.time) ?? 0;
                              return bt - at;
                          };
                          const sortedPinned = [...pinned].sort(sortByTimeDesc);
                          const sortedRegular = (() => {
                              const sorted = [...regular];
                              if (sortBy === 'newest') {
                                  return sorted.sort(sortByTimeDesc);
                              } else if (sortBy === 'oldest') {
                                  return sorted.sort((a, b) => {
                                      const at = a.createdAt ?? Date.parse(a.time) ?? 0;
                                      const bt = b.createdAt ?? Date.parse(b.time) ?? 0;
                                      return at - bt;
                                  });
                              } else if (sortBy === 'popular') {
                                  return sorted.sort((a, b) => b.likes - a.likes);
                              }
                              return sorted;
                          })();
                          return [...sortedPinned, ...sortedRegular];
                      };

                      const handleLikeCommentLocal = (commentId) => {
                          onLikeComment(post.id, commentId);
                          // Update local state immediately for better UX
                          setComments(prev => prev.map(comment => {
                              if (comment.id === commentId) {
                                  const wasLiked = comment.isLiked;
                                  return {
                                      ...comment,
                                      isLiked: !wasLiked,
                                      likes: wasLiked ? comment.likes - 1 : comment.likes + 1
                                  };
                              }
                              return comment;
                          }));
                      };

                      const maxChars = 200;
                      const isOverLimit = commentText.length > maxChars;
                      const progressPercent = (commentText.length / maxChars) * 100;

                      return (
                          <div className="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50" onMouseDown={(e) => { if (e.target === e.currentTarget) onClose(); }}>
                              <div className="bg-white rounded-3xl w-full max-w-md mx-4 max-h-[90vh] overflow-hidden slide-up">
                                  {/* Header */}
                                  <div className="flex items-center justify-between p-4 border-b border-gray-200">
                                      <div className="flex items-center space-x-3">
                                          <button
                                              onClick={onClose}
                                              disabled={isCommenting}
                                              className="text-gray-500 hover:text-gray-700 disabled:opacity-50"
                                          >
                                              âœ•
                                          </button>
                                          <h2 className="text-lg font-bold">Comments</h2>
                                          <span className="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs font-medium">
                                              {comments.length}
                                          </span>
                                      </div>

                                      {/* Sort Options */}
                                      <div className="flex items-center space-x-2">
                                          <select
                                              value={sortBy}
                                              onChange={(e) => setSortBy(e.target.value)}
                                              className="text-sm bg-gray-100 rounded-lg px-2 py-1 border-none focus:outline-none focus:ring-2 focus:ring-primary"
                                          >
                                              <option value="newest">Newest</option>
                                              <option value="oldest">Oldest</option>
                                              <option value="popular">Popular</option>
                                          </select>
                                      </div>
                                  </div>

                                  {/* Post Preview */}
                                  <div className="p-4 border-b border-gray-100 bg-gray-50">
                                      <div className="flex items-center space-x-3 mb-3">
                                          {post.avatarUrl ? (
                                              <img src={post.avatarUrl} alt={post.author} className="w-8 h-8 rounded-full object-cover" />
                                          ) : (
                                              <div className={`w-8 h-8 ${post.avatarColor} rounded-full flex items-center justify-center`}>
                                                  <span className="text-white font-bold text-xs">{post.authorInitial}</span>
                                              </div>
                                          )}
                                          <div>
                                              <button className="font-semibold text-sm text-gray-900 hover:underline text-left" onClick={() => onUserClick && onUserClick(post.author)}>{post.author}</button>
                                              <p className="text-gray-500 text-xs">{getRelativePostTime(post)}</p>
                                          </div>
                                      </div>
                                      {(() => {
                                          const hasStructured = post && (post.title || post.details);
                                          let t = post?.title || null;
                                          let d = post?.details || null;
                                          if (!hasStructured && typeof post?.content === 'string') {
                                              const parts = post.content.split(/\n\s*\n/);
                                              if (parts.length > 1) { t = parts[0].trim(); d = parts.slice(1).join('\n\n').trim(); }
                                          }
                                          const summary = (d || post?.content || '').toString();
                                          const clipped = summary.length > 160 ? `${summary.substring(0, 160)}...` : summary;
                                          return (
                                              <div>
                                                  {t && <div className="text-sm font-bold text-gray-900 mb-1">{t}</div>}
                                                  <p className="text-gray-700 text-sm leading-relaxed whitespace-pre-line">{clipped}</p>
                                              </div>
                                          );
                                      })()}
                                      {post.image && (
                                          <div className="mt-3 rounded-xl overflow-hidden bg-gray-100 flex items-center justify-center">
                                              {post.image.type === 'file' ? (
                                                  <img src={post.image.url} alt="Post" className="w-full max-h-64 object-contain" />
                                              ) : (
                                                  <div className={`${post.image.bgColor} w-full h-32 flex items-center justify-center`}>
                                                      <span className="text-4xl">{post.image.emoji}</span>
                                                  </div>
                                              )}
                                          </div>
                                      )}
                                  </div>

                                  {/* Comments List */}
                                  <div className="flex-1 overflow-y-auto max-h-64">
                                      {comments.length > 0 ? (
                                          <div className="p-4 space-y-4">
                                              {getSortedComments().map((comment, index) => (
                                                  <div key={comment.id} className="flex items-start space-x-3">
                                          {comment.avatarUrl ? (
                                              <img src={comment.avatarUrl} alt={comment.author} className="w-8 h-8 rounded-full object-cover flex-shrink-0 cursor-pointer" onClick={() => onUserClick && onUserClick(comment.author)} />
                                          ) : (
                                              <div className={`w-8 h-8 ${comment.avatarColor} rounded-full flex items-center justify-center flex-shrink-0`}>
                                                  <span className="text-white font-bold text-xs">{comment.authorInitial}</span>
                                              </div>
                                          )}
                                          <div className="flex-1 min-w-0">
                                              <div className="bg-gray-100 rounded-2xl px-3 py-2 max-w-full">
                                                  <div className="flex items-center gap-2">
                                                      <button className="font-semibold text-sm text-gray-900 hover:underline text-left" onClick={() => onUserClick && onUserClick(comment.author)}>{comment.author}</button>
                                                      {comment.isPinned && (
                                                          <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-secondary/10 text-secondary text-[10px] font-semibold uppercase tracking-wide">
                                                              Sabit
                                                          </span>
                                                      )}
                                                  </div>
                                                  <p className="text-gray-700 text-sm leading-relaxed mt-1 break-all">{comment.text}</p>
                                              </div>
                                                          <div className="flex items-center space-x-4 mt-2 px-1">
                                                              <button
                                                                  onClick={() => handleLikeCommentLocal(comment.id)}
                                                                  className={`flex items-center space-x-1 text-xs ${
                                                                      comment.isLiked ? 'text-red-500' : 'text-gray-500'
                                                                  } hover:text-red-500 transition-colors`}
                                                              >
                                                                  <svg width="14" height="14" viewBox="0 0 24 24" fill={comment.isLiked ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2">
                                                                      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                                                  </svg>
                                                                  <span>{comment.likes}</span>
                                                              </button>
                                                              <button
                                                                  onClick={() => setReplyingTo(comment.id)}
                                                                  className="text-xs text-gray-500 hover:text-primary transition-colors"
                                                              >
                                                                  Reply
                                                              </button>
                                                              <span className="text-xs text-gray-400">{getRelativeCommentTime(comment)}</span>
                                                          </div>
                                                      </div>
                                                  </div>
                                              ))}
                                          </div>
                                      ) : (
                                          <div className="text-center py-16">
                                              <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#A1A1AA" strokeWidth="2">
                                                      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                                  </svg>
                                              </div>
                                              <h3 className="text-lg font-semibold text-gray-900 mb-2">No comments yet</h3>
                                              <p className="text-gray-500 text-sm">Be the first to share your thoughts!</p>
                                          </div>
                                      )}
                                  </div>

                                  {/* Reply Indicator */}
                                  {replyingTo && (
                                      <div className="px-4 py-2 bg-blue-50 border-b border-blue-100">
                                          <div className="flex items-center justify-between">
                                              <span className="text-sm text-blue-700">
                                                  Replying to {comments.find(c => c.id === replyingTo)?.author}
                                              </span>
                                              <button
                                                  onClick={() => setReplyingTo(null)}
                                                  className="text-blue-500 hover:text-blue-700 text-sm"
                                              >
                                                  Cancel
                                              </button>
                                          </div>
                                      </div>
                                  )}

                                  {/* Comment Input */}
                                  <div className="p-4 border-t border-gray-200">
                                      <div className="space-y-3">
                                          {/* Quick Emoji Reactions */}
                                          <div className="flex items-center space-x-2 overflow-x-auto scrollbar-hide">
                                              {quickEmojis.map(emoji => (
                                                  <button
                                                      key={emoji}
                                                      onClick={() => handleEmojiClick(emoji)}
                                                      className="flex-shrink-0 w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-lg transition-colors"
                                                  >
                                                      {emoji}
                                                  </button>
                                              ))}
                                              <button
                                                  onClick={() => setShowEmojiPicker(!showEmojiPicker)}
                                                  className="flex-shrink-0 w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-sm transition-colors"
                                              >
                                                  ðŸ˜€
                                              </button>
                                          </div>

                                          {/* Extended Emoji Picker */}
                                          {showEmojiPicker && (
                                              <div className="bg-gray-50 rounded-xl p-3">
                                                  <div className="grid grid-cols-8 gap-2">
                                                      {['ðŸ˜€', 'ðŸ˜ƒ', 'ðŸ˜„', 'ðŸ˜', 'ðŸ˜…', 'ðŸ˜‚', 'ðŸ¤£', 'ðŸ˜Š', 'ðŸ˜‡', 'ðŸ™‚', 'ðŸ™ƒ', 'ðŸ˜‰', 'ðŸ˜Œ', 'ðŸ˜', 'ðŸ¥°', 'ðŸ˜˜', 'ðŸ˜—', 'ðŸ˜™', 'ðŸ˜š', 'ðŸ˜‹', 'ðŸ˜›', 'ðŸ˜', 'ðŸ˜œ', 'ðŸ¤ª', 'ðŸ¤¨', 'ðŸ§', 'ðŸ¤“', 'ðŸ˜Ž', 'ðŸ¤©', 'ðŸ¥³', 'ðŸ˜', 'ðŸ˜’'].map(emoji => (
                                                          <button
                                                              key={emoji}
                                                              onClick={() => handleEmojiClick(emoji)}
                                                              className="w-8 h-8 rounded-lg hover:bg-gray-200 flex items-center justify-center text-lg transition-colors"
                                                          >
                                                              {emoji}
                                                          </button>
                                                      ))}
                                                  </div>
                                              </div>
                                          )}

                                          {/* Comment Text Input */}
                                          <div className="relative">
                                              <textarea
                                                  value={commentText}
                                                  onChange={(e) => setCommentText(e.target.value)}
                                                  onKeyDown={handleKeyDown}
                                                  placeholder={replyingTo ? "Write a reply..." : "Add a comment..."}
                                                  className="w-full p-3 border border-gray-200 rounded-xl resize-none focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 text-base transition-all"
                                                  rows={2}
                                                  disabled={isCommenting}
                                                  maxLength={maxChars}
                                              />
                                          </div>

                                          {/* Character Counter & Actions */}
                                          <div className="flex items-center justify-between">
                                              <div className="flex items-center space-x-3 text-sm">
                                                  <span className={`${isOverLimit ? 'text-red-500' : 'text-gray-500'}`}>
                                                      {commentText.length}/{maxChars}
                                                  </span>
                                                  <div className="w-16 h-1 bg-gray-200 rounded-full overflow-hidden">
                                                      <div
                                                          className={`h-full transition-all duration-300 ${
                                                              progressPercent > 90 ? 'bg-red-500' :
                                                              progressPercent > 75 ? 'bg-yellow-500' : 'bg-primary'
                                                          }`}
                                                          style={{ width: `${Math.min(progressPercent, 100)}%` }}
                                                      />
                                                  </div>
                                              </div>

                                              <button
                                                  onClick={handleSubmitComment}
                                                  disabled={!commentText.trim() || isOverLimit || isCommenting}
                                                  className={`px-4 py-2 rounded-xl font-semibold text-sm transition-all btn-hover-lift ${
                                                      (!commentText.trim() || isOverLimit || isCommenting)
                                                          ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                                          : 'bg-primary text-white hover:bg-primary-dark'
                                                  }`}
                                              >
                                                  {isCommenting ? (
                                                      <div className="flex items-center space-x-2">
                                                          <div className="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                          <span>Posting...</span>
                                                      </div>
                                                  ) : (
                                                      replyingTo ? 'Reply' : 'Comment'
                                                  )}
                                              </button>
                                          </div>

                                          {/* Coin Reward Info */}
                                          <div className="bg-gradient-to-r from-primary/10 to-secondary/10 rounded-xl p-3">
                                              <div className="flex items-center space-x-2">
                                                  <span className="text-lg">ðŸª™</span>
                                                  <span className="text-sm font-medium text-gray-700">
                                                      Earn 3 coins for commenting!
                                                  </span>
                                              </div>
                                          </div>

                                          {/* Keyboard Shortcut Hint */}
                                          <p className="text-center text-xs text-gray-400">
                                              Press âŒ˜+Enter (or Ctrl+Enter) to comment quickly
                                          </p>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      );
                  };

                  // Simple placeholder modals
                  const SimpleModal = ({ isOpen, onClose, title, children }) => {
                      if (!isOpen) return null;
                      return (
                          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onMouseDown={(e) => { if (e.target === e.currentTarget) onClose(); }}>
                              <div className="bg-white rounded-3xl w-full max-w-md mx-4 max-h-[80vh] overflow-hidden slide-up">
                                  <div className="flex items-center justify-between p-4 border-b border-gray-200">
                                      <h2 className="text-lg font-bold">{title}</h2>
                                      <button onClick={onClose} className="text-gray-500">âœ•</button>
                                  </div>
                                  <div className="p-4">
                                      {children}
                                  </div>
                              </div>
                          </div>
                      );
                  };

                  // HomeView Component
                  const HomeView = () => (
                      <div className="p-4">
                          <button
                              onClick={() => setIsCreatePostModalOpen(true)}
                              className="btn btn-primary w-full p-4 flex items-center justify-center shadow-md mb-4 transition"
                          >
                              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" className="mr-3">
                                  <path d="M12 5v14M5 12h14" stroke="white" strokeWidth="2" strokeLinecap="round" />
                              </svg>
                              <span className="font-semibold text-lg">Share your moment</span>
                          </button>

                          {posts.length === 0 ? (
                              <div className="text-center py-16">
                                  <div className="text-6xl mb-4">âœ¨</div>
                                  <h3 className="text-xl font-bold mb-2">No posts yet</h3>
                                  <p className="text-textSecondary text-sm mb-4">Be the first to share something!</p>
                                  <button
                                      onClick={() => setIsCreatePostModalOpen(true)}
                                      className="bg-mint text-white px-6 py-2 rounded-full font-semibold"
                                  >
                                      Create First Post
                                  </button>
                              </div>
                          ) : (
                              posts.map(post => (
                                  <PostCard
                                      key={post.id}
                                      post={post}
                                      onLike={handleLike}
                                      onCoinEarned={handleCoinEarned}
                                      onComment={handleComment}
                                      onAddComment={handleAddComment}
                                      onSave={handleSave}
                                      onShare={handleShare}
                                      onDelete={requestDeletePost}
                                      onUpdatePost={handleUpdatePost}
                                      onGroupClick={handleOpenGroupByRef}
                                      savedContent={savedContent}
                                      onUserClick={handleUserClick}
                                      currentUser={me}
                                  />
                              ))
                          )}
                      </div>
                  );

                  // ðŸŒ Community & Groups Component
                  const CommunityView = () => {
                      const [activeTab, setActiveTab] = useState('groups'); // legacy, not used widely
                      // Persist header tab so we return to the last section (For You / Explore / Groups)
                      const [headerTab, setHeaderTab] = useState(() => {
                          const stored = StorageManager.load('headerTab', 'groups');
                          return stored === 'tips' ? 'groups' : stored;
                      });
                      useEffect(() => { StorageManager.save('headerTab', headerTab); }, [headerTab]);
                      const [showCreateGroup, setShowCreateGroup] = useState(false);

                      // Sample groups data - in real app this would come from API
                      const sampleGroups = [
                          {
                              id: 1,
                              name: "New Mom Support",
                              description: "A supportive community for first-time mothers",
                              image: "",
                              color: "bg-rose-200",
                              coverGradient: "from-rose-400 via-pink-300 to-rose-200",
                              members: 1247,
                              category: "Support",
                              isPrivate: false,
                              recentActivity: "2 min ago"
                          },
                          {
                              id: 2,
                              name: "Baby Food Recipes",
                              description: "Healthy and easy recipes for little ones",
                              image: "",
                              color: "bg-amber-200",
                              coverGradient: "from-amber-400 via-orange-300 to-yellow-200",
                              members: 856,
                              category: "Food",
                              isPrivate: false,
                              recentActivity: "15 min ago"
                          },
                          {
                              id: 3,
                              name: "Playground Meetups",
                              description: "Local playground dates and activities",
                              image: "",
                              color: "bg-emerald-200",
                              coverGradient: "from-emerald-400 via-green-300 to-teal-200",
                              members: 324,
                              category: "Local",
                              isPrivate: false,
                              recentActivity: "1 hour ago"
                          },
                          {
                              id: 4,
                              name: "Working Moms",
                              description: "Balancing career and motherhood",
                              image: "",
                              color: "bg-sky-200",
                              coverGradient: "from-sky-400 via-blue-300 to-indigo-200",
                              members: 2134,
                              category: "Career",
                              isPrivate: false,
                              recentActivity: "3 hours ago"
                          },
                          {
                              id: 5,
                              name: "Sleep Training",
                              description: "Tips and support for better baby sleep",
                              image: "",
                              color: "bg-violet-200",
                              coverGradient: "from-violet-400 via-purple-300 to-fuchsia-200",
                              members: 687,
                              category: "Sleep",
                              isPrivate: false,
                              recentActivity: "5 hours ago"
                          },
                          {
                              id: 6,
                              name: "Toddler Activities",
                              description: "Fun activities for 1-3 year olds",
                              image: "",
                              color: "bg-rose-200",
                              coverGradient: "from-pink-400 via-rose-300 to-red-200",
                              members: 943,
                              category: "Activities",
                              isPrivate: false,
                              recentActivity: "1 day ago"
                          },
                          {
                              id: 7,
                              name: "Toddler Tantrums Help",
                              description: "Share strategies for managing toddler emotions",
                              image: "",
                              color: "bg-rose-200",
                              coverGradient: "from-rose-400 via-pink-300 to-rose-200",
                              members: 892,
                              category: "Support",
                              isPrivate: false,
                              recentActivity: "5 min ago"
                          },
                          {
                              id: 8,
                              name: "Postpartum Wellness",
                              description: "Supporting moms through postpartum recovery",
                              image: "",
                              color: "bg-rose-200",
                              coverGradient: "from-rose-400 via-pink-300 to-rose-200",
                              members: 1456,
                              category: "Support",
                              isPrivate: false,
                              recentActivity: "10 min ago"
                          },
                          {
                              id: 9,
                              name: "Single Moms Unite",
                              description: "Community for single mothers supporting each other",
                              image: "",
                              color: "bg-rose-200",
                              coverGradient: "from-rose-400 via-pink-300 to-rose-200",
                              members: 2341,
                              category: "Support",
                              isPrivate: false,
                              recentActivity: "15 min ago"
                          },
                          {
                              id: 10,
                              name: "Breastfeeding Support",
                              description: "Tips, advice, and encouragement for breastfeeding",
                              image: "",
                              color: "bg-rose-200",
                              coverGradient: "from-rose-400 via-pink-300 to-rose-200",
                              members: 1876,
                              category: "Support",
                              isPrivate: false,
                              recentActivity: "20 min ago"
                          },
                          {
                              id: 11,
                              name: "Mom Mental Health",
                              description: "Safe space for discussing mental health challenges",
                              image: "",
                              color: "bg-rose-200",
                              coverGradient: "from-rose-400 via-pink-300 to-rose-200",
                              members: 1123,
                              category: "Support",
                              isPrivate: false,
                              recentActivity: "25 min ago"
                          },
                          {
                              id: 12,
                              name: "Organic Baby Meals",
                              description: "Healthy organic recipes for babies",
                              image: "",
                              color: "bg-amber-200",
                              coverGradient: "from-amber-400 via-orange-300 to-yellow-200",
                              members: 654,
                              category: "Food",
                              isPrivate: false,
                              recentActivity: "3 min ago"
                          },
                          {
                              id: 13,
                              name: "Meal Prep for Moms",
                              description: "Quick and easy meal prep ideas for busy moms",
                              image: "",
                              color: "bg-amber-200",
                              coverGradient: "from-amber-400 via-orange-300 to-yellow-200",
                              members: 1234,
                              category: "Food",
                              isPrivate: false,
                              recentActivity: "8 min ago"
                          },
                          {
                              id: 14,
                              name: "Vegetarian Kids",
                              description: "Raising vegetarian children with balanced nutrition",
                              image: "",
                              color: "bg-amber-200",
                              coverGradient: "from-amber-400 via-orange-300 to-yellow-200",
                              members: 567,
                              category: "Food",
                              isPrivate: false,
                              recentActivity: "12 min ago"
                          },
                          {
                              id: 15,
                              name: "Allergy-Friendly Cooking",
                              description: "Recipes for kids with food allergies",
                              image: "",
                              color: "bg-amber-200",
                              coverGradient: "from-amber-400 via-orange-300 to-yellow-200",
                              members: 789,
                              category: "Food",
                              isPrivate: false,
                              recentActivity: "18 min ago"
                          },
                          {
                              id: 16,
                              name: "Quick Family Dinners",
                              description: "30-minute dinner ideas for the whole family",
                              image: "",
                              color: "bg-amber-200",
                              coverGradient: "from-amber-400 via-orange-300 to-yellow-200",
                              members: 2345,
                              category: "Food",
                              isPrivate: false,
                              recentActivity: "22 min ago"
                          },
                          {
                              id: 17,
                              name: "Istanbul Playdates",
                              description: "Organizing playdates in Istanbul",
                              image: "",
                              color: "bg-emerald-200",
                              coverGradient: "from-emerald-400 via-green-300 to-teal-200",
                              members: 432,
                              category: "Local",
                              isPrivate: false,
                              recentActivity: "4 min ago"
                          },
                          {
                              id: 18,
                              name: "Ankara Moms",
                              description: "Local community for moms in Ankara",
                              image: "",
                              color: "bg-emerald-200",
                              coverGradient: "from-emerald-400 via-green-300 to-teal-200",
                              members: 678,
                              category: "Local",
                              isPrivate: false,
                              recentActivity: "7 min ago"
                          },
                          {
                              id: 19,
                              name: "Izmir Family Events",
                              description: "Family-friendly events in Izmir",
                              image: "",
                              color: "bg-emerald-200",
                              coverGradient: "from-emerald-400 via-green-300 to-teal-200",
                              members: 543,
                              category: "Local",
                              isPrivate: false,
                              recentActivity: "11 min ago"
                          },
                          {
                              id: 20,
                              name: "Bursa Playgrounds",
                              description: "Best playgrounds and parks in Bursa",
                              image: "",
                              color: "bg-emerald-200",
                              coverGradient: "from-emerald-400 via-green-300 to-teal-200",
                              members: 321,
                              category: "Local",
                              isPrivate: false,
                              recentActivity: "16 min ago"
                          },
                          {
                              id: 21,
                              name: "Antalya Beach Moms",
                              description: "Beach activities and meetups in Antalya",
                              image: "",
                              color: "bg-emerald-200",
                              coverGradient: "from-emerald-400 via-green-300 to-teal-200",
                              members: 456,
                              category: "Local",
                              isPrivate: false,
                              recentActivity: "19 min ago"
                          },
                          {
                              id: 22,
                              name: "Remote Work Moms",
                              description: "Balancing remote work and motherhood",
                              image: "",
                              color: "bg-sky-200",
                              coverGradient: "from-sky-400 via-blue-300 to-indigo-200",
                              members: 1890,
                              category: "Career",
                              isPrivate: false,
                              recentActivity: "6 min ago"
                          },
                          {
                              id: 23,
                              name: "Entrepreneur Moms",
                              description: "Moms building their own businesses",
                              image: "",
                              color: "bg-sky-200",
                              coverGradient: "from-sky-400 via-blue-300 to-indigo-200",
                              members: 1456,
                              category: "Career",
                              isPrivate: false,
                              recentActivity: "9 min ago"
                          },
                          {
                              id: 24,
                              name: "Returning to Work",
                              description: "Support for moms returning to the workforce",
                              image: "",
                              color: "bg-sky-200",
                              coverGradient: "from-sky-400 via-blue-300 to-indigo-200",
                              members: 1123,
                              category: "Career",
                              isPrivate: false,
                              recentActivity: "13 min ago"
                          },
                          {
                              id: 25,
                              name: "Tech Moms",
                              description: "Women in tech balancing career and family",
                              image: "",
                              color: "bg-sky-200",
                              coverGradient: "from-sky-400 via-blue-300 to-indigo-200",
                              members: 987,
                              category: "Career",
                              isPrivate: false,
                              recentActivity: "17 min ago"
                          },
                          {
                              id: 26,
                              name: "Freelance Moms",
                              description: "Freelancing while raising children",
                              image: "",
                              color: "bg-sky-200",
                              coverGradient: "from-sky-400 via-blue-300 to-indigo-200",
                              members: 765,
                              category: "Career",
                              isPrivate: false,
                              recentActivity: "21 min ago"
                          },
                          {
                              id: 27,
                              name: "Baby Sleep Training",
                              description: "Methods and tips for better baby sleep",
                              image: "",
                              color: "bg-indigo-200",
                              coverGradient: "from-indigo-400 via-purple-300 to-indigo-200",
                              members: 2341,
                              category: "Sleep",
                              isPrivate: false,
                              recentActivity: "2 min ago"
                          },
                          {
                              id: 28,
                              name: "Toddler Bedtime Routines",
                              description: "Creating peaceful bedtime routines",
                              image: "",
                              color: "bg-indigo-200",
                              coverGradient: "from-indigo-400 via-purple-300 to-indigo-200",
                              members: 1678,
                              category: "Sleep",
                              isPrivate: false,
                              recentActivity: "5 min ago"
                          },
                          {
                              id: 29,
                              name: "Co-Sleeping Support",
                              description: "Safe co-sleeping practices and advice",
                              image: "",
                              color: "bg-indigo-200",
                              coverGradient: "from-indigo-400 via-purple-300 to-indigo-200",
                              members: 890,
                              category: "Sleep",
                              isPrivate: false,
                              recentActivity: "8 min ago"
                          },
                          {
                              id: 30,
                              name: "Sleep Deprived Moms",
                              description: "Support for exhausted moms",
                              image: "",
                              color: "bg-indigo-200",
                              coverGradient: "from-indigo-400 via-purple-300 to-indigo-200",
                              members: 3456,
                              category: "Sleep",
                              isPrivate: false,
                              recentActivity: "12 min ago"
                          },
                          {
                              id: 31,
                              name: "Nap Time Strategies",
                              description: "Helping kids take better naps",
                              image: "",
                              color: "bg-indigo-200",
                              coverGradient: "from-indigo-400 via-purple-300 to-indigo-200",
                              members: 1234,
                              category: "Sleep",
                              isPrivate: false,
                              recentActivity: "15 min ago"
                          },
                          {
                              id: 32,
                              name: "Outdoor Adventures",
                              description: "Hiking and outdoor activities with kids",
                              image: "",
                              color: "bg-purple-200",
                              coverGradient: "from-purple-400 via-pink-300 to-purple-200",
                              members: 987,
                              category: "Activities",
                              isPrivate: false,
                              recentActivity: "3 min ago"
                          },
                          {
                              id: 33,
                              name: "Arts & Crafts Moms",
                              description: "Creative activities and crafts for kids",
                              image: "",
                              color: "bg-purple-200",
                              coverGradient: "from-purple-400 via-pink-300 to-purple-200",
                              members: 1456,
                              category: "Activities",
                              isPrivate: false,
                              recentActivity: "7 min ago"
                          },
                          {
                              id: 34,
                              name: "Swimming Lessons",
                              description: "Swimming classes and water safety",
                              image: "",
                              color: "bg-purple-200",
                              coverGradient: "from-purple-400 via-pink-300 to-purple-200",
                              members: 678,
                              category: "Activities",
                              isPrivate: false,
                              recentActivity: "10 min ago"
                          },
                          {
                              id: 35,
                              name: "Music & Movement",
                              description: "Music classes and dance for toddlers",
                              image: "",
                              color: "bg-purple-200",
                              coverGradient: "from-purple-400 via-pink-300 to-purple-200",
                              members: 543,
                              category: "Activities",
                              isPrivate: false,
                              recentActivity: "14 min ago"
                          },
                          {
                              id: 36,
                              name: "Library Story Time",
                              description: "Story time and reading activities",
                              image: "",
                              color: "bg-purple-200",
                              coverGradient: "from-purple-400 via-pink-300 to-purple-200",
                              members: 890,
                              category: "Activities",
                              isPrivate: false,
                              recentActivity: "18 min ago"
                          },
                          {
                              id: 37,
                              name: "Pregnancy Support",
                              description: "Support during pregnancy journey",
                              image: "",
                              color: "bg-rose-200",
                              coverGradient: "from-rose-400 via-pink-300 to-rose-200",
                              members: 2123,
                              category: "Support",
                              isPrivate: false,
                              recentActivity: "4 min ago"
                          },
                          {
                              id: 38,
                              name: "Special Needs Parenting",
                              description: "Support for parents of special needs children",
                              image: "",
                              color: "bg-rose-200",
                              coverGradient: "from-rose-400 via-pink-300 to-rose-200",
                              members: 1234,
                              category: "Support",
                              isPrivate: false,
                              recentActivity: "9 min ago"
                          },
                          {
                              id: 39,
                              name: "Blended Families",
                              description: "Navigating step-parenting and blended families",
                              image: "",
                              color: "bg-rose-200",
                              coverGradient: "from-rose-400 via-pink-300 to-rose-200",
                              members: 567,
                              category: "Support",
                              isPrivate: false,
                              recentActivity: "13 min ago"
                          },
                          {
                              id: 40,
                              name: "Gluten-Free Kids",
                              description: "Gluten-free recipes and meal ideas",
                              image: "",
                              color: "bg-amber-200",
                              coverGradient: "from-amber-400 via-orange-300 to-yellow-200",
                              members: 432,
                              category: "Food",
                              isPrivate: false,
                              recentActivity: "6 min ago"
                          },
                          {
                              id: 41,
                              name: "Baby-Led Weaning",
                              description: "BLW recipes and feeding tips",
                              image: "",
                              color: "bg-amber-200",
                              coverGradient: "from-amber-400 via-orange-300 to-yellow-200",
                              members: 1890,
                              category: "Food",
                              isPrivate: false,
                              recentActivity: "11 min ago"
                          },
                          {
                              id: 42,
                              name: "Ankara Family Fun",
                              description: "Family activities and events in Ankara",
                              image: "",
                              color: "bg-emerald-200",
                              coverGradient: "from-emerald-400 via-green-300 to-teal-200",
                              members: 765,
                              category: "Local",
                              isPrivate: false,
                              recentActivity: "8 min ago"
                          },
                          {
                              id: 43,
                              name: "Istanbul Weekend Plans",
                              description: "Weekend activities for families in Istanbul",
                              image: "",
                              color: "bg-emerald-200",
                              coverGradient: "from-emerald-400 via-green-300 to-teal-200",
                              members: 2345,
                              category: "Local",
                              isPrivate: false,
                              recentActivity: "12 min ago"
                          },
                          {
                              id: 44,
                              name: "Part-Time Work Moms",
                              description: "Balancing part-time work and family",
                              image: "",
                              color: "bg-sky-200",
                              coverGradient: "from-sky-400 via-blue-300 to-indigo-200",
                              members: 987,
                              category: "Career",
                              isPrivate: false,
                              recentActivity: "7 min ago"
                          },
                          {
                              id: 45,
                              name: "Night Shift Moms",
                              description: "Moms working night shifts",
                              image: "",
                              color: "bg-sky-200",
                              coverGradient: "from-sky-400 via-blue-300 to-indigo-200",
                              members: 654,
                              category: "Career",
                              isPrivate: false,
                              recentActivity: "14 min ago"
                          },
                          {
                              id: 46,
                              name: "Early Morning Routines",
                              description: "Starting the day right with kids",
                              image: "",
                              color: "bg-indigo-200",
                              coverGradient: "from-indigo-400 via-purple-300 to-indigo-200",
                              members: 1234,
                              category: "Sleep",
                              isPrivate: false,
                              recentActivity: "5 min ago"
                          },
                          {
                              id: 47,
                              name: "Sleep Regression Help",
                              description: "Dealing with sleep regressions",
                              image: "",
                              color: "bg-indigo-200",
                              coverGradient: "from-indigo-400 via-purple-300 to-indigo-200",
                              members: 2341,
                              category: "Sleep",
                              isPrivate: false,
                              recentActivity: "10 min ago"
                          },
                          {
                              id: 48,
                              name: "Soccer Moms",
                              description: "Youth soccer and sports activities",
                              image: "",
                              color: "bg-purple-200",
                              coverGradient: "from-purple-400 via-pink-300 to-purple-200",
                              members: 1678,
                              category: "Activities",
                              isPrivate: false,
                              recentActivity: "6 min ago"
                          },
                          {
                              id: 49,
                              name: "Science Experiments",
                              description: "Fun science activities for kids",
                              image: "",
                              color: "bg-purple-200",
                              coverGradient: "from-purple-400 via-pink-300 to-purple-200",
                              members: 890,
                              category: "Activities",
                              isPrivate: false,
                              recentActivity: "11 min ago"
                          },
                          {
                              id: 50,
                              name: "Adoption Support",
                              description: "Support for adoptive parents",
                              image: "",
                              color: "bg-rose-200",
                              coverGradient: "from-rose-400 via-pink-300 to-rose-200",
                              members: 432,
                              category: "Support",
                              isPrivate: false,
                              recentActivity: "8 min ago"
                          },
                          {
                              id: 51,
                              name: "Vegan Family Meals",
                              description: "Plant-based recipes for the whole family",
                              image: "",
                              color: "bg-amber-200",
                              coverGradient: "from-amber-400 via-orange-300 to-yellow-200",
                              members: 765,
                              category: "Food",
                              isPrivate: false,
                              recentActivity: "13 min ago"
                          },
                          {
                              id: 52,
                              name: "Izmir Nature Walks",
                              description: "Nature walks and outdoor activities in Izmir",
                              image: "",
                              color: "bg-emerald-200",
                              coverGradient: "from-emerald-400 via-green-300 to-teal-200",
                              members: 543,
                              category: "Local",
                              isPrivate: false,
                              recentActivity: "9 min ago"
                          },
                          {
                              id: 53,
                              name: "Work-Life Balance",
                              description: "Finding balance between work and family",
                              image: "",
                              color: "bg-sky-200",
                              coverGradient: "from-sky-400 via-blue-300 to-indigo-200",
                              members: 3456,
                              category: "Career",
                              isPrivate: false,
                              recentActivity: "4 min ago"
                          },
                          {
                              id: 54,
                              name: "Bedtime Stories",
                              description: "Sharing favorite bedtime stories",
                              image: "",
                              color: "bg-indigo-200",
                              coverGradient: "from-indigo-400 via-purple-300 to-indigo-200",
                              members: 2123,
                              category: "Sleep",
                              isPrivate: false,
                              recentActivity: "7 min ago"
                          },
                          {
                              id: 55,
                              name: "Yoga for Moms & Kids",
                              description: "Yoga classes for mothers and children",
                              image: "",
                              color: "bg-purple-200",
                              coverGradient: "from-purple-400 via-pink-300 to-purple-200",
                              members: 1234,
                              category: "Activities",
                              isPrivate: false,
                              recentActivity: "12 min ago"
                          },
                          {
                              id: 56,
                              name: "Homeschooling Moms",
                              description: "Resources and support for homeschooling",
                              image: "",
                              color: "bg-purple-200",
                              coverGradient: "from-purple-400 via-pink-300 to-purple-200",
                              members: 1890,
                              category: "Activities",
                              isPrivate: false,
                              recentActivity: "16 min ago"
                          }
                      ];

                      // Initialize sample groups - merge with existing groups
                      React.useEffect(() => {
                          const existingGroupIds = new Set(allGroups.map(g => g.id));
                          const newGroups = sampleGroups.filter(g => !existingGroupIds.has(g.id));
                          
                          if (newGroups.length > 0 || allGroups.length === 0) {
                              const mergedGroups = allGroups.length === 0 
                                  ? sampleGroups 
                                  : [...allGroups, ...newGroups];
                              setAllGroups(mergedGroups);
                              StorageManager.save('allGroups', mergedGroups);
                          }
                      }, []);

                      const categories = ['All', 'My Groups', 'Support', 'Food', 'Local', 'Career', 'Sleep', 'Activities'];
                      const [selectedCategory, setSelectedCategory] = useState(() => {
                          return StorageManager.load('selectedCategory', 'All');
                      });
                      
                      // Persist selectedCategory to localStorage
                      React.useEffect(() => {
                          StorageManager.save('selectedCategory', selectedCategory);
                      }, [selectedCategory]);

                      const groupsSource = useMemo(
                          () => (allGroups.length > 0 ? allGroups : sampleGroups),
                          [allGroups]
                      );

                      const getFilteredGroups = () => {
                          const groupsToShow = groupsSource;
                          if (selectedCategory === 'All') return groupsToShow;
                          if (selectedCategory === 'My Groups') return groupsToShow.filter(group => joinedGroups.includes(group.id));
                          return groupsToShow.filter(group => group.category === selectedCategory);
                      };

                      const myGroups = useMemo(
                          () => groupsSource.filter(group => joinedGroups.includes(group.id)),
                          [groupsSource, joinedGroups]
                      );

                      const getMyGroups = () => myGroups;

                      const memberRegistry = useMemo(() => StorageManager.load('groupMembers', {}), [joinedGroups, allGroups]);

                      const getMemberCount = useCallback(
                          (group) => {
                              const stored = memberRegistry?.[group.id];
                              if (Array.isArray(stored) && stored.length) return stored.length;
                              if (typeof group.members === 'number') return group.members;
                              return 0;
                          },
                          [memberRegistry]
                      );

                      const categoryStats = useMemo(() => {
                          const stats = {};
                          groupsSource.forEach(group => {
                              const key = group.category || 'Other';
                              if (!stats[key]) stats[key] = { groups: 0, members: 0 };
                              stats[key].groups += 1;
                              stats[key].members += getMemberCount(group);
                          });
                          stats['My Groups'] = {
                              groups: myGroups.length,
                              members: myGroups.reduce((sum, group) => sum + getMemberCount(group), 0)
                          };
                          return stats;
                      }, [groupsSource, myGroups, getMemberCount]);

                      const categoryCards = useMemo(() => [
                          {
                              key: 'My Groups',
                              headline: 'Sana Ã¶zel',
                              title: 'My Groups',
                              subtitle: 'KatÄ±ldÄ±ÄŸÄ±n topluluklarÄ± tek dokunuÅŸla aÃ§',
                              image: 'https://images.unsplash.com/photo-1523875194681-bedd468c58bf?w=1200&q=80&auto=format&fit=crop',
                              gradient: 'linear-gradient(135deg, #5BAE9F 0%, #7FB7A8 50%, #97C5B8 100%)',
                              stats: categoryStats['My Groups'] || { groups: 0, members: 0 }
                          },
                              {
                                  key: 'Support',
                              headline: 'Destek paylaÅŸÄ±mlarÄ±',
                              title: 'Support',
                              subtitle: 'Uyku, emzirme ve doÄŸum sonrasÄ± desteÄŸi',
                              image: 'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=1200&q=80&auto=format&fit=crop',
                              gradient: 'linear-gradient(135deg, #F87171 0%, #FB7185 50%, #FCA5A5 100%)',
                              stats: categoryStats['Support'] || { groups: 0, members: 0 }
                              },
                              {
                                  key: 'Food',
                              headline: 'Ek gÄ±da & tarifler',
                              title: 'Food',
                              subtitle: 'Besleyici menÃ¼ler ve mutfak fikirleri',
                              image: 'https://images.unsplash.com/photo-1498837167922-ddd27525d352?w=1200&q=80&auto=format&fit=crop',
                              gradient: 'linear-gradient(135deg, #F59E0B 0%, #FBBF24 50%, #FCD34D 100%)',
                              stats: categoryStats['Food'] || { groups: 0, members: 0 }
                              },
                              {
                                  key: 'Local',
                              headline: 'Mahallenden anneler',
                              title: 'Local',
                              subtitle: 'Yerel etkinlikler ve buluÅŸmalar',
                              image: 'https://images.unsplash.com/photo-1528909514045-2fa4ac7a08ba?w=1200&q=80&auto=format&fit=crop',
                              gradient: 'linear-gradient(135deg, #10B981 0%, #34D399 50%, #6EE7B7 100%)',
                              stats: categoryStats['Local'] || { groups: 0, members: 0 }
                              },
                              {
                                  key: 'Career',
                              headline: 'Ã‡alÄ±ÅŸan anneler',
                              title: 'Career',
                              subtitle: 'Ä°ÅŸ ve anneliÄŸi dengeleyen hikayeler',
                              image: 'https://images.unsplash.com/photo-1521737604893-d14cc237f11d?w=1200&q=80&auto=format&fit=crop',
                              gradient: 'linear-gradient(135deg, #3B82F6 0%, #60A5FA 50%, #93C5FD 100%)',
                              stats: categoryStats['Career'] || { groups: 0, members: 0 }
                              },
                              {
                                  key: 'Sleep',
                              headline: 'Rutin & uyku ipuÃ§larÄ±',
                              title: 'Sleep',
                              subtitle: 'Uyku eÄŸitimi ve sakin ritÃ¼eller',
                              image: 'https://images.unsplash.com/photo-1522844990619-4951c40f7eda?w=1200&q=80&auto=format&fit=crop',
                              gradient: 'linear-gradient(135deg, #6366F1 0%, #818CF8 50%, #A78BFA 100%)',
                              stats: categoryStats['Sleep'] || { groups: 0, members: 0 }
                              },
                              {
                                  key: 'Activities',
                              headline: 'Oyun & keÅŸif fikirleri',
                              title: 'Activities',
                              subtitle: 'Duyusal oyunlar ve gÃ¼nlÃ¼k aktiviteler',
                              image: 'https://images.unsplash.com/photo-1502082553048-f009c37129b9?w=1200&q=80&auto=format&fit=crop',
                              gradient: 'linear-gradient(135deg, #A855F7 0%, #C084FC 50%, #D8B4FE 100%)',
                              stats: categoryStats['Activities'] || { groups: 0, members: 0 }
                          }
                      ], [categoryStats]);

                      const handleJoinGroup = (groupId, isLeaving = false) => {
                              const gm = StorageManager.load('groupMembers', {}) || {};
                              const key = String(groupId);
                              const list = Array.isArray(gm[key]) ? gm[key] : [];
                          const isJoined = joinedGroups.includes(groupId);

                          if (isLeaving || isJoined) {
                              setJoinedGroups(prev => prev.filter(id => id !== groupId));
                              gm[key] = list.filter(u => u !== me.username);
                          } else {
                              setJoinedGroups(prev => [...prev, groupId]);
                              gm[key] = Array.from(new Set([...list, me.username]));
                              // Note: Group joining coins removed per new system
                              // handleCoinEarned(10); // Earn coins for joining
                              }

                          StorageManager.save('groupMembers', gm);
                      };

                      const GROUP_CATEGORY_COLORS = {
                          Support: { gradient: 'from-rose-100 via-rose-200 to-rose-300', text: 'text-rose-600', inner: 'bg-white/40' },
                          Food: { gradient: 'from-amber-100 via-yellow-200 to-amber-300', text: 'text-amber-600', inner: 'bg-white/40' },
                          Local: { gradient: 'from-emerald-100 via-teal-200 to-emerald-300', text: 'text-emerald-600', inner: 'bg-white/40' },
                          Career: { gradient: 'from-sky-100 via-blue-200 to-sky-300', text: 'text-sky-600', inner: 'bg-white/40' },
                          Sleep: { gradient: 'from-indigo-100 via-indigo-200 to-indigo-300', text: 'text-indigo-600', inner: 'bg-white/35' },
                          Activities: { gradient: 'from-purple-100 via-purple-200 to-purple-300', text: 'text-purple-600', inner: 'bg-white/40' }
                      };

                      const GroupListCard = ({ group, memberCount, isJoined, onJoin, onClick }) => {
                          const palette = GROUP_CATEGORY_COLORS[group.category] || { gradient: 'from-gray-100 via-gray-200 to-gray-300', text: 'text-gray-600', inner: 'bg-white/40' };
                          const joinLabel = isJoined ? 'Leave' : 'Join';
                          const joinClass = isJoined
                              ? 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                              : 'bg-[#7FB7A8] text-white hover:bg-[#6FAF9D]';

                          return (
                              <div className="flex items-center justify-between rounded-[28px] border border-gray-200 bg-white px-4 py-4 shadow-[0_18px_45px_-32px_rgba(91,174,155,0.55)] transition-transform hover:-translate-y-0.5">
                                  <div 
                                      className="flex items-center gap-3 min-w-0 flex-1 cursor-pointer"
                                      onClick={(e) => {
                                          e.stopPropagation();
                                          if (onClick) onClick(group);
                                      }}
                                  >
                                      <div className={`flex h-12 w-12 items-center justify-center rounded-[18px] bg-gradient-to-br ${palette.gradient}`}>
                                          <div className={`flex h-8 w-8 items-center justify-center rounded-2xl ${palette.inner}`}>
                                              <span className={`text-sm font-semibold ${palette.text}`}>{(group.name || 'G')[0]?.toUpperCase()}</span>
                                              </div>
                                                                  </div>
                                      <div className="min-w-0">
                                          <p className="text-base font-semibold text-gray-900 truncate">{group.name}</p>
                                          <div className="mt-1 flex items-center gap-2 text-xs text-gray-500">
                                              <span className="inline-flex items-center gap-1">
                                                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                      <path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2" />
                                                      <circle cx="9" cy="7" r="4" />
                                                      <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                                                      <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                                                  </svg>
                                                  {memberCount.toLocaleString()}
                                                                              </span>
                                              <span className="h-1 w-1 rounded-full bg-gray-300"></span>
                                              <span className="capitalize">{group.category}</span>
                                                                      </div>
                                                                  </div>
                                                              </div>
                                                              <button
                                      onClick={(e) => {
                                          e.stopPropagation();
                                          if (onJoin) onJoin();
                                      }}
                                      className={`rounded-full px-4 py-2 text-sm font-semibold transition-all ${joinClass}`}
                                                              >
                                      {joinLabel}
                                                              </button>
                              </div>
                          );
                      };

                      // Sample posts data for feed views (cleared)
                      const sampleGroupPosts = [];

                      // For You View - Posts from joined groups
                      const ForYouView = () => {
                          const [subTab, setSubTab] = useState('all'); // all | posts | polls
                          const myGroups = getMyGroups();
                          const allGroupPostsList = Object.entries(groupPosts || {}).flatMap(([gid, arr]) => (arr || []).map(p => ({...p, groupId: Number(gid)})));
                          const relevantBase = myGroups.length > 0
                              ? allGroupPostsList.filter(p => myGroups.some(g => g.id === p.groupId))
                              : [];
                          const postsOnly = relevantBase.filter(p => !p.poll);
                          const pollsOnly = relevantBase.filter(p => p.poll && Array.isArray(p.poll.options) && p.poll.options.length > 0);
                          const toShow = subTab === 'all' ? relevantBase : subTab === 'posts' ? postsOnly : pollsOnly;

                          return (
                              <div className="px-4 space-y-4">
                                  <div className="text-center py-2">
                                      <h3 className="text-lg font-bold text-gray-900 mb-2">Latest from your groups</h3>
                                      <p className="text-gray-500 text-sm">Posts from {myGroups.length} joined groups</p>
                                  </div>

                                  {/* Sub tabs like Explore */}
                                  <div className="sticky top-0 z-10 bg-white/95 backdrop-blur border-b border-border flex items-center space-x-2 justify-center py-2">
                                      {['all','posts','polls'].map(key => (
                                          <button
                                              key={key}
                                              onClick={() => setSubTab(key)}
                                              className={`px-4 py-1.5 rounded-full text-sm font-medium transition-colors ${
                                                  subTab === key ? 'bg-primary text-white shadow-sm' : 'bg-gray-100 text-textSecondary hover:bg-gray-200'
                                              }`}
                                              role="tab"
                                              aria-selected={subTab === key}
                                          >
                                              {key === 'all' ? 'All' : key === 'posts' ? `Posts${postsOnly.length ? ` (${postsOnly.length})` : ''}` : `Polls${pollsOnly.length ? ` (${pollsOnly.length})` : ''}`}
                                          </button>
                                      ))}
                                  </div>

                                  {toShow.length > 0 ? (
                                      [...toShow].sort((a,b)=> (getTimestamp(b.createdAt ?? b.time ?? b.id) ?? 0) - (getTimestamp(a.createdAt ?? a.time ?? a.id) ?? 0)).map(post => (
                                          <PostCard
                                              key={post.id}
                                              post={post}
                                              onLike={handleLike}
                                              onCoinEarned={handleCoinEarned}
                                              onComment={handleComment}
                                              onAddComment={handleAddComment}
                                              onSave={handleSave}
                                              onShare={handleShare}
                                              onDelete={requestDeletePost}
                                              onUpdatePost={handleUpdatePost}
                                              onGroupClick={handleOpenGroupByRef}
                                              savedContent={savedContent}
                                              currentUser={me}
                                              onUserClick={handleUserClick}
                                          />
                                      ))
                                  ) : (
                                      <div className="text-center py-16">
                                          <div className="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                              <span className="text-4xl">ðŸ“±</span>
                                          </div>
                                          <h3 className="text-xl font-bold text-gray-900 mb-2">Join groups to see posts</h3>
                                          <p className="text-gray-500 text-sm mb-6 max-w-xs mx-auto">
                                              Join some groups to see posts from your community here
                                          </p>
                                          <button
                                              onClick={() => setHeaderTab('groups')}
                                              className="bg-primary text-white px-6 py-3 rounded-full font-semibold hover:bg-primary-dark transition-colors btn-hover-lift"
                                          >
                                              Browse Groups
                                          </button>
                                      </div>
                                  )}
                              </div>
                          );
                      };

                      // Explore View - All posts from all groups
                      const ExploreView = () => {
                          const [subTab, setSubTab] = useState('all'); // all | posts | polls
                          const list = Object.values(groupPosts || {}).flatMap(arr => arr || []);
                          const onlyPublic = (post) => {
                              try {
                                  const grp = (allGroups || []).find(g => g.id === post.groupId || g.name === post.groupName);
                                  if (!grp) return true; // default to public if unknown
                                  const isPriv = !!grp.isPrivate || (grp.privacy && grp.privacy !== 'public');
                                  return !isPriv;
                              } catch { return true; }
                          };
                          const base = (list.length > 0 ? list : sampleGroupPosts).filter(onlyPublic);
                          const postsOnly = base.filter(p => !p.poll);
                          const pollsOnly = base.filter(p => p.poll && Array.isArray(p.poll.options) && p.poll.options.length > 0);
                          const toShow = subTab === 'all' ? base : subTab === 'posts' ? postsOnly : pollsOnly;

                          return (
                            <div className="px-4 space-y-4">
                              <div className="text-center py-2">
                                <h3 className="text-lg font-bold text-gray-900">Explore Community</h3>
                                <p className="text-sm text-textSecondary">Discover posts from all groups</p>
                              </div>

                              {/* Sub tabs */}
                              <div className="sticky top-0 z-10 bg-white/95 backdrop-blur border-b border-border flex items-center space-x-2 justify-center py-2">
                                {['all','posts','polls'].map(key => (
                                  <button
                                    key={key}
                                    onClick={() => setSubTab(key)}
                                    className={`px-4 py-1.5 rounded-full text-sm font-medium transition-colors ${
                                      subTab === key ? 'bg-primary text-white shadow-sm' : 'bg-gray-100 text-textSecondary hover:bg-gray-200'
                                    }`}
                                    role="tab"
                                    aria-selected={subTab === key}
                                  >
                                    {key === 'all' ? 'All' : key === 'posts' ? `Posts${postsOnly.length ? ` (${postsOnly.length})` : ''}` : `Polls${pollsOnly.length ? ` (${pollsOnly.length})` : ''}`}
                                  </button>
                                ))}
                              </div>

                              {toShow.length === 0 ? (
                                <div className="text-center py-12 text-textSecondary">No items yet</div>
                              ) : (
                                [...toShow].sort((a,b)=> (getTimestamp(b.createdAt ?? b.time ?? b.id) ?? 0) - (getTimestamp(a.createdAt ?? a.time ?? a.id) ?? 0)).map(post => (
                                  <PostCard
                                    key={post.id}
                                    post={post}
                                    onLike={handleLike}
                                    onCoinEarned={handleCoinEarned}
                                    onComment={handleComment}
                                    onAddComment={handleAddComment}
                                    onSave={handleSave}
                                    onShare={handleShare}
                                    onDelete={requestDeletePost}
                                    onUpdatePost={handleUpdatePost}
                                    onGroupClick={handleOpenGroupByRef}
                                    savedContent={savedContent}
                                    currentUser={me}
                                    onUserClick={handleUserClick}
                                    blurred={(function(){
                                      try {
                                        const grp = (allGroups||[]).find(g => g.id === post.groupId || g.name === post.groupName);
                                        if (!grp) return false;
                                        const isPriv = !!grp.isPrivate || grp.privacy === 'invite';
                                        return isPriv && !(joinedGroups||[]).includes(grp.id);
                                      } catch { return false; }
                                    })()}
                                  />
                                ))
                              )}
                            </div>
                          );
                      }

                      // Groups View - With Category filters at the top


                      const GroupsView = () => {
                          const filteredGroups = getFilteredGroups();
                          const isAll = selectedCategory === 'All';

                          return (
                              <div className="space-y-4">
                                  <div className="px-4">
                                      <div className="flex items-center gap-2 overflow-x-auto scrollbar-hide py-2">
                                          {categories.map(category => {
                                              const isActive = selectedCategory === category;
                                              return (
                                                  <button
                                                      key={category}
                                                      onClick={() => setSelectedCategory(category)}
                                                      className={`rounded-full px-3 py-1.5 text-xs font-semibold whitespace-nowrap transition-all ${
                                                          isActive
                                                              ? 'bg-gradient-to-r from-primary to-secondary text-white shadow-sm'
                                                              : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                                      }`}
                                                  >
                                                      {category}
                                                  </button>
                                              );
                                          })}
                                      </div>
                                  </div>

                                  <div className="px-4">
                                      <button
                                          type="button"
                                          onClick={() => setShowCreateGroup(true)}
                                          className="w-full rounded-[28px] border border-gray-200 bg-white px-4 py-2.5 text-center text-sm font-medium text-[#97B9B1] hover:bg-gray-50 transition-all"
                                      >
                                          + Create Group
                                      </button>
                                  </div>

                                  {isAll ? (
                                      <div className="px-4 space-y-4 pb-6">
                                          {categoryCards.map(card => {
                                              const stats = card.stats || { groups: 0, members: 0 };
                                              const groupLabel = `${stats.groups} grup`;
                                              const memberLabel = stats.members ? `${stats.members.toLocaleString()} anne` : null;
                                              return (
                                                  <button
                                                      key={card.key}
                                                      type="button"
                                                      onClick={() => setSelectedCategory(card.key)}
                                                      className="relative block w-full overflow-hidden rounded-[32px] text-left shadow-[0_25px_45px_-30px_rgba(91,174,155,0.6)] focus:outline-none focus-visible:ring-2 focus-visible:ring-primary"
                                                  >
                                                      <div 
                                                          className="absolute inset-0"
                                                          style={{ background: card.gradient || 'linear-gradient(135deg, #5BAE9F 0%, #7FB7A8 50%, #97C5B8 100%)' }}
                                                      >
                                                          <img 
                                                              src={card.image} 
                                                              alt={card.title} 
                                                              className="h-full w-full object-cover"
                                                              onError={(e) => {
                                                                  e.target.style.display = 'none';
                                                              }}
                                                              onLoad={(e) => {
                                                                  e.target.parentElement.style.background = '';
                                                              }}
                                                          />
                                                      </div>
                                                      <div className="absolute inset-0 bg-gradient-to-br from-black/55 via-black/30 to-black/70"></div>
                                                      <div className="relative flex min-h-[180px] flex-col justify-between px-6 py-8 text-white">
                                          <div className="space-y-3">
                                                              <span className="text-xs font-semibold uppercase tracking-[0.35em] text-white/70">{card.headline}</span>
                                                              <h3 className="text-[26px] font-semibold leading-snug">{card.title}</h3>
                                                              <p className="text-sm text-white/80 max-w-md">{card.subtitle}</p>
                                                          </div>
                                                          <div className="flex items-center gap-3 text-xs text-white/70 pt-2">
                                                              <span>{groupLabel}</span>
                                                              {memberLabel && (
                                                                  <>
                                                                      <span className="h-1 w-1 rounded-full bg-white/40"></span>
                                                                      <span>{memberLabel}</span>
                                                                  </>
                                                              )}
                                                          </div>
                                                      </div>
                                                  </button>
                                              );
                                          })}
                                      </div>
                                  ) : (
                                      <div className="px-4 space-y-3 pb-6">
                                          {filteredGroups.length === 0 ? (
                                              <div className="rounded-3xl border border-dashed border-gray-300 bg-white px-5 py-10 text-center">
                                                  <h3 className="text-lg font-semibold text-gray-900 mb-2">HenÃ¼z grup bulunamadÄ±</h3>
                                                  <p className="text-sm text-gray-500 mb-6">
                                                      Bu kategoride yeni bir grup oluÅŸturabilir ya da diÄŸer kategorilere gÃ¶z atabilirsin.
                                                  </p>
                                                  <button
                                                      type="button"
                                                      onClick={() => setShowCreateGroup(true)}
                                                      className="inline-flex items-center gap-2 rounded-full bg-primary px-5 py-2 text-sm font-semibold text-white hover:bg-primary-dark transition-all"
                                                  >
                                                      Yeni grup oluÅŸtur
                                                  </button>
                                              </div>
                                          ) : (
                                              filteredGroups.map(group => (
                                                  <GroupListCard
                                                      key={group.id}
                                                      group={group}
                                                      memberCount={getMemberCount(group)}
                                                      isJoined={joinedGroups.includes(group.id)}
                                                      onJoin={() => handleJoinGroup(group.id, joinedGroups.includes(group.id))}
                                                      onClick={handleNavigateToGroup}
                                                  />
                                              ))
                                          )}
                                          </div>
                                  )}
                              </div>
                          );
                      };



                      return (
                          <div className="bg-background min-h-screen">
                              {/* Header */}
                              <div className="bg-white">
                              <div className="px-4 py-2">
                                      {/* Main Header Tabs (moved up) */}
                                      <div className="flex w-full gap-2">
                                          {['For You', 'Explore', 'Groups'].map((tab) => (
                                              <button
                                                  key={tab}
                                                  onClick={() => setHeaderTab(tab.toLowerCase().replace(' ', ''))}
                                                  className={`flex-1 py-2.5 rounded-xl text-sm font-medium transition-all ${
                                                      headerTab === tab.toLowerCase().replace(' ', '')
                                                          ? 'bg-gradient-to-r from-primary to-secondary text-white shadow-md'
                                                          : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                                  }`}
                                              >
                                                  {tab}
                                              </button>
                                          ))}
                                      </div>
                                  </div>
                              </div>

                              {/* Content based on header tab */}
                              <div className="pb-6">
                                  {headerTab === 'foryou' && <ForYouView />}
                                  {headerTab === 'explore' && <ExploreView />}
                                  {headerTab === 'groups' && <GroupsView />}
                              </div>

                              {/* Create Group Modal */}
                              <CreateGroupModal
                                  isOpen={showCreateGroup}
                                  onClose={() => setShowCreateGroup(false)}
                                  onCreateGroup={handleCreateGroup}
                              />
                          </div>
                      );
                  };

                      const GroupsView = () => {
                          const isAll = selectedCategory === 'All';
                          const groupsToRender = isAll ? groupsSource : getFilteredGroups();
                          const hasGroups = groupsToRender.length > 0;

                          return (
                              <div className="space-y-4">
                                  <div className="px-4">
                                      <div className="flex items-center gap-2 overflow-x-auto scrollbar-hide py-2">
                                          {categories.map(category => {
                                              const isActive = selectedCategory === category;
                                              return (
                                                  <button
                                                      key={category}
                                                      onClick={() => setSelectedCategory(category)}
                                                      className={`rounded-full px-4 py-2 text-sm font-semibold transition-all ${
                                                          isActive
                                                              ? 'bg-[#BFD9D2] text-primary shadow-sm shadow-primary/20'
                                                              : 'bg-[#F4F6F8] text-gray-500 border border-transparent hover:text-primary'
                                                      }`}
                                                  >
                                                      {category}
                                                  </button>
                                              );
                                          })}
                                      </div>
                                  </div>

                                  <div className="px-4">
                                      <button
                                          type="button"
                                          onClick={() => setShowCreateGroup(true)}
                                          className="w-full rounded-3xl border border-primary/30 bg-white px-4 py-3 text-center text-sm font-semibold text-primary shadow-sm hover:bg-primary/10 transition-all"
                                      >
                                          + Create Group
                                      </button>
                                  </div>

                                  <div className="px-4 space-y-3">
                                      {hasGroups ? (
                                          groupsToRender.slice(0, 20).map(group => (
                                              <GroupListCard
                                                  key={group.id}
                                                  group={group}
                                                  memberCount={getMemberCount(group)}
                                                  isJoined={joinedGroups.includes(group.id)}
                                                  onJoin={() => handleJoinGroup(group.id, joinedGroups.includes(group.id))}
                                                  onClick={handleNavigateToGroup}
                                              />
                                          ))
                                      ) : (
                                          <div className="rounded-3xl border border-dashed border-gray-300 bg-white px-5 py-10 text-center">
                                              <h3 className="text-lg font-semibold text-gray-900 mb-2">HenÃ¼z grup bulunamadÄ±</h3>
                                              <p className="text-sm text-gray-500 mb-6">
                                                  Bu kategoride yeni bir grup oluÅŸturabilir ya da diÄŸer kategorilere gÃ¶z atabilirsin.
                                              </p>
                                              <button
                                                  type="button"
                                                  onClick={() => setShowCreateGroup(true)}
                                                  className="inline-flex items-center gap-2 rounded-full bg-primary px-5 py-2 text-sm font-semibold text-white hover:bg-primary-dark transition-all"
                                              >
                                                  Yeni grup oluÅŸtur
                                              </button>
                                          </div>
                                      )}
                                  </div>

                                  {isAll && categoryCards.length > 0 && (
                                      <div className="px-4 space-y-4 pb-6">
                                          {categoryCards.map(card => {
                                              const stats = card.stats || { groups: 0, members: 0 };
                                              const groupLabel = `${stats.groups} grup`;
                                              const memberLabel = stats.members ? `${stats.members.toLocaleString()} anne` : null;
                                              return (
                                                  <button
                                                      key={card.key}
                                                      type="button"
                                                      onClick={() => setSelectedCategory(card.key)}
                                                      className="relative block w-full overflow-hidden rounded-[28px] text-left shadow-[0_25px_45px_-30px_rgba(91,174,155,0.6)] focus:outline-none focus-visible:ring-2 focus-visible:ring-primary"
                                                  >
                                                      <div 
                                                          className="absolute inset-0"
                                                          style={{ background: card.gradient || 'linear-gradient(135deg, #5BAE9F 0%, #7FB7A8 50%, #97C5B8 100%)' }}
                                                      >
                                                          <img 
                                                              src={card.image} 
                                                              alt={card.title} 
                                                              className="h-full w-full object-cover"
                                                              onError={(e) => {
                                                                  e.target.style.display = 'none';
                                                              }}
                                                              onLoad={(e) => {
                                                                  e.target.parentElement.style.background = '';
                                                              }}
                                                          />
                                                      </div>
                                                      <div className="absolute inset-0 bg-gradient-to-br from-black/55 via-black/30 to-black/70"></div>
                                                      <div className="relative flex min-h-[160px] flex-col justify-between px-6 py-7 text-white">
                                                          <div className="space-y-2">
                                                              <span className="text-xs font-semibold uppercase tracking-[0.35em] text-white/70">{card.headline}</span>
                                                              <h3 className="text-[24px] font-semibold leading-snug">{card.title}</h3>
                                                              <p className="text-sm text-white/80 max-w-md">{card.subtitle}</p>
                                                          </div>
                                                          <div className="flex items-center gap-3 text-xs text-white/70 pt-1">
                                                              <span>{groupLabel}</span>
                                                              {memberLabel && (
                                                                  <>
                                                                      <span className="h-1 w-1 rounded-full bg-white/40"></span>
                                                                      <span>{memberLabel}</span>
                                                                  </>
                                                              )}
                                                          </div>
                                                      </div>
                                                  </button>
                                              );
                                          })}
                                      </div>
                                  )}
                              </div>
                          );
                      };

                      const MyGroupsView = () => {
                          if (myGroups.length === 0) {
                              return (
                                  <div className="px-4 py-12 text-center space-y-4">
                                      <div className="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-gray-100 text-3xl">ðŸŒ±</div>
                                      <div className="text-lg font-semibold text-gray-900">HenÃ¼z bir gruba katÄ±lmadÄ±n</div>
                                      <p className="text-sm text-gray-500 max-w-sm mx-auto">
                                          Destek bulabileceÄŸin gruplarÄ± keÅŸfet ya da yeni bir topluluk oluÅŸtur.
                                      </p>
                                      <div className="flex items-center justify-center gap-3">
                                          <button
                                              type="button"
                                              onClick={() => setSelectedCategory('All')}
                                              className="rounded-full border border-primary/30 px-4 py-2 text-sm font-semibold text-primary hover:bg-primary/10 transition-all"
                                          >
                                              GruplarÄ± keÅŸfet
                                          </button>
                                          <button
                                              type="button"
                                              onClick={() => setShowCreateGroup(true)}
                                              className="rounded-full bg-primary px-4 py-2 text-sm font-semibold text-white hover:bg-primary-dark transition-all"
                                          >
                                              Yeni grup oluÅŸtur
                                          </button>
                                      </div>
                                  </div>
                              );
                          }

                          const suggested = groupsSource.filter(group => !joinedGroups.includes(group.id)).slice(0, 4);

                          return (
                              <div className="space-y-6">
                                  <div className="px-4">
                                      <h3 className="text-lg font-semibold text-gray-900">My Groups</h3>
                                  </div>
                                  <div className="px-4 space-y-3">
                                      {myGroups.map(group => (
                                          <GroupListCard
                                              key={group.id}
                                              group={group}
                                              memberCount={getMemberCount(group)}
                                              isJoined={true}
                                              onJoin={() => handleJoinGroup(group.id, true)}
                                              onClick={handleNavigateToGroup}
                                          />
                                      ))}
                                  </div>

                                  {suggested.length > 0 && (
                                      <div className="space-y-3 px-4 pb-4">
                                          <div className="flex items-center justify-between">
                                              <h4 className="text-sm font-semibold text-gray-700">Ã–nerilen gruplar</h4>
                                              <button
                                                  type="button"
                                                  onClick={() => setSelectedCategory('All')}
                                                  className="text-xs font-semibold text-primary hover:text-primary-dark"
                                              >
                                                  TÃ¼mÃ¼nÃ¼ gÃ¶r
                                              </button>
                                          </div>
                                          <div className="space-y-3">
                                              {suggested.map(group => (
                                                  <GroupListCard
                                                      key={group.id}
                                                      group={group}
                                                      memberCount={getMemberCount(group)}
                                                      isJoined={false}
                                                      onJoin={() => handleJoinGroup(group.id)}
                                                      onClick={handleNavigateToGroup}
                                                  />
                                              ))}
                                          </div>
                                      </div>
                                  )}
                              </div>
                          );
                      };


                  // ShopView Component
      // ðŸ›ï¸ Real Baby Marketplace Component
      const ShopView = ({ coinCount, setCoinCount }) => {
          const [activeCategory, setActiveCategory] = useState(() => StorageManager.load('shopActiveCategory', 'all'));
          const [cartItems, setCartItems] = useState(StorageManager.load('cartItems', []));
          const [selectedProductId, setSelectedProductId] = useState(null);
          const [sortBy, setSortBy] = useState(() => StorageManager.load('shopSortBy', 'popular'));
          const [search, setSearch] = useState(() => StorageManager.load('shopSearch', ''));
          const [isCartOpen, setIsCartOpen] = useState(false);
          const [isCheckoutOpen, setIsCheckoutOpen] = useState(false);
          const [isOrdersOpen, setIsOrdersOpen] = useState(false);
          const [showPremiumModal, setShowPremiumModal] = useState(false);
          const [showCoinInfo, setShowCoinInfo] = useState(false);
          const [showCancelPremiumModal, setShowCancelPremiumModal] = useState(false);
          const [isPremium, setIsPremium] = useState(StorageManager.load('isPremium', false));
          const [visibleCount, setVisibleCount] = useState(30); // Start with 30 products (responsive grid)

          useEffect(() => { StorageManager.save('cartItems', cartItems); }, [cartItems]);
          useEffect(() => { StorageManager.save('shopActiveCategory', activeCategory); }, [activeCategory]);
          useEffect(() => { StorageManager.save('shopSortBy', sortBy); }, [sortBy]);
          useEffect(() => { StorageManager.save('shopSearch', search); }, [search]);

          // Reset visible count when category or search changes
          useEffect(() => {
              setVisibleCount(30);
          }, [activeCategory, search]);
          
          // Infinite scroll handler
          useEffect(() => {
              // Only enable infinite scroll for category views (not "All")
              if (activeCategory === 'all' && !search.trim()) return;
              
              let ticking = false;
              const handleScroll = () => {
                  if (!ticking) {
                      window.requestAnimationFrame(() => {
                          const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                          const scrollHeight = document.documentElement.scrollHeight;
                          const clientHeight = window.innerHeight;
                          
                          // Load more when user scrolls to 80% of the page
                          if (scrollTop + clientHeight >= scrollHeight * 0.8) {
                              setVisibleCount(prev => prev + 30);
                          }
                          ticking = false;
                      });
                      ticking = true;
                  }
              };
              
              window.addEventListener('scroll', handleScroll, { passive: true });
              return () => window.removeEventListener('scroll', handleScroll);
          }, [activeCategory, search]);

          // Real Baby Products Data - Prices in Turkish Lira (TL)
          const shopItems = {
              babygear: [
                  { id: 'gear_1', name: 'UPPAbaby Vista V2 Bebek ArabasÄ±', brand: 'UPPAbaby', price: 28900, originalPrice: 32000, rating: 4.8, reviews: 2847, image: 'https://images.unsplash.com/photo-1580489944761-15a19d654956?w=400&h=400&fit=crop', icon: (
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <path d="M3 21h18"/>
                          <path d="M5 21V7l8-4v18"/>
                          <path d="M19 21V11l-6-4"/>
                      </svg>
                  ), description: 'LÃ¼ks bebek arabasÄ± - geriye dÃ¶nebilen oturma ve beÅŸik uyumluluÄŸu', ageRange: '0-4 yaÅŸ', features: ['Her zeminde kullanÄ±m', 'Tek elle katlama', 'GeniÅŸ sepet'], discount: 10 },
                  { id: 'gear_2', name: 'Ergobaby Omni 360 TaÅŸÄ±yÄ±cÄ±', brand: 'Ergobaby', price: 5760, rating: 4.6, reviews: 1923, icon: 'ðŸ¤±', description: '4 ergonomik taÅŸÄ±ma pozisyonu ile bebek taÅŸÄ±yÄ±cÄ±', ageRange: '0-4 yaÅŸ', features: ['Bel desteÄŸi', 'Nefes alabilir kumaÅŸ', 'Makinede yÄ±kanabilir'] },
                  { id: 'gear_3', name: 'Graco Pack n Play Oyun ParkÄ±', brand: 'Graco', price: 5120, originalPrice: 6400, rating: 4.4, reviews: 3421, icon: 'ðŸ ', description: 'Portatif oyun parkÄ±, beÅŸik ve alt deÄŸiÅŸtirme Ã¼nitesi', ageRange: '0-3 yaÅŸ', features: ['Kompakt katlama', 'Depolama cepleri', 'Tekerlekli'], discount: 20 },
                  { id: 'gear_4', name: 'Baby Brezza Otomatik Formula Makinesi', brand: 'Baby Brezza', price: 6400, rating: 4.3, reviews: 876, icon: 'ðŸ¼', description: 'Otomatik formula karÄ±ÅŸtÄ±rÄ±cÄ± ve daÄŸÄ±tÄ±cÄ±', ageRange: '0-12 ay', features: ['Tek dokunuÅŸ karÄ±ÅŸtÄ±rma', 'Ã–zelleÅŸtirilebilir ayarlar', 'Kolay temizlik'] },
                  { id: 'gear_5', name: 'Chicco KeyFit 30 Oto KoltuÄŸu', brand: 'Chicco', price: 6400, rating: 4.7, reviews: 4532, icon: 'ðŸš—', description: 'Bebek oto koltuÄŸu, taban ve kolay montaj', ageRange: '0-30 lbs', features: ['Anti-sÄ±Ã§rama Ã§ubuÄŸu', 'Kolay kurulum', 'Premium kumaÅŸlar'] },
                  { id: 'gear_6', name: 'Fisher-Price Sallanan Bebek YataÄŸÄ±', brand: 'Fisher-Price', price: 2560, rating: 4.5, reviews: 2156, icon: 'ðŸª‘', description: 'YumuÅŸak sallanma hareketi ile portatif bebek yataÄŸÄ±', ageRange: '0-6 ay', features: ['Otomatik sallama', 'Oyuncak Ã§ubuÄŸu', 'Makinede yÄ±kanabilir'] },
                  { id: 'gear_7', name: 'Cybex Cloud Q Oto KoltuÄŸu', brand: 'Cybex', price: 8900, originalPrice: 9600, rating: 4.9, reviews: 1234, icon: 'ðŸš™', description: '360Â° dÃ¶nen bebek oto koltuÄŸu', ageRange: '0-18 kg', features: ['Yan Ã§arpÄ±ÅŸma korumasÄ±', 'ISOFIX baÄŸlantÄ±', 'Ayarlanabilir'], discount: 7 },
                  { id: 'gear_8', name: 'Maxi-Cosi Pria 85 Oto KoltuÄŸu', brand: 'Maxi-Cosi', price: 7200, rating: 4.6, reviews: 2876, icon: 'ðŸš—', description: 'YÃ¼ksek performanslÄ± bÃ¼yÃ¼k Ã§ocuk oto koltuÄŸu', ageRange: '9-36 kg', features: ['Side impact korumasÄ±', 'Konforlu yastÄ±klar', 'Kolay kurulum'] },
                  { id: 'gear_9', name: 'Doona Ä°lk YÄ±llar Araba KoltuÄŸu', brand: 'Doona', price: 11200, rating: 4.7, reviews: 1567, icon: 'ðŸ‘¶', description: 'Bebek arabasÄ±na dÃ¶nÃ¼ÅŸen oto koltuÄŸu', ageRange: '0-13 kg', features: ['Tek Ã¼rÃ¼n', 'Hafif tasarÄ±m', 'Kolay taÅŸÄ±ma'] },
                  { id: 'gear_10', name: 'Stokke Xplory Bebek ArabasÄ±', brand: 'Stokke', price: 15200, originalPrice: 16800, rating: 4.8, reviews: 987, icon: 'ðŸš¼', description: 'YÃ¼ksek oturma pozisyonlu lÃ¼ks bebek arabasÄ±', ageRange: '0-4 yaÅŸ', features: ['YÃ¼ksek oturma', 'ModÃ¼ler sistem', 'DÃ¶nÃ¼ÅŸtÃ¼rÃ¼lebilir'], discount: 10 },
                  { id: 'gear_11', name: '4moms mamaRoo SalÄ±ncak', brand: '4moms', price: 9600, rating: 4.6, reviews: 2341, icon: 'ðŸª‘', description: '5 hareket desenli bebek salÄ±ncaÄŸÄ±', ageRange: '0-6 ay', features: ['App kontrolÃ¼', 'MÃ¼zik entegrasyonu', 'Kolay temizlik'] },
                  { id: 'gear_12', name: 'Bugaboo Fox3 Bebek ArabasÄ±', brand: 'Bugaboo', price: 14400, originalPrice: 16000, rating: 4.9, reviews: 1654, icon: 'ðŸš—', description: 'Premium kompakt bebek arabasÄ±', ageRange: '0-4 yaÅŸ', features: ['Tek elle katlama', 'Ã‡ok yÃ¶nlÃ¼', 'Hafif alÃ¼minyum'], discount: 10 },
                  { id: 'gear_13', name: 'Inglesina Zippy Bebek ArabasÄ±', brand: 'Inglesina', price: 7200, rating: 4.5, reviews: 1876, icon: 'ðŸ‘¶', description: 'Tek elle katlanabilir kompakt bebek arabasÄ±', ageRange: '0-3 yaÅŸ', features: ['Tek elle katlama', 'Kompakt', '5 nokta kemer'] },
                  { id: 'gear_14', name: 'Joie Mimzy 2in1 Bebek BeÅŸiÄŸi', brand: 'Joie', price: 4800, rating: 4.4, reviews: 2134, icon: 'ðŸ›ï¸', description: 'BeÅŸik ve yatak dÃ¶nÃ¼ÅŸÃ¼mÃ¼', ageRange: '0-4 yaÅŸ', features: ['2in1 tasarÄ±m', 'Kompakt', 'DayanÄ±klÄ±'] },
                  { id: 'gear_15', name: 'Mountain Buggy Nano Bebek ArabasÄ±', brand: 'Mountain Buggy', price: 6400, originalPrice: 7200, rating: 4.7, reviews: 1543, icon: 'ðŸš™', description: 'Ultra kompakt seyahat bebek arabasÄ±', ageRange: '6M-4Y', features: ['Kabin bagajÄ±na sÄ±ÄŸar', 'Hafif', 'Kolay kurulum'], discount: 11 },
                  { id: 'gear_16', name: 'Nuna Mixx Next Bebek ArabasÄ±', brand: 'Nuna', price: 11200, rating: 4.8, reviews: 2345, icon: 'ðŸ‘¶', description: 'AlÃ¼minyum Ã§erÃ§eveli lÃ¼ks bebek arabasÄ±', ageRange: '0-4 yaÅŸ', features: ['Hafif alÃ¼minyum', 'Suspension sistemi', 'Ã‡ok yÃ¶nlÃ¼'] },
                  { id: 'gear_17', name: 'Peg Perego Book Pop Up Bebek ArabasÄ±', brand: 'Peg Perego', price: 5600, originalPrice: 6400, rating: 4.5, reviews: 1765, icon: 'ðŸ“±', description: 'Tek elle aÃ§Ä±lÄ±p kapanan bebek arabasÄ±', ageRange: '0-3 yaÅŸ', features: ['Tek elle kullanÄ±m', 'Kompakt', 'Hafif'], discount: 13 },
                  { id: 'gear_18', name: 'Silver Cross Wave Bebek ArabasÄ±', brand: 'Silver Cross', price: 17600, rating: 4.9, reviews: 876, icon: 'ðŸ‘‘', description: 'Premium lÃ¼ks bebek arabasÄ± sistemi', ageRange: '0-4 yaÅŸ', features: ['ModÃ¼ler sistem', 'LÃ¼ks kumaÅŸlar', 'Uzun Ã¶mÃ¼rlÃ¼'] },
                  { id: 'gear_19', name: 'Thule Spring Bebek ArabasÄ±', brand: 'Thule', price: 8000, rating: 4.6, reviews: 1987, icon: 'ðŸ”ï¸', description: 'Aktif ebeveynler iÃ§in bebek arabasÄ±', ageRange: '6M-4Y', features: ['DÃ¼ÅŸÃ¼k profil', 'Hafif', 'DayanÄ±klÄ±'] },
                  { id: 'gear_20', name: 'Yoyo+ Bebek ArabasÄ±', brand: 'Babyzen', price: 10400, originalPrice: 11200, rating: 4.7, reviews: 3456, icon: 'âœˆï¸', description: 'UÃ§ak kabin bagajÄ±na sÄ±ÄŸan bebek arabasÄ±', ageRange: '0-4 yaÅŸ', features: ['Ultra kompakt', 'Kabin uyumlu', 'Hafif'], discount: 7 }
              ],
              clothing: [
                  { id: 'cloth_1', name: 'Carter\'s 5\'li Body Seti', brand: 'Carter\'s', price: 800, rating: 4.6, reviews: 1834, icon: 'ðŸ‘•', description: 'YumuÅŸak pamuklu body, kopÃ§alÄ± kapanÄ±ÅŸ', ageRange: '0-24 ay', features: ['%100 pamuk', 'Kolay deÄŸiÅŸim', 'Makinede yÄ±kanabilir'], sizes: ['NB', '3M', '6M', '12M'] },
                  { id: 'cloth_2', name: 'Hanna Andersson Pijama TakÄ±mÄ±', brand: 'Hanna Andersson', price: 1344, originalPrice: 1792, rating: 4.8, reviews: 967, icon: 'ðŸŒ™', description: 'Organik pamuklu yÃ¼rÃ¼me Ã§aÄŸÄ± pijamalarÄ±', ageRange: '12M-4T', features: ['Organik pamuk', 'Rahat oturuÅŸ', 'Alev geciktirici'], discount: 25 },
                  { id: 'cloth_3', name: 'Gerber 8\'li Body Seti', brand: 'Gerber', price: 608, rating: 4.4, reviews: 2743, icon: 'ðŸ¼', description: 'Temel kÄ±sa kollu body seti', ageRange: '0-18 ay', features: ['Omuzdan aÃ§Ä±lÄ±r', 'Etiket yok', 'KarÄ±ÅŸÄ±k paket'] },
                  { id: 'cloth_4', name: 'Patagonia Bebek Ceketi', brand: 'Patagonia', price: 2528, rating: 4.7, reviews: 543, icon: 'ðŸ§¥', description: 'DÄ±ÅŸ mekan maceralarÄ± iÃ§in su geÃ§irmez ceket', ageRange: '3M-4T', features: ['Su geÃ§irmez', 'Geri dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ malzeme', 'BÃ¼yÃ¼me payÄ±'] },
                  { id: 'cloth_5', name: 'Honest Company Bez Paketi', brand: 'Honest', price: 1600, rating: 4.5, reviews: 3876, icon: 'ðŸ‘¶', description: 'EÄŸlenceli desenli bitki bazlÄ± bezler', ageRange: 'YenidoÄŸan-6', features: ['Bitki bazlÄ± Ã§ekirdek', 'Hipoalerjenik', 'Sevimli desenler'] },
                  { id: 'cloth_6', name: 'Zutano 4\'lÃ¼ Patik Seti', brand: 'Zutano', price: 1024, rating: 4.6, reviews: 1243, icon: 'ðŸ§¦', description: 'Parlak renklerde ayakta kalan bebek patikleri', ageRange: '0-18 ay', features: ['Ayakta kalÄ±r', 'YumuÅŸak polar', 'Makinede yÄ±kanabilir'] },
                  { id: 'cloth_7', name: 'Next Organik Bebek Ã‡orabÄ± 6\'lÄ±', brand: 'Next', price: 320, rating: 4.5, reviews: 876, icon: 'ðŸ§¦', description: 'Organik pamuklu, elastik bilek', ageRange: '0-24 ay', features: ['Organik pamuk', 'Esnek', 'Boyalar zararsÄ±z'] },
                  { id: 'cloth_8', name: 'H&M Kids Ã‡ift KatmanlÄ± Ãœst', brand: 'H&M', price: 480, originalPrice: 640, rating: 4.3, reviews: 1234, icon: 'ðŸ‘”', description: 'YumuÅŸak pamuklu Ã§ift katmanlÄ± Ã¼st', ageRange: '6M-4Y', features: ['%100 pamuk', 'Kolay giyilir', 'Ã‡ok fonksiyonlu'], discount: 25 },
                  { id: 'cloth_9', name: 'Burts Bees Organik Bebek Body', brand: 'Burt\'s Bees', price: 640, rating: 4.6, reviews: 2341, icon: 'ðŸ', description: 'Organik pamuklu bebek body seti', ageRange: '0-18 ay', features: ['GOTS sertifikalÄ±', 'Hipoalerjenik', 'YumuÅŸak dokusu'] },
                  { id: 'cloth_10', name: 'Primary Organik Pijama', brand: 'Primary', price: 1120, rating: 4.7, reviews: 1654, icon: 'ðŸŒ™', description: 'Renkli organik pamuklu pijama seti', ageRange: '2T-12', features: ['Organik pamuk', 'CanlÄ± renkler', 'Rahat kesim'] },
                  { id: 'cloth_11', name: 'Mini Boden Ã‡ocuk Elbisesi', brand: 'Mini Boden', price: 1600, originalPrice: 1920, rating: 4.8, reviews: 987, icon: 'ðŸ‘—', description: 'EÄŸlenceli desenli Ã§ocuk elbisesi', ageRange: '2T-10', features: ['EÄŸlenceli desenler', 'DayanÄ±klÄ±', 'Makinede yÄ±kanabilir'], discount: 17 },
                  { id: 'cloth_12', name: 'Gap Kids Jean Pantolon', brand: 'Gap Kids', price: 800, rating: 4.5, reviews: 3214, icon: 'ðŸ‘–', description: 'Esnek bel lastikli jean pantolon', ageRange: '2T-14', features: ['Esnek bel', 'DayanÄ±klÄ±', 'Klasik kesim'] },
                  { id: 'cloth_13', name: 'The Children\'s Place Sweatshirt', brand: 'The Children\'s Place', price: 480, originalPrice: 640, rating: 4.4, reviews: 2765, icon: 'ðŸ§¥', description: 'YumuÅŸak pamuklu sweatshirt', ageRange: '2T-16', features: ['Rahat', 'Ã‡ok renkli', 'Kolay bakÄ±m'], discount: 25 },
                  { id: 'cloth_14', name: 'Old Navy Bebek Tulumu', brand: 'Old Navy', price: 640, rating: 4.6, reviews: 1987, icon: 'ðŸ‘¶', description: 'KopÃ§alÄ± bebek tulumu', ageRange: '0-24 ay', features: ['Kolay deÄŸiÅŸim', 'YumuÅŸak', 'Uygun fiyat'] },
                  { id: 'cloth_15', name: 'Cat & Jack Ã‡ocuk AyakkabÄ±sÄ±', brand: 'Target', price: 480, rating: 4.5, reviews: 3456, icon: 'ðŸ‘Ÿ', description: 'Rahat yÃ¼rÃ¼me ayakkabÄ±sÄ±', ageRange: '6M-10Y', features: ['Esnek taban', 'Kolay giyilir', 'DayanÄ±klÄ±'] },
                  { id: 'cloth_16', name: 'Zara Kids KÄ±ÅŸ Montu', brand: 'Zara', price: 1600, originalPrice: 2000, rating: 4.7, reviews: 1543, icon: 'ðŸ§¥', description: 'SÄ±cak tutan kÄ±ÅŸ montu', ageRange: '2Y-14Y', features: ['Su geÃ§irmez', 'IsÄ± yalÄ±tÄ±mÄ±', 'ÅžÄ±k tasarÄ±m'], discount: 20 },
                  { id: 'cloth_17', name: 'Ralph Lauren Bebek TakÄ±mÄ±', brand: 'Ralph Lauren', price: 2400, rating: 4.9, reviews: 876, icon: 'ðŸ‘”', description: 'Klasik polo ve ÅŸort takÄ±mÄ±', ageRange: '0-24 ay', features: ['Premium kalite', 'Klasik stil', 'DayanÄ±klÄ±'] },
                  { id: 'cloth_18', name: 'Baby Gap Organik Body', brand: 'Gap', price: 560, rating: 4.6, reviews: 2341, icon: 'ðŸ‘•', description: 'Organik pamuklu bebek body', ageRange: '0-24 ay', features: ['Organik', 'YumuÅŸak', 'Kaliteli'] },
                  { id: 'cloth_19', name: 'Uniqlo Bebek Ä°Ã§ Ã‡amaÅŸÄ±rÄ±', brand: 'Uniqlo', price: 320, rating: 4.5, reviews: 2876, icon: 'ðŸ©²', description: 'YumuÅŸak bebek iÃ§ Ã§amaÅŸÄ±rÄ± seti', ageRange: '0-24 ay', features: ['Nefes alabilir', 'YumuÅŸak', 'Esnek'] },
                  { id: 'cloth_20', name: 'Columbia Bebek YaÄŸmurluÄŸu', brand: 'Columbia', price: 960, originalPrice: 1280, rating: 4.7, reviews: 1876, icon: 'ðŸŒ§ï¸', description: 'Su geÃ§irmez bebek yaÄŸmurluÄŸu', ageRange: '6M-4T', features: ['Tam su geÃ§irmez', 'Hafif', 'Kolay giyilir'], discount: 25 }
              ],
              accessories: [
                  { id: 'acc_1', name: 'Sophie la Girafe DiÅŸ KaÅŸÄ±yÄ±cÄ±', brand: 'Sophie la Girafe', price: 800, rating: 4.7, reviews: 4521, icon: 'ðŸ¦’', description: 'Klasik doÄŸal kauÃ§uk diÅŸ kaÅŸÄ±yÄ±cÄ± oyuncak', ageRange: '0+ ay', features: ['DoÄŸal kauÃ§uk', 'GÄ±da boyasÄ±', 'Kolay kavranÄ±r'] },
                  { id: 'acc_2', name: 'Bumbo Yer OturaÄŸÄ±', brand: 'Bumbo', price: 1278, rating: 4.3, reviews: 2165, icon: 'ðŸ’º', description: 'BebeÄŸin oturmasÄ±na yardÄ±mcÄ± yer oturaÄŸÄ±', ageRange: '3-14 ay', features: ['Kolay temizlenir', 'TaÅŸÄ±nabilir', 'GÃ¼venlik kemeri dahil'] },
                  { id: 'acc_3', name: 'Skip Hop Bez Ã‡antasÄ±', brand: 'Skip Hop', price: 2560, originalPrice: 3200, rating: 4.5, reviews: 1876, icon: 'ðŸŽ’', description: 'Ã‡ok bÃ¶lmeli ÅŸÄ±k bez Ã§antasÄ±', ageRange: 'TÃ¼m yaÅŸlar', features: ['11 cep', 'Alt deÄŸiÅŸtirme pedi', 'Araba klipsleri'], discount: 20 },
                  { id: 'acc_4', name: 'Munchkin Biberon IsÄ±tÄ±cÄ±', brand: 'Munchkin', price: 960, rating: 4.4, reviews: 1432, icon: 'ðŸ¼', description: 'HÄ±zlÄ± biberon ve mama Ä±sÄ±tÄ±cÄ±', ageRange: '0+ ay', features: ['Buhar Ä±sÄ±tma', 'Otomatik kapanma', 'Ã‡oÄŸu biberona uyar'] },
                  { id: 'acc_5', name: 'Baby Einstein Aktivite MasasÄ±', brand: 'Baby Einstein', price: 2880, rating: 4.6, reviews: 2987, icon: 'ðŸŽª', description: 'Ä°nteraktif Ã¶ÄŸrenme aktivite masasÄ±', ageRange: '6+ ay', features: ['360Â° dÃ¶ner koltuk', 'MÃ¼zikli oyuncaklar', 'YÃ¼kseklik ayarlÄ±'] },
                  { id: 'acc_6', name: 'Owlet AkÄ±llÄ± Ã‡orap', brand: 'Owlet', price: 9600, rating: 4.2, reviews: 3421, icon: 'ðŸ§¦', description: 'Kalp atÄ±ÅŸÄ± ve oksijeni takip eden bebek monitÃ¶rÃ¼', ageRange: '0-18 ay', features: ['GerÃ§ek zamanlÄ± takip', 'Uygulama bildirimleri', 'Huzur'] },
                  { id: 'acc_7', name: 'Philips Avent Biberon Seti', brand: 'Philips', price: 480, rating: 4.6, reviews: 5234, icon: 'ðŸ¼', description: '6\'lÄ± doÄŸal cam biberon seti', ageRange: '0+ ay', features: ['BPA iÃ§ermez', 'Kolay temizlik', 'Anti-kolik'] },
                  { id: 'acc_8', name: 'BabyBjÃ¶rn Bebek SalÄ±ncaÄŸÄ±', brand: 'BabyBjÃ¶rn', price: 6400, originalPrice: 7200, rating: 4.8, reviews: 3456, icon: 'ðŸª‘', description: 'Elektrikli bebek salÄ±ncaÄŸÄ±', ageRange: '0-2 yaÅŸ', features: ['5 hÄ±z ayarÄ±', 'Kolay katlanÄ±r', 'Pille Ã§alÄ±ÅŸÄ±r'], discount: 11 },
                  { id: 'acc_9', name: 'Skip Hop Treetop Friends DiÅŸ KaÅŸÄ±yÄ±cÄ±', brand: 'Skip Hop', price: 320, rating: 4.6, reviews: 2341, icon: 'ðŸ¦·', description: 'FarklÄ± dokulu diÅŸ kaÅŸÄ±yÄ±cÄ± seti', ageRange: '3M+', features: ['FarklÄ± dokular', 'BPA iÃ§ermez', 'Kolay tutma'] },
                  { id: 'acc_10', name: 'WubbaNub Emzik Oyuncak', brand: 'WubbaNub', price: 240, rating: 4.7, reviews: 1876, icon: 'ðŸ»', description: 'Sevimli oyuncaklÄ± emzik', ageRange: '0-6 ay', features: ['Sevimli tasarÄ±m', 'Kolay bulunur', 'GÃ¼venli'] },
                  { id: 'acc_11', name: 'Munchkin Gizli Kamera MonitÃ¶rÃ¼', brand: 'Munchkin', price: 3200, rating: 4.5, reviews: 1543, icon: 'ðŸ“¹', description: 'Gece gÃ¶rÃ¼ÅŸlÃ¼ bebek monitÃ¶rÃ¼', ageRange: 'TÃ¼m yaÅŸlar', features: ['Gece gÃ¶rÃ¼ÅŸÃ¼', '2 yÃ¶nlÃ¼ ses', 'Mobil uygulama'] },
                  { id: 'acc_12', name: 'Fisher-Price Cradle Swing', brand: 'Fisher-Price', price: 4800, originalPrice: 5600, rating: 4.6, reviews: 2987, icon: 'ðŸª‘', description: 'MÃ¼zikli bebek salÄ±ncaÄŸÄ±', ageRange: '0-9 ay', features: ['16 mÃ¼zik', '6 hÄ±z', 'Otomatik sallama'], discount: 14 },
                  { id: 'acc_13', name: 'Aden + Anais Muslin Ã–rtÃ¼', brand: 'Aden + Anais', price: 960, rating: 4.8, reviews: 4567, icon: 'ðŸ§¸', description: 'BÃ¼yÃ¼k muslin Ã¶rtÃ¼ seti', ageRange: '0+ ay', features: ['Ã‡ok amaÃ§lÄ±', 'Nefes alabilir', 'Sevimli desenler'] },
                  { id: 'acc_14', name: 'Itzy Ritzy Silikon Mama Ã–nlÃ¼ÄŸÃ¼', brand: 'Itzy Ritzy', price: 320, rating: 4.5, reviews: 2341, icon: 'ðŸ½ï¸', description: 'Yemek toplayan silikon Ã¶nlÃ¼k', ageRange: '6M+', features: ['Yemek toplama', 'Kolay temizlik', 'BPA iÃ§ermez'] },
                  { id: 'acc_15', name: 'DockATot Deluxe+ Yatak', brand: 'DockATot', price: 9600, rating: 4.7, reviews: 3214, icon: 'ðŸ›ï¸', description: 'Portatif bebek yatak yataÄŸÄ±', ageRange: '0-8 ay', features: ['TaÅŸÄ±nabilir', 'Nefes alabilir', 'YumuÅŸak'] },
                  { id: 'acc_16', name: 'Lovevery Play Gym', brand: 'Lovevery', price: 2400, rating: 4.9, reviews: 1876, icon: 'ðŸŽª', description: 'Montessori ilhamlÄ± oyun jimnastik salonu', ageRange: '0-12 ay', features: ['GeliÅŸim odaklÄ±', 'Organik kumaÅŸ', 'Ã‡ok amaÃ§lÄ±'] },
                  { id: 'acc_17', name: 'Oeuf Sparrow BeÅŸik', brand: 'Oeuf', price: 11200, originalPrice: 12800, rating: 4.8, reviews: 987, icon: 'ðŸ›ï¸', description: 'Minimalist modern beÅŸik', ageRange: '0-2 yaÅŸ', features: ['Modern tasarÄ±m', 'Organik kumaÅŸ', 'DÃ¶nÃ¼ÅŸtÃ¼rÃ¼lebilir'], discount: 13 },
                  { id: 'acc_18', name: 'Baby Shusher Uyku Makinesi', brand: 'Baby Shusher', price: 1280, rating: 4.6, reviews: 2345, icon: 'ðŸ’¤', description: 'Shh sesi Ã§Ä±karan uyku makinesi', ageRange: '0-12 ay', features: ['Shh sesi', 'Timer', 'TaÅŸÄ±nabilir'] },
                  { id: 'acc_19', name: 'Ingenuity ConvertMe Swing', brand: 'Ingenuity', price: 4000, rating: 4.5, reviews: 1765, icon: 'ðŸª‘', description: '2in1 sallanan bebek koltuÄŸu', ageRange: '0-9 ay', features: ['2in1 tasarÄ±m', '6 hÄ±z', 'Kolay katlanÄ±r'] },
                  { id: 'acc_20', name: 'Bright Starts TÃ¼m YÃ¶nlerden SalÄ±ncak', brand: 'Bright Starts', price: 3200, originalPrice: 4000, rating: 4.4, reviews: 2876, icon: 'ðŸª‘', description: 'Her yÃ¶ne sallanan bebek salÄ±ncaÄŸÄ±', ageRange: '0-9 ay', features: ['Ã‡ok yÃ¶nlÃ¼', 'MÃ¼zikli', 'Kolay kurulum'], discount: 20 }
              ],
              health: [
                  { id: 'health_1', name: 'Honest Hamilelik Vitaminleri', brand: 'Honest', price: 960, rating: 4.5, reviews: 1234, icon: 'ðŸ’Š', description: 'DHA iÃ§eren tam hamilelik vitamini', ageRange: 'Hamilelik', features: ['Folik asit', 'Demir', 'DHA dahil'] },
                  { id: 'health_2', name: 'Fridababy NoseFrida', brand: 'Fridababy', price: 640, rating: 4.6, reviews: 5432, icon: 'ðŸ‘ƒ', description: 'TÄ±kalÄ± burunlar iÃ§in burun aspiratÃ¶rÃ¼', ageRange: '0+ ay', features: ['Hijyenik filtreler', 'Kolay temizlik', 'Doktor Ã¶nerili'] },
                  { id: 'health_3', name: 'Zarbee\'s Bebek Ã–ksÃ¼rÃ¼k Åžurubu', brand: 'Zarbee\'s', price: 288, rating: 4.4, reviews: 2876, icon: 'ðŸ¯', description: 'Agave iÃ§eren doÄŸal Ã¶ksÃ¼rÃ¼k ÅŸurubu', ageRange: '2+ ay', features: ['Yapay aroma yok', 'GÃ¼venli iÃ§erikler', 'Pediatrist Ã¶nerili'] },
                  { id: 'health_4', name: 'Mustela Bebek Losyonu', brand: 'Mustela', price: 544, rating: 4.7, reviews: 1987, icon: 'ðŸ§´', description: 'Hassas cilt iÃ§in nazik nemlendirici losyon', ageRange: '0+ ay', features: ['Hipoalerjenik', 'GÃ¶zyaÅŸÄ± iÃ§ermez', 'DoÄŸal iÃ§erikler'] },
                  { id: 'health_5', name: 'Bebek Termometresi', brand: 'iHealth', price: 1120, rating: 4.3, reviews: 1543, icon: 'ðŸŒ¡ï¸', description: 'Temas gerektirmeyen kÄ±zÄ±lÃ¶tesi termometre', ageRange: 'TÃ¼m yaÅŸlar', features: ['1 saniye okuma', 'AteÅŸ alarmÄ±', 'HafÄ±za fonksiyonu'] },
                  { id: 'health_6', name: 'Aquaphor Bebek Ä°yileÅŸtirici', brand: 'Aquaphor', price: 256, rating: 4.8, reviews: 4321, icon: 'ðŸ©¹', description: 'Kuru cilt iÃ§in geliÅŸmiÅŸ iyileÅŸtirici merhem', ageRange: '0+ ay', features: ['Kokusuz', 'Pediatrist Ã¶nerili', 'Ã‡ok amaÃ§lÄ±'] },
                  { id: 'health_7', name: 'Mustela YenidoÄŸan ÅžampuanÄ±', brand: 'Mustela', price: 480, rating: 4.6, reviews: 2341, icon: 'ðŸ§´', description: 'YenidoÄŸanlar iÃ§in nazik ÅŸampuan', ageRange: '0-12 ay', features: ['GÃ¶zyaÅŸÄ± iÃ§ermez', 'PH dengeli', 'Hipoalerjenik'] },
                  { id: 'health_8', name: 'Pampers Premium Care Bez', brand: 'Pampers', price: 1120, rating: 4.7, reviews: 8765, icon: 'ðŸ‘¶', description: 'Premium bakÄ±m bezi paketi - 64\'lÃ¼', ageRange: 'YenidoÄŸan-6', features: ['12 saat koruma', 'Nefes alabilir', 'YumuÅŸak dokunuÅŸ'] },
                  { id: 'health_9', name: 'Huggies Natural Care Bez', brand: 'Huggies', price: 960, rating: 4.6, reviews: 5432, icon: 'ðŸ‘¶', description: 'DoÄŸal iÃ§erikli bebek bezi', ageRange: 'YenidoÄŸan-6', features: ['DoÄŸal iÃ§erik', 'YumuÅŸak', 'GÃ¼venilir'] },
                  { id: 'health_10', name: 'California Baby Losyon', brand: 'California Baby', price: 640, rating: 4.7, reviews: 2876, icon: 'ðŸ§´', description: 'Organik bebek losyonu', ageRange: '0+ ay', features: ['Organik', 'Kokusuz', 'Hipoalerjenik'] },
                  { id: 'health_11', name: 'Weleda Bebek ÅžampuanÄ±', brand: 'Weleda', price: 480, rating: 4.8, reviews: 1987, icon: 'ðŸ§´', description: 'DoÄŸal iÃ§erikli bebek ÅŸampuanÄ±', ageRange: '0+ ay', features: ['DoÄŸal iÃ§erik', 'GÃ¶zyaÅŸÄ± iÃ§ermez', 'Organik'] },
                  { id: 'health_12', name: 'Burt\'s Bees Bebek YaÄŸÄ±', brand: 'Burt\'s Bees', price: 320, originalPrice: 400, rating: 4.6, reviews: 3456, icon: 'ðŸ›', description: 'DoÄŸal bebek masaj yaÄŸÄ±', ageRange: '0+ ay', features: ['%100 doÄŸal', 'Nemlendirici', 'YumuÅŸak'], discount: 20 },
                  { id: 'health_13', name: 'Pampers Pure Bezi', brand: 'Pampers', price: 1280, rating: 4.7, reviews: 2341, icon: 'ðŸ‘¶', description: 'DoÄŸal bebek bezi paketi', ageRange: 'YenidoÄŸan-6', features: ['DoÄŸal iÃ§erik', 'Nefes alabilir', 'Hassas cilt'] },
                  { id: 'health_14', name: 'Aveeno Bebek Losyonu', brand: 'Aveeno', price: 480, rating: 4.5, reviews: 4321, icon: 'ðŸ§´', description: 'Yulaf iÃ§erikli nemlendirici losyon', ageRange: '0+ ay', features: ['Yulaf iÃ§erikli', 'Kokusuz', 'Pediatrist testli'] },
                  { id: 'health_15', name: 'Cetaphil Bebek ÅžampuanÄ±', brand: 'Cetaphil', price: 400, rating: 4.6, reviews: 1876, icon: 'ðŸ§´', description: 'Nazik bebek ÅŸampuanÄ±', ageRange: '0+ ay', features: ['Nazik formÃ¼l', 'GÃ¶zyaÅŸÄ± iÃ§ermez', 'Kokusuz'] },
                  { id: 'health_16', name: 'Dr. Brown\'s Biberon Temizleme FÄ±rÃ§asÄ±', brand: 'Dr. Brown\'s', price: 128, rating: 4.5, reviews: 2876, icon: 'ðŸ§½', description: 'Biberon ve emzik temizleme seti', ageRange: 'TÃ¼m yaÅŸlar', features: ['KapsamlÄ± set', 'Kolay temizlik', 'DayanÄ±klÄ±'] },
                  { id: 'health_17', name: 'Medela Emzirme GÃ¶ÄŸÃ¼s Pedi', brand: 'Medela', price: 320, rating: 4.7, reviews: 2341, icon: 'ðŸ¤±', description: 'GÃ¶ÄŸÃ¼s pedi paketi 60\'lÄ±', ageRange: 'Hamilelik', features: ['Ultra ince', 'Nefes alabilir', 'YapÄ±ÅŸkan bant'] },
                  { id: 'health_18', name: 'Babyganics YÃ¼zey Temizleyici', brand: 'Babyganics', price: 320, rating: 4.6, reviews: 1987, icon: 'ðŸ§¼', description: 'Bebek gÃ¼venli yÃ¼zey temizleyici', ageRange: 'TÃ¼m yaÅŸlar', features: ['DoÄŸal iÃ§erik', 'Kokusuz', 'Ã‡ok amaÃ§lÄ±'] },
                  { id: 'health_19', name: 'Lansinoh Emzirme PompasÄ±', brand: 'Lansinoh', price: 2400, originalPrice: 2800, rating: 4.5, reviews: 1543, icon: 'ðŸ¼', description: 'Elektrikli emzirme pompasÄ±', ageRange: 'Hamilelik', features: ['Ã‡ift pompa', 'Sessiz', 'TaÅŸÄ±nabilir'], discount: 14 },
                  { id: 'health_20', name: 'Desitin Bebek Kremi', brand: 'Desitin', price: 256, rating: 4.8, reviews: 4567, icon: 'ðŸ©¹', description: 'PiÅŸik Ã¶nleyici bebek kremi', ageRange: '0+ ay', features: ['Ã‡inko oksit', 'PiÅŸik Ã¶nleyici', 'Pediatrist Ã¶nerili'] }
              ],
              food: [
                  { id: 'food_1', name: 'Earth\'s Best Organik TahÄ±l', brand: 'Earth\'s Best', price: 160, rating: 4.4, reviews: 2341, icon: 'ðŸ¥£', description: 'Bebekler iÃ§in organik tam tahÄ±l gevreÄŸi', ageRange: '4+ ay', features: ['Organik', 'Demir katkÄ±lÄ±', 'Kolay sindirilir'] },
                  { id: 'food_2', name: 'Gerber Organik Pouch', brand: 'Gerber', price: 416, rating: 4.5, reviews: 3876, icon: 'ðŸŽ', description: 'Organik meyve ve sebze pouch 8\'li paket', ageRange: '6+ ay', features: ['Åžeker eklenmemiÅŸ', 'Tekrar kapatÄ±labilir', 'Yolda besleme'] },
                  { id: 'food_3', name: 'Happy Baby Puf', brand: 'Happy Baby', price: 128, rating: 4.6, reviews: 4523, icon: 'ðŸŒ¾', description: 'Parmak beslenmesi iÃ§in organik puf atÄ±ÅŸtÄ±rmalÄ±k', ageRange: '8+ ay', features: ['Kolay erir', 'Organik', 'MÃ¼kemmel boyut'] },
                  { id: 'food_4', name: 'Similac Pro-Advance Formula', brand: 'Similac', price: 1120, rating: 4.3, reviews: 2987, icon: 'ðŸ¼', description: '2\'-FL HMO iÃ§eren bebek mamasÄ±', ageRange: '0-12 ay', features: ['Anne sÃ¼tÃ¼ne en yakÄ±n', 'Beyin geliÅŸimi', 'Kolay sindirilir'] },
                  { id: 'food_5', name: 'NurturMe Kinoa Kurabiyeleri', brand: 'NurturMe', price: 192, rating: 4.7, reviews: 1234, icon: 'ðŸª', description: 'Organik kinoa puf ve kurabiyeler', ageRange: '10+ ay', features: ['Protein zengini', 'Organik', 'Yapay renk yok'] },
                  { id: 'food_6', name: 'Baby Led Weaning Seti', brand: 'ezpz', price: 1280, rating: 4.5, reviews: 1876, icon: 'ðŸ½ï¸', description: 'Kendi kendine beslenme iÃ§in silikon beslenme seti', ageRange: '6+ ay', features: ['Emici taban', 'BPA iÃ§ermez', 'BulaÅŸÄ±k makinesinde yÄ±kanÄ±r'] },
                  { id: 'food_7', name: 'Hipp Organik Meyve PÃ¼resi', brand: 'Hipp', price: 320, rating: 4.6, reviews: 3214, icon: 'ðŸŒ', description: 'Organik meyve pÃ¼releri 6\'lÄ± paket', ageRange: '4+ ay', features: ['%100 organik', 'Åžeker eklenmemiÅŸ', 'Vitamin katkÄ±lÄ±'] },
                  { id: 'food_8', name: 'Aptamil Bebek SÃ¼tÃ¼', brand: 'Aptamil', price: 1280, rating: 4.4, reviews: 4567, icon: 'ðŸ¼', description: 'GeliÅŸim iÃ§in Ã¶zel formÃ¼l bebek sÃ¼tÃ¼', ageRange: '0-12 ay', features: ['Prebiyotik', 'DHA katkÄ±lÄ±', 'Kolay hazÄ±rlanÄ±r'] },
                  { id: 'food_9', name: 'Enfamil NeuroPro Formula', brand: 'Enfamil', price: 1440, originalPrice: 1600, rating: 4.5, reviews: 3214, icon: 'ðŸ¼', description: 'MFGM iÃ§eren bebek formÃ¼lÃ¼', ageRange: '0-12 ay', features: ['MFGM teknolojisi', 'DHA', 'Kolay sindirilir'], discount: 10 },
                  { id: 'food_10', name: 'Plum Organics Pouch Seti', brand: 'Plum Organics', price: 480, rating: 4.6, reviews: 2341, icon: 'ðŸŽ', description: 'Organik meyve sebze pouch 10\'lu', ageRange: '6+ ay', features: ['Organik', 'Åžeker eklenmemiÅŸ', 'Ã‡eÅŸitli lezzetler'] },
                  { id: 'food_11', name: 'Beech-Nut Stage 1 PÃ¼resi', brand: 'Beech-Nut', price: 320, rating: 4.4, reviews: 1876, icon: 'ðŸ¥•', description: 'Organik bebek pÃ¼resi seti', ageRange: '4+ ay', features: ['Organik', 'Temiz iÃ§erik', 'Tek malzeme'] },
                  { id: 'food_12', name: 'Ella\'s Kitchen Pouch', brand: 'Ella\'s Kitchen', price: 400, rating: 4.7, reviews: 2987, icon: 'ðŸŒ', description: 'Organik meyve pÃ¼resi pouch', ageRange: '4+ ay', features: ['Organik', 'Åžeker eklenmemiÅŸ', 'EÄŸlenceli desenler'] },
                  { id: 'food_13', name: 'Serenity Kids Bebek MamasÄ±', brand: 'Serenity Kids', price: 640, rating: 4.8, reviews: 1543, icon: 'ðŸ¥©', description: 'YÃ¼ksek protein organik bebek mamasÄ±', ageRange: '6+ ay', features: ['YÃ¼ksek protein', 'Organik', 'Temiz iÃ§erik'] },
                  { id: 'food_14', name: 'Once Upon a Farm Pouch', brand: 'Once Upon a Farm', price: 480, originalPrice: 560, rating: 4.6, reviews: 2341, icon: 'ðŸŒ±', description: 'SoÄŸuk basÄ±nÃ§lÄ± organik pÃ¼re', ageRange: '6+ ay', features: ['SoÄŸuk basÄ±nÃ§', 'Organik', 'Taze malzemeler'], discount: 14 },
                  { id: 'food_15', name: 'Happy Tot Organik TahÄ±l', brand: 'Happy Tot', price: 240, rating: 4.5, reviews: 1876, icon: 'ðŸ¥£', description: 'Organik tam tahÄ±l bebek gevreÄŸi', ageRange: '6+ ay', features: ['Organik', 'Demir katkÄ±lÄ±', 'Besleyici'] },
                  { id: 'food_16', name: 'Sprout Organik Pouch', brand: 'Sprout', price: 360, rating: 4.6, reviews: 1654, icon: 'ðŸ¥¦', description: 'Organik sebze meyve pouch', ageRange: '6+ ay', features: ['Organik', 'Åžeker eklenmemiÅŸ', 'Sebze odaklÄ±'] },
                  { id: 'food_17', name: 'Gerber Puffs AtÄ±ÅŸtÄ±rmalÄ±k', brand: 'Gerber', price: 192, rating: 4.4, reviews: 4321, icon: 'ðŸŒ¾', description: 'Parmak beslenmesi iÃ§in puf', ageRange: '8+ ay', features: ['Kolay erir', 'Vitamin katkÄ±lÄ±', 'Ã‡eÅŸitli lezzetler'] },
                  { id: 'food_18', name: 'Happy Baby Teether Wafers', brand: 'Happy Baby', price: 160, rating: 4.5, reviews: 2876, icon: 'ðŸª', description: 'DiÅŸ Ã§Ä±karma iÃ§in organik wafer', ageRange: '6+ ay', features: ['Organik', 'DiÅŸ Ã§Ä±karma', 'Kolay tutma'] },
                  { id: 'food_19', name: 'Amara Organik Bebek MamasÄ±', brand: 'Amara', price: 800, rating: 4.7, reviews: 987, icon: 'ðŸ¥—', description: 'Dondurularak kurutulmuÅŸ organik mama', ageRange: '6+ ay', features: ['Dondurularak kurutulmuÅŸ', 'Organik', 'Besleyici'] },
                  { id: 'food_20', name: 'Yumi Organik Bebek MamasÄ±', brand: 'Yumi', price: 640, rating: 4.6, reviews: 1234, icon: 'ðŸŽ', description: 'Taze organik bebek mamasÄ± abonelik', ageRange: '4+ ay', features: ['Taze', 'Organik', 'Abonelik sistemi'] }
              ],
              toys: [
                  { id: 'toy_1', name: 'Fisher-Price Piyano OyuncaÄŸÄ±', brand: 'Fisher-Price', price: 480, rating: 4.6, reviews: 3456, icon: 'ðŸŽ¹', description: 'MÃ¼zikli piyano oyuncaÄŸÄ±', ageRange: '6+ ay', features: ['5 tuÅŸ', 'ÅžarkÄ±lar', 'Parlak renkler'] },
                  { id: 'toy_2', name: 'VTech Ã–ÄŸrenme Laptop', brand: 'VTech', price: 800, originalPrice: 960, rating: 4.5, reviews: 2341, icon: 'ðŸ’»', description: 'Ä°nteraktif Ã¶ÄŸrenme laptopu', ageRange: '2-5 yaÅŸ', features: ['80+ ÅŸarkÄ±', 'EÄŸitici oyunlar', 'TaÅŸÄ±nabilir'], discount: 17 },
                  { id: 'toy_3', name: 'LEGO DUPLO YapÄ± BloÄŸu', brand: 'LEGO', price: 640, rating: 4.8, reviews: 5432, icon: 'ðŸ§±', description: 'BÃ¼yÃ¼k yapÄ± bloÄŸu seti 65 parÃ§a', ageRange: '18M+', features: ['GÃ¼venli boyut', 'YaratÄ±cÄ± oyun', 'DayanÄ±klÄ±'] },
                  { id: 'toy_4', name: 'Melissa & Doug AhÅŸap Bulmaca', brand: 'Melissa & Doug', price: 480, rating: 4.7, reviews: 2876, icon: 'ðŸ§©', description: 'Hayvan ÅŸekilli ahÅŸap bulmaca', ageRange: '12M+', features: ['AhÅŸap', 'EÄŸitici', '8 parÃ§a'] },
                  { id: 'toy_5', name: 'Baby Einstein MÃ¼zik KÃ¼resi', brand: 'Baby Einstein', price: 640, rating: 4.4, reviews: 1876, icon: 'ðŸŽµ', description: 'MÃ¼zik Ã§alan ve Ä±ÅŸÄ±k veren kÃ¼re', ageRange: '0+ ay', features: ['SakinleÅŸtirici mÃ¼zik', 'LED Ä±ÅŸÄ±k', 'Kolay tutma'] },
                  { id: 'toy_6', name: 'Play-Doh Klasik Set', brand: 'Play-Doh', price: 320, rating: 4.6, reviews: 5234, icon: 'ðŸŽ¨', description: '10 kutu oyun hamuru seti', ageRange: '2+ yaÅŸ', features: ['YaratÄ±cÄ± oyun', 'GÃ¼venli', 'Renkli'] },
                  { id: 'toy_7', name: 'Hape AhÅŸap Bloklar', brand: 'Hape', price: 640, rating: 4.7, reviews: 2341, icon: 'ðŸ§±', description: 'Renkli ahÅŸap yapÄ± bloklarÄ±', ageRange: '12M+', features: ['AhÅŸap', 'EÄŸitici', '100 parÃ§a'] },
                  { id: 'toy_8', name: 'Green Toys Ã‡Ã¶p Kamyonu', brand: 'Green Toys', price: 480, rating: 4.6, reviews: 1876, icon: 'ðŸš›', description: 'Geri dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ oyuncak kamyon', ageRange: '2+ yaÅŸ', features: ['Ekolojik', 'DayanÄ±klÄ±', 'GÃ¼venli'] },
                  { id: 'toy_9', name: 'Fat Brain Toys SpinAgain', brand: 'Fat Brain Toys', price: 800, originalPrice: 960, rating: 4.8, reviews: 3214, icon: 'ðŸŽ¯', description: 'DÃ¶nen disk yÄ±ÄŸma oyuncaÄŸÄ±', ageRange: '12M+', features: ['Motor geliÅŸimi', 'Renkli', 'EÄŸlenceli'], discount: 17 },
                  { id: 'toy_10', name: 'Little Tikes Cozy Coupe', brand: 'Little Tikes', price: 3200, rating: 4.7, reviews: 4567, icon: 'ðŸš—', description: 'Klasik Ã§ocuk arabasÄ±', ageRange: '18M-5Y', features: ['Klasik tasarÄ±m', 'DayanÄ±klÄ±', 'GÃ¼venli'] },
                  { id: 'toy_11', name: 'Manhattan Toy Winkel', brand: 'Manhattan Toy', price: 480, rating: 4.6, reviews: 2987, icon: 'ðŸ”µ', description: 'GÃ¶rsel uyarÄ±m oyuncaÄŸÄ±', ageRange: '0+ ay', features: ['GÃ¶rsel uyarÄ±m', 'Kolay tutma', 'GÃ¼venli'] },
                  { id: 'toy_12', name: 'Oball Rattle', brand: 'Oball', price: 160, rating: 4.7, reviews: 5432, icon: 'ðŸ””', description: 'Åžeffaf top Ã§Ä±ngÄ±rak', ageRange: '0+ ay', features: ['Kolay tutma', 'Ã‡Ä±ngÄ±raklÄ±', 'Hafif'] },
                  { id: 'toy_13', name: 'HABA AhÅŸap FigÃ¼rler', brand: 'HABA', price: 640, rating: 4.8, reviews: 2341, icon: 'ðŸŽ­', description: 'AhÅŸap oyun figÃ¼rleri seti', ageRange: '18M+', features: ['AhÅŸap', 'YaratÄ±cÄ± oyun', 'DayanÄ±klÄ±'] },
                  { id: 'toy_14', name: 'B. Toys Aktivite KÃ¼pÃ¼', brand: 'B. Toys', price: 800, originalPrice: 960, rating: 4.5, reviews: 1876, icon: 'ðŸŽ²', description: '5 yÃ¼zlÃ¼ aktivite kÃ¼pÃ¼', ageRange: '6M+', features: ['Ã‡ok yÃ¶nlÃ¼', 'EÄŸitici', 'Renkli'], discount: 17 },
                  { id: 'toy_15', name: 'Plan Toys AhÅŸap Arabalar', brand: 'Plan Toys', price: 480, rating: 4.7, reviews: 1654, icon: 'ðŸš™', description: 'SÃ¼rdÃ¼rÃ¼lebilir ahÅŸap oyuncak arabalar', ageRange: '12M+', features: ['SÃ¼rdÃ¼rÃ¼lebilir', 'AhÅŸap', 'GÃ¼venli'] },
                  { id: 'toy_16', name: 'Skip Hop Aktivite Merkezi', brand: 'Skip Hop', price: 1600, rating: 4.6, reviews: 2987, icon: 'ðŸŽª', description: '360Â° dÃ¶ner aktivite merkezi', ageRange: '4-12 ay', features: ['360Â° dÃ¶nÃ¼ÅŸ', 'Ã‡ok aktivite', 'Ayarlanabilir'] },
                  { id: 'toy_17', name: 'Infantino Ã‡Ä±ngÄ±rak Seti', brand: 'Infantino', price: 320, rating: 4.5, reviews: 4321, icon: 'ðŸ””', description: '5\'li Ã§Ä±ngÄ±rak seti', ageRange: '0+ ay', features: ['Ã‡eÅŸitli dokular', 'Ã‡Ä±ngÄ±raklÄ±', 'Renkli'] },
                  { id: 'toy_18', name: 'Nuby DiÅŸ Ã‡Ä±karma OyuncaÄŸÄ±', brand: 'Nuby', price: 160, rating: 4.4, reviews: 2876, icon: 'ðŸ¦·', description: 'SoÄŸutulabilir diÅŸ Ã§Ä±karma oyuncaÄŸÄ±', ageRange: '3M+', features: ['SoÄŸutulabilir', 'FarklÄ± dokular', 'BPA iÃ§ermez'] },
                  { id: 'toy_19', name: 'Lamaze GÃ¶rsel UyarÄ±m OyuncaÄŸÄ±', brand: 'Lamaze', price: 480, rating: 4.7, reviews: 1543, icon: 'ðŸŒˆ', description: 'Renkli gÃ¶rsel uyarÄ±m oyuncaÄŸÄ±', ageRange: '0+ ay', features: ['GÃ¶rsel uyarÄ±m', 'Ã‡Ä±ngÄ±raklÄ±', 'EÄŸitici'] },
                  { id: 'toy_20', name: 'Green Toys Su OyuncaÄŸÄ± Seti', brand: 'Green Toys', price: 640, originalPrice: 800, rating: 4.6, reviews: 2341, icon: 'ðŸ’§', description: 'Banyo oyuncaÄŸÄ± seti', ageRange: '6M+', features: ['Geri dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ', 'GÃ¼venli', 'EÄŸlenceli'], discount: 20 }
              ],
              books: [
                  { id: 'book_1', name: 'Ä°lk 100 Kelime - Bebek KitabÄ±', brand: 'Scholastic', price: 160, rating: 4.7, reviews: 4321, icon: 'ðŸ“š', description: 'Bebekler iÃ§in gÃ¶rsel kelime kitabÄ±', ageRange: '0-3 yaÅŸ', features: ['BÃ¼yÃ¼k resimler', 'Sert kapak', '100 kelime'] },
                  { id: 'book_2', name: 'YumuÅŸak Dokun-Hisset KitabÄ±', brand: 'DK', price: 192, rating: 4.8, reviews: 3456, icon: 'ðŸ“–', description: 'Dokunsal Ã¶ÄŸrenme kitabÄ±', ageRange: '6M+', features: ['FarklÄ± dokular', 'Parlak renkler', 'DayanÄ±klÄ±'] },
                  { id: 'book_3', name: 'Uyku ZamanÄ± Hikayeleri', brand: 'Usborne', price: 320, originalPrice: 400, rating: 4.6, reviews: 2341, icon: 'ðŸŒ™', description: 'Uyku Ã¶ncesi hikaye koleksiyonu', ageRange: '2-5 yaÅŸ', features: ['10 hikaye', 'Resimli', 'SakinleÅŸtirici'], discount: 20 },
                  { id: 'book_4', name: 'Alfabe Ã–ÄŸrenme KartlarÄ±', brand: 'School Zone', price: 128, rating: 4.5, reviews: 2876, icon: 'ðŸ”¤', description: 'ABC Ã¶ÄŸrenme flash kartlarÄ±', ageRange: '3+ yaÅŸ', features: ['56 kart', 'Resimli', 'EÄŸitici'] },
                  { id: 'book_5', name: 'SayÄ±larÄ± Ã–ÄŸreniyorum', brand: 'Baby Einstein', price: 160, rating: 4.4, reviews: 1876, icon: 'ðŸ”¢', description: 'SayÄ±larÄ± Ã¶ÄŸrenmek iÃ§in interaktif kitap', ageRange: '1-3 yaÅŸ', features: ['Butonlar', 'MÃ¼zik', 'IÅŸÄ±k efektleri'] },
                  { id: 'book_6', name: 'The Very Hungry Caterpillar', brand: 'Eric Carle', price: 128, rating: 4.9, reviews: 8765, icon: 'ðŸ›', description: 'Klasik Ã§ocuk kitabÄ±', ageRange: '2-5 yaÅŸ', features: ['Klasik', 'EÄŸitici', 'Resimli'] },
                  { id: 'book_7', name: 'Goodnight Moon', brand: 'Margaret Wise Brown', price: 96, rating: 4.8, reviews: 5432, icon: 'ðŸŒ™', description: 'Uyku Ã¶ncesi klasik kitap', ageRange: '0-3 yaÅŸ', features: ['Klasik', 'SakinleÅŸtirici', 'Sevimli'] },
                  { id: 'book_8', name: 'Brown Bear Collection', brand: 'Eric Carle', price: 320, rating: 4.7, reviews: 3214, icon: 'ðŸ»', description: '4\'lÃ¼ klasik kitaplar seti', ageRange: '1-4 yaÅŸ', features: ['Klasik set', 'EÄŸitici', 'Renkli'] },
                  { id: 'book_9', name: 'Press Here KitabÄ±', brand: 'Herve Tullet', price: 160, originalPrice: 192, rating: 4.8, reviews: 2341, icon: 'ðŸ‘†', description: 'Ä°nteraktif basma kitabÄ±', ageRange: '2-5 yaÅŸ', features: ['Ä°nteraktif', 'EÄŸlenceli', 'EÄŸitici'], discount: 17 },
                  { id: 'book_10', name: 'Where\'s Spot? Lift-the-Flap', brand: 'Eric Hill', price: 128, rating: 4.6, reviews: 2876, icon: 'ðŸ•', description: 'KaldÄ±r-kapa eÄŸlenceli kitap', ageRange: '1-4 yaÅŸ', features: ['KaldÄ±r-kapa', 'EÄŸlenceli', 'DayanÄ±klÄ±'] },
                  { id: 'book_11', name: 'Pete the Cat Seti', brand: 'James Dean', price: 480, rating: 4.7, reviews: 1876, icon: 'ðŸ±', description: '5\'li Pete the Cat kitap seti', ageRange: '2-6 yaÅŸ', features: ['EÄŸlenceli', 'MÃ¼zikli', 'Resimli'] },
                  { id: 'book_12', name: 'Dr. Seuss Klasik Seti', brand: 'Dr. Seuss', price: 640, originalPrice: 800, rating: 4.9, reviews: 4567, icon: 'ðŸ“–', description: 'Klasik Dr. Seuss kitaplarÄ± seti', ageRange: '3-8 yaÅŸ', features: ['Klasik', 'EÄŸitici', 'EÄŸlenceli'], discount: 20 },
                  { id: 'book_13', name: 'Llama Llama Red Pajama', brand: 'Anna Dewdney', price: 128, rating: 4.6, reviews: 2341, icon: 'ðŸ¦™', description: 'Sevimli llama hikayesi', ageRange: '2-5 yaÅŸ', features: ['Sevimli', 'SakinleÅŸtirici', 'Resimli'] },
                  { id: 'book_14', name: 'Chicka Chicka Boom Boom', brand: 'Bill Martin', price: 160, rating: 4.7, reviews: 2987, icon: 'ðŸŒ´', description: 'Alfabe Ã¶ÄŸrenme kitabÄ±', ageRange: '2-5 yaÅŸ', features: ['EÄŸitici', 'EÄŸlenceli', 'Ritmik'] },
                  { id: 'book_15', name: 'The Snowy Day', brand: 'Ezra Jack Keats', price: 128, rating: 4.8, reviews: 1654, icon: 'â„ï¸', description: 'Klasik kÄ±ÅŸ hikayesi', ageRange: '2-5 yaÅŸ', features: ['Klasik', 'Resimli', 'Sevimli'] },
                  { id: 'book_16', name: 'Little Blue Truck', brand: 'Alice Schertle', price: 160, rating: 4.7, reviews: 3214, icon: 'ðŸš›', description: 'Sevimli kamyon hikayesi', ageRange: '2-5 yaÅŸ', features: ['EÄŸlenceli', 'EÄŸitici', 'Resimli'] },
                  { id: 'book_17', name: 'Giraffes Can\'t Dance', brand: 'Giles Andreae', price: 128, originalPrice: 160, rating: 4.6, reviews: 1876, icon: 'ðŸ¦’', description: 'Ä°lham verici hikaye', ageRange: '2-5 yaÅŸ', features: ['Ä°lham verici', 'EÄŸlenceli', 'Resimli'], discount: 20 },
                  { id: 'book_18', name: 'We\'re Going on a Bear Hunt', brand: 'Michael Rosen', price: 160, rating: 4.8, reviews: 2341, icon: 'ðŸ»', description: 'Macera hikayesi', ageRange: '2-5 yaÅŸ', features: ['Macera', 'EÄŸlenceli', 'Ritmik'] },
                  { id: 'book_19', name: 'The Gruffalo', brand: 'Julia Donaldson', price: 160, rating: 4.7, reviews: 2987, icon: 'ðŸ‘¹', description: 'Klasik Ã§ocuk hikayesi', ageRange: '3-7 yaÅŸ', features: ['Klasik', 'EÄŸlenceli', 'Resimli'] },
                  { id: 'book_20', name: 'Dear Zoo Lift-the-Flap', brand: 'Rod Campbell', price: 128, rating: 4.7, reviews: 5432, icon: 'ðŸ“¬', description: 'HayvanlarÄ± tanÄ±ma kitabÄ±', ageRange: '1-4 yaÅŸ', features: ['KaldÄ±r-kapa', 'EÄŸitici', 'EÄŸlenceli'] }
              ],
              nursery: [
                  { id: 'nursery_1', name: 'Graco Pack n Play BeÅŸik', brand: 'Graco', price: 3200, rating: 4.5, reviews: 3456, icon: 'ðŸ›ï¸', description: 'TaÅŸÄ±nabilir beÅŸik ve oyun alanÄ±', ageRange: '0-3 yaÅŸ', features: ['Kompakt', 'Kolay kurulum', 'Ã‡ok amaÃ§lÄ±'] },
                  { id: 'nursery_2', name: 'Babyletto YÄ±ldÄ±z BeÅŸik', brand: 'Babyletto', price: 12800, originalPrice: 14400, rating: 4.8, reviews: 1234, icon: 'â­', description: 'Modern tasarÄ±m beÅŸik', ageRange: '0-2 yaÅŸ', features: ['AhÅŸap', '3 yÃ¼kseklik', 'DÃ¶nÃ¼ÅŸtÃ¼rÃ¼lebilir'], discount: 11 },
                  { id: 'nursery_3', name: 'Hatch Baby Rest Gece LambasÄ±', brand: 'Hatch', price: 2400, rating: 4.6, reviews: 2341, icon: 'ðŸ’¡', description: 'AkÄ±llÄ± gece lambasÄ± ve ses makinesi', ageRange: '0+ ay', features: ['App kontrolÃ¼', 'Renk deÄŸiÅŸimi', 'Beyaz gÃ¼rÃ¼ltÃ¼'] },
                  { id: 'nursery_4', name: 'Skip Hop Bebek OdasÄ± OrganizatÃ¶rÃ¼', brand: 'Skip Hop', price: 800, rating: 4.4, reviews: 1876, icon: 'ðŸ—„ï¸', description: 'Ã‡ok bÃ¶lmeli depolama organizatÃ¶rÃ¼', ageRange: 'TÃ¼m yaÅŸlar', features: ['4 bÃ¶lme', 'AsÄ±labilir', 'Ã‡ok fonksiyonlu'] },
                  { id: 'nursery_5', name: 'Safety 1st Bebek OdasÄ± KapÄ± Emniyeti', brand: 'Safety 1st', price: 320, rating: 4.5, reviews: 2876, icon: 'ðŸšª', description: 'GÃ¼venlik kapÄ± emniyeti', ageRange: 'TÃ¼m yaÅŸlar', features: ['Ayarlanabilir', 'Kolay kurulum', 'DayanÄ±klÄ±'] },
                  { id: 'nursery_6', name: 'Pottery Barn Kids BeÅŸik', brand: 'Pottery Barn Kids', price: 16000, originalPrice: 19200, rating: 4.8, reviews: 987, icon: 'ðŸ›ï¸', description: 'LÃ¼ks dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lebilir beÅŸik', ageRange: '0-5 yaÅŸ', features: ['DÃ¶nÃ¼ÅŸtÃ¼rÃ¼lebilir', 'Premium', 'DayanÄ±klÄ±'], discount: 17 },
                  { id: 'nursery_7', name: 'Dreambaby GÃ¼venlik Seti', brand: 'Dreambaby', price: 640, rating: 4.5, reviews: 2341, icon: 'ðŸ”’', description: 'KapsamlÄ± bebek gÃ¼venlik seti', ageRange: 'TÃ¼m yaÅŸlar', features: ['KapsamlÄ±', 'Kolay kurulum', 'GÃ¼venli'] },
                  { id: 'nursery_8', name: 'Skip Hop Duo Signature Ã‡anta', brand: 'Skip Hop', price: 1600, rating: 4.7, reviews: 1876, icon: 'ðŸŽ’', description: 'Premium bez Ã§antasÄ±', ageRange: 'TÃ¼m yaÅŸlar', features: ['Premium', 'Ã‡ok bÃ¶lmeli', 'ÅžÄ±k'] },
                  { id: 'nursery_9', name: 'Delta Children Emme BeÅŸiÄŸi', brand: 'Delta Children', price: 4800, originalPrice: 5600, rating: 4.6, reviews: 1543, icon: 'ðŸ›ï¸', description: 'Kompakt dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lebilir beÅŸik', ageRange: '0-4 yaÅŸ', features: ['Kompakt', 'DÃ¶nÃ¼ÅŸtÃ¼rÃ¼lebilir', 'DayanÄ±klÄ±'], discount: 14 },
                  { id: 'nursery_10', name: 'Babyletto ModÃ¼ler Depolama', brand: 'Babyletto', price: 2400, rating: 4.7, reviews: 876, icon: 'ðŸ“¦', description: 'ModÃ¼ler depolama sistemi', ageRange: 'TÃ¼m yaÅŸlar', features: ['ModÃ¼ler', 'Ã‡ok amaÃ§lÄ±', 'Modern'] },
                  { id: 'nursery_11', name: 'IKEA Bebek OdasÄ± Seti', brand: 'IKEA', price: 3200, rating: 4.5, reviews: 4321, icon: 'ðŸª‘', description: 'Temel bebek odasÄ± mobilya seti', ageRange: '0-5 yaÅŸ', features: ['Uygun fiyat', 'Fonksiyonel', 'DayanÄ±klÄ±'] },
                  { id: 'nursery_12', name: 'Stokke Sleepi BeÅŸik', brand: 'Stokke', price: 14400, originalPrice: 16000, rating: 4.9, reviews: 1234, icon: 'ðŸ›ï¸', description: 'BÃ¼yÃ¼yen oval beÅŸik', ageRange: '0-10 yaÅŸ', features: ['BÃ¼yÃ¼yen', 'Premium', 'Uzun Ã¶mÃ¼rlÃ¼'], discount: 10 },
                  { id: 'nursery_13', name: 'Summer Infant BeÅŸik Perdesi', brand: 'Summer Infant', price: 640, rating: 4.6, reviews: 2876, icon: 'ðŸªŸ', description: 'Bebek beÅŸik perdesi', ageRange: '0-2 yaÅŸ', features: ['IÅŸÄ±k geÃ§irmez', 'Nefes alabilir', 'Kolay kurulum'] },
                  { id: 'nursery_14', name: 'Dream On Me BeÅŸik', brand: 'Dream On Me', price: 3200, rating: 4.5, reviews: 1876, icon: 'ðŸ›ï¸', description: 'Kompakt portatif beÅŸik', ageRange: '0-2 yaÅŸ', features: ['Portatif', 'Kompakt', 'Hafif'] },
                  { id: 'nursery_15', name: 'Baby Trend BeÅŸik Seti', brand: 'Baby Trend', price: 2400, originalPrice: 2800, rating: 4.4, reviews: 2341, icon: 'ðŸ›ï¸', description: 'Temel beÅŸik seti', ageRange: '0-2 yaÅŸ', features: ['Temel set', 'Uygun fiyat', 'DayanÄ±klÄ±'], discount: 14 },
                  { id: 'nursery_16', name: 'Munchkin Latch Bebek GÃ¼venliÄŸi', brand: 'Munchkin', price: 480, rating: 4.6, reviews: 3214, icon: 'ðŸ”', description: 'Dolap ve Ã§ekmece gÃ¼venlik kilidi', ageRange: 'TÃ¼m yaÅŸlar', features: ['Kolay kurulum', 'GÃ¼venli', 'KapsamlÄ±'] },
                  { id: 'nursery_17', name: 'Carter\'s Bebek OdasÄ± Dekorasyonu', brand: 'Carter\'s', price: 960, rating: 4.6, reviews: 1987, icon: 'ðŸŽ¨', description: 'Bebek odasÄ± dekorasyon seti', ageRange: 'TÃ¼m yaÅŸlar', features: ['EÄŸlenceli', 'Renkli', 'Kolay kurulum'] },
                  { id: 'nursery_18', name: 'Infantino Depolama OrganizatÃ¶rÃ¼', brand: 'Infantino', price: 800, rating: 4.5, reviews: 1543, icon: 'ðŸ“', description: 'Ã‡ok bÃ¶lmeli depolama Ã§Ã¶zÃ¼mÃ¼', ageRange: 'TÃ¼m yaÅŸlar', features: ['Ã‡ok bÃ¶lmeli', 'AsÄ±labilir', 'Fonksiyonel'] },
                  { id: 'nursery_19', name: 'Graco Simple Switch BeÅŸik', brand: 'Graco', price: 5600, originalPrice: 6400, rating: 4.7, reviews: 2341, icon: 'ðŸ›ï¸', description: 'Kolay dÃ¶nÃ¼ÅŸÃ¼m beÅŸik', ageRange: '0-5 yaÅŸ', features: ['Kolay dÃ¶nÃ¼ÅŸÃ¼m', 'Ã‡ok amaÃ§lÄ±', 'DayanÄ±klÄ±'], discount: 13 },
                  { id: 'nursery_20', name: 'Skip Hop BeÅŸik Ã–rtÃ¼sÃ¼', brand: 'Skip Hop', price: 480, rating: 4.6, reviews: 1876, icon: 'ðŸ›‹ï¸', description: 'BeÅŸik iÃ§in Ã¶rtÃ¼ seti', ageRange: '0-2 yaÅŸ', features: ['YumuÅŸak', 'Kolay bakÄ±m', 'Ã‡eÅŸitli desenler'] }
              ],
              pregnancy: [
                  { id: 'preg_1', name: 'Bellababy Hamile YastÄ±ÄŸÄ±', brand: 'Bellababy', price: 640, rating: 4.6, reviews: 3456, icon: 'ðŸ›ï¸', description: 'U ÅŸekilli hamilelik destek yastÄ±ÄŸÄ±', ageRange: 'Hamilelik', features: ['U ÅŸekli', 'YumuÅŸak', 'Ã‡ok amaÃ§lÄ±'] },
                  { id: 'preg_2', name: 'Frida Mom DoÄŸum SonrasÄ± Seti', brand: 'Frida Mom', price: 960, rating: 4.7, reviews: 2341, icon: 'ðŸ©¹', description: 'DoÄŸum sonrasÄ± bakÄ±m seti', ageRange: 'Hamilelik', features: ['7 Ã¼rÃ¼n', 'Pediatrist Ã¶nerili', 'Eksiksiz set'] },
                  { id: 'preg_3', name: 'Kindred Bravely Emzirme SÃ¼tyeni', brand: 'Kindred Bravely', price: 480, rating: 4.8, reviews: 4567, icon: 'ðŸ‘™', description: 'Rahat emzirme sÃ¼tyeni', ageRange: 'Hamilelik', features: ['GeniÅŸletilebilir', 'Destekleyici', 'Kolay eriÅŸim'] },
                  { id: 'preg_4', name: 'Ameda Mya Emzirme PompasÄ±', brand: 'Ameda', price: 4800, originalPrice: 5600, rating: 4.5, reviews: 1876, icon: 'ðŸ¼', description: 'Hafif ve taÅŸÄ±nabilir emzirme pompasÄ±', ageRange: 'Hamilelik', features: ['Hafif', 'Sessiz', 'Ã‡ift pompa'], discount: 14 },
                  { id: 'preg_5', name: 'Boppy Hamilelik YastÄ±ÄŸÄ±', brand: 'Boppy', price: 800, rating: 4.7, reviews: 2987, icon: 'ðŸ›ï¸', description: 'C ÅŸekilli hamilelik yastÄ±ÄŸÄ±', ageRange: 'Hamilelik', features: ['C ÅŸekli', 'Ã‡ok amaÃ§lÄ±', 'YumuÅŸak'] },
                  { id: 'preg_6', name: 'Motherhood Maternity KÄ±yafet Seti', brand: 'Motherhood', price: 1280, originalPrice: 1600, rating: 4.5, reviews: 2341, icon: 'ðŸ‘—', description: 'Hamilelik kÄ±yafet seti', ageRange: 'Hamilelik', features: ['Rahat', 'Stil Ã§eÅŸitliliÄŸi', 'Kaliteli'], discount: 20 },
                  { id: 'preg_7', name: 'Ingrid & Isabel Bel BandÄ±', brand: 'Ingrid & Isabel', price: 480, rating: 4.6, reviews: 1876, icon: 'ðŸ‘–', description: 'Hamilelik bel desteÄŸi bandÄ±', ageRange: 'Hamilelik', features: ['Destekleyici', 'Rahat', 'Ã‡ok amaÃ§lÄ±'] },
                  { id: 'preg_8', name: 'Boob Design Emzirme KÄ±yafeti', brand: 'Boob Design', price: 1600, rating: 4.7, reviews: 1543, icon: 'ðŸ‘•', description: 'ÅžÄ±k emzirme kÄ±yafeti', ageRange: 'Hamilelik', features: ['ÅžÄ±k', 'Fonksiyonel', 'Rahat'] },
                  { id: 'preg_9', name: 'Spectra S1 Emzirme PompasÄ±', brand: 'Spectra', price: 6400, originalPrice: 7200, rating: 4.8, reviews: 3214, icon: 'ðŸ¼', description: 'Hastane kalitesi emzirme pompasÄ±', ageRange: 'Hamilelik', features: ['Hastane kalitesi', 'Sessiz', 'Ã‡ift pompa'], discount: 11 },
                  { id: 'preg_10', name: 'Seraphine Hamilelik Elbisesi', brand: 'Seraphine', price: 2400, rating: 4.8, reviews: 987, icon: 'ðŸ‘—', description: 'Premium hamilelik elbisesi', ageRange: 'Hamilelik', features: ['Premium', 'ÅžÄ±k', 'Rahat'] },
                  { id: 'preg_11', name: 'Belly Bandit Bel SargÄ±sÄ±', brand: 'Belly Bandit', price: 960, rating: 4.6, reviews: 2341, icon: 'ðŸŽ€', description: 'DoÄŸum sonrasÄ± bel desteÄŸi', ageRange: 'Hamilelik', features: ['Destekleyici', 'Rahat', 'Fonksiyonel'] },
                  { id: 'preg_12', name: 'Isabella Oliver Hamilelik Giyim', brand: 'Isabella Oliver', price: 3200, originalPrice: 4000, rating: 4.7, reviews: 1876, icon: 'ðŸ‘”', description: 'ÅžÄ±k hamilelik giyim koleksiyonu', ageRange: 'Hamilelik', features: ['ÅžÄ±k', 'Premium', 'Ã‡eÅŸitli'], discount: 20 },
                  { id: 'preg_13', name: 'Mama Mio Hamilelik BakÄ±m Seti', brand: 'Mama Mio', price: 1600, rating: 4.6, reviews: 1543, icon: 'ðŸ§´', description: 'Hamilelik bakÄ±m kremi seti', ageRange: 'Hamilelik', features: ['DoÄŸal iÃ§erik', 'Nemlendirici', 'GÃ¼venli'] },
                  { id: 'preg_14', name: 'PinkBlush Hamilelik TakÄ±mÄ±', brand: 'PinkBlush', price: 960, originalPrice: 1280, rating: 4.5, reviews: 2341, icon: 'ðŸ‘—', description: 'Hamilelik takÄ±m elbise', ageRange: 'Hamilelik', features: ['ÅžÄ±k', 'Rahat', 'Ã‡eÅŸitli boyutlar'], discount: 25 },
                  { id: 'preg_15', name: 'Haakaa Emzirme PompasÄ±', brand: 'Haakaa', price: 320, rating: 4.8, reviews: 5432, icon: 'ðŸ¼', description: 'Silikon manuel emzirme pompasÄ±', ageRange: 'Hamilelik', features: ['Manuel', 'Kolay kullanÄ±m', 'TaÅŸÄ±nabilir'] },
                  { id: 'preg_16', name: 'Blanqi Hamilelik Pantolonu', brand: 'Blanqi', price: 1600, rating: 4.7, reviews: 1987, icon: 'ðŸ‘–', description: 'Destekleyici hamilelik pantolonu', ageRange: 'Hamilelik', features: ['Destekleyici', 'Rahat', 'ÅžÄ±k'] },
                  { id: 'preg_17', name: 'Latched Mama Emzirme ÃœstÃ¼', brand: 'Latched Mama', price: 1280, rating: 4.6, reviews: 2341, icon: 'ðŸ‘•', description: 'Rahat emzirme Ã¼stÃ¼', ageRange: 'Hamilelik', features: ['Rahat', 'Fonksiyonel', 'Ã‡eÅŸitli stiller'] },
                  { id: 'preg_18', name: 'Nursing Queen Emzirme Elbisesi', brand: 'Nursing Queen', price: 2400, originalPrice: 2800, rating: 4.7, reviews: 1876, icon: 'ðŸ‘—', description: 'ÅžÄ±k emzirme elbisesi', ageRange: 'Hamilelik', features: ['ÅžÄ±k', 'Fonksiyonel', 'Premium'], discount: 14 },
                  { id: 'preg_19', name: 'Milky Mama Takviye Seti', brand: 'Milky Mama', price: 960, rating: 4.6, reviews: 1543, icon: 'ðŸª', description: 'SÃ¼t artÄ±rÄ±cÄ± Ã§erez seti', ageRange: 'Hamilelik', features: ['DoÄŸal', 'Etkili', 'Lezzetli'] },
                  { id: 'preg_20', name: 'Kindred Bravely SÃ¼tyen Seti', brand: 'Kindred Bravely', price: 1920, originalPrice: 2400, rating: 4.8, reviews: 3214, icon: 'ðŸ‘™', description: '3\'lÃ¼ emzirme sÃ¼tyeni seti', ageRange: 'Hamilelik', features: ['Ã‡ok amaÃ§lÄ±', 'Rahat', 'Kaliteli'], discount: 20 }
              ],
              feeding: [
                  { id: 'feed_1', name: 'Philips Avent Biberon Seti', brand: 'Philips', price: 480, rating: 4.6, reviews: 5234, icon: 'ðŸ¼', description: '6\'lÄ± doÄŸal cam biberon seti', ageRange: '0+ ay', features: ['BPA iÃ§ermez', 'Kolay temizlik', 'Anti-kolik'] },
                  { id: 'feed_2', name: 'ezpz Minik Tabak Seti', brand: 'ezpz', price: 320, rating: 4.7, reviews: 3456, icon: 'ðŸ½ï¸', description: 'Emici tabanlÄ± silikon beslenme tabaÄŸÄ±', ageRange: '6M+', features: ['Emici taban', 'BPA iÃ§ermez', 'Kolay temizlik'] },
                  { id: 'feed_3', name: 'Munchkin YumuÅŸak UÃ§lu KaÅŸÄ±k Seti', brand: 'Munchkin', price: 160, rating: 4.5, reviews: 2876, icon: 'ðŸ¥„', description: 'Bebekler iÃ§in yumuÅŸak uÃ§lu kaÅŸÄ±k 6\'lÄ±', ageRange: '4M+', features: ['YumuÅŸak uÃ§', 'BPA iÃ§ermez', 'Renkli'] },
                  { id: 'feed_4', name: 'OXO Tot Yedek Minderli Mama Sandalyesi', brand: 'OXO', price: 3200, originalPrice: 4000, rating: 4.8, reviews: 1234, icon: 'ðŸª‘', description: 'YÃ¼ksek sandalye - yedek minder dahil', ageRange: '6M-3Y', features: ['Ayarlanabilir', 'Kolay temizlik', 'DayanÄ±klÄ±'], discount: 20 },
                  { id: 'feed_5', name: 'Dr. Brown\'s Biberon Seti', brand: 'Dr. Brown\'s', price: 640, rating: 4.7, reviews: 4567, icon: 'ðŸ¼', description: 'Anti-kolik biberon seti', ageRange: '0+ ay', features: ['Anti-kolik', 'HavalandÄ±rma sistemi', 'BPA iÃ§ermez'] },
                  { id: 'feed_6', name: 'Tommee Tippee Closer to Nature', brand: 'Tommee Tippee', price: 480, rating: 4.6, reviews: 3214, icon: 'ðŸ¼', description: 'DoÄŸal emme benzeri biberon', ageRange: '0+ ay', features: ['DoÄŸal emme', 'Kolay tutma', 'GÃ¼venli'] },
                  { id: 'feed_7', name: 'NumNum Gootensil KaÅŸÄ±k', brand: 'NumNum', price: 160, rating: 4.8, reviews: 2341, icon: 'ðŸ¥„', description: 'Pre-cupped Ã¶n yÃ¼kleme kaÅŸÄ±k', ageRange: '4M+', features: ['Ã–n yÃ¼kleme', 'Kolay kullanÄ±m', 'GÃ¼venli'] },
                  { id: 'feed_8', name: 'Boon Biberon Kurutma RaftÄ±', brand: 'Boon', price: 480, originalPrice: 640, rating: 4.7, reviews: 1876, icon: 'ðŸª´', description: 'Biberon ve aksesuar kurutma raftÄ±', ageRange: 'TÃ¼m yaÅŸlar', features: ['Kompakt', 'Fonksiyonel', 'Kolay temizlik'], discount: 25 },
                  { id: 'feed_9', name: 'Munchkin Gizli Kamera MonitÃ¶rÃ¼', brand: 'Munchkin', price: 1600, rating: 4.5, reviews: 1543, icon: 'ðŸ“¹', description: 'Biberon ve mama hazÄ±rlama iÃ§in', ageRange: 'TÃ¼m yaÅŸlar', features: ['Kolay kullanÄ±m', 'GÃ¼venli', 'Pratik'] },
                  { id: 'feed_10', name: 'Nuk Biberon Seti', brand: 'Nuk', price: 400, rating: 4.6, reviews: 2987, icon: 'ðŸ¼', description: 'DoÄŸal emme benzeri biberon seti', ageRange: '0+ ay', features: ['DoÄŸal emme', 'Anti-kolik', 'GÃ¼venli'] },
                  { id: 'feed_11', name: 'Avent Natural Biberon', brand: 'Philips Avent', price: 320, rating: 4.7, reviews: 4321, icon: 'ðŸ¼', description: 'DoÄŸal emme biberon', ageRange: '0+ ay', features: ['DoÄŸal emme', 'Kolay kullanÄ±m', 'GÃ¼venli'] },
                  { id: 'feed_12', name: 'Comotomo Biberon', brand: 'Comotomo', price: 640, originalPrice: 800, rating: 4.8, reviews: 3214, icon: 'ðŸ¼', description: 'Silikon doÄŸal emme biberon', ageRange: '0+ ay', features: ['Silikon', 'YumuÅŸak', 'DoÄŸal emme'], discount: 20 },
                  { id: 'feed_13', name: 'Boon Pulp Beslenme Seti', brand: 'Boon', price: 480, rating: 4.6, reviews: 2341, icon: 'ðŸ½ï¸', description: 'Silikon beslenme seti', ageRange: '6M+', features: ['BPA iÃ§ermez', 'Kolay temizlik', 'YaratÄ±cÄ± tasarÄ±m'] },
                  { id: 'feed_14', name: 'BabyBjÃ¶rn Mama Sandalyesi', brand: 'BabyBjÃ¶rn', price: 4800, originalPrice: 5600, rating: 4.8, reviews: 1876, icon: 'ðŸª‘', description: 'Minimalist mama sandalyesi', ageRange: '6M-3Y', features: ['Minimalist', 'Kolay temizlik', 'DayanÄ±klÄ±'], discount: 14 },
                  { id: 'feed_15', name: 'Skip Hop Ã‡atal KaÅŸÄ±k Seti', brand: 'Skip Hop', price: 320, rating: 4.5, reviews: 2876, icon: 'ðŸ´', description: 'Bebek Ã§atal kaÅŸÄ±k seti', ageRange: '12M+', features: ['GÃ¼venli', 'Renkli', 'Kolay tutma'] },
                  { id: 'feed_16', name: 'Munchkin Latch Bebek GÃ¼venliÄŸi', brand: 'Munchkin', price: 240, rating: 4.7, reviews: 1543, icon: 'ðŸ¼', description: 'Biberon tutucu', ageRange: '0+ ay', features: ['Pratik', 'GÃ¼venli', 'Kolay kullanÄ±m'] },
                  { id: 'feed_17', name: 'Dr. Brown\'s Formula HazÄ±rlayÄ±cÄ±', brand: 'Dr. Brown\'s', price: 1280, rating: 4.6, reviews: 2341, icon: 'ðŸŒ¡ï¸', description: 'Otomatik formula hazÄ±rlayÄ±cÄ±', ageRange: '0+ ay', features: ['Otomatik', 'Pratik', 'GÃ¼venli'] },
                  { id: 'feed_18', name: 'ezpz Happy Mat', brand: 'ezpz', price: 480, originalPrice: 640, rating: 4.8, reviews: 3214, icon: 'ðŸ½ï¸', description: 'Emici tabanlÄ± beslenme matÄ±', ageRange: '6M+', features: ['Emici taban', 'Kolay temizlik', 'Pratik'], discount: 25 },
                  { id: 'feed_19', name: 'NumNum DIPOT', brand: 'NumNum', price: 320, rating: 4.7, reviews: 1876, icon: 'ðŸ¥„', description: 'Dual-end beslenme kaÅŸÄ±ÄŸÄ±', ageRange: '4M+', features: ['Ã‡ift uÃ§lu', 'Pratik', 'GÃ¼venli'] },
                  { id: 'feed_20', name: 'Tommee Tippee Sippee Cup', brand: 'Tommee Tippee', price: 240, rating: 4.6, reviews: 2987, icon: 'ðŸ¥¤', description: 'GeÃ§iÅŸ bardaÄŸÄ± seti', ageRange: '6M+', features: ['GeÃ§iÅŸ bardaÄŸÄ±', 'GÃ¼venli', 'Kolay kullanÄ±m'] }
              ]
          };

          const categories = [
              {
                  id: 'babygear',
                  name: 'Baby Gear',
                  icon: (
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <circle cx="12" cy="12" r="10"/>
                          <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                          <line x1="9" y1="9" x2="9.01" y2="9"/>
                          <line x1="15" y1="9" x2="15.01" y2="9"/>
                      </svg>
                  )
              },
              {
                  id: 'clothing',
                  name: 'Clothing',
                  icon: (
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <path d="M20.38 3.46L16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"/>
                      </svg>
                  )
              },
              {
                  id: 'accessories',
                  name: 'Accessories',
                  icon: (
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <circle cx="12" cy="12" r="3"/>
                          <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"/>
                          <path d="M20.2 4.2L16 8.4M8.4 16L4.2 20.2M20.2 20.2L16 16M8.4 8.4L4.2 4.2"/>
                      </svg>
                  )
              },
              {
                  id: 'health',
                  name: 'Health & Care',
                  icon: (
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                      </svg>
                  )
              },
              {
                  id: 'food',
                  name: 'Food & Nutrition',
                  icon: (
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
                          <line x1="3" y1="6" x2="21" y2="6"/>
                          <path d="M16 10a4 4 0 0 1-8 0"/>
                      </svg>
                  )
              },
              {
                  id: 'toys',
                  name: 'Toys',
                  icon: 'ðŸ§¸'
              },
              {
                  id: 'books',
                  name: 'Books',
                  icon: 'ðŸ“š'
              },
              {
                  id: 'nursery',
                  name: 'Nursery',
                  icon: 'ðŸ›ï¸'
              },
              {
                  id: 'pregnancy',
                  name: 'Pregnancy',
                  icon: 'ðŸ¤°'
              },
              {
                  id: 'feeding',
                  name: 'Feeding',
                  icon: 'ðŸ¼'
              }
          ];

          // Product Detail View Component
          const ProductDetailView = ({ productId, onBack }) => {
              const allProducts = Object.values(shopItems).flat();
              const product = allProducts.find(p => p.id === productId);
              const [quantity, setQuantity] = useState(1);
              
              if (!product) {
                  return (
                      <div className="bg-background min-h-screen flex items-center justify-center p-4">
                          <div className="text-center max-w-md">
                              <div className="text-6xl mb-4">ðŸ“¦</div>
                              <h2 className="text-xl font-bold text-gray-900 mb-2">Product Not Found</h2>
                              <p className="text-gray-500 mb-6">The product you're looking for doesn't exist.</p>
                              <button 
                                  onClick={onBack} 
                                  className="px-6 py-3 bg-primary text-white rounded-xl font-medium hover:bg-primary-dark transition-colors"
                              >
                                  Go Back to Shop
                              </button>
                          </div>
                      </div>
                  );
              }
              
              const isInCart = cartItems.includes(product.id);
              const cartQuantity = cartItems.filter(id => id === product.id).length;
              
              const handleAddToCart = () => {
                  const itemsToAdd = Array(quantity).fill(product.id);
                  setCartItems(prev => [...prev, ...itemsToAdd]);
              };
              
              const handleQuantityChange = (delta) => {
                  setQuantity(prev => Math.max(1, Math.min(99, prev + delta)));
              };
              
              const getProductImage = (product) => {
                  if (product.image) return product.image;
                  // Generate image URL based on product ID
                  const seed = product.id.replace(/[^0-9]/g, '') || product.id.charCodeAt(0);
                  const categorySeeds = {
                      'gear': 1, 'cloth': 2, 'acc': 3, 'health': 4, 'food': 5,
                      'toy': 6, 'book': 7, 'nursery': 8, 'pregnancy': 9, 'feeding': 10
                  };
                  const categorySeed = Object.entries(categorySeeds).find(([key]) => product.id.includes(key))?.[1] || 1;
                  return `https://picsum.photos/seed/${categorySeed}${seed}/400/400`;
              };
              
              return (
                  <div className="bg-gray-50 min-h-screen pb-20">
                      {/* Header with Back Button */}
                      <div className="bg-white border-b border-gray-100 sticky top-0 z-20">
                          <div className="flex items-center justify-between px-4 py-3">
                              <button 
                                  onClick={onBack}
                                  className="w-9 h-9 flex items-center justify-center rounded-full bg-gray-50 hover:bg-gray-100 transition-colors"
                              >
                                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                                      <path d="M19 12H5M12 19l-7-7 7-7"/>
                                  </svg>
                              </button>
                              <h1 className="text-sm font-semibold text-gray-900">Product</h1>
                              <button className="w-9 h-9 flex items-center justify-center rounded-full bg-gray-50 hover:bg-gray-100 transition-colors">
                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                      <circle cx="18" cy="5" r="3"/>
                                      <circle cx="6" cy="12" r="3"/>
                                      <circle cx="18" cy="19" r="3"/>
                                      <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                                      <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                                  </svg>
                              </button>
                          </div>
                      </div>
                      
                      {/* Product Image - Compact */}
                      <div className="w-full h-64 bg-gray-100 relative overflow-hidden">
                          <img src={getProductImage(product)} alt={product.name} className="w-full h-full object-cover" />
                          {product.discount && (
                              <div className="absolute top-3 right-3 bg-red-500 text-white px-2 py-1 rounded-lg shadow-md">
                                  <span className="text-xs font-bold">-{product.discount}%</span>
                              </div>
                          )}
                      </div>
                      
                      {/* Product Info - Compact */}
                      <div className="bg-white -mt-4 rounded-t-3xl relative z-10">
                          <div className="p-4 space-y-4">
                              {/* Title and Brand */}
                              <div>
                                  <h2 className="text-lg font-bold text-gray-900 leading-tight mb-1">{product.name}</h2>
                                  {product.brand && (
                                      <p className="text-xs text-gray-500">{product.brand}</p>
                                  )}
                              </div>
                              
                              {/* Price Row */}
                              <div className="flex items-center justify-between pb-3 border-b border-gray-100">
                                  <div className="flex items-baseline gap-2">
                                      <span className="font-bold text-2xl text-gray-900">â‚º{product.price.toLocaleString('tr-TR')}</span>
                                      {product.originalPrice && (
                                          <>
                                              <span className="text-gray-400 text-sm line-through">â‚º{product.originalPrice.toLocaleString('tr-TR')}</span>
                                              <span className="text-red-500 text-xs font-semibold">
                                                  {Math.round((1 - product.price / product.originalPrice) * 100)}% OFF
                                              </span>
                                          </>
                                      )}
                                  </div>
                                  {product.ageRange && (
                                      <div className="flex items-center gap-1.5 text-gray-500 bg-gray-50 px-2.5 py-1.5 rounded-full">
                                          <span className="text-xs">ðŸ‘¶</span>
                                          <span className="text-xs font-medium">{product.ageRange}</span>
                                      </div>
                                  )}
                              </div>
                              
                              {/* Description */}
                              {product.description && (
                                  <div>
                                      <p className="text-gray-700 leading-relaxed text-sm">{product.description}</p>
                                  </div>
                              )}
                              
                              {/* Features - Compact */}
                              {product.features && product.features.length > 0 && (
                                  <div>
                                      <h3 className="font-semibold text-gray-900 mb-2 text-sm">Features</h3>
                                      <div className="space-y-1.5">
                                          {product.features.map((feature, index) => (
                                              <div key={index} className="flex items-start gap-2">
                                                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" className="text-primary flex-shrink-0 mt-0.5">
                                                      <polyline points="20 6 9 17 4 12"/>
                                                  </svg>
                                                  <span className="text-gray-700 text-xs leading-relaxed flex-1">{feature}</span>
                                              </div>
                                          ))}
                                      </div>
                                  </div>
                              )}
                              
                              {/* Quantity and Actions */}
                              <div className="pt-2 space-y-3">
                                  {/* Quantity Selector - Compact */}
                                  <div>
                                      <label className="text-xs font-semibold text-gray-700 mb-2 block">Quantity</label>
                                      <div className="flex items-center gap-3">
                                          <button
                                              onClick={() => handleQuantityChange(-1)}
                                              className="w-10 h-10 rounded-lg border border-gray-200 flex items-center justify-center hover:border-primary hover:bg-primary/5 transition-colors"
                                          >
                                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                                                  <line x1="5" y1="12" x2="19" y2="12"/>
                                              </svg>
                                          </button>
                                          <div className="flex-1 text-center">
                                              <span className="text-lg font-bold text-gray-900">{quantity}</span>
                                          </div>
                                          <button
                                              onClick={() => handleQuantityChange(1)}
                                              className="w-10 h-10 rounded-lg border border-gray-200 flex items-center justify-center hover:border-primary hover:bg-primary/5 transition-colors"
                                          >
                                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                                                  <line x1="12" y1="5" x2="12" y2="19"/>
                                                  <line x1="5" y1="12" x2="19" y2="12"/>
                                              </svg>
                                          </button>
                                      </div>
                                  </div>
                                  
                                  {/* Add to Cart Button - Compact */}
                                  <button
                                      onClick={handleAddToCart}
                                      disabled={isInCart}
                                      className={`w-full py-3 rounded-xl font-semibold text-sm transition-all shadow-sm ${
                                          isInCart
                                              ? 'bg-green-500 text-white cursor-not-allowed'
                                              : 'bg-gradient-to-r from-primary to-secondary text-white hover:opacity-90 active:scale-[0.98]'
                                      }`}
                                  >
                                      {isInCart ? (
                                          <span>âœ“ Added to Cart {cartQuantity > 0 && `(${cartQuantity})`}</span>
                                      ) : (
                                          <span>Add to Cart</span>
                                      )}
                                  </button>
                              </div>
                          </div>
                      </div>
                  </div>
              );
          };

          // Product Card Component
          const ProductCard = ({ product }) => {
              const [isInCart, setIsInCart] = useState(cartItems.includes(product.id));
              useEffect(() => { setIsInCart(cartItems.includes(product.id)); }, [cartItems, product.id]);
              useEffect(() => { setIsInCart(cartItems.includes(product.id)); }, [cartItems, product.id]);

              const handleAddToCart = () => {
                  setCartItems(prev => {
                      if (prev.includes(product.id)) return prev;
                      const arr = [...prev, product.id];
                      return arr;
                  });
                  setIsInCart(true);
              };

              const renderStars = (rating) => {
                  const fullStars = Math.floor(rating);
                  const hasHalfStar = rating % 1 !== 0;

                  return (
                      <div className="flex items-center space-x-1">
                          {[...Array(fullStars)].map((_, i) => (
                              <span key={i} className="text-yellow-400 text-sm">â˜…</span>
                          ))}
                          {hasHalfStar && <span className="text-yellow-400 text-sm">â˜†</span>}
                          <span className="text-gray-500 text-xs ml-1">({product.reviews})</span>
                      </div>
                  );
              };

              const getProductImage = (product) => {
                  if (product.image) return product.image;
                  // Generate image URL based on product ID
                  const seed = product.id.replace(/[^0-9]/g, '') || product.id.charCodeAt(0);
                  const categorySeeds = {
                      'gear': 1, 'cloth': 2, 'acc': 3, 'health': 4, 'food': 5,
                      'toy': 6, 'book': 7, 'nursery': 8, 'pregnancy': 9, 'feeding': 10
                  };
                  const categorySeed = Object.entries(categorySeeds).find(([key]) => product.id.includes(key))?.[1] || 1;
                  return `https://picsum.photos/seed/${categorySeed}${seed}/400/400`;
              };

              return (
                  <div className="bg-white rounded-xl overflow-hidden border border-gray-100 transition-all hover:shadow-md cursor-pointer flex flex-col h-full" onClick={() => { setSelectedProductId(product.id); }}>
                      {/* Product Image - Compact */}
                      <div className="w-full h-32 bg-gray-100 relative overflow-hidden">
                          <img src={getProductImage(product)} alt={product.name} className="w-full h-full object-cover" />
                          {product.discount && (
                              <div className="absolute top-1.5 right-1.5 bg-red-500 text-white px-1.5 py-0.5 rounded text-[10px] font-bold">
                                  -{product.discount}%
                              </div>
                          )}
                      </div>

                      {/* Product Info - Compact */}
                      <div className="p-2.5 flex flex-col flex-grow">
                          {/* Product Name & Brand */}
                          <div className="mb-1.5 min-w-0">
                              <h4 className="font-semibold text-gray-900 text-xs leading-tight line-clamp-2 mb-0.5">{product.name}</h4>
                              {product.brand && (
                                  <p className="text-gray-400 text-[10px] truncate">{product.brand}</p>
                          )}
                      </div>

                          {/* Price & Actions - Compact */}
                          <div className="flex items-center justify-between gap-2 mt-auto pt-1.5 border-t border-gray-50">
                              <div className="flex items-center gap-1 min-w-0">
                                  <span className="font-bold text-sm text-gray-900 whitespace-nowrap">â‚º{product.price.toLocaleString('tr-TR')}</span>
                              {product.originalPrice && (
                                      <span className="text-gray-300 text-[10px] line-through whitespace-nowrap">â‚º{product.originalPrice.toLocaleString('tr-TR')}</span>
                                  )}
                              </div>
                          <button
                              onClick={(e)=> { e.stopPropagation(); handleAddToCart(); }}
                              disabled={isInCart}
                                  className={`px-2 py-1 rounded-lg text-[10px] font-medium transition-all flex-shrink-0 ${
                                  isInCart
                                      ? 'bg-green-100 text-green-600 cursor-not-allowed'
                                      : 'bg-primary text-white hover:bg-primary-dark'
                              }`}
                          >
                                  {isInCart ? 'âœ“' : '+'}
                          </button>
                          </div>
                      </div>
                  </div>
              );
          };

          // If a product is selected, show product detail view
          if (selectedProductId) {
              return (
                  <ProductDetailView 
                      productId={selectedProductId} 
                      onBack={() => setSelectedProductId(null)} 
                  />
              );
          }

          return (
              <div className="bg-background min-h-screen">
                  {/* Header */}
                  <div className="bg-white">
                      <div className="px-4 py-2">
                          {/* Main Header Tabs - Scrollable */}
                          <div className="flex space-x-1 overflow-x-auto scrollbar-hide pb-2">
                              {['All', 'Baby Gear', 'Clothing', 'Accessories', 'Health & Care', 'Food & Nutrition', 'Toys', 'Books', 'Nursery', 'Pregnancy', 'Feeding'].map((tab) => (
                                  <button
                                      key={tab}
                                      onClick={() => {
                                          const categoryMap = {
                                              'All': 'all',
                                              'Baby Gear': 'babygear',
                                              'Clothing': 'clothing',
                                              'Accessories': 'accessories',
                                              'Health & Care': 'health',
                                              'Food & Nutrition': 'food',
                                              'Toys': 'toys',
                                              'Books': 'books',
                                              'Nursery': 'nursery',
                                              'Pregnancy': 'pregnancy',
                                              'Feeding': 'feeding'
                                          };
                                          setActiveCategory(categoryMap[tab]);
                                      }}
                                      className={`flex-shrink-0 px-3 py-2 rounded-xl text-xs font-semibold whitespace-nowrap transition-all duration-200 ${
                                          activeCategory === (() => {
                                              const categoryMap = {
                                                  'All': 'all',
                                                  'Baby Gear': 'babygear',
                                                  'Clothing': 'clothing',
                                                  'Accessories': 'accessories',
                                                  'Health & Care': 'health',
                                                  'Food & Nutrition': 'food',
                                                  'Toys': 'toys',
                                                  'Books': 'books',
                                                  'Nursery': 'nursery',
                                                  'Pregnancy': 'pregnancy',
                                                  'Feeding': 'feeding'
                                              };
                                              return categoryMap[tab];
                                          })()
                                              ? 'bg-gradient-to-r from-primary to-secondary text-white shadow-md'
                                              : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                      }`}
                                  >
                                      {tab}
                                  </button>
                              ))}
                          </div>

                          {/* Bottom Row: Coins + Premium + Cart */}
                          <div className="flex mt-2 h-8">
                              {/* Coins */}
                              <button
                                  className="flex-1 h-8 px-2 bg-white border border-gray-200 text-gray-600 rounded-l-lg font-semibold text-xs hover:bg-gray-50 transition-colors flex items-center justify-center gap-1"
                                  onClick={() => setShowCoinInfo(true)}
                              >
                                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-primary">
                                      <circle cx="12" cy="12" r="10"/>
                                      <path d="M8 12h8M12 8v8"/>
                                      <circle cx="12" cy="12" r="3"/>
                                      </svg>
                                  <span className="text-xs">{coinCount || 0} coins</span>
                                  </button>

                              {/* Premium */}
                              <button
                                  className={`flex-1 h-8 px-2 border-t border-b font-semibold text-xs transition-colors flex items-center justify-center gap-1 ${
                                      isPremium
                                          ? 'bg-gradient-to-r from-primary to-secondary text-white border-primary'
                                          : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'
                                  }`}
                                  onClick={() => {
                                      if (isPremium) {
                                          setShowCancelPremiumModal(true);
                                      } else {
                                          setShowPremiumModal(true);
                                      }
                                  }}
                              >
                                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={isPremium ? "text-white" : "text-primary"}>
                                      <path d="M6 3h12l4 6-10 12L2 9l4-6z"/>
                                      <path d="M6 3l6 6-6 6"/>
                                      <path d="M18 3l-6 6 6 6"/>
                                  </svg>
                                  <span className="text-xs">{isPremium ? 'Premium âœ“' : 'Premium'}</span>
                              </button>

                              {/* Cart */}
                              <div className="relative flex-1 h-8">
                                  <button className="w-full h-8 px-2 bg-white border border-gray-200 text-gray-600 rounded-r-lg font-semibold text-xs hover:bg-gray-50 transition-colors flex items-center justify-center gap-1" onClick={()=> setIsCartOpen(true)}>
                                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-primary">
                                              <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
                                              <line x1="3" y1="6" x2="21" y2="6"/>
                                              <path d="M16 10a4 4 0 0 1-8 0"/>
                                          </svg>
                                      <span className="text-xs">Cart</span>
                                      </button>
                                      {cartItems.length > 0 && (
                                      <div className="absolute -top-1 -right-1 w-4 h-4 bg-purple-200 rounded-full flex items-center justify-center shadow-sm">
                                          <span className="text-white text-xs font-semibold">{cartItems.length}</span>
                                          </div>
                                      )}
                                  </div>
                              </div>
                          </div>
                          </div>

                          {/* Search + Sort */}
                  <div className="px-4 py-2 bg-white border-b border-gray-100">
                      <div className="flex items-center gap-2">
                              <div className="flex-1 relative">
                                  <input
                                      value={search}
                                      onChange={(e)=> setSearch(e.target.value)}
                                      placeholder="Search products..."
                                  className="w-full px-8 py-2 rounded-xl border border-gray-200 bg-white focus:outline-none focus:ring-2 focus:ring-primary/30 focus:shadow-md transition-all text-sm"
                                  />
                                  <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                          <circle cx="11" cy="11" r="8"/>
                                          <path d="M21 21l-4.35-4.35"/>
                                      </svg>
                                  </span>
                              {search && (
                                  <button
                                      onClick={() => setSearch('')}
                                      className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                                  >
                                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                          <line x1="18" y1="6" x2="6" y2="18"/>
                                          <line x1="6" y1="6" x2="18" y2="18"/>
                                      </svg>
                                  </button>
                              )}
                              </div>
                              <select
                                  value={sortBy}
                                  onChange={(e)=> setSortBy(e.target.value)}
                              className="px-3 py-2 rounded-xl border border-gray-200 bg-white focus:outline-none focus:ring-2 focus:ring-primary/30 shadow-sm hover:shadow-md transition-all text-sm"
                                  aria-label="Sort"
                              >
                                  <option value="popular">Most popular</option>
                                  <option value="price_asc">Price: Low to High</option>
                                  <option value="price_desc">Price: High to Low</option>
                                  <option value="name">Name</option>
                              </select>
                      </div>
                  </div>

                  {/* Products Grid */}
                  <div className="p-4">
                      {/* Products List */}
                          {(() => {
                          // If "All" category and no search query, show category cards like Groups page
                          if (activeCategory === 'all' && !search.trim()) {
                              const categoryGradients = {
                                  'babygear': 'from-blue-500 via-blue-400 to-cyan-300',
                                  'clothing': 'from-pink-500 via-pink-400 to-rose-300',
                                  'accessories': 'from-purple-500 via-purple-400 to-violet-300',
                                  'health': 'from-green-500 via-green-400 to-emerald-300',
                                  'food': 'from-orange-500 via-orange-400 to-amber-300',
                                  'toys': 'from-yellow-500 via-yellow-400 to-yellow-300',
                                  'books': 'from-indigo-500 via-indigo-400 to-blue-300',
                                  'nursery': 'from-teal-500 via-teal-400 to-cyan-300',
                                  'pregnancy': 'from-rose-500 via-rose-400 to-pink-300',
                                  'feeding': 'from-emerald-500 via-emerald-400 to-green-300'
                              };
                              
                              const categoryImages = {
                                  'babygear': 'https://images.unsplash.com/photo-1555252333-9f8e92e65df9?w=800&q=80',
                                  'clothing': 'https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?w=800&q=80',
                                  'accessories': 'https://images.unsplash.com/photo-1602992708529-c9fdb12905c9?w=800&q=80',
                                  'health': 'https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=800&q=80',
                                  'food': 'https://images.unsplash.com/photo-1514626585111-9aa86183ac98?w=800&q=80',
                                  'toys': 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800&q=80',
                                  'books': 'https://images.unsplash.com/photo-1481627834876-b7833e8f5570?w=800&q=80',
                                  'nursery': 'https://images.unsplash.com/photo-1505691723518-36a5ac3c3537?w=800&q=80',
                                  'pregnancy': 'https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=800&q=80',
                                  'feeding': 'https://images.unsplash.com/photo-1544947950-fa07a98d237f?w=800&q=80'
                              };
                              
                              return (
                                  <div className="space-y-4">
                                      {categories.filter(cat => cat.id !== 'all' && shopItems[cat.id] && shopItems[cat.id].length > 0).map(category => {
                                          const categoryProducts = shopItems[category.id] || [];
                                          const productCount = categoryProducts.length;
                                          const gradient = categoryGradients[category.id] || 'from-gray-500 via-gray-400 to-gray-300';
                                          const backgroundImage = categoryImages[category.id];
                                          
                                          return (
                                              <button
                                                  key={category.id}
                                                  type="button"
                                                  onClick={() => setActiveCategory(category.id)}
                                                  className="relative block w-full overflow-hidden rounded-[28px] text-left shadow-[0_25px_45px_-30px_rgba(91,174,155,0.6)] focus:outline-none focus-visible:ring-2 focus-visible:ring-primary transition-transform hover:scale-[1.02]"
                                              >
                                                  {/* Background Image */}
                                                  <div 
                                                      className="absolute inset-0 bg-cover bg-center"
                                                      style={{ backgroundImage: `url(${backgroundImage})` }}
                                                  ></div>
                                                  {/* Gradient Overlay */}
                                                  <div className={`absolute inset-0 bg-gradient-to-br ${gradient} opacity-60`}></div>
                                                  {/* Dark Overlay for better text readability */}
                                                  <div className="absolute inset-0 bg-gradient-to-br from-black/50 via-black/40 to-black/60"></div>
                                                  <div className="relative flex min-h-[160px] flex-col justify-between px-6 py-7 text-white">
                                                      <div className="space-y-2">
                                                          <div className="flex items-center gap-3">
                                                              <div className="text-3xl flex items-center justify-center w-12 h-12 bg-white/20 rounded-xl backdrop-blur-sm">
                                                                  {category.icon}
                                                              </div>
                                                              <span className="text-xs font-semibold uppercase tracking-[0.35em] text-white/80">CATEGORY</span>
                                                          </div>
                                                          <h3 className="text-[24px] font-semibold leading-snug">{category.name}</h3>
                                                          <p className="text-sm text-white/90 max-w-md">{productCount} products available</p>
                                                      </div>
                                                      <div className="flex items-center gap-2 text-xs text-white/80 pt-2">
                                                          <span className="flex items-center gap-1">
                                                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                                  <path d="M9 18l6-6-6-6" strokeLinecap="round" strokeLinejoin="round" />
                                                              </svg>
                                                              Browse products
                                                          </span>
                                                      </div>
                                                  </div>
                                              </button>
                                          );
                                      })}
                                  </div>
                              );
                          }
                          
                          // Default: show products in 3-column grid with infinite scroll
                              const base = activeCategory === 'all'
                                  ? Object.values(shopItems).flat()
                                  : shopItems[activeCategory] || [];
                              const filtered = base.filter(p => {
                                  const q = search.trim().toLowerCase();
                                  if (!q) return true;
                                  return (
                                      p.name.toLowerCase().includes(q) ||
                                      (p.brand||'').toLowerCase().includes(q) ||
                                      (p.description||'').toLowerCase().includes(q)
                                  );
                              });
                              const sorted = [...filtered].sort((a,b) => {
                                  if (sortBy === 'price_asc') return (a.price||0) - (b.price||0);
                                  if (sortBy === 'price_desc') return (b.price||0) - (a.price||0);
                                  if (sortBy === 'name') return (a.name||'').localeCompare(b.name||'');
                                  // popular
                                  const ra = typeof a.rating === 'number' ? a.rating : 0;
                                  const rb = typeof b.rating === 'number' ? b.rating : 0;
                                  const va = typeof a.reviews === 'number' ? a.reviews : 0;
                                  const vb = typeof b.reviews === 'number' ? b.reviews : 0;
                                  return (rb*vb) - (ra*va);
                              });
                          const visibleProducts = sorted.slice(0, visibleCount);
                          const hasMore = sorted.length > visibleCount;
                          
                          return (
                              <>
                                  <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                      {visibleProducts.map(product => (
                                  <ProductCard key={product.id} product={product} />
                                      ))}
                      </div>
                                  {hasMore && (
                                      <div className="flex justify-center py-6">
                                          <div className="text-sm text-gray-500">Loading more products...</div>
                  </div>
                                  )}
                                  {!hasMore && visibleProducts.length > 0 && (
                                      <div className="flex justify-center py-6">
                                          <div className="text-sm text-gray-500">All products loaded</div>
                              </div>
                                  )}
                              </>
                          );
                      })()}
                                      </div>

                  {/* Cart Modal */}
                  {isCartOpen && (
                      <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end justify-center z-50" onMouseDown={(e)=>{ if (e.target === e.currentTarget) setIsCartOpen(false); }}>
                          <div className="bg-white w-full max-w-md rounded-t-3xl overflow-hidden shadow-2xl border-t border-gray-100 max-h-[85vh] flex flex-col">
                              {/* Header */}
                              <div className="relative bg-gradient-to-r from-primary to-secondary px-6 py-5 text-white">
                                          <div className="flex items-center justify-between">
                                      <div className="flex items-center gap-3">
                                          <div className="w-10 h-10 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
                                              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                  <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
                                                  <line x1="3" y1="6" x2="21" y2="6"/>
                                                  <path d="M16 10a4 4 0 0 1-8 0"/>
                                              </svg>
                                          </div>
                                              <div>
                                              <h2 className="text-lg font-bold">Sepetim</h2>
                                              <p className="text-xs text-white/80">{cartItems.length} Ã¼rÃ¼n</p>
                                              </div>
                                              </div>
                                      <button 
                                          onClick={()=> setIsCartOpen(false)} 
                                          className="w-9 h-9 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-full flex items-center justify-center transition-all"
                                      >
                                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                                              <line x1="18" y1="6" x2="6" y2="18"/>
                                              <line x1="6" y1="6" x2="18" y2="18"/>
                                          </svg>
                                      </button>
                                          </div>
                                      </div>

                              {/* Cart Items */}
                              <div className="flex-1 overflow-y-auto p-4 bg-gray-50/50">
                                  {cartItems.length === 0 ? (
                                      <div className="flex flex-col items-center justify-center py-16">
                                          <div className="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                                              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="text-gray-400">
                                                  <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
                                                  <line x1="3" y1="6" x2="21" y2="6"/>
                                                  <path d="M16 10a4 4 0 0 1-8 0"/>
                                              </svg>
                                          </div>
                                          <p className="text-gray-500 font-medium mb-1">Sepetiniz boÅŸ</p>
                                          <p className="text-sm text-gray-400">AlÄ±ÅŸveriÅŸe baÅŸlamak iÃ§in Ã¼rÃ¼nlere gÃ¶z atÄ±n</p>
                                      </div>
                                  ) : (
                                      (() => {
                                          const counts = {};
                                          cartItems.forEach(id => { counts[id] = (counts[id] || 0) + 1; });
                                          const entries = Object.entries(counts);
                                          const all = Object.values(shopItems).flat();
                                          return (
                                              <div className="space-y-3">
                                                  {entries.map(([id, qty]) => {
                                              const p = all.find(x => x.id === id);
                                              if (!p) return null;
                                              return (
                                                          <div key={id} className="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-all">
                                                              <div className="flex items-start gap-4">
                                                                  <div className="w-16 h-16 bg-gray-100 rounded-xl overflow-hidden flex items-center justify-center flex-shrink-0 border border-gray-200">
                                                                      {p.image ? (
                                                                          <img src={p.image} alt={p.name} className="w-full h-full object-cover" />
                                                                      ) : (
                                                                          <span className="text-2xl">{p.icon}</span>
                                                                      )}
                                                          </div>
                                                                  <div className="flex-1 min-w-0">
                                                                      <h3 className="font-semibold text-gray-900 mb-1 text-sm line-clamp-2">{p.name}</h3>
                                                                      <p className="text-sm font-bold text-primary mb-3">â‚º{p.price.toLocaleString('tr-TR')}</p>
                                                                      <div className="flex items-center justify-between">
                                                                          <div className="flex items-center gap-2 bg-gray-50 rounded-lg p-1">
                                                                              <button 
                                                                                  onClick={()=> setCartItems(prev => { const idx = prev.indexOf(id); if (idx > -1) { const cp = [...prev]; cp.splice(idx,1); return cp; } return prev; })} 
                                                                                  className="w-7 h-7 rounded-lg bg-white hover:bg-gray-100 flex items-center justify-center transition-all shadow-sm"
                                                                              >
                                                                                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                                                                                      <line x1="5" y1="12" x2="19" y2="12"/>
                                                                                  </svg>
                                                                              </button>
                                                                              <span className="w-8 text-center text-sm font-semibold text-gray-900">{qty}</span>
                                                                              <button 
                                                                                  onClick={()=> setCartItems(prev => [...prev, id])} 
                                                                                  className="w-7 h-7 rounded-lg bg-white hover:bg-gray-100 flex items-center justify-center transition-all shadow-sm"
                                                                              >
                                                                                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                                                                                      <line x1="12" y1="5" x2="12" y2="19"/>
                                                                                      <line x1="5" y1="12" x2="19" y2="12"/>
                                                                                  </svg>
                                                                              </button>
                                                          </div>
                                                                          <button 
                                                                              onClick={()=> setCartItems(prev => prev.filter(x => x !== id))} 
                                                                              className="text-gray-400 hover:text-rose-500 transition-colors p-2"
                                                                          >
                                                                              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                                                  <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                                                              </svg>
                                                                          </button>
                                                      </div>
                                                                  </div>
                                                      </div>
                                                  </div>
                                              );
                                                  })}
                                              </div>
                                          );
                                      })()
                                  )}
                              </div>

                              {/* Footer */}
                              <div className="px-6 py-5 border-t-2 border-gray-200 bg-white">
                                  {cartItems.length > 0 && (
                                      <>
                                          <div className="flex items-center justify-between mb-4 pb-4 border-b border-gray-100">
                                              <div className="text-sm text-gray-600">
                                                  <span className="font-medium">{cartItems.length}</span> Ã¼rÃ¼n
                                              </div>
                                              {(() => { 
                                                  const all = Object.values(shopItems).flat(); 
                                                  const total = cartItems.reduce((s,id)=> { 
                                                      const p=all.find(x=>x.id===id); 
                                                      return s + (p?.price||0); 
                                                  }, 0); 
                                                  return (
                                                      <div className="text-right">
                                                          <p className="text-xs text-gray-500 mb-1">Toplam</p>
                                                          <p className="text-xl font-bold text-gray-900">â‚º{total.toLocaleString('tr-TR')}</p>
                                                      </div>
                                                  ); 
                                              })()}
                                          </div>
                                          <div className="flex items-center gap-3">
                                              <button 
                                                  onClick={()=> setCartItems([])} 
                                                  className="px-4 py-3 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold transition-all flex-1"
                                              >
                                                  Temizle
                                              </button>
                                      <button
                                          onClick={()=> { if (cartItems.length>0){ setIsCartOpen(false); setIsCheckoutOpen(true);} }}
                                          disabled={cartItems.length===0}
                                                  className={`px-6 py-3 rounded-xl font-bold text-white transition-all flex-1 shadow-lg ${
                                                      cartItems.length===0 
                                                          ? 'bg-gray-300 cursor-not-allowed' 
                                                          : 'bg-gradient-to-r from-primary to-secondary hover:shadow-xl transform hover:scale-[1.02]'
                                                  }`}
                                              >
                                                  Ã–demeye GeÃ§
                                              </button>
                                  </div>
                                      </>
                                  )}
                              </div>
                          </div>
                      </div>
                  )}

                  {/* Checkout Modal */}
                  {isCheckoutOpen && (
                      <div className="fixed inset-0 bg-black/50 flex items-end justify-center z-50" onMouseDown={(e)=>{ if (e.target === e.currentTarget) setIsCheckoutOpen(false); }}>
                          <div className="bg-white w-full max-w-md rounded-t-3xl overflow-hidden">
                              <CheckoutModal
                                  cartItems={cartItems}
                                  setCartItems={setCartItems}
                                  shopItems={shopItems}
                                  coinCount={coinCount}
                                  setCoinCount={setCoinCount}
                                  isPremium={isPremium}
                                  onClose={()=> setIsCheckoutOpen(false)}
                                  onProductClick={(productId) => {
                                      setIsCheckoutOpen(false);
                                      setSelectedProductId(productId);
                                  }}
                              />
                          </div>
                      </div>
                  )}


                  {/* Premium Modal */}
                  {showPremiumModal && (
                      <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" onMouseDown={(e)=>{ if (e.target === e.currentTarget) setShowPremiumModal(false); }}>
                          <div className="bg-white rounded-3xl w-full max-w-md mx-4 overflow-hidden shadow-2xl max-h-[90vh] flex flex-col border border-gray-100">
                              {/* Header */}
                              <div className="relative bg-gradient-to-br from-primary via-secondary to-accent p-8 text-white overflow-hidden">
                                  {/* Subtle Pattern */}
                                  <div className="absolute inset-0 opacity-10">
                                      <div className="absolute top-0 right-0 w-32 h-32 bg-white rounded-full blur-3xl"></div>
                                      <div className="absolute bottom-0 left-0 w-24 h-24 bg-white rounded-full blur-2xl"></div>
                                  </div>

                                  <button
                                      onClick={() => setShowPremiumModal(false)}
                                      className="absolute top-5 right-5 w-9 h-9 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-full flex items-center justify-center transition-all z-10"
                                  >
                                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                                          <line x1="18" y1="6" x2="6" y2="18"/>
                                          <line x1="6" y1="6" x2="18" y2="18"/>
                                      </svg>
                                  </button>

                                  <div className="text-center relative z-10">
                                      <div className="w-16 h-16 bg-white/20 backdrop-blur-md rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                                          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                                              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                          </svg>
                                      </div>
                                      <h2 className="text-3xl font-bold mb-2">Orbit Premium</h2>
                                      <p className="text-white/90 text-sm">TÃ¼m Ã¶zelliklere eriÅŸim</p>
                                  </div>
                              </div>

                              {/* Content */}
                              <div className="p-6 flex-1 overflow-y-auto bg-gray-50/50">
                                  {/* Pricing Card */}
                                  <div className="bg-white rounded-2xl p-6 mb-6 shadow-sm border border-gray-100">
                                      <div className="text-center">
                                          <div className="flex items-baseline justify-center gap-2 mb-2">
                                              <span className="text-6xl font-bold text-gray-900">â‚º99</span>
                                              <span className="text-2xl text-gray-500 font-medium">/ay</span>
                                          </div>
                                          <p className="text-sm text-gray-500">Ä°stediÄŸin zaman iptal et</p>
                                      </div>
                                  </div>

                                  {/* Benefits */}
                                      <div className="space-y-3">
                                      <div className="flex items-start gap-4 p-4 bg-white rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-all hover:border-blue-500/20">
                                          <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center flex-shrink-0 shadow-sm">
                                              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5">
                                                  <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                              </svg>
                                          </div>
                                          <div className="flex-1 pt-1">
                                              <h4 className="font-bold text-gray-900 mb-1.5 text-base">%25 Coin Ä°ndirimi</h4>
                                              <p className="text-sm text-gray-600 leading-relaxed">AlÄ±ÅŸveriÅŸlerde coin kullanarak %25 indirim kazan</p>
                                          </div>
                                      </div>

                                      <div className="flex items-start gap-4 p-4 bg-white rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-all hover:border-green-500/20">
                                          <div className="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center flex-shrink-0 shadow-sm">
                                              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5">
                                                  <path d="M3 3v18h18"/>
                                                  <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
                                              </svg>
                                          </div>
                                          <div className="flex-1 pt-1">
                                              <h4 className="font-bold text-gray-900 mb-1.5 text-base">YÃ¼ksek Coin Limiti</h4>
                                              <p className="text-sm text-gray-600 leading-relaxed">Ayda 5,000 coin'e kadar kazan</p>
                                          </div>
                                      </div>

                                      <div className="flex items-start gap-4 p-4 bg-white rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-all hover:border-purple-500/20">
                                          <div className="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center flex-shrink-0 shadow-sm">
                                              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5">
                                                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                                  <path d="M8 9h8"/>
                                                  <path d="M8 13h6"/>
                                              </svg>
                                          </div>
                                          <div className="flex-1 pt-1">
                                              <h4 className="font-bold text-gray-900 mb-1.5 text-base">Ã–ncelikli Destek</h4>
                                              <p className="text-sm text-gray-600 leading-relaxed">HÄ±zlÄ± yanÄ±t ve Ã¶zel destek ekibi</p>
                                          </div>
                                      </div>
                                  </div>
                              </div>

                              {/* Footer Button */}
                              <div className="px-6 pb-6 pt-5 border-t border-gray-200 bg-white flex-shrink-0">
                                  {isPremium ? (
                                      <div className="space-y-3">
                                          <div className="flex items-center justify-center gap-2.5 py-3.5 bg-green-50 rounded-xl border border-green-200">
                                              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" className="text-green-600">
                                                      <path d="M9 12l2 2 4-4"/>
                                                      <circle cx="12" cy="12" r="10"/>
                                                  </svg>
                                              <span className="font-semibold text-green-700">Premium Aktif</span>
                                              </div>
                                          <button
                                              onClick={() => setShowCancelPremiumModal(true)}
                                              className="w-full py-3.5 px-4 bg-gray-50 hover:bg-gray-100 text-gray-700 rounded-xl font-semibold transition-all border border-gray-200"
                                          >
                                              Premium'u Ä°ptal Et
                                          </button>
                                      </div>
                                  ) : (
                                      <button
                                          onClick={() => {
                                              setIsPremium(true);
                                              StorageManager.save('isPremium', true);
                                              setShowPremiumModal(false);
                                          }}
                                          className="w-full py-4 px-6 bg-gradient-to-r from-primary to-secondary text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition-all transform hover:scale-[1.01]"
                                      >
                                          Premium'a BaÅŸla - â‚º99/ay
                                      </button>
                                  )}
                              </div>
                          </div>
                      </div>
                  )}

                  {/* Cancel Premium Modal */}
                  {showCancelPremiumModal && (
                      <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" onMouseDown={(e)=>{ if (e.target === e.currentTarget) setShowCancelPremiumModal(false); }}>
                          <div className="bg-white rounded-3xl w-full max-w-md mx-4 overflow-hidden shadow-2xl">
                              {/* Header */}
                              <div className="bg-gradient-to-r from-red-500 to-red-600 p-6 text-white relative overflow-hidden">
                                  {/* Background Pattern */}
                                  <div className="absolute inset-0 opacity-10">
                                      <div className="absolute top-4 left-4 w-8 h-8 bg-white rounded-full"></div>
                                      <div className="absolute top-8 right-8 w-6 h-6 bg-white rounded-full"></div>
                                      <div className="absolute bottom-4 left-8 w-4 h-4 bg-white rounded-full"></div>
                                      <div className="absolute bottom-8 right-4 w-10 h-10 bg-white rounded-full"></div>
                                  </div>

                                  {/* Close Button */}
                                  <button
                                      onClick={() => setShowCancelPremiumModal(false)}
                                      className="absolute top-4 right-4 w-8 h-8 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition-all"
                                  >
                                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                                          <line x1="18" y1="6" x2="6" y2="18"/>
                                          <line x1="6" y1="6" x2="18" y2="18"/>
                                      </svg>
                                  </button>

                                  {/* Title Section */}
                                  <div className="text-center relative z-10">
                                      <div className="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                                          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                              <path d="M9 12l2 2 4-4"/>
                                              <circle cx="12" cy="12" r="10"/>
                                              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                          </svg>
                                      </div>
                                      <h2 className="text-2xl font-bold mb-2">Cancel Premium?</h2>
                                      <p className="text-white/90 text-sm">Are you sure you want to cancel your Premium membership?</p>
                                  </div>
                              </div>

                              {/* Content */}
                              <div className="p-6">
                                  {/* Warning Message */}
                                  <div className="bg-gradient-to-r from-red-50 to-red-100 rounded-2xl p-4 border border-red-200 mb-6">
                                      <div className="flex items-start">
                                          <div className="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5">
                                                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                                  <line x1="12" y1="9" x2="12" y2="13"/>
                                                  <line x1="12" y1="17" x2="12.01" y2="17"/>
                                              </svg>
                                          </div>
                                          <div>
                                              <h3 className="font-bold text-red-800 mb-2">You will lose access to:</h3>
                                              <ul className="space-y-1 text-sm text-red-700">
                                                  <li className="flex items-center">
                                                      <span className="w-1.5 h-1.5 bg-red-500 rounded-full mr-2"></span>
                                                      25% coin discount in shop
                                                  </li>
                                                  <li className="flex items-center">
                                                      <span className="w-1.5 h-1.5 bg-red-500 rounded-full mr-2"></span>
                                                      Higher coin earning limits
                                                  </li>
                                                  <li className="flex items-center">
                                                      <span className="w-1.5 h-1.5 bg-red-500 rounded-full mr-2"></span>
                                                      Priority support
                                                  </li>
                                                  <li className="flex items-center">
                                                      <span className="w-1.5 h-1.5 bg-red-500 rounded-full mr-2"></span>
                                                      Exclusive content access
                                                  </li>
                                              </ul>
                                          </div>
                                      </div>
                                  </div>

                                  {/* Action Buttons */}
                                  <div className="space-y-3">
                                      <button
                                          onClick={() => {
                                              setIsPremium(false);
                                              StorageManager.save('isPremium', false);
                                              setShowCancelPremiumModal(false);
                                              setShowPremiumModal(false);
                                          }}
                                          className="w-full py-3 px-4 bg-red-500 text-white rounded-2xl font-bold hover:bg-red-600 transition-all shadow-lg hover:shadow-xl transform hover:scale-[1.02]"
                                      >
                                          Yes, Cancel Premium
                                      </button>

                                      <button
                                          onClick={() => setShowCancelPremiumModal(false)}
                                          className="w-full py-3 px-4 bg-gray-100 text-gray-700 rounded-2xl font-semibold hover:bg-gray-200 transition-colors"
                                      >
                                          Keep Premium
                                      </button>
                                  </div>
                              </div>
                          </div>
                      </div>
                  )}

                  {/* Orders Modal */}
                  {isOrdersOpen && (
                      <div className="fixed inset-0 bg-black/50 flex items-end justify-center z-50" onMouseDown={(e)=>{ if (e.target === e.currentTarget) setIsOrdersOpen(false); }}>
                          <div className="bg-white w-full max-w-md rounded-t-3xl overflow-hidden">
                              <OrdersModal
                                  onClose={()=> setIsOrdersOpen(false)}
                                  onReorder={(order)=>{
                                      const ids = order.items.flatMap(it => Array(it.qty).fill(it.id));
                                      setCartItems(prev => [...prev, ...ids]);
                                      ToastManager.show('Items moved to cart', 'success');
                                      setIsOrdersOpen(false);
                                  }}
                                  onClear={()=>{ StorageManager.save('orders', []); ToastManager.show('Orders cleared', 'info'); }}
                                  catalog={Object.values(shopItems).flat()}
                              />
                          </div>
                      </div>
                  )}
              </div>
          );
      };

      // Checkout modal component (inside script scope)
      const CheckoutModal = ({ cartItems, setCartItems, shopItems, coinCount = 0, setCoinCount, isPremium = false, onClose, onProductClick }) => {
          const [step, setStep] = useState(1); // 1: Shipping, 2: Payment
          const [processing, setProcessing] = useState(false);
          const [promo, setPromo] = useState(StorageManager.load('shopPromo', ''));
          const [shipping, setShipping] = useState(() => StorageManager.load('shopCheckoutInfo', {
              fullName: '', email: '', phone: '', address: '', city: '', zip: '', country: ''
          }));
          useEffect(()=> { StorageManager.save('shopCheckoutInfo', shipping); }, [shipping]);
          useEffect(()=> { StorageManager.save('shopPromo', promo); }, [promo]);

          const all = Object.values(shopItems).flat();
          const counts = {};
          cartItems.forEach(id => { counts[id] = (counts[id] || 0) + 1; });
          const items = Object.entries(counts).map(([id, qty]) => {
              const p = all.find(x => x.id === id);
              return p ? { ...p, qty } : null;
          }).filter(Boolean);
          const subtotal = items.reduce((s, p) => s + (p.price || 0) * p.qty, 0);
          const discount = promo.trim().toUpperCase() === 'PROMO10' ? subtotal * 0.10 : 0;
          const shippingFee = subtotal > 100 ? 0 : 4.99;
          const totalBeforeCoins = Math.max(0, subtotal - discount) + (items.length ? shippingFee : 0);
          const [coinsUse, setCoinsUse] = useState(0);
          const [useCoins, setUseCoins] = useState(false);
          const coinsCap = isPremium ? Math.min(Math.floor(totalBeforeCoins * 0.25), Math.max(0, coinCount||0)) : 0;
          useEffect(() => { if (coinsUse > coinsCap) setCoinsUse(coinsCap); }, [coinsCap]);
          const total = Math.max(0, totalBeforeCoins - (useCoins && isPremium ? coinsUse : 0));

          const validShipping = shipping.fullName && shipping.email && shipping.address && shipping.city && shipping.zip && shipping.country;

          const [card, setCard] = useState({ name: '', number: '', expiry: '', cvv: '' });
          const validPayment = card.name && card.number.replace(/\s+/g,'').length >= 12 && /\d{2}\/\d{2}/.test(card.expiry) && card.cvv.length >= 3;
          const canPay = (total === 0) || validPayment;

          const placeOrder = async () => {
              if (!validShipping || !validPayment || items.length === 0) return;
              setProcessing(true);
              await new Promise(r => setTimeout(r, 1200));
              const order = {
                  id: Date.now(),
                  createdAt: new Date().toISOString(),
                  items: items.map(p => ({ id: p.id, name: p.name, price: p.price, qty: p.qty })),
                  subtotal, discount, shippingFee, total,
                  shipping,
                  status: 'confirmed'
              };
              const orders = StorageManager.load('orders', []);
              orders.unshift(order);
              StorageManager.save('orders', orders);
              if (coinsUse > 0 && setCoinCount) setCoinCount(prev => Math.max(0, (prev||0) - coinsUse));
              setCartItems([]);
              setProcessing(false);
              onClose();
              ToastManager.show('Order placed successfully!', 'success');
          };

          return (
              <div className="max-h-[90vh] overflow-y-auto">
                  <div className="flex items-center justify-between px-4 py-3 border-b border-gray-200">
                      <div className="font-semibold">Checkout</div>
                      <button onClick={onClose} className="text-gray-600">âœ•</button>
                  </div>

                  <div className="p-4 space-y-4">
                      {/* Steps */}
                      <div className="flex items-center gap-2 text-sm">
                          <span className={`px-2 py-1 rounded-full ${step===1?'bg-primary text-white':'bg-gray-100 text-gray-700'}`}>1. Shipping</span>
                          <span className="text-gray-400">â†’</span>
                          <span className={`px-2 py-1 rounded-full ${step===2?'bg-primary text-white':'bg-gray-100 text-gray-700'}`}>2. Payment</span>
                      </div>

                      {/* Coins usage - moved to top */}
                              <div className="bg-gray-50 rounded-xl p-3">
                                  <div className="flex items-center justify-between">
                                      <div>
                                          <div className="text-sm font-medium text-gray-900">Pay with Coins</div>
                                          {isPremium ? (
                                          <div className="text-xs text-gray-500">Balance: {coinCount||0} â€¢ Max usable: {coinsCap} â€¢ <span className="text-green-600 font-semibold">%25 Ä°ndirim</span></div>
                                          ) : (
                                              <div className="text-xs text-red-500">Premium required to use coins (%25 discount)</div>
                                          )}
                                      </div>
                                      <button
                                          onClick={()=> {
                                              if (!isPremium) {
                                                  // Premium modal aÃ§Ä±lacak - burada setShowPremiumModal Ã§aÄŸrÄ±lmalÄ±
                                                  return;
                                              }
                                              setUseCoins(v => { const nv = !v; if (!nv) setCoinsUse(0); else setCoinsUse(prev => Math.min(coinsCap, prev || coinsCap)); return nv; });
                                          }}
                                          className={`px-3 py-1.5 rounded-xl text-sm font-semibold ${
                                              !isPremium
                                                  ? 'bg-gray-200 text-gray-500 cursor-not-allowed'
                                                  : useCoins
                                                      ? 'bg-primary text-white'
                                                      : 'bg-white border border-gray-200 text-gray-700'
                                          }`}
                                      >
                                          {!isPremium ? 'Premium Required' : useCoins ? 'Using Coins' : 'Use Coins'}
                                      </button>
                                  </div>
                                  {isPremium && (
                                  <div className="mt-2 flex items-center gap-2">
                                      <input
                                          type="number"
                                          min="0"
                                          max={coinsCap}
                                          inputMode="numeric"
                                          value={useCoins ? String(coinsUse) : '0'}
                                          onChange={(e)=> {
                                              const n = Math.max(0, Math.min(coinsCap, parseInt(e.target.value||'0', 10) || 0));
                                              setCoinsUse(n);
                                          }}
                                          disabled={!useCoins}
                                          className={`w-24 px-3 py-2 rounded-xl bg-white border ${useCoins ? 'border-gray-300' : 'border-gray-200 opacity-60'} text-sm`}
                                      />
                                      <div className="flex items-center gap-2">
                                          <button disabled={!useCoins} onClick={()=> setCoinsUse(v => Math.max(0, v-1))} className={`w-7 h-7 rounded-full ${useCoins ? 'bg-white border border-gray-200' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}`}>-</button>
                                          <button disabled={!useCoins} onClick={()=> setCoinsUse(v => Math.min(coinsCap, v+1))} className={`w-7 h-7 rounded-full ${useCoins ? 'bg-white border border-gray-200' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}`}>+</button>
                                          <button disabled={!useCoins} onClick={()=> setCoinsUse(coinsCap)} className={`px-2 py-1 rounded-lg ${useCoins ? 'bg-white border border-gray-200' : 'bg-gray-100 text-gray-400 cursor-not-allowed'} text-xs`}>Max</button>
                                      </div>
                                  </div>
                                  )}
                              </div>

                      {/* Order summary always visible */}
                      <div className="bg-gray-50 rounded-xl p-3">
                          <div className="flex items-center justify-between mb-2">
                              <div className="text-sm font-medium text-gray-900">Order Summary</div>
                              <div className="text-xs text-gray-500">{cartItems.length} items</div>
                          </div>
                          {items.length === 0 ? (
                              <div className="text-xs text-gray-500">Your cart is empty.</div>
                          ) : (
                                  <div className="space-y-2">
                                      {items.map(p => (
                                          <div key={p.id} onClick={() => onProductClick && onProductClick(p.id)} className={`flex items-center justify-between text-sm ${onProductClick ? 'cursor-pointer hover:bg-gray-100 rounded-lg p-2 -mx-2 transition-colors' : ''}`}>
                                              <div className="flex items-center gap-2">
                                                  <div className="w-8 h-8 bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center">
                                                      {p.image ? (
                                                          <img src={p.image} alt={p.name} className="w-full h-full object-cover" />
                                                      ) : (
                                                          <span className="text-lg">{p.icon}</span>
                                                      )}
                                                  </div>
                                                  <div>
                                                      <div className="font-medium text-gray-900 line-clamp-1">{p.name}</div>
                                                      <div className="text-xs text-gray-500">Qty: {p.qty}</div>
                                                  </div>
                                              </div>
                                              <div className="text-gray-900">â‚º{(p.price * p.qty).toLocaleString('tr-TR')}</div>
                                          </div>
                                      ))}
                                      <div className="h-px bg-gray-200 my-1"/>
                                      <div className="flex items-center justify-between text-sm"><span className="text-gray-600">Ara Toplam</span><span className="text-gray-900">â‚º{subtotal.toLocaleString('tr-TR')}</span></div>
                                      <div className="flex items-center justify-between text-sm"><span className="text-gray-600">Kargo</span><span className="text-gray-900">{shippingFee===0 ? 'Ãœcretsiz' : `â‚º${shippingFee.toLocaleString('tr-TR')}`}</span></div>
                                      <div className="flex items-center justify-between text-sm"><span className="text-gray-600">Ä°ndirim</span><span className="text-gray-900">-â‚º{discount.toLocaleString('tr-TR')}</span></div>
                                      <div className="flex items-center justify-between text-sm"><span className="text-gray-600">Coin</span><span className="text-gray-900">-{coinsUse.toFixed(2)}</span></div>
                                      <div className="flex items-center justify-between font-semibold"><span className="text-gray-900">Toplam</span><span className="text-gray-900">â‚º{total.toLocaleString('tr-TR')}</span></div>
                                  </div>
                          )}
                      </div>

                      {step === 1 && (
                          <div className="space-y-3">
                              <div className="grid grid-cols-1 gap-2">
                                  <input value={shipping.fullName} onChange={(e)=> setShipping({...shipping, fullName: e.target.value})} placeholder="Full name" className="px-3 py-2 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none"/>
                                  <input value={shipping.email} onChange={(e)=> setShipping({...shipping, email: e.target.value})} placeholder="Email" className="px-3 py-2 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none"/>
                                  <input value={shipping.phone} onChange={(e)=> setShipping({...shipping, phone: e.target.value})} placeholder="Phone (optional)" className="px-3 py-2 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none"/>
                                  <input value={shipping.address} onChange={(e)=> setShipping({...shipping, address: e.target.value})} placeholder="Address" className="px-3 py-2 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none"/>
                                  <div className="grid grid-cols-2 gap-2">
                                      <input value={shipping.city} onChange={(e)=> setShipping({...shipping, city: e.target.value})} placeholder="City" className="px-3 py-2 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none"/>
                                      <input value={shipping.zip} onChange={(e)=> setShipping({...shipping, zip: e.target.value})} placeholder="ZIP" className="px-3 py-2 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none"/>
                                  </div>
                                  <input value={shipping.country} onChange={(e)=> setShipping({...shipping, country: e.target.value})} placeholder="Country" className="px-3 py-2 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none"/>
                              </div>
                              <div className="flex items-center justify-between">
                                  <div className="flex items-center gap-2">
                                      <input value={promo} onChange={(e)=> setPromo(e.target.value)} placeholder="Promo code (PROMO10)" className="px-3 py-2 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none text-sm"/>
                                  </div>
                                  <button onClick={()=> setStep(2)} disabled={!validShipping || items.length===0} className={`px-4 py-2 rounded-xl text-sm font-semibold ${(!validShipping || items.length===0) ? 'bg-gray-200 text-gray-400' : 'bg-primary text-white'}`}>Continue</button>
                              </div>
                          </div>
                      )}

                      {step === 2 && (
                          <div className="space-y-3">
                              <div className="grid grid-cols-1 gap-2">
                                  <input value={card.name} onChange={(e)=> setCard({...card, name: e.target.value})} placeholder="Name on card" className="px-3 py-2 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none"/>
                                  <input value={card.number} onChange={(e)=> setCard({...card, number: e.target.value})} placeholder="Card number" className="px-3 py-2 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none"/>
                                  <div className="grid grid-cols-2 gap-2">
                                      <input value={card.expiry} onChange={(e)=> setCard({...card, expiry: e.target.value})} placeholder="MM/YY" className="px-3 py-2 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none"/>
                                      <input value={card.cvv} onChange={(e)=> setCard({...card, cvv: e.target.value})} placeholder="CVV" className="px-3 py-2 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none"/>
                                  </div>
                              </div>
                              <div className="flex items-center justify-between">
                                  <button onClick={()=> setStep(1)} className="px-3 py-2 rounded-xl bg-gray-100">Geri</button>
                                  <button onClick={placeOrder} disabled={!canPay || processing} className={`px-4 py-2 rounded-xl font-semibold ${(!canPay || processing) ? 'bg-gray-200 text-gray-400' : 'bg-primary text-white'}`}>{processing ? 'Ä°ÅŸleniyor...' : (total === 0 ? 'Coin ile Ã–de' : `â‚º${total.toLocaleString('tr-TR')} Ã–de`)}</button>
                              </div>
                              <p className="text-[11px] text-gray-400">Demo checkout â€” no real payment occurs.</p>
                          </div>
                      )}
                  </div>
              </div>
          );
      };

      // Orders list modal
      const OrdersModal = ({ onClose, onReorder, onClear, catalog }) => {
          const [orders, setOrders] = useState(() => StorageManager.load('orders', []));
          const refresh = () => setOrders(StorageManager.load('orders', []));

          const formatDate = (iso) => {
              try { return new Date(iso).toLocaleString(); } catch { return iso; }
          };

          return (
              <div className="max-h-[90vh] overflow-y-auto">
                  <div className="flex items-center justify-between px-4 py-3 border-b border-gray-200">
                      <div className="font-semibold">My Orders</div>
                      <div className="flex items-center gap-2">
                          {orders.length > 0 && (
                              <button onClick={() => { onClear && onClear(); refresh(); }} className="px-3 py-1.5 rounded-xl bg-gray-100 text-sm">Clear</button>
                          )}
                          <button onClick={onClose} className="text-gray-600">âœ•</button>
                      </div>
                  </div>
                  <div className="p-4 space-y-3">
                      {orders.length === 0 ? (
                          <div className="text-center text-sm text-gray-500 py-8">No orders yet.</div>
                      ) : (
                          orders.map(order => (
                              <div key={order.id} className="bg-gray-50 rounded-xl p-3">
                                  <div className="flex items-center justify-between mb-2">
                                      <div>
                                          <div className="text-sm font-medium text-gray-900">Order #{order.id}</div>
                                          <div className="text-xs text-gray-500">{formatDate(order.createdAt)}</div>
                                      </div>
                                      <div className="text-sm font-semibold text-gray-900">â‚º{Number(order.total||0).toLocaleString('tr-TR')}</div>
                                  </div>
                                  <div className="space-y-2">
                                      {order.items.map((it, idx) => {
                                          const p = (catalog||[]).find(x => x.id === it.id);
                                          return (
                                              <div key={idx} className="flex items-center justify-between text-sm">
                                                  <div className="flex items-center gap-2">
                                                      <div className="w-8 h-8 bg-gradient-to-br from-primary to-secondary rounded-lg flex items-center justify-center">
                                                          <span className="text-lg">{p?.icon || 'ðŸ›ï¸'}</span>
                                                      </div>
                                                      <div>
                                                          <div className="font-medium text-gray-900 line-clamp-1">{p?.name || it.name}</div>
                                                          <div className="text-xs text-gray-500">Qty: {it.qty}</div>
                                                      </div>
                                                  </div>
                                                  <div className="text-gray-900">â‚º{(Number(it.price||p?.price||0) * it.qty).toLocaleString('tr-TR')}</div>
                                              </div>
                                          );
                                      })}
                                  </div>
                                  <div className="flex items-center justify-end gap-2 mt-2">
                                      <span className="text-xs text-gray-500">Status: {order.status || 'confirmed'}</span>
                                      <button onClick={() => onReorder && onReorder(order)} className="px-3 py-1.5 rounded-xl bg-primary text-white text-sm">Reorder</button>
                                  </div>
                              </div>
                          ))
                      )}
                  </div>
              </div>
          );
      };

      // Edit Profile Modal Component
      const EditProfileModal = ({ isOpen, onClose }) => {
          const [editData, setEditData] = useState(userProfile);
          const [isSaving, setIsSaving] = useState(false);

          const handleSave = async () => {
              setIsSaving(true);

              // Simulate API call
              await new Promise(resolve => setTimeout(resolve, 1000));

              const oldName = userProfile.name;
              const oldUsername = userProfile.username;
              const newName = (editData.name || '').trim() || me.name;
              const newUsername = (editData.username || '').trim() || me.username;

              const updatedProfile = { ...editData, name: newName, username: newUsername };
              setUserProfile(prev => ({ ...prev, name: newName, username: newUsername }));
              // Keep global `me` in sync so name persists across app
              setMe(prev => ({ ...prev, name: newName, username: newUsername }));

              // Track name history for broader updates
              const nameHistory = StorageManager.load('nameHistory', []);
              if (!nameHistory.includes(oldName)) nameHistory.push(oldName);
              StorageManager.save('nameHistory', nameHistory);

              // Update all existing posts authored by the user
              setPosts(prev => {
                  const updated = prev.map(p => {
                      const isMine = (
                          p.author === oldName ||
                          p.username === oldUsername ||
                          (Array.isArray(nameHistory) && nameHistory.includes(p.author))
                      );
                      return isMine
                          ? { ...p, author: newName, authorInitial: newName[0] ? newName[0].toUpperCase() : 'U', username: newUsername }
                          : p;
                  });
                  StorageManager.save('posts', updated);
                  return updated;
              });

              // Update saved content entries authored by the user
              setSavedContent(prev => {
                  const updated = prev.map(it => {
                      const isMine = it.author === oldName || (Array.isArray(nameHistory) && nameHistory.includes(it.author));
                      return isMine ? { ...it, author: newName } : it;
                  });
                  StorageManager.save('savedContent', updated);
                  return updated;
              });

              // Update comments authored by the user
              const allComments = StorageManager.load('comments', {});
              let anyChanged = false;
              Object.keys(allComments || {}).forEach(pid => {
                  const list = allComments[pid] || [];
                  let changedHere = false;
                  const updatedList = list.map(c => {
                      if (c.author === oldName) {
                          changedHere = true; anyChanged = true;
                          return {
                              ...c,
                              author: newName,
                              authorInitial: newName[0] ? newName[0].toUpperCase() : 'U'
                          };
                      }
                      return c;
                  });
                  if (changedHere) {
                      allComments[pid] = updatedList;
                  }
              });
              if (anyChanged) {
                  StorageManager.save('comments', allComments);
                  Object.keys(allComments).forEach(pid => {
                      window.dispatchEvent(new CustomEvent('commentsUpdated', { detail: { postId: Number(pid) } }));
                  });
              }

              StorageManager.save('userProfile', updatedProfile);
              ToastManager.show('Profile updated successfully!', 'success');
              setIsSaving(false);
              onClose();
          };

          return (
              <div className="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50" onMouseDown={(e) => { if (e.target === e.currentTarget) onClose(); }}>
                  <div className="bg-white rounded-3xl w-full max-w-md mx-4 max-h-[85vh] overflow-hidden slide-up">
                      <div className="flex items-center justify-between p-4 border-b border-gray-200">
                          <h2 className="text-lg font-bold">Edit Profile</h2>
                          <button onClick={onClose} className="text-gray-500">âœ•</button>
                      </div>

                      <div className="p-4 space-y-4 max-h-96 overflow-y-auto">
                          <div>
                              <label className="block text-sm font-medium text-gray-700 mb-2">Name</label>
                              <input
                                  type="text"
                                  value={editData.name}
                                  onChange={(e) => setEditData({...editData, name: e.target.value})}
                                  className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 text-base"
                                  maxLength={50}
                              />
                          </div>

                          <div>
                              <label className="block text-sm font-medium text-gray-700 mb-2">Username</label>
                              <input
                                  type="text"
                                  value={editData.username}
                                  onChange={(e) => setEditData({...editData, username: e.target.value})}
                                  className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 text-base"
                                  maxLength={30}
                              />
                          </div>

                          <div>
                              <label className="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                              <textarea
                                  value={editData.bio}
                                  onChange={(e) => setEditData({...editData, bio: e.target.value})}
                                  className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 text-base resize-none"
                                  rows={3}
                                  maxLength={150}
                              />
                              <p className="text-xs text-gray-500 mt-1">{editData.bio.length}/150</p>
                          </div>

                          <div>
                              <label className="block text-sm font-medium text-gray-700 mb-2">Location</label>
                              <input
                                  type="text"
                                  value={editData.location}
                                  onChange={(e) => setEditData({...editData, location: e.target.value})}
                                  className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 text-base"
                                  placeholder="Your location"
                              />
                          </div>

                          <div>
                              <label className="block text-sm font-medium text-gray-700 mb-2">Website</label>
                              <input
                                  type="url"
                                  value={editData.website}
                                  onChange={(e) => setEditData({...editData, website: e.target.value})}
                                  className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 text-base"
                                  placeholder="https://yourwebsite.com"
                              />
                          </div>
                      </div>

                      <div className="p-4 border-t border-gray-200">
                          <button
                              onClick={handleSave}
                              disabled={isSaving}
                              className={`w-full py-3 rounded-xl font-semibold transition-all btn-hover-lift ${
                                  isSaving
                                      ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                      : 'bg-primary text-white hover:bg-primary-dark'
                              }`}
                          >
                              {isSaving ? (
                                  <div className="flex items-center justify-center space-x-2">
                                      <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                      <span>Saving...</span>
                                  </div>
                              ) : (
                                  'Save Changes'
                              )}
                          </button>
                      </div>
                  </div>
              </div>
          );
      };

      // ProfileView Component
      const ProfileView = () => {
          const [savedContent, setSavedContent] = useState(StorageManager.load('savedContent', [])); // Load saved content
          const [showEditModal, setShowEditModal] = useState(false);
          const [profileTab, setProfileTab] = useState('posts'); // 'posts' | 'saved' | 'orders' | 'savedProducts'
          const avatarInputRef = useRef(null);
          const [coinCount, setCoinCount] = useState(() => StorageManager.load('coinCount', 127));
          const [showAllGroupsModal, setShowAllGroupsModal] = useState(false);
          const [orders] = useState(() => StorageManager.load('orders', []));
          const [shopItems] = useState(() => StorageManager.load('shopItems', []));
          // Load profile from storage; fall back to current `me`
          const [userProfile, setUserProfile] = useState(() => {
              const stored = StorageManager.load('userProfile', null);
              const baseProfile = {
                  name: me.name,
                  username: me.username,
                  bio: "24 year old full time mom of two, part time digital artist who's unsurprisingly always in need of a little caffeine â˜•ï¸ semi-retired gamer turned book addict (romance, fantasy & spooky stories). Always down for a scary movie or a haunted house adventure! ðŸ‘»",
                  location: 'Phillipsburg, New Jersey, US',
                  joinDate: 'Joined March 2024',
                  website: '',
                  followers: 156,
                  following: 89,
                  avatarUrl: StorageManager.load('me', null)?.avatarUrl || null,
                  coverGradient: 'from-[#CFEDE7] via-[#BFE5DD] to-[#A5D9CE]',
                  status: 'Active now',
                  children: [],
                  identityBadges: [
                      { emoji: 'ðŸ’œ', label: 'Preemie mama' },
                      { emoji: 'ðŸ¡', label: 'SAHM' },
                      { emoji: 'â™‰ï¸', label: 'Taurus' }
                  ],
                  interests: [
                      { emoji: 'ðŸ“š', label: 'Bookworm' },
                      { emoji: 'ðŸŒ®', label: 'Total foodie' },
                      { emoji: 'ðŸ€', label: 'Crafty queen' },
                      { emoji: 'ðŸ¶', label: 'Pets > people' },
                      { emoji: 'ðŸ§ª', label: 'Science savvy' },
                      { emoji: 'ðŸŽ¨', label: 'Art is everything' },
                      { emoji: 'ðŸŽ²', label: 'Games night pro' },
                      { emoji: 'ðŸ‘¾', label: 'Gamer girl' },
                      { emoji: 'âš–ï¸', label: 'Political pro' }
                  ],
                  friendDescriptors: [
                      { emoji: 'ðŸŒ¶ï¸', label: 'Hot mess' },
                      { emoji: 'ðŸ¥±', label: 'Sleep deprived' },
                      { emoji: 'ðŸ›ï¸', label: 'Home bird' }
                  ],
                  languages: [
                      { emoji: 'ðŸŒ', label: 'English' }
                  ],
                  hobbies: [],
                  values: [],
                  lifestyle: [],
                  goals: [],
                  storyHighlights: [
                      {
                          title: 'If I had a theme song...',
                          description: 'On the Brightside - Never Shout Never'
                      },
                      {
                          title: 'An embarrassing era I went through...',
                          description: '2013 tumblr girl'
                      }
                  ],
                  storyImage: 'https://images.unsplash.com/photo-1510024161681-8f47d1e70f9b?auto=format&fit=crop&w=900&q=80'
              };
              if (stored) return { ...baseProfile, ...stored };
              return baseProfile;
          });


          // Keep profile data in sync with `me` (name, username, avatar)
          useEffect(() => {
              setUserProfile(prev => {
                  const needsName = prev.name !== me.name;
                  const needsUser = prev.username !== me.username;
                  const needsAvatar = prev.avatarUrl !== me.avatarUrl && !!me.avatarUrl;
                  if (needsName || needsUser || needsAvatar) {
                      const updated = { ...prev, name: me.name, username: me.username, avatarUrl: needsAvatar ? me.avatarUrl : prev.avatarUrl };
                      StorageManager.save('userProfile', updated);
                      return updated;
                  }
                  return prev;
              });
          }, [me.name, me.username, me.avatarUrl]);

          const handleAvatarSelected = (e) => {
              const file = e.target.files && e.target.files[0];
              if (!file) return;
              const reader = new FileReader();
              reader.onload = () => {
                  setUserProfile(prev => {
                      const updated = { ...prev, avatarUrl: reader.result };
                      StorageManager.save('userProfile', updated);
                      return updated;
                  });
                  // Mirror to `me` so avatar is available app-wide and persists
                  setMe(prev => ({ ...prev, avatarUrl: reader.result }));
                  ToastManager.show('Profile photo updated', 'success');
              };
              reader.readAsDataURL(file);
              e.target.value = '';
          };

          const fallbackChildren = React.useMemo(() => ([
              { emoji: 'ðŸ‘¶', label: 'Boy â€¢ Gray â€¢ 2 years, 4 weeks', bg: 'bg-[#FBE9F1]', text: 'text-[#7D3E56]' },
              { emoji: 'ðŸ‘¶', label: 'Boy â€¢ Callaghan â€¢ 4 months, 4 weeks', bg: 'bg-[#FBE9F1]', text: 'text-[#7D3E56]' }
          ]), []);

          const fallbackIdentityBadges = React.useMemo(() => ([
              { emoji: 'ðŸ’œ', label: 'Preemie mama' },
              { emoji: 'ðŸ¡', label: 'SAHM' },
              { emoji: 'â™‰ï¸', label: 'Taurus' }
          ]), []);

          const fallbackInterests = React.useMemo(() => ([
              { emoji: 'ðŸ“š', label: 'Bookworm' },
              { emoji: 'ðŸŒ®', label: 'Total foodie' },
              { emoji: 'ðŸ€', label: 'Crafty queen' },
              { emoji: 'ðŸ¶', label: 'Pets > people' },
              { emoji: 'ðŸ§ª', label: 'Science savvy' },
              { emoji: 'ðŸŽ¨', label: 'Art is everything' },
              { emoji: 'ðŸŽ²', label: 'Games night pro' },
              { emoji: 'ðŸ‘¾', label: 'Gamer girl' },
              { emoji: 'âš–ï¸', label: 'Political pro' }
          ]), []);

          const fallbackFriendDescriptors = React.useMemo(() => ([
              { emoji: 'ðŸŒ¶ï¸', label: 'Hot mess' },
              { emoji: 'ðŸ¥±', label: 'Sleep deprived' },
              { emoji: 'ðŸ›ï¸', label: 'Home bird' }
          ]), []);

          const fallbackLanguages = React.useMemo(() => ([
              { emoji: 'ðŸŒ', label: 'English' }
          ]), []);

          const fallbackStoryHighlights = React.useMemo(() => ([
              {
                  title: 'If I had a theme song, it would be...',
                  description: 'On the Brightside - Never Shout Never'
              },
              {
                  title: 'An embarrassing era I went through...',
                  description: '2013 tumblr girl'
              }
          ]), []);

          // Format age display: "x years y months z weeks"
          const formatAge = (birthDate) => {
              if (!birthDate) return '';
              const today = new Date();
              const birth = new Date(birthDate);
              
              let years = today.getFullYear() - birth.getFullYear();
              let months = today.getMonth() - birth.getMonth();
              let days = today.getDate() - birth.getDate();
              
              // Adjust for negative months/days
              if (days < 0) {
                  months--;
                  const lastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
                  days += lastMonth.getDate();
              }
              
              if (months < 0) {
                  years--;
                  months += 12;
              }
              
              // Calculate weeks from remaining days
              const weeks = Math.floor(days / 7);
              const remainingDays = days % 7;
              
              const parts = [];
              if (years > 0) {
                  parts.push(`${years} ${years === 1 ? 'year' : 'years'}`);
              }
              if (months > 0) {
                  parts.push(`${months} ${months === 1 ? 'month' : 'months'}`);
              }
              if (weeks > 0) {
                  parts.push(`${weeks} ${weeks === 1 ? 'week' : 'weeks'}`);
              }
              // If less than a week old, show days (including 0 days for today)
              if (parts.length === 0) {
                  if (remainingDays === 0) {
                      parts.push('0 days');
                  } else {
                      parts.push(`${remainingDays} ${remainingDays === 1 ? 'day' : 'days'}`);
                  }
              }
              
              return parts.length > 0 ? parts.join(' ') : '';
          };

          // Force re-render to update ages daily - use state that updates once per day
          const [ageUpdateKey, setAgeUpdateKey] = useState(() => {
              // Set initial key based on current date
              return new Date().toDateString();
          });

          useEffect(() => {
              // Update ages once per day
              const checkDate = setInterval(() => {
                  const currentDate = new Date().toDateString();
                  if (currentDate !== ageUpdateKey) {
                      setAgeUpdateKey(currentDate);
                  }
              }, 60000); // Check every minute

              return () => clearInterval(checkDate);
          }, [ageUpdateKey]);

          // Update coinCount from storage periodically
          useEffect(() => {
              const interval = setInterval(() => {
                  const stored = StorageManager.load('coinCount', 127);
                  setCoinCount(stored);
              }, 1000); // Update every second
              return () => clearInterval(interval);
          }, []);

          // Process children with dynamic age calculation
          const processedChildren = useMemo(() => {
              const children = Array.isArray(userProfile.children) && userProfile.children.length ? userProfile.children : [];
              // Use ageUpdateKey to force recalculation
              return children.map(child => {
                  const emoji = child.gender === 'boy' ? 'ðŸ‘¦' : child.gender === 'girl' ? 'ðŸ‘§' : (child.emoji || 'ðŸ‘¶');
                  // Use name if available, otherwise use existing label or fallback
                  const displayName = child.name || child.label || '';
                  let displayLabel = displayName;
                  // If there's a birth date, add age to the label
                  if (child.birthDate) {
                      const age = formatAge(child.birthDate);
                      if (age) {
                          displayLabel = displayName ? `${displayName} (${age})` : age;
                      }
                  }
                  return {
                      ...child,
                      emoji,
                      label: displayLabel,
                      name: child.name || ''
                  };
              });
          }, [userProfile.children, ageUpdateKey]);

          const profileChildren = processedChildren;
          const profileIdentityBadges = Array.isArray(userProfile.identityBadges) && userProfile.identityBadges.length ? userProfile.identityBadges : fallbackIdentityBadges;
          const profileInterests = Array.isArray(userProfile.interests) && userProfile.interests.length ? userProfile.interests : fallbackInterests;
          const profileFriendDescriptors = Array.isArray(userProfile.friendDescriptors) && userProfile.friendDescriptors.length ? userProfile.friendDescriptors : fallbackFriendDescriptors;
          const profileLanguages = Array.isArray(userProfile.languages) && userProfile.languages.length ? userProfile.languages : fallbackLanguages;
          const profileHobbies = Array.isArray(userProfile.hobbies) && userProfile.hobbies.length ? userProfile.hobbies : [];
          const profileValues = Array.isArray(userProfile.values) && userProfile.values.length ? userProfile.values : [];
          const profileLifestyle = Array.isArray(userProfile.lifestyle) && userProfile.lifestyle.length ? userProfile.lifestyle : [];
          const profileGoals = Array.isArray(userProfile.goals) && userProfile.goals.length ? userProfile.goals : [];
          const profileStoryHighlights = Array.isArray(userProfile.storyHighlights) && userProfile.storyHighlights.length ? userProfile.storyHighlights : fallbackStoryHighlights;
          const profileStoryImage = userProfile.storyImage || 'https://images.unsplash.com/photo-1510024161681-8f47d1e70f9b?auto=format&fit=crop&w=900&q=80';

          // Get user's groups - sorted by most recently joined (last in joinedGroups array)
          const myGroups = useMemo(() => {
              const groups = allGroups.filter(group => joinedGroups.includes(group.id));
              // Sort by position in joinedGroups (most recently joined first)
              const sorted = [...groups].sort((a, b) => {
                  const idxA = joinedGroups.indexOf(a.id);
                  const idxB = joinedGroups.indexOf(b.id);
                  return idxB - idxA; // Reverse order (last joined first)
              });
              return sorted;
          }, [allGroups, joinedGroups]);

          // Get user's own posts (from all posts and group posts)
          const myOwnPosts = useMemo(() => {
              // Get regular posts by user
              const regularPosts = (posts || []).filter(p => 
                  p.author === me.name || 
                  p.username === me.username ||
                  p.authorInitial === (me.name?.[0]?.toUpperCase() || me.username?.[0]?.toUpperCase())
              );

              // Get group posts by user
              const groupPostsData = StorageManager.load('groupPosts', {});
              const allGroupPostsList = Object.entries(groupPostsData || {}).flatMap(([gid, arr]) => 
                  (arr || []).map(p => ({...p, groupId: Number(gid)}))
              );
              const myGroupPostsFiltered = allGroupPostsList.filter(p => 
                  p.author === me.name ||
                  p.username === me.username ||
                  (p.groupId && myGroups.some(g => g.id === p.groupId && (p.author === me.name || p.username === me.username)))
              );

              // Combine and sort by date
              const combined = [...regularPosts, ...myGroupPostsFiltered];
              return combined.sort((a, b) => {
                  const timeA = getTimestamp(a.createdAt ?? a.time ?? a.id) ?? 0;
                  const timeB = getTimestamp(b.createdAt ?? b.time ?? b.id) ?? 0;
                  return timeB - timeA; // Most recent first
              });
          }, [posts, me.name, me.username, myGroups]);

          // Saved content breakdown
          const savedTips = useMemo(() => (savedContent || []).filter(item => item.type === 'tip'), [savedContent]);
          const savedPosts = useMemo(() => (savedContent || []).filter(item => item.type !== 'tip'), [savedContent]);
          const savedTipFallbacks = useMemo(() => [
              'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=80',
              'https://images.unsplash.com/photo-1522844990619-4951c40f7eda?auto=format&fit=crop&w=1200&q=80',
              'https://images.unsplash.com/photo-1545239351-1141bd82e8a6?auto=format&fit=crop&w=1200&q=80',
              'https://images.unsplash.com/photo-1520262494112-9fe481d36ec3?auto=format&fit=crop&w=1200&q=80',
              'https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=1200&q=80'
          ], []);

          // Edit Profile Modal
              const EditProfileModal = ({ isOpen, onClose }) => {
              const [editData, setEditData] = useState({
                  ...userProfile,
                  children: Array.isArray(userProfile.children) && userProfile.children.length ? userProfile.children : [],
                  identityBadges: userProfile.identityBadges || fallbackIdentityBadges,
                  interests: userProfile.interests || fallbackInterests,
                  friendDescriptors: userProfile.friendDescriptors || fallbackFriendDescriptors,
                  languages: userProfile.languages || fallbackLanguages,
                  hobbies: userProfile.hobbies || [],
                  values: userProfile.values || [],
                  lifestyle: userProfile.lifestyle || [],
                  goals: userProfile.goals || [],
                  storyHighlights: userProfile.storyHighlights || fallbackStoryHighlights
              });
              const [isSaving, setIsSaving] = useState(false);
              const [showSelectModal, setShowSelectModal] = useState(null); // 'identityBadges' | 'interests' | 'friendDescriptors' | 'languages' | null
              const [coverMode, setCoverMode] = useState('preset'); // 'preset' | 'custom'
              const [customColors, setCustomColors] = useState({
                  from: '#CFEDE7',
                  via: '#BFE5DD',
                  to: '#A5D9CE'
              });

              // Predefined lists for selection - categorized
              const identityBadgesPacks = {
                  'ABOUT ME': [
                      { emoji: 'ðŸ¥‡', label: 'Doing it solo' },
                      { emoji: 'ðŸ°', label: 'Step-mama' },
                      { emoji: 'ðŸ“', label: 'Neighbor' },
                      { emoji: 'ðŸš—', label: 'Adoptive mama' },
                      { emoji: 'ðŸ“š', label: 'Homeschooling' },
                      { emoji: 'ðŸŒˆ', label: 'Rainbow baby mama' },
                      { emoji: 'ðŸ¡', label: 'SAHM' },
                      { emoji: 'ðŸ‘‘', label: 'Mama' },
                      { emoji: 'ðŸ‘±â€â™€ï¸', label: 'Glam-ma' },
                      { emoji: '', label: 'She/Her' },
                      { emoji: '', label: 'They/Them' },
                      { emoji: 'ðŸ–¤', label: 'Widow' },
                      { emoji: 'ðŸ¥¤', label: 'Staying sober' },
                      { emoji: '', label: 'Neurodivergent' },
                      { emoji: 'ðŸ’œ', label: 'Preemie mama' },
                      { emoji: 'ðŸ‘‘', label: 'Boy mama' },
                      { emoji: 'ðŸ’–', label: 'Girl mama' },
                      { emoji: 'ðŸ¤±', label: 'Breastfeeding mama' },
                      { emoji: 'ðŸ¼', label: 'Formula feeding mama' },
                      { emoji: 'ðŸŒ±', label: 'First-time mama' },
                      { emoji: 'ðŸ‘¶', label: 'Twin mama' },
                      { emoji: 'ðŸƒ', label: 'Working mama' }
                  ],
                  'ZODIAC': [
                      { emoji: 'â™‘ï¸', label: 'Capricorn' },
                      { emoji: 'â™’ï¸', label: 'Aquarius' },
                      { emoji: 'â™“ï¸', label: 'Pisces' },
                      { emoji: 'â™ˆï¸', label: 'Aries' },
                      { emoji: 'â™‰ï¸', label: 'Taurus' },
                      { emoji: 'â™Šï¸', label: 'Gemini' },
                      { emoji: 'â™‹ï¸', label: 'Cancer' },
                      { emoji: 'â™Œï¸', label: 'Leo' },
                      { emoji: 'â™ï¸', label: 'Virgo' },
                      { emoji: 'â™Žï¸', label: 'Libra' },
                      { emoji: 'â™ï¸', label: 'Scorpio' },
                      { emoji: 'â™ï¸', label: 'Sagittarius' }
                  ]
              };

              const interestsOptions = [
                  { emoji: 'ðŸ“š', label: 'Bookworm' },
                  { emoji: 'ðŸŒ®', label: 'Total foodie' },
                  { emoji: 'ðŸ€', label: 'Crafty queen' },
                  { emoji: 'ðŸ¶', label: 'Pets > people' },
                  { emoji: 'ðŸ§ª', label: 'Science savvy' },
                  { emoji: 'ðŸŽ¨', label: 'Art is everything' },
                  { emoji: 'ðŸŽ²', label: 'Games night pro' },
                  { emoji: 'ðŸ‘¾', label: 'Gamer girl' },
                  { emoji: 'âš–ï¸', label: 'Political pro' },
                  { emoji: 'ðŸŽµ', label: 'Music lover' },
                  { emoji: 'ðŸŽ¬', label: 'Movie buff' },
                  { emoji: 'âœˆï¸', label: 'Travel enthusiast' },
                  { emoji: 'ðŸ§˜', label: 'Yoga & wellness' },
                  { emoji: 'ðŸ‹ï¸', label: 'Fitness fanatic' },
                  { emoji: 'ðŸŒ¿', label: 'Plant parent' },
                  { emoji: 'ðŸ“¸', label: 'Photography' },
                  { emoji: 'ðŸ³', label: 'Home cook' },
                  { emoji: 'ðŸƒ', label: 'Runner' },
                  { emoji: 'ðŸ§µ', label: 'DIY enthusiast' },
                  { emoji: 'ðŸŽ¤', label: 'Karaoke fan' },
                  { emoji: 'ðŸ–¼ï¸', label: 'Museum lover' },
                  { emoji: 'ðŸŽ­', label: 'Theater goer' },
                  { emoji: 'ðŸŒ', label: 'Nature lover' },
                  { emoji: 'â˜•', label: 'Coffee enthusiast' },
                  { emoji: 'ðŸ·', label: 'Wine connoisseur' },
                  { emoji: 'ðŸŽª', label: 'Festival goer' },
                  { emoji: 'ðŸ•ï¸', label: 'Camping fan' },
                  { emoji: 'ðŸŠ', label: 'Swimmer' },
                  { emoji: 'ðŸ§©', label: 'Puzzle solver' }
              ];

              const friendDescriptorsOptions = [
                  { emoji: 'ðŸŒ¶ï¸', label: 'Hot mess' },
                  { emoji: 'ðŸ¥±', label: 'Sleep deprived' },
                  { emoji: 'ðŸ›ï¸', label: 'Home bird' },
                  { emoji: 'âœ¨', label: 'Organized queen' },
                  { emoji: 'ðŸ¤ª', label: 'Funny friend' },
                  { emoji: 'ðŸ’ª', label: 'Strong & resilient' },
                  { emoji: 'ðŸ§', label: 'Sweet tooth' },
                  { emoji: 'â˜•', label: 'Coffee addict' },
                  { emoji: 'ðŸŽª', label: 'Life of the party' },
                  { emoji: 'ðŸ“–', label: 'Book club regular' },
                  { emoji: 'ðŸŒˆ', label: 'Optimist' },
                  { emoji: 'ðŸŽ¯', label: 'Goal-oriented' },
                  { emoji: 'ðŸ’«', label: 'Dreamer' },
                  { emoji: 'ðŸ¦‹', label: 'Free spirit' },
                  { emoji: 'âš¡', label: 'Energizer' },
                  { emoji: 'ðŸŒ™', label: 'Night owl' },
                  { emoji: 'ðŸŒ…', label: 'Early bird' },
                  { emoji: 'ðŸ§ ', label: 'Deep thinker' },
                  { emoji: 'ðŸ’', label: 'Caring friend' },
                  { emoji: 'ðŸŽ¨', label: 'Creative soul' }
              ];

              const languagesOptions = [
                  { emoji: 'ðŸŒ', label: 'English' },
                  { emoji: 'ðŸ‡¹ðŸ‡·', label: 'Turkish' },
                  { emoji: 'ðŸ‡ªðŸ‡¸', label: 'Spanish' },
                  { emoji: 'ðŸ‡«ðŸ‡·', label: 'French' },
                  { emoji: 'ðŸ‡©ðŸ‡ª', label: 'German' },
                  { emoji: 'ðŸ‡®ðŸ‡¹', label: 'Italian' },
                  { emoji: 'ðŸ‡µðŸ‡¹', label: 'Portuguese' },
                  { emoji: 'ðŸ‡·ðŸ‡º', label: 'Russian' },
                  { emoji: 'ðŸ‡¨ðŸ‡³', label: 'Chinese' },
                  { emoji: 'ðŸ‡¯ðŸ‡µ', label: 'Japanese' },
                  { emoji: 'ðŸ‡°ðŸ‡·', label: 'Korean' },
                  { emoji: 'ðŸ‡¸ðŸ‡¦', label: 'Arabic' },
                  { emoji: 'ðŸ‡³ðŸ‡±', label: 'Dutch' },
                  { emoji: 'ðŸ‡µðŸ‡±', label: 'Polish' },
                  { emoji: 'ðŸ‡¬ðŸ‡·', label: 'Greek' },
                  { emoji: 'ðŸ‡¸ðŸ‡ª', label: 'Swedish' },
                  { emoji: 'ðŸ‡³ðŸ‡´', label: 'Norwegian' },
                  { emoji: 'ðŸ‡©ðŸ‡°', label: 'Danish' },
                  { emoji: 'ðŸ‡«ðŸ‡®', label: 'Finnish' },
                  { emoji: 'ðŸ‡¨ðŸ‡¿', label: 'Czech' },
                  { emoji: 'ðŸ‡­ðŸ‡º', label: 'Hungarian' },
                  { emoji: 'ðŸ‡·ðŸ‡´', label: 'Romanian' },
                  { emoji: 'ðŸ‡®ðŸ‡±', label: 'Hebrew' },
                  { emoji: 'ðŸ‡®ðŸ‡³', label: 'Hindi' },
                  { emoji: 'ðŸ‡¹ðŸ‡­', label: 'Thai' },
                  { emoji: 'ðŸ‡»ðŸ‡³', label: 'Vietnamese' }
              ];

              const hobbiesOptions = [
                  { emoji: 'ðŸŽ¨', label: 'Painting' },
                  { emoji: 'ðŸ“', label: 'Writing' },
                  { emoji: 'ðŸ§¶', label: 'Knitting' },
                  { emoji: 'ðŸŽ¸', label: 'Playing guitar' },
                  { emoji: 'ðŸŽ¹', label: 'Piano' },
                  { emoji: 'ðŸƒ', label: 'Running' },
                  { emoji: 'ðŸ§—', label: 'Rock climbing' },
                  { emoji: 'ðŸš´', label: 'Cycling' },
                  { emoji: 'ðŸŽ¯', label: 'Archery' },
                  { emoji: 'ðŸŒï¸', label: 'Golf' },
                  { emoji: 'ðŸŽ®', label: 'Gaming' },
                  { emoji: 'ðŸ§©', label: 'Puzzles' },
                  { emoji: 'ðŸŽ²', label: 'Board games' },
                  { emoji: 'ðŸŽª', label: 'Circus arts' },
                  { emoji: 'ðŸŽ­', label: 'Acting' }
              ];

              const valuesOptions = [
                  { emoji: 'ðŸ’š', label: 'Environmentalist' },
                  { emoji: 'ðŸ¤', label: 'Community focused' },
                  { emoji: 'ðŸŒˆ', label: 'Inclusivity' },
                  { emoji: 'ðŸ§˜', label: 'Mindfulness' },
                  { emoji: 'ðŸ’', label: 'Kindness' },
                  { emoji: 'ðŸŒŸ', label: 'Positivity' },
                  { emoji: 'ðŸŽ“', label: 'Lifelong learning' },
                  { emoji: 'ðŸ’ª', label: 'Resilience' },
                  { emoji: 'ðŸŒ±', label: 'Growth mindset' },
                  { emoji: 'â¤ï¸', label: 'Compassion' },
                  { emoji: 'ðŸ•Šï¸', label: 'Peace' },
                  { emoji: 'ðŸŽ¯', label: 'Authenticity' },
                  { emoji: 'âœ¨', label: 'Gratitude' },
                  { emoji: 'ðŸš€', label: 'Innovation' },
                  { emoji: 'ðŸŒ', label: 'Global citizenship' }
              ];

              const lifestyleOptions = [
                  { emoji: 'ðŸŒ±', label: 'Vegan' },
                  { emoji: 'ðŸ¥—', label: 'Vegetarian' },
                  { emoji: 'ðŸ¡', label: 'Minimalist' },
                  { emoji: 'â™»ï¸', label: 'Zero waste' },
                  { emoji: 'ðŸš«', label: 'Alcohol-free' },
                  { emoji: 'ðŸŒ™', label: 'Night owl' },
                  { emoji: 'ðŸŒ…', label: 'Early riser' },
                  { emoji: 'ðŸ“±', label: 'Digital detox' },
                  { emoji: 'ðŸ§˜', label: 'Yoga practitioner' },
                  { emoji: 'ðŸƒ', label: 'Active lifestyle' },
                  { emoji: 'ðŸ“š', label: 'Continuous learner' },
                  { emoji: 'ðŸŒ¿', label: 'Nature lover' },
                  { emoji: 'ðŸ–ï¸', label: 'Beach person' },
                  { emoji: 'â›°ï¸', label: 'Mountain person' },
                  { emoji: 'ðŸ™ï¸', label: 'City dweller' }
              ];

              const goalsOptions = [
                  { emoji: 'ðŸ“–', label: 'Learn new language' },
                  { emoji: 'ðŸ’¼', label: 'Career growth' },
                  { emoji: 'ðŸƒ', label: 'Run a marathon' },
                  { emoji: 'ðŸŒ', label: 'Travel the world' },
                  { emoji: 'ðŸ“š', label: 'Read 50 books/year' },
                  { emoji: 'ðŸ’ª', label: 'Build strength' },
                  { emoji: 'ðŸ§˜', label: 'Daily meditation' },
                  { emoji: 'âœï¸', label: 'Write a book' },
                  { emoji: 'ðŸŽ¨', label: 'Master a skill' },
                  { emoji: 'ðŸ¡', label: 'Buy a home' },
                  { emoji: 'ðŸ’', label: 'Start a family' },
                  { emoji: 'ðŸŒ±', label: 'Start a business' },
                  { emoji: 'ðŸŽ“', label: 'Get certified' },
                  { emoji: 'ðŸŽ¯', label: 'Achieve work-life balance' },
                  { emoji: 'ðŸŒŸ', label: 'Personal growth' }
              ];

              // Zodiac sign labels for single selection logic
              const zodiacLabels = ['Capricorn', 'Aquarius', 'Pisces', 'Aries', 'Taurus', 'Gemini', 'Cancer', 'Leo', 'Virgo', 'Libra', 'Scorpio', 'Sagittarius'];

              const handleSelectItem = (field, item) => {
                  const current = editData[field] || [];
                  const exists = current.some(i => i.label === item.label);
                  
                  // Special handling for Identity Badges - Zodiac signs (only one can be selected)
                  if (field === 'identityBadges' && zodiacLabels.includes(item.label)) {
                      // If clicking a zodiac sign
                      if (exists) {
                          // Unselect - remove from array
                          setEditData({ ...editData, [field]: current.filter(i => i.label !== item.label) });
                      } else {
                          // Select - remove all other zodiac signs first, then add new one
                          const otherBadges = current.filter(badge => !zodiacLabels.includes(badge.label));
                          setEditData({ ...editData, [field]: [...otherBadges, item] });
                      }
                      return;
                  }
                  
                  // Default behavior for other items
                  if (exists) {
                      // Unselect - remove from array
                      setEditData({ ...editData, [field]: current.filter(i => i.label !== item.label) });
                  } else {
                      // Select - add to array
                      setEditData({ ...editData, [field]: [...current, item] });
                  }
              };

              // Calculate age from birth date
              const calculateAge = (birthDate) => {
                  if (!birthDate) return null;
                  const today = new Date();
                  const birth = new Date(birthDate);
                  let age = today.getFullYear() - birth.getFullYear();
                  const monthDiff = today.getMonth() - birth.getMonth();
                  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                      age--;
                  }
                  return age;
              };

              // Format age display: "x years y months z weeks"
              const formatAge = (birthDate) => {
                  if (!birthDate) return '';
                  const today = new Date();
                  const birth = new Date(birthDate);
                  
                  let years = today.getFullYear() - birth.getFullYear();
                  let months = today.getMonth() - birth.getMonth();
                  let days = today.getDate() - birth.getDate();
                  
                  // Adjust for negative months/days
                  if (days < 0) {
                      months--;
                      const lastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
                      days += lastMonth.getDate();
                  }
                  
                  if (months < 0) {
                      years--;
                      months += 12;
                  }
                  
                  // Calculate weeks from remaining days
                  const weeks = Math.floor(days / 7);
                  const remainingDays = days % 7;
                  
                  const parts = [];
                  if (years > 0) {
                      parts.push(`${years} ${years === 1 ? 'year' : 'years'}`);
                  }
                  if (months > 0) {
                      parts.push(`${months} ${months === 1 ? 'month' : 'months'}`);
                  }
                  if (weeks > 0) {
                      parts.push(`${weeks} ${weeks === 1 ? 'week' : 'weeks'}`);
                  }
                  // If less than a week old, show days (including 0 days for today)
                  if (parts.length === 0) {
                      if (remainingDays === 0) {
                          parts.push('0 days');
                      } else {
                          parts.push(`${remainingDays} ${remainingDays === 1 ? 'day' : 'days'}`);
                      }
                  }
                  
                  return parts.length > 0 ? parts.join(' ') : '';
              };

              const getOptionsForField = (field) => {
                  switch(field) {
                      case 'identityBadges': 
                          // Return all packs flattened for backwards compatibility, but we'll handle categories in modal
                          return Object.values(identityBadgesPacks).flat();
                      case 'interests': return interestsOptions;
                      case 'friendDescriptors': return friendDescriptorsOptions;
                      case 'languages': return languagesOptions;
                      case 'hobbies': return hobbiesOptions;
                      case 'values': return valuesOptions;
                      case 'lifestyle': return lifestyleOptions;
                      case 'goals': return goalsOptions;
                      default: return [];
                  }
              };

              if (!isOpen) return null;

              // Prefill with latest profile each time the modal opens
              useEffect(() => {
                  if (isOpen) {
                      setEditData({
                          ...userProfile,
                          children: Array.isArray(userProfile.children) && userProfile.children.length ? userProfile.children : [],
                          identityBadges: userProfile.identityBadges || fallbackIdentityBadges,
                          interests: userProfile.interests || fallbackInterests,
                          friendDescriptors: userProfile.friendDescriptors || fallbackFriendDescriptors,
                          languages: userProfile.languages || fallbackLanguages,
                          hobbies: userProfile.hobbies || [],
                          values: userProfile.values || [],
                          lifestyle: userProfile.lifestyle || [],
                          goals: userProfile.goals || [],
                          storyHighlights: userProfile.storyHighlights || fallbackStoryHighlights
                      });
                  }
              }, [isOpen, userProfile]);

              const addItem = (field, item) => {
                  const current = editData[field] || [];
                  setEditData({ ...editData, [field]: [...current, item] });
              };

              const removeItem = (field, index) => {
                  const current = editData[field] || [];
                  setEditData({ ...editData, [field]: current.filter((_, i) => i !== index) });
              };

              const updateItem = (field, index, updatedItem) => {
                  const current = editData[field] || [];
                  const updated = [...current];
                  updated[index] = updatedItem;
                  setEditData({ ...editData, [field]: updated });
              };

              const handleSave = async () => {
                  setIsSaving(true);
                  await new Promise(resolve => setTimeout(resolve, 1000));

                  const oldName = me.name;
                  const oldUsername = me.username;
                  const newName = (editData.name || '').trim() || oldName;
                  const newUsername = (editData.username || '').trim() || me.username;

                  const updatedProfile = { 
                      ...editData, 
                      name: newName, 
                      username: newUsername,
                      avatarUrl: editData.avatarUrl || userProfile.avatarUrl,
                      coverGradient: editData.coverGradient || userProfile.coverGradient,
                      children: Array.isArray(editData.children) && editData.children.length ? editData.children : [],
                      identityBadges: editData.identityBadges || fallbackIdentityBadges,
                      interests: editData.interests || fallbackInterests,
                      friendDescriptors: editData.friendDescriptors || fallbackFriendDescriptors,
                      languages: editData.languages || fallbackLanguages,
                      hobbies: editData.hobbies || [],
                      values: editData.values || [],
                      lifestyle: editData.lifestyle || [],
                      goals: editData.goals || [],
                      storyHighlights: editData.storyHighlights || fallbackStoryHighlights
                  };
                  setUserProfile(updatedProfile);
                  // Keep global `me` in sync so name and avatar persist across app
                  setMe(prev => ({ ...prev, name: newName, username: newUsername, avatarUrl: updatedProfile.avatarUrl }));

                  // Track name history for broader updates
                  const nameHistory = StorageManager.load('nameHistory', []);
                  if (!nameHistory.includes(oldName)) nameHistory.push(oldName);
                  StorageManager.save('nameHistory', nameHistory);

                  // Update all existing posts authored by the user
                  setPosts(prev => {
                      const updated = prev.map(p => {
                          const isMine = (
                              p.author === oldName ||
                              p.username === oldUsername ||
                              (Array.isArray(nameHistory) && nameHistory.includes(p.author))
                          );
                          return isMine
                              ? { ...p, author: newName, authorInitial: newName[0] ? newName[0].toUpperCase() : 'U', username: newUsername }
                              : p;
                      });
                      StorageManager.save('posts', updated);
                      return updated;
                  });

                  // Update saved content entries authored by the user
                  setSavedContent(prev => {
                      const updated = prev.map(it => {
                          const isMine = it.author === oldName || (Array.isArray(nameHistory) && nameHistory.includes(it.author));
                          return isMine ? { ...it, author: newName } : it;
                      });
                      StorageManager.save('savedContent', updated);
                      return updated;
                  });

                  // Update comments authored by the user
                  const allComments = StorageManager.load('comments', {});
                  let anyChanged = false;
                  Object.keys(allComments || {}).forEach(pid => {
                      const list = allComments[pid] || [];
                      let changedHere = false;
                      const updatedList = list.map(c => {
                          if (c.author === oldName) {
                              changedHere = true; anyChanged = true;
                              return {
                                  ...c,
                                  author: newName,
                                  authorInitial: newName[0] ? newName[0].toUpperCase() : 'U'
                              };
                          }
                          return c;
                      });
                      if (changedHere) {
                          allComments[pid] = updatedList;
                      }
                  });
                  if (anyChanged) {
                      StorageManager.save('comments', allComments);
                      Object.keys(allComments).forEach(pid => {
                          window.dispatchEvent(new CustomEvent('commentsUpdated', { detail: { postId: Number(pid) } }));
                      });
                  }

                  StorageManager.save('userProfile', updatedProfile);
                  ToastManager.show('Profile updated successfully!', 'success');
                  setIsSaving(false);
                  onClose();
              };

              return (
                  <div className="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50" onMouseDown={(e) => { if (e.target === e.currentTarget) onClose(); }}>
                      <div className="bg-white rounded-3xl w-full max-w-md mx-4 max-h-[85vh] overflow-hidden slide-up">
                          <div className="flex items-center justify-between p-4 border-b border-gray-200">
                              <h2 className="text-lg font-bold">Edit Profile</h2>
                              <button onClick={onClose} className="text-gray-500">âœ•</button>
                          </div>

                          <div className="p-4 space-y-4 max-h-[70vh] overflow-y-auto">
                              {/* Avatar Picker */}
                              <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Profile Photo</label>
                                  <div className="flex items-center gap-4">
                                      <div className="relative">
                                          <div className="w-20 h-20 rounded-full border-2 border-gray-200 overflow-hidden bg-gray-100">
                                              {editData.avatarUrl || userProfile.avatarUrl || me.avatarUrl ? (
                                                  <img
                                                      src={editData.avatarUrl || userProfile.avatarUrl || me.avatarUrl}
                                                      alt="Profile"
                                                      className="w-full h-full object-cover"
                                                  />
                                              ) : (
                                                  <div className="w-full h-full bg-gradient-to-br from-gray-200 via-gray-300 to-gray-400 flex items-center justify-center relative">
                                                      <div className="absolute inset-0 bg-gradient-to-br from-black/10 to-transparent"></div>
                                                      <span className="text-2xl font-bold text-white relative z-10 drop-shadow-lg">
                                                          {(editData.name || userProfile.name || me.name || 'U').charAt(0).toUpperCase()}
                                                      </span>
                                                  </div>
                                              )}
                                          </div>
                                      </div>
                                      <div className="flex-1">
                                          <button
                                              onClick={() => avatarInputRef?.current?.click()}
                                              className="px-4 py-2 border border-gray-200 rounded-xl text-sm font-semibold text-gray-700 hover:bg-gray-50 transition-colors"
                                          >
                                              Change Photo
                                          </button>
                                          <input ref={avatarInputRef} type="file" accept="image/*" className="hidden" onChange={(e) => {
                                              const file = e.target.files && e.target.files[0];
                                              if (!file) return;
                                              const reader = new FileReader();
                                              reader.onload = () => {
                                                  setEditData({...editData, avatarUrl: reader.result});
                                              };
                                              reader.readAsDataURL(file);
                                              e.target.value = '';
                                          }} />
                                      </div>
                                  </div>
                              </div>

                              {/* Cover Gradient Picker */}
                              <div>
                                  <div className="flex items-center justify-between mb-2">
                                      <label className="block text-sm font-medium text-gray-700">Cover Style</label>
                                      <div className="flex items-center gap-2 text-xs">
                                          <button
                                              onClick={() => setCoverMode('preset')}
                                              className={`px-3 py-1 rounded-lg transition-colors ${
                                                  coverMode === 'preset' 
                                                      ? 'bg-primary text-white' 
                                                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                              }`}
                                          >
                                              Presets
                                          </button>
                                          <button
                                              onClick={() => setCoverMode('custom')}
                                              className={`px-3 py-1 rounded-lg transition-colors ${
                                                  coverMode === 'custom' 
                                                      ? 'bg-primary text-white' 
                                                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                              }`}
                                          >
                                              Custom
                                          </button>
                                      </div>
                                  </div>
                                  
                                  {coverMode === 'preset' ? (
                                      <div className="max-h-64 overflow-y-auto">
                                          <div className="grid grid-cols-3 gap-3">
                                              {[
                                              // Mint/Green tones
                                              'from-[#CFEDE7] via-[#BFE5DD] to-[#A5D9CE]',
                                              'from-[#E6F8F3] via-[#D2F1EA] to-[#B8E8DE]',
                                              'from-[#A7F3D0] via-[#86EFAC] to-[#4ADE80]',
                                              'from-[#D1FAE5] via-[#A7F3D0] to-[#6EE7B7]',
                                              'from-[#ECFDF5] via-[#D1FAE5] to-[#A7F3D0]',
                                              'from-[#065F46] via-[#047857] to-[#059669]',
                                              
                                              // Pink/Rose tones
                                              'from-[#FDE2E4] via-[#FAD2E1] to-[#E2ECE9]',
                                              'from-[#FCE7F3] via-[#FBCFE8] to-[#F9A8D4]',
                                              'from-[#FDF2F8] via-[#FCE7F3] to-[#FBCFE8]',
                                              'from-[#EC4899] via-[#F472B6] to-[#FBBF24]',
                                              'from-[#FBCFE8] via-[#F9A8D4] to-[#F472B6]',
                                              'from-[#831843] via-[#9F1239] to-[#BE185D]',
                                              
                                              // Blue/Cyan tones
                                              'from-[#E0F2FE] via-[#BAE6FD] to-[#A7F3D0]',
                                              'from-[#DBEAFE] via-[#BFDBFE] to-[#93C5FD]',
                                              'from-[#EFF6FF] via-[#DBEAFE] to-[#BFDBFE]',
                                              'from-[#3B82F6] via-[#60A5FA] to-[#93C5FD]',
                                              'from-[#1E40AF] via-[#2563EB] to-[#3B82F6]',
                                              'from-[#0EA5E9] via-[#38BDF8] to-[#7DD3FC]',
                                              
                                              // Purple/Violet tones
                                              'from-[#EDE9FE] via-[#DDD6FE] to-[#C4B5FD]',
                                              'from-[#F3E8FF] via-[#E9D5FF] to-[#D8B4FE]',
                                              'from-[#8B5CF6] via-[#A78BFA] to-[#C4B5FD]',
                                              'from-[#6B21A8] via-[#7C3AED] to-[#8B5CF6]',
                                              'from-[#DDD6FE] via-[#C4B5FD] to-[#A78BFA]',
                                              'from-[#4C1D95] via-[#5B21B6] to-[#6B21A8]',
                                              
                                              // Yellow/Amber tones
                                              'from-[#FFF1D6] via-[#FFE4C4] to-[#FDE2E4]',
                                              'from-[#FEF3C7] via-[#FDE68A] to-[#FCD34D]',
                                              'from-[#FFFBEB] via-[#FEF3C7] to-[#FDE68A]',
                                              'from-[#F59E0B] via-[#FBBF24] to-[#FCD34D]',
                                              'from-[#92400E] via-[#B45309] to-[#D97706]',
                                              'from-[#FCD34D] via-[#FDE68A] to-[#FEF3C7]',
                                              
                                              // Orange/Red tones
                                              'from-[#FFEDD5] via-[#FED7AA] to-[#FDBA74]',
                                              'from-[#FFF7ED] via-[#FFEDD5] to-[#FED7AA]',
                                              'from-[#F97316] via-[#FB923C] to-[#FDBA74]',
                                              'from-[#EA580C] via-[#F97316] to-[#FB923C]',
                                              'from-[#FEE2E2] via-[#FECACA] to-[#FCA5A5]',
                                              'from-[#DC2626] via-[#EF4444] to-[#F87171]',
                                              
                                              // Teal/Emerald tones
                                              'from-[#CCFBF1] via-[#99F6E4] to-[#5EEAD4]',
                                              'from-[#F0FDFA] via-[#CCFBF1] to-[#99F6E4]',
                                              'from-[#14B8A6] via-[#2DD4BF] to-[#5EEAD4]',
                                              'from-[#0D9488] via-[#14B8A6] to-[#2DD4BF]',
                                              'from-[#134E4A] via-[#0F766E] to-[#14B8A6]',
                                              'from-[#99F6E4] via-[#5EEAD4] to-[#2DD4BF]',
                                              
                                              // Indigo tones
                                              'from-[#E0E7FF] via-[#C7D2FE] to-[#A5B4FC]',
                                              'from-[#EEF2FF] via-[#E0E7FF] to-[#C7D2FE]',
                                              'from-[#6366F1] via-[#818CF8] to-[#A5B4FC]',
                                              'from-[#4338CA] via-[#4F46E5] to-[#6366F1]',
                                              'from-[#312E81] via-[#3730A3] to-[#4338CA]',
                                              'from-[#C7D2FE] via-[#A5B4FC] to-[#818CF8]',
                                              
                                              // Gray/Neutral tones
                                              'from-[#F3F4F6] via-[#E5E7EB] to-[#D1D5DB]',
                                              'from-[#F9FAFB] via-[#F3F4F6] to-[#E5E7EB]',
                                              'from-[#6B7280] via-[#9CA3AF] to-[#D1D5DB]',
                                              'from-[#374151] via-[#4B5563] to-[#6B7280]',
                                              'from-[#1F2937] via-[#374151] to-[#4B5563]',
                                              'from-[#D1D5DB] via-[#9CA3AF] to-[#6B7280]',
                                              
                                              // Special combinations
                                              'from-[#F0F9FF] via-[#E0F2FE] to-[#BAE6FD]',
                                              'from-[#FDF4FF] via-[#FAE8FF] to-[#F5D0FE]',
                                              'from-[#FFF7ED] via-[#FFEDD5] to-[#FED7AA]',
                                              'from-[#ECFDF5] via-[#D1FAE5] to-[#A7F3D0]',
                                              'from-[#FEF2F2] via-[#FEE2E2] to-[#FECACA]',
                                              'from-[#F5F3FF] via-[#EDE9FE] to-[#DDD6FE]',
                                              
                                              // Vibrant gradients
                                              'from-[#F59E0B] via-[#EF4444] to-[#EC4899]',
                                              'from-[#3B82F6] via-[#8B5CF6] to-[#EC4899]',
                                              'from-[#10B981] via-[#3B82F6] to-[#8B5CF6]',
                                              'from-[#F59E0B] via-[#10B981] to-[#3B82F6]',
                                              'from-[#EC4899] via-[#8B5CF6] to-[#3B82F6]',
                                              'from-[#FBBF24] via-[#F59E0B] to-[#EF4444]',
                                              
                                              // Pastel gradients
                                              'from-[#FDF2F8] via-[#FCE7F3] to-[#FBCFE8]',
                                              'from-[#ECFDF5] via-[#D1FAE5] to-[#A7F3D0]',
                                              'from-[#EFF6FF] via-[#DBEAFE] to-[#BFDBFE]',
                                              'from-[#F3E8FF] via-[#E9D5FF] to-[#D8B4FE]',
                                              'from-[#FEF3C7] via-[#FDE68A] to-[#FCD34D]',
                                              'from-[#FFEDD5] via-[#FED7AA] to-[#FDBA74]',
                                              
                                              // Dark gradients
                                              'from-[#1F2937] via-[#374151] to-[#4B5563]',
                                              'from-[#111827] via-[#1F2937] to-[#374151]',
                                              'from-[#0F172A] via-[#1E293B] to-[#334155]',
                                              'from-[#1E1B4B] via-[#312E81] to-[#4338CA]',
                                              'from-[#581C87] via-[#6B21A8] to-[#7C3AED]',
                                              'from-[#831843] via-[#9F1239] to-[#BE185D]',
                                              
                                              // Warm gradients
                                              'from-[#FFF7ED] via-[#FFEDD5] to-[#FED7AA]',
                                              'from-[#FEF2F2] via-[#FEE2E2] to-[#FECACA]',
                                              'from-[#FDF4FF] via-[#FAE8FF] to-[#F5D0FE]',
                                              'from-[#FFFBEB] via-[#FEF3C7] to-[#FDE68A]',
                                              'from-[#F0FDF4] via-[#DCFCE7] to-[#BBF7D0]',
                                              'from-[#F0F9FF] via-[#E0F2FE] to-[#BAE6FD]',
                                          ].map(g => (
                                              <button 
                                                  key={g} 
                                                  onClick={() => setEditData({...editData, coverGradient: g})}
                                                  className={`rounded-2xl overflow-hidden border-2 h-16 transition-all hover:scale-105 ${(editData.coverGradient || userProfile.coverGradient) === g ? 'border-primary shadow-md ring-2 ring-primary ring-offset-1' : 'border-gray-200 hover:border-gray-300'}`}
                                              >
                                                  <div className={`w-full h-full bg-gradient-to-br ${g}`} />
                                              </button>
                                          ))}
                                      </div>
                                  </div>
                                  ) : (
                                      <div className="space-y-4">
                                          {/* Custom Gradient Preview */}
                                          <div className="rounded-2xl overflow-hidden border-2 border-gray-200 h-24">
                                              <div 
                                                  className="w-full h-full bg-gradient-to-br"
                                                  style={{
                                                      background: `linear-gradient(to bottom right, ${customColors.from}, ${customColors.via}, ${customColors.to})`
                                                  }}
                                              />
                                          </div>
                                          
                                          {/* Color Pickers */}
                                          <div className="space-y-3">
                                              {['from', 'via', 'to'].map((pos) => (
                                                  <div key={pos} className="flex items-center gap-3">
                                                      <label className="text-xs font-medium text-gray-600 w-12 capitalize">{pos}:</label>
                                                      <div className="flex items-center gap-2 flex-1">
                                                          <input
                                                              type="color"
                                                              value={customColors[pos]}
                                                              onChange={(e) => {
                                                                  const newColors = { ...customColors, [pos]: e.target.value };
                                                                  setCustomColors(newColors);
                                                                  // Automatically update editData
                                                                  const gradient = `from-[${newColors.from}] via-[${newColors.via}] to-[${newColors.to}]`;
                                                                  setEditData({...editData, coverGradient: gradient});
                                                              }}
                                                              className="w-12 h-12 rounded-lg border-2 border-gray-200 cursor-pointer"
                                                          />
                                                          <input
                                                              type="text"
                                                              value={customColors[pos]}
                                                              onChange={(e) => {
                                                                  const hex = e.target.value;
                                                                  if (/^#[0-9A-Fa-f]{6}$/.test(hex) || hex === '') {
                                                                      const newColors = { ...customColors, [pos]: hex || '#000000' };
                                                                      setCustomColors(newColors);
                                                                      const gradient = `from-[${newColors.from}] via-[${newColors.via}] to-[${newColors.to}]`;
                                                                      setEditData({...editData, coverGradient: gradient});
                                                                  }
                                                              }}
                                                              placeholder="#000000"
                                                              className="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm font-mono focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
                                                              maxLength={7}
                                                          />
                                                      </div>
                                                  </div>
                                              ))}
                                              
                                              <button
                                                  onClick={() => {
                                                      // Generate random gradient
                                                      const randomColor = () => {
                                                          const letters = '0123456789ABCDEF';
                                                          let color = '#';
                                                          for (let i = 0; i < 6; i++) {
                                                              color += letters[Math.floor(Math.random() * 16)];
                                                          }
                                                          return color;
                                                      };
                                                      const newColors = {
                                                          from: randomColor(),
                                                          via: randomColor(),
                                                          to: randomColor()
                                                      };
                                                      setCustomColors(newColors);
                                                      const gradient = `from-[${newColors.from}] via-[${newColors.via}] to-[${newColors.to}]`;
                                                      setEditData({...editData, coverGradient: gradient});
                                                  }}
                                                  className="w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium text-gray-700 transition-colors"
                                              >
                                                  ðŸŽ² Random Gradient
                                              </button>
                                          </div>
                                      </div>
                                  )}
                              </div>

                              <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Name</label>
                                  <input
                                      type="text"
                                      value={editData.name}
                                      onChange={(e) => setEditData({...editData, name: e.target.value})}
                                      className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 text-base"
                                      maxLength={50}
                                  />
                              </div>

                              <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                  <input
                                      type="text"
                                      value={editData.username}
                                      onChange={(e) => setEditData({...editData, username: e.target.value})}
                                      className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 text-base"
                                      maxLength={30}
                                  />
                              </div>

                              <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                                  <textarea
                                      value={editData.bio}
                                      onChange={(e) => setEditData({...editData, bio: e.target.value})}
                                      className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 text-base resize-none"
                                      rows={3}
                                      maxLength={150}
                                  />
                                  <p className="text-xs text-gray-500 mt-1">{editData.bio.length}/150</p>
                              </div>

                              <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Location</label>
                                  <input
                                      type="text"
                                      value={editData.location}
                                      onChange={(e) => setEditData({...editData, location: e.target.value})}
                                      className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 text-base"
                                      placeholder="Your location"
                                  />
                              </div>

                              <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Website</label>
                                  <input
                                      type="url"
                                      value={editData.website}
                                      onChange={(e) => setEditData({...editData, website: e.target.value})}
                                      className="w-full px-3 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 text-base"
                                      placeholder="https://yourwebsite.com"
                                  />
                              </div>

                              {/* Children */}
                              <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Children</label>
                                  <div className="space-y-3">
                                      {(editData.children || []).map((child, idx) => (
                                          <div key={idx} className="p-3 border border-gray-200 rounded-xl space-y-2">
                                              <div className="flex items-center justify-between gap-2">
                                                  <input
                                                      type="text"
                                                      value={child.name || ''}
                                                      onChange={(e) => updateItem('children', idx, { ...child, name: e.target.value })}
                                                      placeholder="Child name"
                                                      className="flex-1 px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
                                                  />
                                                  <button
                                                      onClick={() => removeItem('children', idx)}
                                                      className="px-2 py-1 text-red-500 hover:bg-red-50 rounded-lg text-sm flex-shrink-0"
                                                  >
                                                      âœ•
                                                  </button>
                                              </div>
                                              <div className="flex items-center gap-2">
                                                  <span className="text-2xl">{(child.gender === 'boy' ? 'ðŸ‘¦' : child.gender === 'girl' ? 'ðŸ‘§' : 'ðŸ‘¶')}</span>
                                                  <div className="flex gap-2 flex-1">
                                                      <button
                                                          onClick={() => updateItem('children', idx, { ...child, gender: 'boy' })}
                                                          className={`flex-1 px-3 py-2 rounded-lg text-sm font-semibold transition-all ${
                                                              child.gender === 'boy'
                                                                  ? 'bg-blue-100 text-blue-700 border-2 border-blue-300'
                                                                  : 'bg-gray-50 text-gray-600 border-2 border-gray-200 hover:border-blue-200'
                                                          }`}
                                                      >
                                                          Boy
                                                      </button>
                                                      <button
                                                          onClick={() => updateItem('children', idx, { ...child, gender: 'girl' })}
                                                          className={`flex-1 px-3 py-2 rounded-lg text-sm font-semibold transition-all ${
                                                              child.gender === 'girl'
                                                                  ? 'bg-pink-100 text-pink-700 border-2 border-pink-300'
                                                                  : 'bg-gray-50 text-gray-600 border-2 border-gray-200 hover:border-pink-200'
                                                          }`}
                                                      >
                                                          Girl
                                                      </button>
                                                  </div>
                                              </div>
                                              <div>
                                                  <label className="block text-xs text-gray-500 mb-1">Birth Date</label>
                                                  <input
                                                      type="date"
                                                      value={child.birthDate || ''}
                                                      onChange={(e) => {
                                                          const birthDate = e.target.value;
                                                          const age = formatAge(birthDate);
                                                          updateItem('children', idx, { 
                                                              ...child, 
                                                              birthDate: birthDate,
                                                              label: age ? `${age} old` : ''
                                                          });
                                                      }}
                                                      max={new Date().toISOString().split('T')[0]}
                                                      className="w-full px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20"
                                                  />
                                                  {child.birthDate && (
                                                      <p className="text-xs text-gray-500 mt-1">
                                                          Age: {formatAge(child.birthDate)} old
                                                      </p>
                                                  )}
                                              </div>
                                          </div>
                                      ))}
                                      <button
                                          onClick={() => addItem('children', { 
                                              name: '',
                                              gender: '', 
                                              birthDate: '', 
                                              label: '',
                                              bg: 'bg-[#FBE9F1]', 
                                              text: 'text-[#7D3E56]' 
                                          })}
                                          className="w-full px-3 py-2 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-primary hover:text-primary"
                                      >
                                          + Add Child
                                      </button>
                                  </div>
                              </div>

                              {/* Identity Badges */}
                              <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Identity Badges</label>
                                  <div className="flex flex-wrap gap-2 mb-3">
                                      {(editData.identityBadges || []).map((badge, idx) => (
                                          <span
                                              key={idx}
                                              className="inline-flex items-center gap-2 rounded-full bg-[#F8F5FF] px-4 py-2 text-sm font-semibold text-[#5A4A92]"
                                          >
                                              <span>{badge.emoji}</span>
                                              <span>{badge.label}</span>
                                              <button
                                                  onClick={() => removeItem('identityBadges', idx)}
                                                  className="ml-1 text-[#5A4A92]/70 hover:text-[#5A4A92]"
                                              >
                                                  âœ•
                                              </button>
                                          </span>
                                      ))}
                                  </div>
                                  <button
                                      onClick={() => setShowSelectModal('identityBadges')}
                                      className="w-full px-3 py-2 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-primary hover:text-primary"
                                  >
                                      + Add Badge
                                  </button>
                              </div>

                              {/* Interests */}
                              <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Interests</label>
                                  <div className="flex flex-wrap gap-2 mb-3">
                                      {(editData.interests || []).map((interest, idx) => (
                                          <span
                                              key={idx}
                                              className="inline-flex items-center gap-2 rounded-full bg-white px-4 py-2 text-sm font-semibold text-gray-700 border border-gray-200"
                                          >
                                              <span>{interest.emoji}</span>
                                              <span>{interest.label}</span>
                                              <button
                                                  onClick={() => removeItem('interests', idx)}
                                                  className="ml-1 text-gray-500 hover:text-gray-700"
                                              >
                                                  âœ•
                                              </button>
                                          </span>
                                      ))}
                                  </div>
                                  <button
                                      onClick={() => setShowSelectModal('interests')}
                                                  className="w-full px-3 py-2 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-primary hover:text-primary"
                                  >
                                      + Add Interest
                                  </button>
                              </div>

                              {/* Friend Descriptors */}
                              <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">My friends would say I'm</label>
                                  <div className="flex flex-wrap gap-2 mb-3">
                                      {(editData.friendDescriptors || []).map((desc, idx) => (
                                          <span
                                              key={idx}
                                              className="inline-flex items-center gap-2 rounded-full bg-white px-4 py-2 text-sm font-semibold text-gray-700 border border-gray-200"
                                          >
                                              <span>{desc.emoji}</span>
                                              <span>{desc.label}</span>
                                              <button
                                                  onClick={() => removeItem('friendDescriptors', idx)}
                                                  className="ml-1 text-gray-500 hover:text-gray-700"
                                              >
                                                  âœ•
                                              </button>
                                          </span>
                                      ))}
                                  </div>
                                  <button
                                      onClick={() => setShowSelectModal('friendDescriptors')}
                                      className="w-full px-3 py-2 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-primary hover:text-primary"
                                  >
                                      + Add Descriptor
                                  </button>
                              </div>

                              {/* Languages */}
                              <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Languages</label>
                                  <div className="flex flex-wrap gap-2 mb-3">
                                      {(editData.languages || []).map((lang, idx) => (
                                          <span
                                              key={idx}
                                              className="inline-flex items-center gap-2 rounded-full bg-white px-4 py-2 text-sm font-semibold text-gray-700 border border-gray-200"
                                          >
                                              <span>{lang.emoji}</span>
                                              <span>{lang.label}</span>
                                              <button
                                                  onClick={() => removeItem('languages', idx)}
                                                  className="ml-1 text-gray-500 hover:text-gray-700"
                                              >
                                                  âœ•
                                              </button>
                                          </span>
                                      ))}
                                  </div>
                                  <button
                                      onClick={() => setShowSelectModal('languages')}
                                      className="w-full px-3 py-2 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-primary hover:text-primary"
                                  >
                                      + Add Language
                                  </button>
                              </div>

                              {/* Hobbies */}
                              <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Hobbies</label>
                                  <div className="flex flex-wrap gap-2 mb-3">
                                      {(editData.hobbies || []).map((item, idx) => (
                                          <span
                                              key={idx}
                                              className="inline-flex items-center gap-2 rounded-full bg-white px-4 py-2 text-sm font-semibold text-gray-700 border border-gray-200"
                                          >
                                              <span>{item.emoji}</span>
                                              <span>{item.label}</span>
                                              <button
                                                  onClick={() => removeItem('hobbies', idx)}
                                                  className="ml-1 text-gray-500 hover:text-gray-700"
                                              >
                                                  âœ•
                                              </button>
                                          </span>
                                      ))}
                                          </div>
                                  <button
                                      onClick={() => setShowSelectModal('hobbies')}
                                      className="w-full px-3 py-2 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-primary hover:text-primary"
                                  >
                                      + Add Hobby
                                  </button>
                              </div>

                              {/* Values */}
                              <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Values</label>
                                  <div className="flex flex-wrap gap-2 mb-3">
                                      {(editData.values || []).map((item, idx) => (
                                          <span
                                              key={idx}
                                              className="inline-flex items-center gap-2 rounded-full bg-white px-4 py-2 text-sm font-semibold text-gray-700 border border-gray-200"
                                          >
                                              <span>{item.emoji}</span>
                                              <span>{item.label}</span>
                                              <button
                                                  onClick={() => removeItem('values', idx)}
                                                  className="ml-1 text-gray-500 hover:text-gray-700"
                                              >
                                                  âœ•
                                              </button>
                                          </span>
                                      ))}
                                  </div>
                                      <button
                                      onClick={() => setShowSelectModal('values')}
                                          className="w-full px-3 py-2 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-primary hover:text-primary"
                                      >
                                      + Add Value
                                      </button>
                                  </div>

                              {/* Lifestyle */}
                              <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Lifestyle</label>
                                  <div className="flex flex-wrap gap-2 mb-3">
                                      {(editData.lifestyle || []).map((item, idx) => (
                                          <span
                                              key={idx}
                                              className="inline-flex items-center gap-2 rounded-full bg-white px-4 py-2 text-sm font-semibold text-gray-700 border border-gray-200"
                                          >
                                              <span>{item.emoji}</span>
                                              <span>{item.label}</span>
                                              <button
                                                  onClick={() => removeItem('lifestyle', idx)}
                                                  className="ml-1 text-gray-500 hover:text-gray-700"
                                              >
                                                  âœ•
                                              </button>
                                          </span>
                                      ))}
                                  </div>
                                  <button
                                      onClick={() => setShowSelectModal('lifestyle')}
                                      className="w-full px-3 py-2 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-primary hover:text-primary"
                                  >
                                      + Add Lifestyle
                                  </button>
                              </div>

                              {/* Goals */}
                              <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Goals</label>
                                  <div className="flex flex-wrap gap-2 mb-3">
                                      {(editData.goals || []).map((item, idx) => (
                                          <span
                                              key={idx}
                                              className="inline-flex items-center gap-2 rounded-full bg-white px-4 py-2 text-sm font-semibold text-gray-700 border border-gray-200"
                                          >
                                              <span>{item.emoji}</span>
                                              <span>{item.label}</span>
                                              <button
                                                  onClick={() => removeItem('goals', idx)}
                                                  className="ml-1 text-gray-500 hover:text-gray-700"
                                              >
                                                  âœ•
                                              </button>
                                          </span>
                                      ))}
                                  </div>
                                  <button
                                      onClick={() => setShowSelectModal('goals')}
                                      className="w-full px-3 py-2 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-primary hover:text-primary"
                                  >
                                      + Add Goal
                                  </button>
                              </div>
                          </div>

                          <div className="p-4 border-t border-gray-200">
                              <button
                                  onClick={handleSave}
                                  disabled={isSaving}
                                  className={`w-full py-3 rounded-xl font-semibold transition-all btn-hover-lift ${
                                      isSaving
                                          ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                          : 'bg-primary text-white hover:bg-primary-dark'
                                  }`}
                              >
                                  {isSaving ? (
                                      <div className="flex items-center justify-center space-x-2">
                                          <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                          <span>Saving...</span>
                                      </div>
                                  ) : (
                                      'Save Changes'
                                  )}
                              </button>
                          </div>
                      </div>

                      {/* Selection Modal for Badges, Interests, etc. */}
                      {showSelectModal && (
                          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[60]" onMouseDown={(e) => { if (e.target === e.currentTarget) setShowSelectModal(null); }}>
                              <div className="bg-white rounded-3xl w-full max-w-md mx-4 max-h-[80vh] overflow-hidden flex flex-col">
                                  <div className="flex items-center justify-between p-4 border-b border-gray-200 flex-shrink-0">
                                      <h3 className="text-lg font-bold text-gray-900">
                                          {showSelectModal === 'identityBadges' && "Tell us where you're at"}
                                          {showSelectModal === 'interests' && 'Select Interest'}
                                          {showSelectModal === 'friendDescriptors' && 'Select Descriptor'}
                                          {showSelectModal === 'languages' && 'Select Language'}
                                          {showSelectModal === 'hobbies' && 'Select Hobby'}
                                          {showSelectModal === 'values' && 'Select Value'}
                                          {showSelectModal === 'lifestyle' && 'Select Lifestyle'}
                                          {showSelectModal === 'goals' && 'Select Goal'}
                                      </h3>
                                      <button onClick={() => setShowSelectModal(null)} className="text-gray-500">âœ•</button>
                                  </div>
                                  <div className="flex-1 overflow-y-auto p-4">
                                      {showSelectModal === 'identityBadges' ? (
                                          // Categorized view for identity badges
                                          <div className="space-y-6">
                                              {Object.entries(identityBadgesPacks).map(([category, options]) => (
                                                  <div key={category}>
                                                      <h4 className="text-xs font-medium text-gray-400 uppercase tracking-wider mb-3">{category}</h4>
                                                      <div className="flex flex-wrap gap-2">
                                                          {options.map((option, idx) => {
                                                              const current = editData[showSelectModal] || [];
                                                              const isSelected = current.some(item => item.label === option.label);
                                                              return (
                                                                  <button
                                                                      key={idx}
                                                                      onClick={() => handleSelectItem(showSelectModal, option)}
                                                                      className={`inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-semibold transition-all ${
                                                                          isSelected
                                                                              ? 'bg-primary text-white border-2 border-primary hover:bg-primary-dark'
                                                                              : 'bg-white border-2 border-gray-200 text-gray-700 hover:border-primary hover:text-primary'
                                                                      }`}
                                                                  >
                                                                      {option.emoji && <span>{option.emoji}</span>}
                                                                      <span>{option.label}</span>
                                                                      {isSelected && <span className="ml-1">âœ“</span>}
                                                                  </button>
                                                              );
                                                          })}
                                                      </div>
                                                  </div>
                                              ))}
                                          </div>
                                      ) : (
                                          // Regular flat view for other fields
                                          <div className="flex flex-wrap gap-2">
                                              {getOptionsForField(showSelectModal).map((option, idx) => {
                                                  const current = editData[showSelectModal] || [];
                                                  const isSelected = current.some(item => item.label === option.label);
                                                  return (
                                                      <button
                                                          key={idx}
                                                          onClick={() => handleSelectItem(showSelectModal, option)}
                                                          className={`inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-semibold transition-all ${
                                                              isSelected
                                                                  ? 'bg-primary text-white border-2 border-primary hover:bg-primary-dark'
                                                                  : 'bg-white border-2 border-gray-200 text-gray-700 hover:border-primary hover:text-primary'
                                                          }`}
                                                      >
                                                          <span>{option.emoji}</span>
                                                          <span>{option.label}</span>
                                                          {isSelected && <span className="ml-1">âœ“</span>}
                                                      </button>
                                                  );
                                              })}
                                          </div>
                                      )}
                                  </div>
                                  <div className="p-4 border-t border-gray-200">
                                      <button
                                          onClick={() => setShowSelectModal(null)}
                                          className="w-full py-2 px-4 rounded-xl font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all"
                                      >
                                          Done
                                      </button>
                                  </div>
                              </div>
                          </div>
                      )}
                  </div>
              );
          };

          return (
              <div className="bg-white min-h-screen">
                  {/* Profile Header */}
                  <div className="relative">
                      <div className="h-40 relative overflow-hidden">
                          <div className={`absolute inset-0 bg-gradient-to-br ${userProfile.coverGradient || 'from-[#CFEDE7] via-[#BFE5DD] to-[#A5D9CE]'}`} />
                          <div className="absolute inset-0 bg-black bg-opacity-5"></div>
                          {/* Edit Profile Button - Top Right */}
                              <button
                                  onClick={() => setShowEditModal(true)}
                              className="absolute top-3 right-3 inline-flex items-center gap-2 rounded-full bg-white/90 backdrop-blur-sm px-3 py-1.5 shadow-md hover:bg-white transition-colors z-10"
                                  title="Edit Profile"
                              >
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-gray-700">
                                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                  </svg>
                              <span className="text-xs font-semibold text-gray-700">Edit Profile</span>
                                          </button>
                                      </div>
                      <div className="absolute -bottom-4 left-1/2 transform -translate-x-1/2">
                          <div className="relative">
                              <div className="w-32 h-32 rounded-full border-4 border-white shadow-xl overflow-hidden bg-white">
                                  {userProfile.avatarUrl || me.avatarUrl ? (
                                  <img
                                          src={userProfile.avatarUrl || me.avatarUrl}
                                      alt="Profile"
                                      className="w-full h-full object-cover"
                                  />
                                  ) : (
                                      <div className="w-full h-full bg-gradient-to-br from-gray-200 via-gray-300 to-gray-400 flex items-center justify-center relative">
                                          <div className="absolute inset-0 bg-gradient-to-br from-black/10 to-transparent"></div>
                                          <span className="text-4xl font-bold text-white relative z-10 drop-shadow-lg">
                                              {(userProfile.name || me.name || 'U').charAt(0).toUpperCase()}
                                          </span>
                              </div>
                                  )}
                              </div>
                              <input ref={avatarInputRef} type="file" accept="image/*" className="hidden" onChange={handleAvatarSelected} />
                          </div>
                      </div>
                  </div>

                  <div className="px-6 pt-2 pb-12 space-y-8">
                      <div className="rounded-[32px] bg-white shadow-[0_25px_55px_-40px_rgba(19,39,35,0.35)] border border-white/60 px-6 pt-3 pb-6 space-y-6">
                          <div className="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
                              <div className="space-y-3">
                                  <div className="flex flex-wrap items-center gap-2">
                                      <h1 className="text-2xl font-semibold text-gray-900">{userProfile.name}</h1>
                              </div>
                              <div className="flex flex-wrap items-center gap-3 text-sm">
                                  {(userProfile.username || me.username) && (
                                      <span className="text-gray-600 font-medium">@{userProfile.username || me.username}</span>
                                  )}
                                  <div className="flex items-center gap-1.5 text-gray-700">
                                      <span className="text-base">ðŸª™</span>
                                      <span className="font-semibold">{coinCount}</span>
                                  </div>
                  </div>
                                  <div className="flex flex-wrap items-center gap-2 text-sm text-gray-500">
                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                      <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/>
                                      <circle cx="12" cy="10" r="3"/>
                                  </svg>
                                  <span>{userProfile.location}</span>
                              </div>
                          {userProfile.website && (
                                      <a
                                          href={userProfile.website}
                                          target="_blank"
                                          rel="noopener noreferrer"
                                          className="inline-flex items-center gap-2 text-xs font-semibold text-[#2E6A58] hover:underline"
                                      >
                                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"/>
                                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"/>
                                  </svg>
                                      {userProfile.website.replace(/^https?:\/\//, '')}
                                  </a>
                          )}
                      </div>
                  </div>

                          <div className="space-y-3">
                              {profileChildren.length > 0 && (
                              <div className="flex flex-wrap gap-2">
                                  {profileChildren.map((child, idx) => (
                                      <span
                                          key={`${child.label}-${idx}`}
                                          className={`inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-semibold shadow-sm ${child.bg || 'bg-[#FBE9F1]'} ${child.text || 'text-[#7D3E56]'}`}
                                      >
                                          <span>{child.emoji}</span>
                                          <span>{child.label}</span>
                                      </span>
                                  ))}
                              </div>
                              )}
                          </div>

                          <div className="rounded-[24px] bg-[#F7F9FB] border border-[#E7EEF1] p-5 text-sm leading-relaxed text-gray-700 shadow-inner">
                              {userProfile.bio}
                          </div>
                      </div>

                      <div className="space-y-6">
                          {profileIdentityBadges.length > 0 && (
                              <section className="space-y-3">
                                  <h3 className="text-sm font-semibold text-gray-900 uppercase tracking-[0.12em]">About Me</h3>
                              <div className="flex flex-wrap gap-2">
                                  {profileIdentityBadges.map((badge, idx) => (
                                      <span
                                          key={`${badge.label}-${idx}`}
                                              className="inline-flex items-center gap-2 rounded-full bg-white border border-gray-200 px-3 py-1.5 text-xs font-semibold text-gray-700 shadow-sm hover:bg-gray-50 transition-colors"
                                      >
                                          <span>{badge.emoji}</span>
                                          <span>{badge.label}</span>
                                      </span>
                                      ))}
                                  </div>
                              </section>
                          )}

                          {profileInterests.length > 0 && (
                              <section className="space-y-3">
                                  <h3 className="text-sm font-semibold text-gray-900 uppercase tracking-[0.12em]">Interests</h3>
                              <div className="flex flex-wrap gap-2">
                                  {profileInterests.map((interest, idx) => (
                                      <span
                                          key={`${interest.label}-${idx}`}
                                              className="inline-flex items-center gap-2 rounded-full bg-white border border-gray-200 px-3 py-1.5 text-xs font-semibold text-gray-700 shadow-sm hover:bg-gray-50 transition-colors"
                                      >
                                          <span>{interest.emoji}</span>
                                          <span>{interest.label}</span>
                                      </span>
                                  ))}
                                                      </div>
                          </section>
                          )}

                          {profileFriendDescriptors.length > 0 && (
                              <section className="space-y-3">
                              <h3 className="text-sm font-semibold text-gray-900 uppercase tracking-[0.12em]">My friends would say I'm</h3>
                              <div className="flex flex-wrap gap-2">
                                  {profileFriendDescriptors.map((item, idx) => (
                                      <span
                                          key={`${item.label}-${idx}`}
                                              className="inline-flex items-center gap-2 rounded-full bg-white border border-gray-200 px-3 py-1.5 text-xs font-semibold text-gray-700 shadow-sm hover:bg-gray-50 transition-colors"
                                      >
                                          <span>{item.emoji}</span>
                                          <span>{item.label}</span>
                                                      </span>
                                  ))}
                                                      </div>
                          </section>
                          )}

                          {profileLanguages.length > 0 && (
                              <section className="space-y-3">
                              <h3 className="text-sm font-semibold text-gray-900 uppercase tracking-[0.12em]">Speaks</h3>
                              <div className="flex flex-wrap gap-2">
                                  {profileLanguages.map((item, idx) => (
                                      <span
                                          key={`${item.label}-${idx}`}
                                              className="inline-flex items-center gap-2 rounded-full bg-white border border-gray-200 px-3 py-1.5 text-xs font-semibold text-gray-700 shadow-sm hover:bg-gray-50 transition-colors"
                                      >
                                          <span>{item.emoji}</span>
                                          <span>{item.label}</span>
                                      </span>
                                      ))}
                                  </div>
                          </section>
                          )}

                          {profileHobbies.length > 0 && (
                              <section className="space-y-3">
                                  <h3 className="text-sm font-semibold text-gray-900 uppercase tracking-[0.12em]">Hobbies</h3>
                                  <div className="flex flex-wrap gap-2">
                                      {profileHobbies.map((item, idx) => (
                                          <span
                                              key={`${item.label}-${idx}`}
                                              className="inline-flex items-center gap-2 rounded-full bg-white border border-gray-200 px-3 py-1.5 text-xs font-semibold text-gray-700 shadow-sm hover:bg-gray-50 transition-colors"
                                          >
                                              <span>{item.emoji}</span>
                                              <span>{item.label}</span>
                                          </span>
                                      ))}
                                      </div>
                              </section>
                          )}

                          {profileValues.length > 0 && (
                              <section className="space-y-3">
                                  <h3 className="text-sm font-semibold text-gray-900 uppercase tracking-[0.12em]">Values</h3>
                                  <div className="flex flex-wrap gap-2">
                                      {profileValues.map((item, idx) => (
                                          <span
                                              key={`${item.label}-${idx}`}
                                              className="inline-flex items-center gap-2 rounded-full bg-white border border-gray-200 px-3 py-1.5 text-xs font-semibold text-gray-700 shadow-sm hover:bg-gray-50 transition-colors"
                                          >
                                              <span>{item.emoji}</span>
                                              <span>{item.label}</span>
                                          </span>
                                      ))}
                                  </div>
                              </section>
                          )}

                          {profileLifestyle.length > 0 && (
                              <section className="space-y-3">
                                  <h3 className="text-sm font-semibold text-gray-900 uppercase tracking-[0.12em]">Lifestyle</h3>
                                  <div className="flex flex-wrap gap-2">
                                      {profileLifestyle.map((item, idx) => (
                                          <span
                                              key={`${item.label}-${idx}`}
                                              className="inline-flex items-center gap-2 rounded-full bg-white border border-gray-200 px-3 py-1.5 text-xs font-semibold text-gray-700 shadow-sm hover:bg-gray-50 transition-colors"
                                          >
                                              <span>{item.emoji}</span>
                                              <span>{item.label}</span>
                                          </span>
                                      ))}
                                  </div>
                              </section>
                          )}

                          {profileGoals.length > 0 && (
                              <section className="space-y-3">
                                  <h3 className="text-sm font-semibold text-gray-900 uppercase tracking-[0.12em]">Goals</h3>
                                  <div className="flex flex-wrap gap-2">
                                      {profileGoals.map((item, idx) => (
                                          <span
                                              key={`${item.label}-${idx}`}
                                              className="inline-flex items-center gap-2 rounded-full bg-white border border-gray-200 px-3 py-1.5 text-xs font-semibold text-gray-700 shadow-sm hover:bg-gray-50 transition-colors"
                                          >
                                              <span>{item.emoji}</span>
                                              <span>{item.label}</span>
                                          </span>
                                      ))}
                                  </div>
                              </section>
                          )}
                                      </div>

                      {/* Tabs */}
                      <div className="sticky top-0 z-10 bg-white/95 backdrop-blur border-b border-gray-200 -mx-6 px-6">
                          <div className="flex items-center gap-2 overflow-x-auto pb-2 pt-2 scrollbar-hide">
                              {[
                                  { key: 'posts', label: 'Posts', count: myOwnPosts.length },
                                  { key: 'saved', label: 'Saved', count: savedPosts.length },
                                  { key: 'orders', label: 'My Orders', count: orders.length },
                                  { key: 'savedProducts', label: 'Saved Products', count: (savedContent || []).filter(item => item.type === 'product').length }
                              ].map(tab => (
                                  <button
                                      key={tab.key}
                                      onClick={() => setProfileTab(tab.key)}
                                      className={`flex-shrink-0 px-4 py-2 rounded-xl text-sm font-semibold transition-all whitespace-nowrap ${
                                          profileTab === tab.key
                                              ? 'bg-gradient-to-r from-primary to-secondary text-white shadow-sm'
                                              : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                      }`}
                                  >
                                      {tab.label} {tab.count > 0 && `(${tab.count})`}
                                  </button>
                              ))}
                          </div>
                      </div>

                      <div className="space-y-6 mt-6">
                          {/* Posts Tab */}
                          {profileTab === 'posts' && (
                          <section className="space-y-3">
                              <div className="flex items-center justify-between">
                                  <h3 className="text-base font-semibold text-gray-900">Benim postlarÄ±m</h3>
                                  {myOwnPosts.length > 3 && (
                                      <button
                                          type="button"
                                          onClick={() => ToastManager.show('All posts view coming soon', 'info')}
                                          className="text-xs font-semibold text-[#2E6A58] hover:text-[#1F4C3E]"
                                      >
                                          View all
                                      </button>
                              )}
                          </div>
                              {myOwnPosts.length > 0 ? (
                                  <div className="space-y-4">
                                      {myOwnPosts.slice(0, 3).map(post => {
                                          const group = post.groupId ? myGroups.find(g => g.id === post.groupId) : null;
                                          return (
                                              <div key={post.id} className="rounded-[28px] border border-white shadow-[0_24px_60px_-40px_rgba(32,60,50,0.45)] bg-white p-5">
                                                  {group && (
                                                      <div className="flex items-center gap-3 mb-3">
                                                          <div className={`h-8 w-8 rounded-lg ${group.color} flex items-center justify-center`}>
                                                              <span className="text-white text-xs font-semibold">{group.name[0]}</span>
                                                  </div>
                                                  <div className="flex-1 min-w-0">
                                                              <p className="text-xs font-semibold text-gray-700 truncate">{group.name}</p>
                                                              <p className="text-xs text-gray-500">{formatRelativeTime(post.createdAt || post.time || post.id)}</p>
                                                      </div>
                                                  </div>
                                                  )}
                                                  {!group && (
                                                      <p className="text-xs text-gray-500 mb-3">{formatRelativeTime(post.createdAt || post.time || post.id)}</p>
                                                  )}
                                                  <p className="text-sm text-gray-900 line-clamp-3 mb-3">{post.content || post.text || ''}</p>
                                                  {group && (
                                                  <button
                                                      onClick={() => handleNavigateToGroup(group)}
                                                          className="text-xs font-semibold text-[#2E6A58] hover:text-[#1F4C3E]"
                                                  >
                                                          View in group â†’
                                                  </button>
                                                  )}
                                              </div>
                                          );
                                      })}
                                  </div>
                              ) : (
                                  <div className="rounded-[28px] border border-dashed border-[#E5E7EB] bg-white p-10 text-center">
                                      <h4 className="text-base font-semibold text-gray-900 mb-2">HenÃ¼z paylaÅŸÄ±m yok</h4>
                                      <p className="text-sm text-gray-500">Ä°lk gÃ¶nderini paylaÅŸ ve topluluÄŸa kendini tanÄ±t.</p>
                                      </div>
                              )}
                          </section>
                          )}

                          {/* Saved Tab */}
                          {profileTab === 'saved' && (
                          <section className="space-y-3">
                              <div className="flex items-center justify-between">
                                  <h3 className="text-base font-semibold text-gray-900">Saved Posts</h3>
                              </div>
                              {savedPosts.length > 0 ? (
                                  <div className="space-y-4">
                                      {savedPosts.map(post => (
                                          <div key={post.id} className="rounded-[28px] border border-white shadow-[0_24px_60px_-40px_rgba(32,60,50,0.45)] bg-white p-5">
                                              <p className="text-xs text-gray-500 mb-3">{formatRelativeTime(post.createdAt || post.time || post.id)}</p>
                                              <p className="text-sm text-gray-900 line-clamp-3">{post.content || post.text || ''}</p>
                                          </div>
                                      ))}
                                  </div>
                              ) : (
                                  <div className="rounded-[28px] border border-dashed border-[#E5E7EB] bg-white p-10 text-center">
                                      <h4 className="text-base font-semibold text-gray-900 mb-2">No saved posts</h4>
                                      <p className="text-sm text-gray-500">Posts you save will appear here.</p>
                                  </div>
                              )}
                          </section>
                          )}

                          {/* My Orders Tab */}
                          {profileTab === 'orders' && (
                          <section className="space-y-3">
                              <div className="flex items-center justify-between">
                                  <h3 className="text-base font-semibold text-gray-900">My Orders</h3>
                              </div>
                              {orders.length > 0 ? (
                                  <div className="space-y-4">
                                      {orders.map((order, idx) => (
                                          <div key={idx} className="rounded-[28px] border border-white shadow-[0_24px_60px_-40px_rgba(32,60,50,0.45)] bg-white p-5">
                                              <div className="flex items-start justify-between mb-3">
                                                  <div>
                                                      <h4 className="text-sm font-semibold text-gray-900">Order #{order.id || idx + 1}</h4>
                                                      <p className="text-xs text-gray-500 mt-1">{order.date || formatRelativeTime(order.createdAt || Date.now())}</p>
                                                  </div>
                                                  <span className={`px-3 py-1 rounded-full text-xs font-semibold ${
                                                      order.status === 'delivered' ? 'bg-green-100 text-green-700' :
                                                      order.status === 'shipped' ? 'bg-blue-100 text-blue-700' :
                                                      order.status === 'processing' ? 'bg-yellow-100 text-yellow-700' :
                                                      'bg-gray-100 text-gray-700'
                                                  }`}>
                                                      {order.status || 'Processing'}
                                                  </span>
                                              </div>
                                              <div className="space-y-2">
                                                  {order.items && Array.isArray(order.items) && order.items.map((item, itemIdx) => {
                                                      const product = shopItems.find(p => p.id === item.productId || p.id === item.id);
                                                      return (
                                                          <div key={itemIdx} className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                                                              <div className="w-12 h-12 rounded-lg bg-gray-200 overflow-hidden flex items-center justify-center">
                                                                  {product?.image || item.image ? (
                                                                      <img src={product?.image || item.image} alt={product?.name || item.name} className="w-full h-full object-cover" />
                                                                  ) : (
                                                                      <span className="text-2xl">{product?.icon || item.icon || 'ðŸ“¦'}</span>
                                                                  )}
                                                              </div>
                                                              <div className="flex-1 min-w-0">
                                                                  <p className="text-sm font-medium text-gray-900 truncate">{item.name || product?.name || 'Product'}</p>
                                                                  <p className="text-xs text-gray-500">Qty: {item.quantity || 1}</p>
                                                              </div>
                                                              <div className="text-sm font-semibold text-gray-900">
                                                                  â‚º{((item.price || product?.price || 0) * (item.quantity || 1)).toLocaleString('tr-TR')}
                                                              </div>
                                                          </div>
                                                      );
                                                  })}
                                              </div>
                                              {order.total && (
                                                  <div className="mt-3 pt-3 border-t border-gray-200 flex justify-between items-center">
                                                      <span className="text-sm font-semibold text-gray-900">Total:</span>
                                                      <span className="text-base font-bold text-primary">â‚º{order.total.toLocaleString('tr-TR')}</span>
                                                  </div>
                                              )}
                                          </div>
                                      ))}
                                  </div>
                              ) : (
                                  <div className="rounded-[28px] border border-dashed border-[#E5E7EB] bg-white p-10 text-center">
                                      <h4 className="text-base font-semibold text-gray-900 mb-2">No orders yet</h4>
                                      <p className="text-sm text-gray-500 mb-4">Your order history will appear here.</p>
                                      <button
                                          onClick={() => setCurrentView('shop')}
                                          className="rounded-full bg-[#2E6A58] px-5 py-2 text-sm font-semibold text-white hover:bg-[#255748]"
                                      >
                                          Browse Shop
                                      </button>
                                  </div>
                              )}
                          </section>
                          )}

                          {/* Saved Products Tab */}
                          {profileTab === 'savedProducts' && (
                          <section className="space-y-3">
                              <div className="flex items-center justify-between">
                                  <h3 className="text-base font-semibold text-gray-900">Saved Products</h3>
                              </div>
                              {(() => {
                                  const savedProducts = (savedContent || []).filter(item => item.type === 'product');
                                  return savedProducts.length > 0 ? (
                                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                          {savedProducts.map(item => {
                                              const product = shopItems.find(p => p.id === item.id || p.id === item.productId);
                                              if (!product) return null;
                                              return (
                                                  <div key={item.id || product.id} className="rounded-[28px] border border-white shadow-[0_24px_60px_-40px_rgba(32,60,50,0.45)] bg-white p-4">
                                                      <div className="flex items-start gap-3">
                                                          <div className="w-16 h-16 rounded-xl bg-gray-100 overflow-hidden flex items-center justify-center flex-shrink-0">
                                                              {product.image ? (
                                                                  <img src={product.image} alt={product.name} className="w-full h-full object-cover" />
                                                              ) : (
                                                                  <span className="text-3xl">{product.icon || 'ðŸ“¦'}</span>
                                                              )}
                                                          </div>
                                                          <div className="flex-1 min-w-0">
                                                              <h4 className="text-sm font-semibold text-gray-900 line-clamp-2 mb-1">{product.name}</h4>
                                                              <p className="text-xs text-gray-500 mb-2">{product.brand}</p>
                                                              <div className="flex items-center justify-between">
                                                                  <span className="text-sm font-bold text-primary">â‚º{product.price?.toLocaleString('tr-TR')}</span>
                                                                  <button
                                                                      onClick={() => {
                                                                          const updated = savedContent.filter(p => p.id !== item.id && p.id !== product.id);
                                                                          setSavedContent(updated);
                                                                          StorageManager.save('savedContent', updated);
                                                                      }}
                                                                      className="text-xs text-red-600 hover:text-red-700 font-medium"
                                                                  >
                                                                      Remove
                                                                  </button>
                                                              </div>
                                                          </div>
                                                      </div>
                                                  </div>
                                              );
                                          })}
                                      </div>
                                  ) : (
                                      <div className="rounded-[28px] border border-dashed border-[#E5E7EB] bg-white p-10 text-center">
                                          <h4 className="text-base font-semibold text-gray-900 mb-2">No saved products</h4>
                                          <p className="text-sm text-gray-500 mb-4">Products you save will appear here.</p>
                                          <button
                                              onClick={() => setCurrentView('shop')}
                                              className="rounded-full bg-[#2E6A58] px-5 py-2 text-sm font-semibold text-white hover:bg-[#255748]"
                                          >
                                              Browse Shop
                                          </button>
                                      </div>
                                  );
                              })()}
                          </section>
                          )}

                          {/* My Groups - Always visible */}
                          {profileTab === 'posts' && (
                          <section className="space-y-3">
                              <div className="flex items-center justify-between">
                                  <h3 className="text-base font-semibold text-gray-900">My Groups</h3>
                                  {myGroups.length > 3 && (
                                      <button
                                          type="button"
                                          onClick={() => setShowAllGroupsModal(true)}
                                          className="text-xs font-semibold text-[#2E6A58] hover:text-[#1F4C3E]"
                                      >
                                          View all
                                      </button>
                              )}
                          </div>
                              {myGroups.length > 0 ? (
                                  <div className="space-y-3">
                                      {myGroups.slice(0, 3).map(group => (
                                          <div key={group.id} className="rounded-[28px] overflow-hidden border border-white shadow-[0_24px_60px_-40px_rgba(32,60,50,0.45)] bg-white">
                                              <div className="p-5 space-y-3">
                                      <div className="flex items-center gap-3">
                                                      <div className={`h-10 w-10 rounded-xl ${group.color} flex items-center justify-center`}>
                                                          <span className="text-white text-sm font-semibold">{group.name[0]}</span>
                                          </div>
                                                      <div className="min-w-0">
                                                          <p className="text-sm font-semibold text-gray-900 truncate">{group.name}</p>
                                                          <p className="text-xs text-gray-500 line-clamp-1">{group.description}</p>
                                          </div>
                                      </div>
                                                  <div className="flex items-center justify-between text-xs text-gray-500">
                                                      <div className="flex items-center gap-2">
                                                          <span>{(StorageManager.load('groupMembers', {})[group.id]?.length || 0).toLocaleString()} members</span>
                                                          <span className="h-1 w-1 rounded-full bg-gray-300"></span>
                                                          <span className="capitalize">{group.category}</span>
                                  </div>
                                                      <button
                                                          onClick={() => handleNavigateToGroup(group)}
                                                          className="rounded-full border border-[#DCE9E3] px-3 py-1 text-xs font-semibold text-[#2E6A58] hover:bg-[#F4FAF7]"
                                                      >
                                                          View
                                                      </button>
                              </div>
                                          </div>
                                      </div>
                                      ))}
                                                              </div>
                              ) : (
                                  <div className="rounded-[28px] border border-dashed border-[#E5E7EB] bg-white p-10 text-center">
                                      <h4 className="text-base font-semibold text-gray-900 mb-2">HenÃ¼z gruba katÄ±lmadÄ±n</h4>
                                      <p className="text-sm text-gray-500 mb-4">Destek bulmak iÃ§in topluluklarda yerini al.</p>
                                                              <button
                                          onClick={() => setCurrentView('community')}
                                          className="rounded-full bg-[#2E6A58] px-5 py-2 text-sm font-semibold text-white hover:bg-[#255748]"
                                                              >
                                          Browse groups
                                                              </button>
                                                          </div>
                              )}
                          </section>
                          )}
                                      </div>

                  </div>

                  <div className="h-12"></div>


                  {/* Edit Profile Modal */}
                  <EditProfileModal
                      isOpen={showEditModal}
                      onClose={() => setShowEditModal(false)}
                      avatarInputRef={avatarInputRef}
                  />

                  {/* View All Groups Modal */}
                  {showAllGroupsModal && (
                      <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onMouseDown={(e) => { if (e.target === e.currentTarget) setShowAllGroupsModal(false); }}>
                          <div className="bg-white rounded-3xl w-full max-w-md mx-4 max-h-[85vh] overflow-hidden slide-up flex flex-col">
                              <div className="flex items-center justify-between p-4 border-b border-gray-200 flex-shrink-0">
                                  <h2 className="text-lg font-bold">My Groups</h2>
                                  <button onClick={() => setShowAllGroupsModal(false)} className="text-gray-500">âœ•</button>
                                  </div>
                              <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                  {myGroups.length > 0 ? (
                                      myGroups.map(group => (
                                          <div key={group.id} className="rounded-[28px] overflow-hidden border border-white shadow-[0_24px_60px_-40px_rgba(32,60,50,0.45)] bg-white">
                                              <div className="p-5 space-y-3">
                                                  <div className="flex items-center gap-3">
                                                      <div className={`h-10 w-10 rounded-xl ${group.color} flex items-center justify-center`}>
                                                          <span className="text-white text-sm font-semibold">{group.name[0]}</span>
                                      </div>
                                                      <div className="min-w-0 flex-1">
                                                          <p className="text-sm font-semibold text-gray-900 truncate">{group.name}</p>
                                                          <p className="text-xs text-gray-500 line-clamp-1">{group.description}</p>
                                  </div>
                              </div>
                                                  <div className="flex items-center justify-between text-xs text-gray-500">
                                                      <div className="flex items-center gap-2">
                                                          <span>{(StorageManager.load('groupMembers', {})[group.id]?.length || 0).toLocaleString()} members</span>
                                                          <span className="h-1 w-1 rounded-full bg-gray-300"></span>
                                                          <span className="capitalize">{group.category}</span>
                                              </div>
                                                      <button
                                                          onClick={() => {
                                                              handleNavigateToGroup(group);
                                                              setShowAllGroupsModal(false);
                                                          }}
                                                          className="rounded-full border border-[#DCE9E3] px-3 py-1 text-xs font-semibold text-[#2E6A58] hover:bg-[#F4FAF7]"
                                                      >
                                                          View
                                                      </button>
                                  </div>
                                          </div>
                                          </div>
                                      ))
                                  ) : (
                                      <div className="rounded-[28px] border border-dashed border-[#E5E7EB] bg-white p-10 text-center">
                                          <h4 className="text-base font-semibold text-gray-900 mb-2">HenÃ¼z gruba katÄ±lmadÄ±n</h4>
                                          <p className="text-sm text-gray-500 mb-4">Destek bulmak iÃ§in topluluklarda yerini al.</p>
                                  <button
                                              onClick={() => {
                                                  setShowAllGroupsModal(false);
                                                  setCurrentView('community');
                                              }}
                                              className="rounded-full bg-[#2E6A58] px-5 py-2 text-sm font-semibold text-white hover:bg-[#255748]"
                                          >
                                              Browse groups
                                  </button>
                                      </div>
                                  )}
                              </div>
                          </div>
                      </div>
                  )}

              </div>
          );
      };

      // Orbit Footer View Component
      const OrbitFooterView = () => {
          const loadEchoHistory = () => {
              const stored = StorageManager.load('orbitEchoHistory', []);
              return Array.isArray(stored) ? stored : [];
          };
          const [prompt, setPrompt] = useState('');
          const [conversation, setConversation] = useState(loadEchoHistory);
          const [isLoading, setIsLoading] = useState(false);
          const [error, setError] = useState('');
          const [showCommunityPrompt, setShowCommunityPrompt] = useState(false);
          const inputRef = useRef(null);
          const prevLengthRef = useRef(conversation.length);

          useEffect(() => {
              StorageManager.save('orbitEchoHistory', conversation);
          }, [conversation]);

          useEffect(() => {
              prevLengthRef.current = conversation.length;
          }, [conversation]);

          const computedRows = useMemo(() => {
              const lineBreaks = prompt.split('\n').length;
              const approx = Math.ceil(prompt.length / 80);
              return Math.min(6, Math.max(3, lineBreaks + approx));
          }, [prompt]);

          const createMessage = (role, content) => ({
              id: `${role}-${Date.now()}-${Math.random().toString(16).slice(2, 8)}`,
              role,
              content,
              createdAt: new Date().toISOString()
          });

          const mockEchoAnswer = (question) => {
              const templates = [
                  `Echo'nun notu: ${question} sorusuna dair sana Ã¼Ã§ adÄ±mdan oluÅŸan bir yol Ã¶nermek isterim.

1. Ä°lk olarak, mevcut rutinin nasÄ±l ilerlediÄŸini kÄ±sa kÄ±sa not al. Bu, gerÃ§ek durumu netleÅŸtirir.
2. ArdÄ±ndan, bebeÄŸinin sinyallerini takip ederek kÃ¼Ã§Ã¼k ayarlamalar yap. Her bebek farklÄ± bir ritme sahiptir.
3. Son olarak, kendine karÅŸÄ± nazik ol. SÃ¼reÃ§te tÃ¶kezlemek normal ve Ã¶ÄŸrenmenin bir parÃ§asÄ±.

HazÄ±rsan bu adÄ±mlarÄ± detaylandÄ±rabiliriz.`,
                  `Echo dÃ¼ÅŸÃ¼nÃ¼yor... ${question} iÃ§in seni destekleyecek uygulamasÄ± kolay birkaÃ§ pratik derledim:

â€¢ GÃ¼n iÃ§indeki akÄ±ÅŸÄ±nÄ± Ã¼Ã§ ana blokta planla. BÃ¶ylece hangi anda neye odaklanacaÄŸÄ±nÄ± bilirsin.
â€¢ Mini nefes egzersizlerini rutine ekle. 4-7-8 tekniÄŸi bile zihnini toparlamaya yardÄ±mcÄ± olur.
â€¢ DuygularÄ±nÄ± gÃ¼vendiÄŸin biriyle paylaÅŸ. PaylaÅŸtÄ±kÃ§a yÃ¼k hafifler.

Bir sonraki adÄ±mda hangisini derinleÅŸtirmek istersin?`,
                  `${question} sorunu duydum ve kÃ¼Ã§Ã¼k bir yol haritasÄ± hazÄ±rladÄ±m:

âœ¨ Hedefi netleÅŸtir: Tam olarak neyin deÄŸiÅŸmesini istiyorsun?
ðŸª„ Mikro adÄ±mlara bÃ¶l: BugÃ¼n atabileceÄŸin en kÃ¼Ã§Ã¼k adÄ±m ne?
ðŸ¤ Destek halkanÄ± kullan: Echo her zaman burada, ayrÄ±ca toplulukta deneyim paylaÅŸabilirsin.

Ä°stersen bu planÄ± birlikte rafine edelim.`
              ];
              const score = question.length % templates.length;
              return templates[score];
          };

          const askEcho = async (question) => {
              const trimmed = question.trim();
              if (!trimmed) return;
              setError('');
              setShowCommunityPrompt(false);
              setPrompt('');

              const userMessage = createMessage('user', trimmed);
              setConversation(prev => [...prev, userMessage]);

              setIsLoading(true);
              try {
                  let answer = null;
                  if (window.OrbitApi?.ai?.askEcho) {
                      const result = await window.OrbitApi.ai.askEcho(trimmed);
                      answer = result?.answer || result?.response || result?.data || '';
                  }
                  if (!answer) {
                      await new Promise(resolve => setTimeout(resolve, 900));
                      answer = mockEchoAnswer(trimmed);
                  }
                  const echoMessage = createMessage('assistant', answer);
                  setConversation(prev => [...prev, echoMessage]);
                  setShowCommunityPrompt(true);
              } catch (err) {
                  console.error('Ask Echo failed', err);
                  setError('Echo ÅŸu anda yanÄ±t veremedi. LÃ¼tfen biraz sonra yeniden dene.');
              } finally {
                  setIsLoading(false);
                  setTimeout(() => {
                      inputRef.current?.focus();
                  }, 120);
              }
          };

          const handleSubmit = (e) => {
              e?.preventDefault();
              askEcho(prompt);
          };

          const handleCommunitySupport = () => {
              setShowCommunityPrompt(false);
              const searchingMessage = createMessage('system', 'Benzer deneyime sahip anneleri buluyorum...');
              setConversation(prev => [...prev, searchingMessage]);
              setTimeout(() => {
                  const resultMessage = createMessage(
                      'system',
                      'Sana benzer deneyimleri paylaÅŸabilecek Ã¼Ã§ anne buldum:\n\nâ€¢ AyÅŸe â€” 3 aylÄ±k bebeÄŸiyle kolik sÃ¼recini yÃ¶netiyor.\nâ€¢ Selin â€” uyku eÄŸitimi geÃ§iÅŸinde baÅŸarÄ±lÄ± oldu.\nâ€¢ Derya â€” sÃ¼t artÄ±rma konusunda gÃ¼nlÃ¼k ipuÃ§larÄ± paylaÅŸÄ±yor.\n\nDilersen sohbet baÅŸlatabilir veya Orbit topluluÄŸunda bir etkinlik aÃ§abilirsin.'
                  );
                  setConversation(prev => [...prev, resultMessage]);
              }, 1400);
          };

          const handleCommunityDismiss = () => {
              setShowCommunityPrompt(false);
          };

          const handleClearChat = () => {
              if (!conversation.length) return;
              const confirmed = window.confirm('Sohbeti temizlemek istediÄŸine emin misin?');
              if (!confirmed) return;
              setConversation([]);
              setShowCommunityPrompt(false);
              StorageManager.remove?.('orbitEchoHistory');
              ToastManager?.show?.('Sohbet temizlendi.', 'info');
          };

          const handleNewChat = () => {
              const intro = createMessage('system', 'Yeni bir sohbet baÅŸlattÄ±k. Echo her zaman yanÄ±nda.');
              setConversation([intro]);
              setShowCommunityPrompt(false);
              ToastManager?.show?.('Yeni sohbet aÃ§Ä±ldÄ±.', 'success');
          };

          const renderMessage = (message, idx) => {
              const role = message.role;
              const isAssistant = role === 'assistant';
              const isUser = role === 'user';
              const isSystem = role === 'system';
              const bubbleBase = 'min-h-[120px] flex flex-col justify-between';
              const bubbleClasses = isAssistant
                  ? `${bubbleBase} bg-white border border-gray-100 shadow-sm rounded-3xl rounded-tl-md`
                  : isSystem
                      ? `${bubbleBase} bg-secondary/12 border border-secondary/25 text-secondary shadow-sm rounded-3xl`
                      : `${bubbleBase} bg-gradient-to-r from-primary to-secondary text-white shadow-[0_20px_35px_-28px_rgba(91,174,155,0.9)] rounded-3xl rounded-tr-md`;
              return (
                  <div key={message.id || idx} className="flex flex-col space-y-2">
                      <div className={`flex ${isAssistant || isSystem ? 'justify-start' : 'justify-end'}`}>
                          <div className={`max-w-[82%] px-5 py-4 text-sm leading-relaxed whitespace-pre-wrap ${bubbleClasses}`}>
                              {isAssistant ? (
                                  <div className="flex flex-col h-full">
                                      <div className="flex items-center gap-3 mb-4">
                                          <div className="w-9 h-9 rounded-2xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-white text-lg">âœ¨</div>
                                          <div>
                                              <p className="text-xs font-semibold text-secondary uppercase tracking-[0.4em]">Echo</p>
                                              <p className="text-[11px] text-gray-400">{formatRelativeTime(message.createdAt || Date.now())}</p>
                                          </div>
                                      </div>
                                      <div className="flex-1">
                                          <p className="text-gray-700 text-sm leading-relaxed whitespace-pre-wrap">{message.content}</p>
                                      </div>
                                  </div>
                              ) : isUser ? (
                                  <div className="flex flex-col h-full text-white">
                                      <div className="text-[11px] uppercase tracking-[0.4em] text-white/70 mb-2">Sen</div>
                                      <div className="flex-1">
                                          <p>{message.content}</p>
                                      </div>
                                      <p className="text-[11px] text-white/70 mt-3">{formatRelativeTime(message.createdAt || Date.now())}</p>
                                  </div>
                              ) : (
                                  <div className="flex flex-col h-full">
                                      <div className="text-[11px] uppercase tracking-[0.3em] text-secondary/60 mb-2">Orbit</div>
                                      <div className="flex-1">
                                          <p className="text-sm text-secondary/90 leading-relaxed whitespace-pre-wrap">{message.content}</p>
                                      </div>
                                      <p className="text-[11px] text-secondary/50 mt-3">{formatRelativeTime(message.createdAt || Date.now())}</p>
                                  </div>
                              )}
                          </div>
                      </div>
                  </div>
              );
          };

          return (
              <div className="min-h-[calc(100vh-9rem)] bg-surface pb-28">
                  <div className="px-4 pt-10 pb-24">
                      <div className="max-w-md mx-auto overflow-hidden rounded-[28px] border border-white/80 bg-white/90 backdrop-blur-xl shadow-[0_30px_60px_-35px_rgba(91,174,155,0.85)]">
                          <header className="relative px-6 pt-7 pb-6 border-b border-white/60">
                              <div className="absolute inset-x-0 -top-28 h-44 bg-gradient-to-br from-primary/30 via-secondary/20 to-accent/30 blur-3xl opacity-90 pointer-events-none"></div>
                              <div className="relative flex items-start justify-between gap-4">
                                  <div>
                                      <div className="inline-flex items-center gap-2 rounded-full bg-secondary/15 px-3 py-1 text-[11px] font-semibold text-secondary">
                                          <span className="inline-flex h-2 w-2 animate-pulse rounded-full bg-emerald-400"></span>
                                          Echo Ã§evrimiÃ§i
                                      </div>
                                      <h2 className="mt-4 text-[30px] font-semibold leading-tight text-gray-900">Ask Echo</h2>
                                      <p className="mt-2 text-sm leading-relaxed text-gray-600">
                                          Sorunu yaz, Echo GPT-5o desteÄŸiyle dinler ve paylaÅŸmaya hazÄ±r yanÄ±tlar Ã¼retir.
                                      </p>
                                  </div>
                                  <div className="hidden sm:flex h-12 w-12 items-center justify-center rounded-2xl bg-gradient-to-br from-primary to-secondary text-white shadow-md">
                                      <svg className="w-6 h-6" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                                          <ellipse cx="24" cy="24" rx="18" ry="10" stroke="white" strokeWidth="2" strokeOpacity="0.4" fill="none" transform="rotate(-15 24 24)"/>
                                          <path d="M 24 6 Q 38 24 24 42 Q 10 24 24 6" stroke="white" strokeWidth="2.5" strokeOpacity="0.6" fill="none" strokeLinecap="round"/>
                                          <circle cx="24" cy="24" r="9" fill="white" fillOpacity="0.95"/>
                                          <circle cx="24" cy="24" r="6" fill="white" fillOpacity="0.7"/>
                                          <circle cx="24" cy="24" r="3.5" fill="white"/>
                                      </svg>
                                  </div>
                              </div>
                              <div className="relative mt-5 rounded-2xl border border-secondary/20 bg-secondary/10 px-4 py-3 text-xs text-secondary/80">
                                  <span className="font-semibold text-secondary">Ä°pucu:</span> Echo yanÄ±tÄ±nÄ± beÄŸendiÄŸinde notlarÄ±na ekleyebilir veya favori sohbetlerine alabilirsin.
                              </div>
                              <div className="relative mt-4 flex flex-wrap items-center justify-end gap-2">
                                  <button
                                      onClick={handleNewChat}
                                      className="inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-primary to-secondary px-4 py-2 text-xs font-semibold text-white shadow hover:shadow-md transition-all"
                                  >
                                      <svg className="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none">
                                          <path d="M12 5v14m7-7H5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                      </svg>
                                      Yeni sohbet
                                  </button>
                                  <button
                                      onClick={handleClearChat}
                                      className="inline-flex items-center gap-2 rounded-full border border-secondary/20 px-4 py-2 text-xs font-semibold text-secondary/80 hover:bg-secondary/10 transition-all"
                                  >
                                      <svg className="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none">
                                          <path d="M4 7h16M9 7V5h6v2m-7 4v6m4-6v6m-6 3h10a2 2 0 0 0 2-2V7H5v11a2 2 0 0 0 2 2Z" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" />
                                      </svg>
                                      Sohbeti temizle
                                  </button>
                              </div>
                          </header>

                          <div className="space-y-5 px-6 py-6 bg-white">
                              {conversation.length === 0 && !isLoading ? (
                                  <div className="flex flex-col items-center justify-center gap-4 py-16 text-center text-gray-500">
                                      <div className="flex h-16 w-16 items-center justify-center rounded-2xl bg-gradient-to-br from-primary/20 to-secondary/20 text-2xl text-secondary">
                                          âœ¨
                                      </div>
                                      <p className="max-w-sm text-sm leading-relaxed">
                                          Ä°lk sorunuzu yazÄ±n. Echo dÃ¼ÅŸÃ¼ncelerini, Ã¶nerilerini ve paylaÅŸabileceÄŸiniz notlarÄ± sizin iÃ§in hazÄ±rlayacak.
                                      </p>
                                  </div>
                              ) : (
                                  conversation.map((message, idx) => renderMessage(message, idx))
                              )}

                              {isLoading && (
                                  <div className="flex justify-start">
                                      <div className="flex items-center space-x-3 rounded-3xl rounded-tl-md border border-secondary/20 bg-white px-5 py-3 text-sm text-gray-500 shadow-sm">
                                          <div className="flex space-x-1">
                                              <span className="h-2 w-2 animate-bounce rounded-full bg-secondary/60" style={{ animationDelay: '0s' }}></span>
                                              <span className="h-2 w-2 animate-bounce rounded-full bg-secondary/40" style={{ animationDelay: '0.15s' }}></span>
                                              <span className="h-2 w-2 animate-bounce rounded-full bg-secondary/30" style={{ animationDelay: '0.3s' }}></span>
                                          </div>
                                          <span>Echo dÃ¼ÅŸÃ¼nÃ¼yor...</span>
                                      </div>
                                  </div>
                              )}
                          </div>

                          {error && (
                              <div className="px-6 pt-2 text-sm text-rose-500">{error}</div>
                          )}

                          {showCommunityPrompt && (
                              <div className="px-6 pb-4">
                                  <div className="rounded-2xl border border-secondary/20 bg-secondary/10 px-5 py-4">
                                      <p className="mb-1 text-sm font-semibold text-secondary">GerÃ§ek deneyim yaÅŸayan annelerden yardÄ±m ister misin?</p>
                                      <p className="mb-4 text-xs text-gray-600">
                                          Echo, benzer deneyimler yaÅŸayan anneleri tespit edip seni onlarla buluÅŸturabilir.
                                      </p>
                                      <div className="flex flex-wrap gap-2">
                                          <button
                                              onClick={handleCommunitySupport}
                                              className="inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-primary to-secondary px-4 py-2 text-xs font-semibold text-white shadow hover:shadow-md transition-all"
                                          >
                                              Evet, baÄŸlantÄ± kur
                                          </button>
                                          <button
                                              onClick={handleCommunityDismiss}
                                              className="inline-flex items-center gap-2 rounded-full border border-secondary/20 px-4 py-2 text-xs font-semibold text-secondary/80 hover:bg-secondary/10 transition-all"
                                          >
                                              HayÄ±r, teÅŸekkÃ¼rler
                                          </button>
                                      </div>
                                  </div>
                              </div>
                          )}

                          <form onSubmit={handleSubmit} className="border-t border-white/70 bg-white px-6 pb-6 pt-4">
                              <label htmlFor="echoPrompt" className="sr-only">Echo sorusu</label>
                              <div className="relative rounded-2xl border border-secondary/15 bg-secondary/5 focus-within:border-secondary/40 focus-within:ring-2 focus-within:ring-secondary/15 transition-all">
                                  <textarea
                                      id="echoPrompt"
                                      ref={inputRef}
                                      value={prompt}
                                      onChange={(e) => setPrompt(e.target.value)}
                                      placeholder="Echo'ya ne sormak istersin?"
                                      rows={computedRows}
                                      className="w-full resize-none bg-transparent px-5 py-4 text-sm leading-relaxed text-gray-700 focus:outline-none"
                                  />
                                  <div className="absolute bottom-3 right-3">
                                      <button
                                          type="submit"
                                          disabled={isLoading || !prompt.trim()}
                                          className={`inline-flex h-11 w-11 items-center justify-center rounded-full transition-all ${
                                              isLoading || !prompt.trim()
                                                  ? 'cursor-not-allowed bg-secondary/15 text-secondary/40'
                                                  : 'bg-gradient-to-r from-primary to-secondary text-white shadow-lg hover:shadow-xl hover:scale-[1.03]'
                                          }`}
                                      >
                                          <svg className="h-[18px] w-[18px]" viewBox="0 0 24 24" fill="none">
                                              <path d="M4 12l16-7-7 16-2.5-6.5L4 12z" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round" />
                                          </svg>
                                      </button>
                                  </div>
                              </div>
                          </form>
                      </div>
                  </div>
              </div>
          );
      };
      // BottomNavigation Component
      const BottomNavigation = ({ currentView, onViewChange }) => {
                      const getIcon = (id, isActive) => {
                          const iconStyle = {
                              width: '24px',
                              height: '24px',
                              transition: 'all 0.3s ease'
                          };

                          switch (id) {
                              case 'tips':
                                  return (
                                      <svg style={iconStyle} viewBox="0 0 24 24" fill="none">
                                          <path d="M4 19.5V6a2 2 0 0 1 2-2h9a1 1 0 0 1 1 1v14.5" stroke={isActive ? '#FFFFFF' : '#A1A1AA'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                          <path d="M4 19.5a2 2 0 0 1 2-2h9" stroke={isActive ? '#FFFFFF' : '#A1A1AA'} strokeWidth="2" strokeLinecap="round" />
                                          <path d="M9 8h4m-4 4h3" stroke={isActive ? '#FFFFFF' : '#A1A1AA'} strokeWidth="2" strokeLinecap="round" />
                                          <path d="M18 7v11.5a1 1 0 0 1-1 1h-9" stroke={isActive ? '#FFFFFF' : '#A1A1AA'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                      </svg>
                                  );
                              case 'community':
                                  // Chat bubble
                                  return (
                                      <svg style={iconStyle} viewBox="0 0 24 24" fill="none">
                                          <path d="M21 12c0 3.866-3.806 7-8.5 7-1.08 0-2.1-.18-3.03-.5L5 19l.88-3.03C5.22 15.04 5 14.04 5 13c0-3.866 3.806-7 8.5-7S21 9.134 21 13z" stroke={isActive ? '#FFFFFF' : '#A1A1AA'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                          <circle cx="10" cy="13" r="1" fill={isActive ? '#FFFFFF' : '#A1A1AA'} />
                                          <circle cx="13.5" cy="13" r="1" fill={isActive ? '#FFFFFF' : '#A1A1AA'} />
                                          <circle cx="17" cy="13" r="1" fill={isActive ? '#FFFFFF' : '#A1A1AA'} />
                                      </svg>
                                  );
                              case 'orbit':
                                  return (
                                      <svg style={iconStyle} viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                                          <ellipse cx="24" cy="24" rx="18" ry="10" stroke={isActive ? '#FFFFFF' : '#A1A1AA'} strokeWidth="2" strokeOpacity={isActive ? '0.4' : '0.4'} fill="none" transform="rotate(-15 24 24)"/>
                                          <path d="M 24 6 Q 38 24 24 42 Q 10 24 24 6" stroke={isActive ? '#FFFFFF' : '#A1A1AA'} strokeWidth="2.5" strokeOpacity={isActive ? '0.6' : '0.5'} fill="none" strokeLinecap="round"/>
                                          <circle cx="24" cy="24" r="9" fill={isActive ? '#FFFFFF' : '#A1A1AA'} fillOpacity={isActive ? '0.95' : '0.8'} />
                                          <circle cx="24" cy="24" r="6" fill={isActive ? '#FFFFFF' : '#A1A1AA'} fillOpacity={isActive ? '0.7' : '0.6'} />
                                          <circle cx="24" cy="24" r="3.5" fill={isActive ? '#FFFFFF' : '#A1A1AA'} />
                                      </svg>
                                  );
                              case 'shop':
                                  // Shopping bag icon (clean, JSX-safe)
                                  return (
                                      <svg style={iconStyle} viewBox="0 0 24 24" fill="none">
                                          <path d="M6 9h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2z" stroke={isActive ? '#FFFFFF' : '#A1A1AA'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                          <path d="M9 9V7a3 3 0 0 1 6 0v2" stroke={isActive ? '#FFFFFF' : '#A1A1AA'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                                      </svg>
                                  );
                              case 'profile':
                                  // Village (people)
                                  return (
                                      <svg style={iconStyle} viewBox="0 0 24 24" fill="none">
                                          <circle cx="8" cy="8" r="3.5" stroke={isActive ? '#FFFFFF' : '#9CA3AF'} strokeWidth="2" />
                                          <circle cx="17" cy="6.5" r="2.5" stroke={isActive ? '#FFFFFF' : '#9CA3AF'} strokeWidth="2" />
                                          <path d="M2 21v-2.5A4.5 4.5 0 0 1 6.5 14h3A4.5 4.5 0 0 1 14 18.5V21" stroke={isActive ? '#FFFFFF' : '#9CA3AF'} strokeWidth="2" strokeLinecap="round" />
                                          <path d="M14 12a5 5 0 0 1 5 5v4" stroke={isActive ? '#FFFFFF' : '#9CA3AF'} strokeWidth="2" strokeLinecap="round" />
                                      </svg>
                                  );
                              default:
                                  return null;
                          }
                      };

                      const navItems = [
                          { id: 'tips', label: 'Tips' },
                          { id: 'community', label: 'Community' },
                          { id: 'orbit', label: 'Orbit', accent: true },
                          { id: 'shop', label: 'Shop' },
                          { id: 'profile', label: 'Profile' }
                      ];

                      const handleNavClick = (viewId) => {
                          // Exit group detail if open, then switch view without delay
                          if (currentGroupView) setCurrentGroupView(null);
                          onViewChange(viewId);
                      };

                      const handleKeyDown = (e, idx) => {
                          // Prevent key events from bubbling out of the nav buttons
                          e.stopPropagation();
                          const order = navItems.map(n => n.id);
                          const cur = order.indexOf(currentView);
                          if (e.key === 'ArrowRight') {
                              const next = order[(cur + 1) % order.length];
                              handleNavClick(next);
                          } else if (e.key === 'ArrowLeft') {
                              const prev = order[(cur - 1 + order.length) % order.length];
                              handleNavClick(prev);
                          } else if (e.key === 'Enter') {
                              // Activate focused tab on Enter only (avoid Space to prevent accidental nav while scrolling)
                              handleNavClick(navItems[idx].id);
                          }
                      };

                      return (
                          <nav
                              role="tablist"
                              className="fixed bottom-0 left-1/2 transform -translate-x-1/2 w-full max-w-md px-3 z-40"
                              style={{
                                  background: 'linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.85) 15%, rgba(255,255,255,0.98) 50%, #FFFFFF 100%)',
                                  backdropFilter: 'blur(25px)',
                                  WebkitBackdropFilter: 'blur(25px)',
                                  borderTop: '1px solid #E6E3EE',
                                  paddingTop: '8px',
                                  paddingBottom: 'calc(env(safe-area-inset-bottom) + 12px)'
                              }}
                          >
                              <div className="flex justify-around items-end">
                                  {navItems.map(item => {
                                      const isActive = currentView === item.id;
                                      const isOrbit = item.id === 'orbit';
                                      // Darker mint for active tab background
                                      const bgActive = '#91B5B0';
                                      const iconWrapperClasses = [
                                          'relative flex items-center justify-center mb-1 transition-all duration-300 ease-out w-11 h-11 rounded-2xl',
                                          isActive ? 'shadow-md' : 'group-hover:scale-105',
                                          isOrbit
                                              ? (isActive
                                                  ? 'bg-gradient-to-r from-primary to-secondary ring-2 ring-secondary/40 shadow-[0_16px_32px_-14px_rgba(91,174,155,0.6)]'
                                                  : 'bg-gradient-to-r from-primary/20 to-secondary/20 ring-1 ring-secondary/30 shadow-[0_12px_28px_-18px_rgba(91,174,155,0.45)]')
                                              : ''
                                      ].filter(Boolean).join(' ');
                                      const iconWrapperStyle = isOrbit
                                          ? undefined
                                          : {
                                              background: isActive ? bgActive : 'rgba(145, 181, 176, 0.12)'
                                          };
                                      const activeOverlayStyle = isOrbit
                                          ? {
                                              background: 'linear-gradient(135deg, rgba(255,255,255,0.72) 0%, rgba(255,255,255,0.25) 100%)'
                                          }
                                          : {
                                              background: 'linear-gradient(135deg, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0) 100%)'
                                          };
                                      const labelClass = isOrbit
                                          ? (isActive
                                              ? 'bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent drop-shadow-[0_4px_12px_rgba(91,174,155,0.35)] font-semibold'
                                              : 'text-secondary font-semibold')
                                          : (isActive ? 'text-gray-600' : 'text-gray-400');
                                      return (
                                          <button
                                              key={item.id}
                                              role="tab"
                                              aria-selected={isActive}
                                              aria-current={isActive ? 'page' : undefined}
                                              onKeyDown={(e)=>handleKeyDown(e, navItems.findIndex(n=>n.id===item.id))}
                                              onClick={() => handleNavClick(item.id)}
                                              className="flex flex-col items-center transition-all duration-300 ease-out group focus:outline-none focus-visible:ring-2 focus-visible:ring-primary rounded-2xl"
                                              style={{ transform: isActive ? 'translateY(-3px)' : (isOrbit ? 'translateY(-1px)' : 'translateY(0)') }}
                                          >
                                              <div
                                                  className={iconWrapperClasses}
                                                  style={iconWrapperStyle}
                                              >
                                                  {isActive && (
                                                      <div
                                                          className="absolute inset-0 rounded-2xl opacity-20"
                                                          style={activeOverlayStyle}
                                                      />
                                                  )}
                                                  {getIcon(item.id, isActive)}
                                              </div>
                                              <span
                                                  className={`text-xs font-medium transition-all duration-300 ${labelClass} ${isOrbit ? 'tracking-wide' : ''}`}
                                              >
                                                  {item.label}
                                              </span>
                                          </button>
                                      );
                                  })}
                              </div>
                          </nav>
                      );
                  };

                  const TipsInsightsView = ({ tips = [], savedTips = [], onToggleSaveTip, onSelectGroup, onExploreGroups }) => {
                      const [activeTip, setActiveTip] = useState(null);
                      const [activeTipImage, setActiveTipImage] = useState(null);
                      const [showSavedOnly, setShowSavedOnly] = useState(false);
                      const [viewMode, setViewMode] = useState('grid'); // grid | category | detail
                      const [categoryContext, setCategoryContext] = useState(null);
                      const [previousView, setPreviousView] = useState('grid');

                      const savedTipIds = useMemo(() => new Set((savedTips || []).map(t => t.id)), [savedTips]);
                      const allTips = useMemo(() => Array.isArray(tips) ? tips : [], [tips]);
                      const visibleTips = useMemo(() => {
                          if (showSavedOnly) {
                              return allTips.filter(tip => savedTipIds.has(tip.id));
                          }
                          return allTips;
                      }, [allTips, showSavedOnly, savedTipIds]);

                      const totalTipCount = allTips.length;
                      const savedCount = savedTipIds.size;
                      const hasTips = visibleTips.length > 0;

                      const fallbackImages = [
                          'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=1200&q=80',
                          'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=80',
                          'https://images.unsplash.com/photo-1545239351-1141bd82e8a6?auto=format&fit=crop&w=1200&q=80',
                          'https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&w=1200&q=80',
                          'https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?auto=format&fit=crop&w=1200&q=80',
                          'https://images.unsplash.com/photo-1522844990619-4951c40f7eda?auto=format&fit=crop&w=1200&q=80',
                          'https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&w=1200&q=80',
                          'https://images.unsplash.com/photo-1520342868574-5fa3804e551c?auto=format&fit=crop&w=1200&q=80',
                          'https://images.unsplash.com/photo-1520262494112-9fe481d36ec3?auto=format&fit=crop&w=1200&q=80',
                          'https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=1200&q=80'
                      ];
                      const fallbackDates = ['OCT 24', 'OCT 22 - DEC 10', 'OCT 20', 'SEP 30', 'AUG 14', 'JUL 02', 'JUN 18', 'MAY 05', 'APR 22', 'MAR 11'];
                      const accentPalette = [
                          'linear-gradient(135deg, rgba(255, 225, 214, 0.9) 0%, rgba(255, 239, 232, 0.9) 100%)',
                          'linear-gradient(135deg, rgba(216, 237, 255, 0.9) 0%, rgba(236, 247, 255, 0.9) 100%)',
                          'linear-gradient(135deg, rgba(230, 230, 255, 0.9) 0%, rgba(245, 241, 255, 0.9) 100%)',
                          'linear-gradient(135deg, rgba(224, 245, 235, 0.9) 0%, rgba(239, 252, 244, 0.9) 100%)',
                          'linear-gradient(135deg, rgba(255, 239, 212, 0.9) 0%, rgba(255, 246, 232, 0.9) 100%)',
                          'linear-gradient(135deg, rgba(252, 226, 230, 0.9) 0%, rgba(255, 244, 247, 0.9) 100%)',
                          'linear-gradient(135deg, rgba(222, 242, 255, 0.9) 0%, rgba(240, 249, 255, 0.9) 100%)',
                          'linear-gradient(135deg, rgba(255, 234, 224, 0.9) 0%, rgba(255, 244, 236, 0.9) 100%)',
                          'linear-gradient(135deg, rgba(234, 240, 255, 0.9) 0%, rgba(244, 247, 255, 0.9) 100%)',
                          'linear-gradient(135deg, rgba(240, 255, 239, 0.9) 0%, rgba(250, 255, 246, 0.9) 100%)'
                      ];

                      const enrichedTips = useMemo(() => {
                          return visibleTips.map((tip, idx) => ({
                              source: tip,
                              cardId: `${tip?.id || 'tip'}-${idx}`,
                              image: tip?.image || fallbackImages[idx % fallbackImages.length],
                              dateLabel: tip?.dateLabel || fallbackDates[idx % fallbackDates.length],
                              caption: tip?.focus || tip?.category || 'Uzman Ã¶nerisi',
                              accent: accentPalette[idx % accentPalette.length]
                          }));
                      }, [visibleTips]);

                      const repeatedTips = useMemo(() => {
                          if (!enrichedTips.length) return [];
                          const desiredLength = Math.max(10, enrichedTips.length);
                          const extended = [];
                          for (let i = 0; i < desiredLength; i += 1) {
                              const base = enrichedTips[i % enrichedTips.length];
                              extended.push({
                                  ...base,
                                  cardId: `${base.cardId}-dup-${i}`
                              });
                          }
                          return extended;
                      }, [enrichedTips]);

                      const highlightPrimary = enrichedTips[0] || null;
                      const highlightSecondary = enrichedTips[1] || highlightPrimary;
                      const highlightTertiary = enrichedTips[2] || highlightSecondary;

                      const carouselSections = useMemo(() => {
                          if (!repeatedTips.length) return [];
                          const segments = [
                              { id: 'relationship-dynamics', title: 'Anne-Bebek RitÃ¼elleri', subtitle: 'BaÄŸÄ±nÄ±zÄ± gÃ¼Ã§lendirmek iÃ§in gÃ¼nlÃ¼k rutinler', start: 0 },
                              { id: 'retrogrades', title: 'DeÄŸiÅŸim DÃ¶nemleri', subtitle: 'Bebek geliÅŸimindeki Ã¶nemli eÅŸikleri keÅŸfet', start: 2 },
                              { id: 'major-events', title: 'YaklaÅŸan DÃ¶nÃ¼m NoktalarÄ±', subtitle: 'Aileniz iÃ§in hazÄ±rlÄ±k rehberi', start: 4 },
                              { id: 'most-recent', title: 'En Yeni Ã–neriler', subtitle: 'Taze iÃ§erikleri hÄ±zlÄ±ca yakala', start: 6 }
                          ];
                          return segments
                              .map(({ id, title, subtitle, start }) => ({
                                  id,
                                  title,
                                  subtitle,
                                  items: repeatedTips.slice(start, start + 4)
                              }))
                              .filter(section => section.items.length > 0);
                      }, [repeatedTips]);

                      const handleNavigate = (tip) => {
                          if (tip?.group?.id && onSelectGroup) {
                              onSelectGroup(tip.group.id, tip.group.name);
                          } else if (onExploreGroups) {
                              onExploreGroups();
                          }
                      };

                      const handleOpenTip = (tip, origin = 'grid', image = null) => {
                          if (!tip) return;
                          setPreviousView(origin);
                          setActiveTip(tip);
                          setActiveTipImage(image || tip?.image || null);
                          setViewMode('detail');
                          window.scrollTo({ top: 0, behavior: 'smooth' });
                      };

                      const handleOpenSection = (section) => {
                          if (!section) return;
                          const uniqueItems = Array.from(new Map((section.items || []).map(item => {
                              const key = item?.source?.id || item.cardId;
                              return [key, item];
                          })).values());
                          setCategoryContext({
                              title: section.title,
                              subtitle: section.subtitle,
                              items: uniqueItems
                          });
                          setViewMode('category');
                          window.scrollTo({ top: 0, behavior: 'smooth' });
                      };

                      const renderCard = (item, origin = 'grid') => {
                          if (!item?.source) return null;
                          const isSaved = savedTipIds.has(item.source.id);
                          return (
                              <div
                                  key={item.cardId}
                                  role="button"
                                  tabIndex={0}
                                  onClick={() => handleOpenTip(item.source, origin, item.image)}
                                      onKeyDown={(e) => {
                                          if (e.key === 'Enter' || e.key === ' ') {
                                              e.preventDefault();
                                              handleOpenTip(item.source, origin, item.image);
                                          }
                                      }}
                                  className="relative min-w-[200px] max-w-[230px] shrink-0 transition-transform focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[#0F6455] hover:-translate-y-1"
                              >
                                  <div className="absolute -inset-[1.5px] rounded-[34px]" style={{ background: item.accent }} aria-hidden="true"></div>
                                  <div className="relative flex h-full flex-col overflow-hidden rounded-[32px] border border-white/70 bg-white/90 shadow-sm backdrop-blur">
                                      <div className="relative h-36 overflow-hidden">
                                          <div
                                              className="absolute inset-0"
                                              style={{
                                                  backgroundImage: `url('${item.image}')`,
                                                  backgroundSize: 'cover',
                                                  backgroundPosition: 'center'
                                              }}
                                          />
                                          <div className="absolute inset-0 bg-gradient-to-b from-black/10 via-black/0 to-black/30"></div>
                                          <div className="absolute left-4 top-4 flex items-center gap-2">
                                              {item.source?.category && (
                                                  <span className="rounded-full bg-black/40 px-2 py-1 text-[10px] font-semibold uppercase tracking-[0.18em] text-white">
                                                      {item.source.category}
                                                  </span>
                                              )}
                                          </div>
                                          <div className="absolute right-3 top-3">
                                              <button
                                                  type="button"
                                                  onClick={(e) => {
                                                      e.stopPropagation();
                                                      e.preventDefault();
                                                      onToggleSaveTip && onToggleSaveTip({ ...item.source, image: item.image });
                                                  }}
                                                  aria-label={isSaved ? 'KayÄ±ttan Ã§Ä±kar' : 'Kaydet'}
                                                  className={`h-9 w-9 rounded-full border backdrop-blur flex items-center justify-center transition-colors ${
                                                      isSaved
                                                          ? 'bg-[#0F6455] text-white border-[#0F6455]'
                                                          : 'bg-white/90 text-gray-600 border-white/70 hover:bg-white'
                                                  }`}
                                              >
                                                  <svg width="16" height="16" viewBox="0 0 24 24" fill={isSaved ? 'currentColor' : 'none'} stroke="currentColor" strokeWidth="2">
                                                      <path d="M6 4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v17l-6-3-6 3z" />
                                                  </svg>
                                              </button>
                                          </div>
                                      </div>
                                      <div className="flex flex-1 flex-col gap-3 px-5 pb-4 pt-4">
                                          <div className="text-[11px] font-semibold uppercase tracking-[0.18em] text-gray-500">
                                              {item.dateLabel}
                                          </div>
                                          <h4 className="text-base font-semibold leading-snug text-gray-900 line-clamp-2">
                                              {item.source?.headline || 'Yeniliklere gÃ¶z at'}
                                          </h4>
                                          <p className="text-xs leading-relaxed text-gray-600 line-clamp-3">
                                              {item.caption}
                                          </p>
                                      </div>
                                      <div className="flex items-center justify-between border-t border-gray-100 px-5 pb-4 pt-3">
                                          <div className="flex items-center gap-2 text-xs text-gray-500 line-clamp-1">
                                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                  <path d="M21 21l-6-6" />
                                                  <circle cx="10" cy="10" r="6" />
                                              </svg>
                                              <span className="line-clamp-1">{item.source?.group?.name || 'Orbit topluluÄŸu'}</span>
                                          </div>
                                          <span className="inline-flex items-center gap-1 text-xs font-semibold text-[#0F6455]">
                                              Oku
                                              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                  <path d="M9 6l6 6-6 6" strokeLinecap="round" strokeLinejoin="round" />
                                              </svg>
                                          </span>
                                      </div>
                                  </div>
                              </div>
                          );
                      };

                      const renderSection = (section) => {
                          if (!section || !section.items || section.items.length === 0) return null;
                          return (
                              <section key={section.id} className="space-y-4">
                                  <div className="flex flex-wrap items-baseline justify-between gap-3">
                                      <div>
                                          <h3 className="text-2xl font-semibold text-gray-900">{section.title}</h3>
                                          {section.subtitle && (
                                              <p className="mt-1 text-sm text-gray-500">{section.subtitle}</p>
                                          )}
                                      </div>
                                      <button
                                          type="button"
                                          onClick={() => handleOpenSection(section)}
                                          className="inline-flex items-center gap-1 rounded-full border border-[#E7E0D0] bg-white/90 px-4 py-2 text-xs font-semibold text-[#0F6455] shadow-sm transition-colors hover:bg-white"
                                      >
                                          TÃ¼mÃ¼nÃ¼ gÃ¶r
                                          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                              <path d="M9 6l6 6-6 6" strokeLinecap="round" strokeLinejoin="round" />
                                          </svg>
                                      </button>
                                  </div>
                                  <div className="flex gap-4 overflow-x-auto pb-2 -mx-1 px-1">
                                      {section.items.map(item => renderCard(item, 'grid'))}
                                  </div>
                              </section>
                          );
                      };

                      const renderEmptyState = () => (
                          <div className="mt-16 rounded-[32px] border border-[#E7E0D0] bg-white/90 p-10 text-center shadow-sm">
                              <div className="mb-2 text-lg font-semibold text-gray-800">
                                  {showSavedOnly ? 'HenÃ¼z kaydettiÄŸin Ã¶neri yok' : 'HenÃ¼z Ã¶neri eklenmedi'}
                              </div>
                              <p className="mx-auto max-w-md text-sm text-gray-500">
                                  {showSavedOnly
                                      ? 'Favorilerine eklediÄŸin iÃ§erikler burada gÃ¶rÃ¼necek. TÃ¼m Ã¶nerileri gÃ¶rmek iÃ§in filtreyi kaldÄ±rabilirsin.'
                                      : 'Yeni iÃ§erikler geldiÄŸinde burada yer alacak. Bu sÄ±rada topluluklarda keÅŸfe devam edebilirsin.'}
                              </p>
                              <div className="mt-6 flex justify-center gap-3">
                                  {showSavedOnly && (
                                      <button
                                          type="button"
                                          onClick={() => setShowSavedOnly(false)}
                                          className="rounded-full bg-gray-900 px-4 py-2 text-sm font-semibold text-white hover:bg-gray-800"
                                      >
                                          TÃ¼m Ã¶nerileri gÃ¶ster
                                      </button>
                                  )}
                                  <button
                                      type="button"
                                      onClick={() => onExploreGroups && onExploreGroups()}
                                      className="rounded-full border border-gray-200 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50"
                                  >
                                      GruplarÄ± keÅŸfet
                                  </button>
                              </div>
                          </div>
                      );

                      if (viewMode === 'detail' && activeTip) {
                          const detailImage = activeTip.image || activeTipImage || fallbackImages[0];
                          const paragraphs = (activeTip.longInsight || activeTip.insight || '').split(/\n+/).filter(Boolean);
                          return (
                              <div className="min-h-screen bg-[#F5F7F9]">
                                  <div className="mx-auto w-full max-w-3xl px-6 pb-24 pt-8 space-y-8">
                                      <button
                                          type="button"
                                          onClick={() => {
                                              setActiveTip(null);
                                              setActiveTipImage(null);
                                              setViewMode(previousView === 'category' ? 'category' : 'grid');
                                          }}
                                          className="inline-flex items-center gap-2 rounded-full border border-[#E7E0D0] bg-white px-4 py-2 text-sm font-semibold text-gray-600 shadow-sm hover:text-gray-800"
                                      >
                                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                              <path d="M15 18l-6-6 6-6" strokeLinecap="round" strokeLinejoin="round" />
                                          </svg>
                                          Geri dÃ¶n
                                      </button>
                                      <article className="space-y-8">
                                          <header className="space-y-4">
                                              <div className="text-xs font-semibold uppercase tracking-[0.28em] text-gray-500">
                                                  {activeTip.category}
                                              </div>
                                              <h1 className="text-4xl font-semibold leading-tight text-gray-900">
                                                  {activeTip.headline}
                                              </h1>
                                              {activeTip.focus && (
                                                  <p className="text-sm font-medium text-gray-500">{activeTip.focus}</p>
                                              )}
                                              {activeTip.expert && (
                                                  <div className="text-sm font-semibold text-gray-600">{activeTip.expert}</div>
                                              )}
                                          </header>
                                          <div
                                              className="relative overflow-hidden rounded-[36px]"
                                              style={{ backgroundImage: `linear-gradient(135deg, rgba(10,20,20,0.25) 0%, rgba(10,20,20,0.45) 100%), url('${detailImage}')`, backgroundSize: 'cover', backgroundPosition: 'center' }}
                                          >
                                              <div className="absolute inset-0"></div>
                                              <div className="relative flex min-h-[320px] flex-col justify-end gap-4 p-10 text-white">
                                                  <div className="text-sm font-semibold uppercase tracking-[0.24em] text-white/80">
                                                      {activeTip.group?.name || 'Orbit topluluÄŸu'}
                                                  </div>
                                                  <p className="max-w-2xl text-sm text-white/80 leading-relaxed">
                                                      {activeTip.insight}
                                                  </p>
                                              </div>
                                          </div>
                                          <div className="space-y-6 rounded-[32px] border border-[#E7E0D0] bg-white/90 p-8 shadow-sm">
                                              {paragraphs.map((paragraph, idx) => (
                                                  <p key={idx} className="text-base leading-relaxed text-gray-700">
                                                      {paragraph}
                                                  </p>
                                              ))}
                                              {Array.isArray(activeTip.actions) && activeTip.actions.length > 0 && (
                                                  <div className="space-y-3 border-t border-[#E7E0D0] pt-4">
                                                      <div className="text-xs font-semibold uppercase tracking-[0.18em] text-gray-500">Uygulanabilir adÄ±mlar</div>
                                                      <ul className="space-y-2 text-sm text-gray-700">
                                                          {activeTip.actions.map((action, idx) => (
                                                              <li key={idx} className="flex items-start gap-2">
                                                                  <span className="mt-1 h-2 w-2 rounded-full bg-[#0F6455]"></span>
                                                                  <span>{action}</span>
                                                              </li>
                                                          ))}
                                                      </ul>
                                                  </div>
                                              )}
                                          </div>
                                          <div className="flex flex-wrap items-center gap-3">
                                              <button
                                                  type="button"
                                                  onClick={() => onToggleSaveTip && onToggleSaveTip({ ...activeTip, image: activeTip.image || activeTipImage })}
                                                  className={`inline-flex items-center gap-2 rounded-full border px-4 py-2 text-sm font-semibold transition-colors ${
                                                      savedTipIds.has(activeTip.id)
                                                          ? 'border-[#0F6455] bg-[#0F6455] text-white'
                                                          : 'border-[#E7E0D0] bg-white text-gray-700 hover:bg-gray-50'
                                                  }`}
                                              >
                                                  <svg width="16" height="16" viewBox="0 0 24 24" fill={savedTipIds.has(activeTip.id) ? 'currentColor' : 'none'} stroke="currentColor" strokeWidth="2">
                                                      <path d="M6 4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v17l-6-3-6 3z" />
                                                  </svg>
                                                  {savedTipIds.has(activeTip.id) ? 'Kaydedildi' : 'Kaydet'}
                                              </button>
                                              <button
                                                  type="button"
                                                  onClick={() => handleNavigate(activeTip)}
                                                  className="inline-flex items-center gap-2 rounded-full border border-transparent bg-[#0F6455] px-4 py-2 text-sm font-semibold text-white transition-colors hover:bg-[#0C5246]"
                                              >
                                                  {activeTip.group?.id ? 'Gruba git' : 'TopluluklarÄ± keÅŸfet'}
                                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                      <path d="M9 6l6 6-6 6" strokeLinecap="round" strokeLinejoin="round" />
                                                  </svg>
                                              </button>
                                          </div>
                                      </article>
                                  </div>
                              </div>
                          );
                      }

                      if (viewMode === 'category' && categoryContext) {
                          const items = categoryContext.items || [];
                          return (
                              <div className="min-h-screen bg-[#F5F7F9]">
                                  <div className="mx-auto w-full max-w-4xl px-6 pb-24 pt-10 space-y-8">
                                      <button
                                          type="button"
                                          onClick={() => {
                                              setCategoryContext(null);
                                              setViewMode('grid');
                                          }}
                                          className="inline-flex items-center gap-2 rounded-full border border-[#E7E0D0] bg-white px-4 py-2 text-sm font-semibold text-gray-600 shadow-sm hover:text-gray-800"
                                      >
                                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                              <path d="M15 18l-6-6 6-6" strokeLinecap="round" strokeLinejoin="round" />
                                          </svg>
                                          TÃ¼m Ã¶nerilere dÃ¶n
                                      </button>
                                      <header className="space-y-3">
                                          <h1 className="text-3xl font-semibold text-gray-900">{categoryContext.title}</h1>
                                          {categoryContext.subtitle && (
                                              <p className="text-sm text-gray-500">{categoryContext.subtitle}</p>
                                          )}
                                          <p className="text-xs font-medium uppercase tracking-[0.24em] text-gray-500">{items.length} iÃ§erik</p>
                                      </header>
                                      <div className="space-y-6">
                                          {items.map(item => {
                                              const tip = item.source;
                                              const isSaved = tip && savedTipIds.has(tip.id);
                                              const image = item.image || fallbackImages[0];
                                              return (
                                                  <button
                                                      key={item.cardId}
                                                      type="button"
                                                      onClick={() => handleOpenTip(tip, 'category', image)}
                                                      className="group relative block w-full overflow-hidden rounded-[36px] text-left shadow-md transition-transform hover:-translate-y-1 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[#0F6455]"
                                                      style={{ backgroundImage: `linear-gradient(135deg, rgba(10,20,20,0.3) 0%, rgba(10,20,20,0.6) 100%), url('${image}')`, backgroundSize: 'cover', backgroundPosition: 'center' }}
                                                  >
                                                      <div className="absolute right-5 top-5">
                                                          <button
                                                              type="button"
                                                          onClick={(e) => { e.stopPropagation(); tip && onToggleSaveTip && onToggleSaveTip({ ...tip, image }); }}
                                                              className={`h-10 w-10 rounded-full border border-white/40 backdrop-blur flex items-center justify-center transition-colors ${
                                                                  isSaved ? 'bg-[#0F6455] text-white border-[#0F6455]' : 'bg-white/80 text-gray-700 hover:bg-white'
                                                              }`}
                                                          >
                                                              <svg width="18" height="18" viewBox="0 0 24 24" fill={isSaved ? 'currentColor' : 'none'} stroke="currentColor" strokeWidth="2">
                                                                  <path d="M6 4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v17l-6-3-6 3z" />
                                                              </svg>
                                                          </button>
                                                      </div>
                                                      <div className="relative flex min-h-[240px] flex-col justify-end gap-3 p-8 text-white md:min-h-[280px]">
                                                          <div className="text-sm font-semibold uppercase tracking-[0.24em] text-white/80">
                                                              {tip?.focus || tip?.category || 'Uzman Ã¶nerisi'}
                                                          </div>
                                                          <h3 className="text-3xl font-semibold leading-tight">
                                                              {tip?.headline || 'Yeni Ã¶neri'}
                                                          </h3>
                                                          <p className="max-w-2xl text-sm text-white/80 leading-relaxed">
                                                              {tip?.insight || 'DetaylarÄ± gÃ¶rmek iÃ§in aÃ§.'}
                                                          </p>
                                                      </div>
                                                  </button>
                                              );
                                          })}
                                      </div>
                                  </div>
                              </div>
                          );
                      }

                      return (
                          <div className="min-h-[calc(100vh-8rem)] bg-[#F5F7F9]">
                              <div className="relative mx-auto max-w-4xl px-6 pt-12 pb-24">
                                  <header className="space-y-6">
                                      <div className="flex flex-wrap items-start justify-between gap-4">
                                          <div className="space-y-2">
                                              <div className="text-[11px] font-semibold uppercase tracking-[0.24em] text-gray-500">
                                                  Orbit Tips
                                              </div>
                                              <h1 className="text-4xl font-semibold tracking-tight text-gray-900">
                                                  Anne & Bebek
                                              </h1>
                                              <p className="max-w-xl text-sm text-gray-500 leading-relaxed">
                                                  GÃ¼nlÃ¼k rutininize uyum saÄŸlayacak mini ritÃ¼eller, emzirme tÃ¼yolarÄ± ve ebeveynlikte iyi hissettiren kÃ¼Ã§Ã¼k dokunuÅŸlar.
                                              </p>
                                          </div>
                                          <button
                                              type="button"
                                              onClick={() => setShowSavedOnly(prev => !prev)}
                                              className={`inline-flex items-center gap-2 rounded-full border px-4 py-2 text-xs font-semibold transition-colors ${
                                                  showSavedOnly
                                                      ? 'border-gray-900 bg-gray-900 text-white'
                                                      : 'border-[#E7E0D0] bg-white/80 text-gray-700 hover:bg-white'
                                              }`}
                                          >
                                              <svg width="14" height="14" viewBox="0 0 24 24" fill={showSavedOnly ? 'currentColor' : 'none'} stroke="currentColor" strokeWidth="2">
                                                  <path d="M6 4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v17l-6-3-6 3z" />
                                              </svg>
                                              {showSavedOnly ? 'TÃ¼m iÃ§erik' : `Kaydedilenler Â· ${savedCount}`}
                                          </button>
                                      </div>
                                      <div className="flex flex-wrap items-center gap-3 text-xs text-gray-500">
                                          <span className="inline-flex items-center gap-2 rounded-full bg-white px-3 py-1 font-semibold text-gray-700 shadow-sm">
                                              <span className="text-sm text-[#0F6455]">{totalTipCount}</span> Ã¶neri
                                          </span>
                                          <span className="inline-flex items-center gap-2 rounded-full bg-white px-3 py-1 font-semibold text-gray-700 shadow-sm">
                                              <span className="text-sm text-[#0F6455]">{savedCount}</span> kaydedildi
                                          </span>
                                          <button
                                              type="button"
                                              onClick={() => onExploreGroups && onExploreGroups()}
                                              className="inline-flex items-center gap-1 rounded-full border border-transparent bg-white px-3 py-1 font-semibold text-gray-600 shadow-sm hover:text-gray-800"
                                          >
                                              Topluluklarda keÅŸfet
                                              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                  <path d="M9 6l6 6-6 6" strokeLinecap="round" strokeLinejoin="round" />
                                              </svg>
                                          </button>
                                      </div>
                                  </header>

                                  {!hasTips ? (
                                      renderEmptyState()
                                  ) : (
                                      <div className="mt-12 space-y-12">
                                          <section className="space-y-3">
                                              <div className="flex items-center justify-between gap-3">
                                                  <div>
                                                      <h2 className="text-xl font-semibold text-gray-900">Ã–ne Ã‡Ä±kanlar</h2>
                                                      <p className="text-sm text-gray-500">DiÄŸer ebeveynlerin favorileri</p>
                                                  </div>
                                              </div>
                                              <button
                                                  type="button"
                                                  onClick={() => handleOpenTip(highlightPrimary?.source, 'grid', highlightPrimary?.image)}
                                                  className="group w-full text-left focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[#0F6455]"
                                              >
                                                  <div
                                                      className="rounded-[36px] p-8 text-white shadow-2xl transition-transform duration-200 group-hover:-translate-y-1 md:p-12"
                                                      style={{ background: 'linear-gradient(135deg, #0F6455 0%, #0B3A36 100%)' }}
                                                  >
                                                      <div className="text-sm font-semibold uppercase tracking-[0.24em] text-white/70">
                                                          {highlightPrimary?.source?.focus || 'GÃ¼venli baÄŸ'}
                                                      </div>
                                                      <h3 className="mt-4 text-3xl font-semibold leading-tight md:text-4xl">
                                                          {highlightPrimary?.source?.headline || 'Birlikte gÃ¼Ã§lÃ¼ bir baÄŸ kurun'}
                                                      </h3>
                                                      <p className="mt-4 max-w-2xl text-sm text-white/80 leading-relaxed md:text-base">
                                                          {highlightPrimary?.source?.insight || 'Her gÃ¼n birkaÃ§ dakikayÄ± sadece bebeÄŸinle gÃ¶z temasÄ± ve nefes eÅŸleÅŸmesi iÃ§in ayÄ±rmayÄ± dene.'}
                                                      </p>
                                                  </div>
                                              </button>
                                          </section>

                                          {renderSection(carouselSections[0])}

                                          {highlightSecondary?.source && (
                                              <section className="space-y-3">
                                                  <div>
                                                      <h2 className="text-xl font-semibold text-gray-900">BaÄŸ Kurma Dilleri</h2>
                                                      <p className="text-sm text-gray-500">Anne-bebek baÄŸÄ±nÄ± anlamaya yardÄ±mcÄ± bakÄ±ÅŸlar</p>
                                                  </div>
                                                  <button
                                                      type="button"
                                                      onClick={() => handleOpenTip(highlightSecondary.source, 'grid', highlightSecondary?.image)}
                                                      className="group w-full text-left focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[#0F6455]"
                                                  >
                                                      <div
                                                          className="rounded-[36px] p-8 text-white shadow-xl transition-transform duration-200 group-hover:-translate-y-1 md:p-12"
                                                          style={{ background: 'linear-gradient(135deg, #6B8FA6 0%, #4F6C81 100%)' }}
                                                      >
                                                          <div className="text-sm font-semibold uppercase tracking-[0.24em] text-white/70">
                                                              {highlightSecondary.source.focus || 'VenÃ¼s ritÃ¼elleri'}
                                                          </div>
                                                          <h3 className="mt-4 text-3xl font-semibold leading-tight md:text-4xl">
                                                              {highlightSecondary.source.headline || 'Sevgi dilinizi keÅŸfedin'}
                                                          </h3>
                                                          <p className="mt-4 max-w-2xl text-sm text-white/80 leading-relaxed md:text-base">
                                                              {highlightSecondary.source.insight || 'Ä°liÅŸkinizde kÃ¼Ã§Ã¼k ama sÃ¼rekli temas anlarÄ± yaratmak, baÄŸ kurmayÄ± gÃ¼Ã§lendirir.'}
                                                          </p>
                                                      </div>
                                                  </button>
                                              </section>
                                          )}

                                          {renderSection(carouselSections[1])}

                                          {highlightTertiary?.source && (
                                              <section className="space-y-3">
                                                  <div>
                                                      <h2 className="text-xl font-semibold text-gray-900">YaklaÅŸan DÃ¶nÃ¼m NoktalarÄ±</h2>
                                                      <p className="text-sm text-gray-500">Aileniz iÃ§in hazÄ±rlÄ±k rehberi</p>
                                                  </div>
                                                  <button
                                                      type="button"
                                                  onClick={() => handleOpenTip(highlightTertiary.source, 'grid', highlightTertiary?.image)}
                                                      className="group w-full text-left focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[#0F6455]"
                                                  >
                                                      <div
                                                          className="rounded-[36px] p-8 text-gray-900 shadow-xl transition-transform duration-200 group-hover:-translate-y-1 md:p-12"
                                                          style={{ background: 'linear-gradient(135deg, #F9E7CD 0%, #F5D5C9 50%, #F8EEE0 100%)' }}
                                                      >
                                                          <div className="text-sm font-semibold uppercase tracking-[0.24em] text-gray-700/80">
                                                              {highlightTertiary.source.focus || 'HazÄ±rlÄ±k planÄ±'}
                                                          </div>
                                                          <h3 className="mt-4 text-3xl font-semibold leading-tight md:text-4xl">
                                                              {highlightTertiary.source.headline || 'Bir sonraki adÄ±ma hazÄ±r mÄ±sÄ±n?'}
                                                          </h3>
                                                          <p className="mt-4 max-w-2xl text-sm text-gray-700 leading-relaxed md:text-base">
                                                              {highlightTertiary.source.insight || 'Yeni dÃ¶neme hazÄ±rlanmak iÃ§in destek kaynaklarÄ±nÄ± ve gÃ¼nlÃ¼k mini hedefleri planla.'}
                                                          </p>
                                                      </div>
                                                  </button>
                                              </section>
                                          )}

                                          {carouselSections.slice(2).map(renderSection)}
                                      </div>
                                  )}
                              </div>
                          </div>
                      );
                  };

                  const GroupDetailView = ({ group, isAdmin = false, onBack, me, users, groupPosts, setGroupPosts, onJoinGroup, isJoined, openNewPostInitially, onOpenPostHandled }) => {
                      const [isInviteOpen, setIsInviteOpen] = useState(false);
                      const [isEventOpen, setIsEventOpen] = useState(false);
                      const [editingEvent, setEditingEvent] = useState(null);
                      const [isNewPostOpen, setIsNewPostOpen] = useState(false);
                      const postsForGroup = groupPosts[group.id] || [];
                      const [events, setEvents] = useState(() => (StorageManager.load('groupEvents', {})[group.id] || []));
                      const [subTab, setSubTab] = useState('posts'); // posts | about | events | members
                      const [postFilter, setPostFilter] = useState('all'); // all | posts | polls | media
                      const [members, setMembers] = useState(() => (StorageManager.load('groupMembers', {})[group.id] || []));
                      const [isEditGroupOpen, setIsEditGroupOpen] = useState(false);
                      const [previewCoverGradient, setPreviewCoverGradient] = useState(null);
                      const [currentCoverGradient, setCurrentCoverGradient] = useState(group.coverGradient || 'from-primary/30 via-secondary/30 to-mint/30');
                      useEffect(() => { setCurrentCoverGradient(group.coverGradient || 'from-primary/30 via-secondary/30 to-mint/30'); }, [group.coverGradient, group.id]);
                      useEffect(() => {
                          if (openNewPostInitially) {
                              setIsNewPostOpen(true);
                              onOpenPostHandled && onOpenPostHandled();
                          }
                      }, [openNewPostInitially]);
                      useEffect(() => {
                          const all = StorageManager.load('groupEvents', {});
                          all[group.id] = events;
                          StorageManager.save('groupEvents', all);
                      }, [events, group.id]);
                      useEffect(() => {
                          const all = StorageManager.load('groupMembers', {});
                          all[group.id] = members;
                          StorageManager.save('groupMembers', all);
                      }, [members, group.id]);
                      useEffect(() => {
                          const key = me.username;
                          setMembers(prev => {
                              const has = Array.isArray(prev) && prev.includes(key);
                              if (isJoined && !has) return [...prev, key];
                              if (!isJoined && has) return prev.filter(u => u !== key);
                              return prev;
                          });
                      }, [isJoined, me.username]);

                      const addGroupPost = (post) => {
                          setGroupPosts(prev => {
                              const copy = { ...(prev || {}) };
                              const arr = copy[group.id] ? [...copy[group.id]] : [];
                              arr.unshift(post);
                              copy[group.id] = arr;
                              StorageManager.save('groupPosts', copy);
                              return copy;
                          });
                      };

                      return (
                          <div className="bg-background min-h-screen">
                              {/* Peanut-style hero with overlay title */}
                              <div className="relative">
                                  <div className="relative h-56">
                                      <div className={`absolute inset-0 bg-gradient-to-br ${previewCoverGradient || currentCoverGradient || 'from-primary/30 via-secondary/30 to-mint/30'}`} />
                                      <div className="absolute inset-0 bg-gradient-to-b from-black/50 via-black/20 to-transparent"></div>
                                      <div className="absolute top-0 inset-x-0 pt-2">
                                          <div className="flex items-center justify-between px-3 py-2">
                                              <button onClick={onBack} className="p-2 rounded-full bg-black/30 hover:bg-black/40">
                                                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#FFFFFF" strokeWidth="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                                              </button>
                                              <h1 className="text-white font-semibold text-base truncate max-w-[65%] text-center">{group.name}</h1>
                                              {(isAdmin) ? (
                                                   <div className="flex items-center space-x-2">
                                                       <button onClick={() => setIsEditGroupOpen(true)} className="px-2 py-1 rounded-lg bg-white/80 text-gray-800 text-xs hover:bg-white" title="Edit group">
                                                           Edit group
                                                       </button>
                                                   </div>
                                              ) : (
                                                  <div className="w-9"></div>
                                              )}
                                          </div>
                                      </div>
                                  </div>
                              </div>
                              {/* Group meta under hero */}
                              <div className="px-4 py-3 bg-white border-b border-gray-100">
                                  <div className="flex items-center justify-between">
                                      <div>
                                          <div className="text-xs font-semibold tracking-wide text-gray-500">{group.isPrivate ? 'PRIVATE GROUP' : 'PUBLIC GROUP'}</div>
                                          <div className="text-sm text-gray-600">{(StorageManager.load('groupMembers', {})[group.id]?.length || 0).toLocaleString()} members</div>
                                      </div>
                                      {isJoined ? (
                                          <button onClick={() => onJoinGroup && onJoinGroup(group.id, true)} className="px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all">
                                              Leave group
                                          </button>
                                      ) : (
                                          <button onClick={() => onJoinGroup && onJoinGroup(group.id)} className="px-3 py-1 rounded-full text-xs font-medium bg-primary text-white hover:bg-primary-dark transition-all">
                                              Join group
                                          </button>
                                      )}
                                  </div>
                              </div>
                              {/* Actions bar */}
                              <div className="sticky top-0 z-10 bg-white px-4 pt-3 pb-2">
                                  <div className="grid grid-cols-3 gap-2">
                                      {isJoined ? (
                                          <>
                                              <button onClick={()=>setIsNewPostOpen(true)} className="rounded-xl bg-white border border-gray-200 hover:shadow-sm flex items-center justify-center gap-2 py-2">
                                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6B7280" strokeWidth="2"><path d="M12 5v14M5 12h14"/></svg>
                                                  <span className="text-sm text-gray-700">New Post</span>
                                              </button>
                                              <button onClick={()=>setIsEventOpen(true)} className="rounded-xl bg-white border border-gray-200 hover:shadow-sm flex items-center justify-center gap-2 py-2">
                                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6B7280" strokeWidth="2"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                                                  <span className="text-sm text-gray-700">Event</span>
                                              </button>
                                              <button onClick={()=>setIsInviteOpen(true)} className="rounded-xl bg-white border border-gray-200 hover:shadow-sm flex items-center justify-center gap-2 py-2">
                                                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6B7280" strokeWidth="2"><path d="M22 12l-8-5v10l8-5z"/><circle cx="6" cy="12" r="3"/></svg>
                                                  <span className="text-sm text-gray-700">Invite</span>
                                              </button>
                                          </>
                                      ) : (
                                          <div className="col-span-3 flex items-center justify-center py-2">
                                              <span className="text-sm text-gray-500">Join the group to see posts</span>
                                          </div>
                                      )}
                                  </div>
                              </div>
                                  <div className="px-4">
                                  <div className="flex w-full border-b border-gray-200">
                                          {['posts','about','events','members'].map(t => (
                                          <button key={t} onClick={()=>setSubTab(t)} className={`flex-1 py-3 text-xs font-medium transition-all border-b-2 ${subTab===t ? 'text-gray-900 border-gray-900' : 'text-gray-600 border-transparent hover:border-gray-300'}`}>
                                                  {t.charAt(0).toUpperCase()+t.slice(1)}
                                              </button>
                                          ))}
                                      </div>
                                  </div>

                              {/* SubTab content */}
                              {subTab === 'posts' && (
                                  <div className="px-4 space-y-4 pb-24">
                                      {/* Hide filter chips to match Peanut */}
                                      {(() => {
                                          const base = postsForGroup;
                                          const filtered = postFilter==='all' ? base : postFilter==='posts' ? base.filter(p=>!p.poll) : base.filter(p=>p.poll);
                                          if (filtered.length===0) return (
                                      <div className="text-center py-16 bg-white rounded-2xl border border-gray-100">
                                          <div className="text-5xl mb-3">{group.image}</div>
                                          <p className="text-textSecondary text-sm mb-4">No items yet</p>
                                          {isJoined && (<button onClick={()=>setIsNewPostOpen(true)} className="px-5 py-2 rounded-full text-white" style={{background:'#91B5B0'}}>Create First Post</button>)}
                                      </div>
                                          );
                                          return filtered.map(p => (
                                              <PostCard
                                                  key={p.id}
                                                  post={p}
                                                  onLike={handleLike}
                                                  onCoinEarned={handleCoinEarned}
                                                  onComment={handleComment}
                                                  onAddComment={handleAddComment}
                                                  onSave={handleSave}
                                                  onShare={handleShare}
                                                  onDelete={requestDeletePost}
                                                  onUpdatePost={handleUpdatePost}
                                                  currentUser={me}
                                                  savedContent={savedContent}
                                                  onUserClick={handleUserClick}
                                                  blurred={Boolean(group.isPrivate && !isJoined)}
                                              />
                                          ));
                                      })()}
                                  </div>
                              )}
                              {subTab === 'about' && (
                                  <div className="px-4 space-y-4 pb-24">
                                      <div className="soft-card p-4">
                                          <h4 className="font-semibold text-gray-900 mb-2">About</h4>
                                          {Boolean(group?.about) && (
                                              <p className="text-gray-700 text-sm leading-relaxed">{group.about}</p>
                                          )}
                                      </div>
                                      <div className="soft-card p-4">
                                          <h4 className="font-semibold text-gray-900 mb-3">Rules</h4>
                                          {group?.rules && group.rules.trim().length > 0 ? (
                                              <ul className="text-sm text-gray-700 space-y-2">
                                                  {group.rules.split('\n').filter(r=>r.trim().length>0).map((r, idx)=> (
                                                      <li key={idx}>â€¢ {r.trim()}</li>
                                                  ))}
                                              </ul>
                                          ) : (
                                              <ul className="text-sm text-gray-700 space-y-2">
                                                  <li>â€¢ Be respectful and supportive</li>
                                                  <li>â€¢ No spam or self-promotion without permission</li>
                                                  <li>â€¢ Use content warnings for sensitive topics</li>
                                              </ul>
                                          )}
                                      </div>
                                  </div>
                              )}
                              {subTab === 'events' && (
                                  <div className="px-4 space-y-4 pb-24">
                                      <button
                                          onClick={() => setIsEventOpen(true)}
                                          className="w-full bg-white border border-gray-200 rounded-lg py-2 px-4 flex items-center justify-center text-primary hover:bg-gray-50 transition-colors mb-4"
                                      >
                                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="mr-2">
                                              <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
                                              <line x1="16" x2="16" y1="2" y2="6"/>
                                              <line x1="8" x2="8" y1="2" y2="6"/>
                                              <line x1="3" x2="21" y1="10" y2="10"/>
                                          </svg>
                                          <span className="font-medium text-sm">Create Event</span>
                                      </button>
                                      {(() => {
                                          const toTs = (ev) => {
                                              try { return new Date(`${ev.date}T${ev.time || '00:00'}`).getTime() || 0; } catch { return 0; }
                                          };
                                          const list = [...(events||[])].sort((a,b)=> toTs(a)-toTs(b));
                                          if (list.length === 0) return (
                                              <div className="text-center py-12 bg-white rounded-2xl border border-gray-100 text-sm text-textSecondary">No events yet</div>
                                          );
                                          return list.map((e)=> {
                                              const isOwner = e.ownerUsername && e.ownerUsername === me.username;
                                              const going = Array.isArray(e.attendeesGoing) ? e.attendeesGoing : [];
                                              const interested = Array.isArray(e.attendeesInterested) ? e.attendeesInterested : [];
                                              const iAmGoing = going.includes(me.username);
                                              const iAmInterested = interested.includes(me.username);
                                              const toggleRsvp = (kind) => {
                                                  setEvents(prev => prev.map(ev => {
                                                      if (ev.id !== e.id) return ev;
                                                      const next = { ...ev, attendeesGoing: [...(ev.attendeesGoing||[])], attendeesInterested: [...(ev.attendeesInterested||[])] };
                                                      if (kind === 'going') {
                                                          next.attendeesInterested = next.attendeesInterested.filter(u => u !== me.username);
                                                          if (next.attendeesGoing.includes(me.username)) next.attendeesGoing = next.attendeesGoing.filter(u => u !== me.username);
                                                          else next.attendeesGoing.push(me.username);
                                                      } else {
                                                          next.attendeesGoing = next.attendeesGoing.filter(u => u !== me.username);
                                                          if (next.attendeesInterested.includes(me.username)) next.attendeesInterested = next.attendeesInterested.filter(u => u !== me.username);
                                                          else next.attendeesInterested.push(me.username);
                                                      }
                                                      return next;
                                                  }));
                                              };
                                              return (
                                                  <div key={e.id} className="soft-card p-4">
                                                      <div className="flex items-start justify-between mb-3">
                                                          <div className="flex-1">
                                                              <h4 className="font-semibold text-gray-900 text-sm mb-1">{e.title}</h4>
                                                              <div className="flex items-center space-x-3 text-xs text-gray-500 mb-2">
                                                                  <span>ðŸ“… {formatEventDateTime(e.date, e.time)}</span>
                                                                  <span>ðŸ“ {e.location || 'TBA'}</span>
                                                                  </div>
                                                              {e.description && (
                                                                  <p className="text-xs text-gray-600 leading-relaxed">{e.description}</p>
                                                              )}
                                                          </div>
                                                          {isOwner && (
                                                              <div className="flex items-center space-x-1">
                                                                  <button onClick={()=>{ setEditingEvent(e); setIsEventOpen(true); }} className="p-1 text-gray-400 hover:text-gray-600">
                                                                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                                          <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                                                                          <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                                                      </svg>
                                                                  </button>
                                                                  <button onClick={()=>{ if (confirm('Delete this event?')) setEvents(prev => prev.filter(x => x.id !== e.id)); }} className="p-1 text-gray-400 hover:text-red-500">
                                                                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                                          <path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M10 11v6M14 11v6"/>
                                                                      </svg>
                                                                  </button>
                                                              </div>
                                                          )}
                                                      </div>
                                                      <div className="flex items-center space-x-2">
                                                          <button onClick={()=>toggleRsvp('going')} className={`px-3 py-1 rounded-full text-xs font-medium ${iAmGoing ? 'bg-primary text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                                                              Going ({going.length})
                                                          </button>
                                                          <button onClick={()=>toggleRsvp('interested')} className={`px-3 py-1 rounded-full text-xs font-medium ${iAmInterested ? 'bg-primary text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                                                              Interested ({interested.length})
                                                          </button>
                                                      </div>
                                                  </div>
                                              );
                                          });
                                      })()}
                                  </div>
                              )}
                              {subTab === 'members' && (
                                  <div className="px-4 space-y-4 pb-24">
                                      <div className="space-y-2">
                                          {(members||[]).map((u,idx)=> {
                                              const user = (users||[]).find(x=>x.username===u);
                                              const name = user?.name || (u===me.username ? me.name : u);
                                              const avatar = user?.avatar || (u===me.username ? me.avatarUrl : null);
                                              return (
                                                  <div key={idx} className="flex items-center justify-between p-3 rounded-xl bg-white border border-gray-100">
                                                      <div className="flex items-center space-x-3">
                                                          <div className="w-10 h-10 rounded-full overflow-hidden bg-primary text-white flex items-center justify-center">
                                                              {avatar ? <img src={avatar} alt={name} className="w-full h-full object-cover"/> : <span className="font-bold">{(name||'U')[0]}</span>}
                                                          </div>
                                                          <div className="text-sm">
                                                              <div className="font-semibold text-gray-900">{name}</div>
                                                              <div className="text-gray-500 text-xs">{u}</div>
                                                          </div>
                                                      </div>
                                                      {u===me.username && <span className="text-xs text-primary">You</span>}
                                                  </div>
                                              );
                                          })}
                                          {(members||[]).length===0 && (<div className="text-center text-sm text-textSecondary py-12">No members to show</div>)}
                                      </div>
                                  </div>
                              )}

                              {/* Edit Group Modal */}
                              {isEditGroupOpen && (
                                  <div className="fixed inset-0 bg-black/50 flex items-end justify-center z-50" onMouseDown={(e)=>{ if (e.target === e.currentTarget) { setIsEditGroupOpen(false); } }}>
                                      <div className="bg-white w-full max-w-md rounded-t-3xl overflow-hidden">
                                          <div className="flex items-center justify-between p-4 border-b border-gray-200">
                                              <h3 className="font-semibold">Edit Group</h3>
                                              <button onClick={()=>setIsEditGroupOpen(false)} className="text-gray-600">âœ•</button>
                                          </div>
                                          <EditGroupForm
                                              group={group}
                                              onCancel={()=>{ setIsEditGroupOpen(false); }}
                                              onPreviewCover={(g)=> setPreviewCoverGradient(g)}
                                              onAutoSaveCover={(g)=>{
                                                  setAllGroups(prev => {
                                                      const arr = prev.map(gp => gp.id===group.id ? { ...gp, coverGradient: g } : gp);
                                                      StorageManager.save('allGroups', arr);
                                                      return arr;
                                                  });
                                                  setCurrentCoverGradient(g);
                                              }}
                                              onSave={(upd)=>{
                                                  setAllGroups(prev => { const arr = prev.map(g => g.id===group.id ? { ...g, ...upd } : g); StorageManager.save('allGroups', arr); return arr; });
                                                  setGroupPosts(prev => { const cp = { ...(prev||{}) }; const arr = cp[group.id]||[]; cp[group.id] = arr.map(p=> ({...p, groupName: upd.name || group.name})); StorageManager.save('groupPosts', cp); return cp; });
                                                  setIsEditGroupOpen(false);
                                              }}
                                          />
                                      </div>
                                  </div>
                              )}

                              {/* New Post Modal (group) */}
                              {isNewPostOpen && (
                                  <GroupNewPostModal
                                      isOpen={isNewPostOpen}
                                      onClose={() => setIsNewPostOpen(false)}
                                      onSubmit={(payload) => {
                                          const now = Date.now();
                                          const authorName = payload.incognito ? 'Incognito' : me.name;
                                          const authorInitial = (authorName && authorName[0]) ? authorName[0].toUpperCase() : 'U';
                                          const newPost = {
                                              id: now,
                                              groupId: group.id,
                                              author: authorName,
                                              authorInitial,
                                              avatarColor: me.avatarColor || 'bg-primary',
                                              avatarUrl: me.avatarUrl || null,
                                              username: payload.incognito ? '@incognito' : me.username,
                                              ownerUsername: me.username,
                                              createdAt: now,
                                              time: new Date(now).toISOString(),
                                              title: payload.title || '',
                                              details: payload.details || '',
                                              content: payload.title + (payload.details ? `\n\n${payload.details}` : ''),
                                              image: payload.image || null,
                                              poll: payload.poll || null,
                                              groupName: group.name,
                                              groupIcon: group.image,
                                              likes: 0,
                                              comments: 0,
                                              sensitive: payload.sensitive || false
                                          };
                                          addGroupPost(newPost);
                                          setIsNewPostOpen(false);
                                      }}
                                  />
                              )}

                              {/* Invite Modal */}
                              {isInviteOpen && (
                                  <ShareModal
                                      isOpen={isInviteOpen}
                                      onClose={() => setIsInviteOpen(false)}
                                      users={users}
                                      post={{ content: `Invite to ${group.name}`}}
                                      onConfirm={(ids)=>{
                                          const invites = StorageManager.load('groupInvites', {});
                                          const list = invites[group.id] || [];
                                          invites[group.id] = Array.from(new Set([...list, ...ids]));
                                          StorageManager.save('groupInvites', invites);
                                          setIsInviteOpen(false);
                                      }}
                                  />
                              )}



                              {/* Event Modal */}
                              {isEventOpen && (
                                  <GroupEventModal
                                      isOpen={isEventOpen}
                                      onClose={() => { setIsEventOpen(false); setEditingEvent(null); }}
                                      initial={editingEvent}
                                      onCreate={(payload)=>{
                                          const now = Date.now();
                                          const newEvent = { id: now, createdAt: now, ownerUsername: me.username, attendeesGoing: [], attendeesInterested: [], ...payload };
                                          setEvents(prev => [newEvent, ...prev]);
                                          setIsEventOpen(false);
                                          setEditingEvent(null);
                                      }}
                                      onSave={(updated)=>{
                                          setEvents(prev => prev.map(ev => ev.id === updated.id ? { ...ev, ...updated } : ev));
                                          setIsEventOpen(false);
                                          setEditingEvent(null);
                                      }}
                                  />
                              )}
                          </div>
                      );
                  };

                  // Group New Post Modal (Peanut-style)
                  const GroupNewPostModal = ({ isOpen, onClose, onSubmit, submitLabel = 'Share' }) => {
                      const [title, setTitle] = useState('');
                      const [details, setDetails] = useState('');
                      const [sensitive, setSensitive] = useState(false);
                      const [incognito, setIncognito] = useState(false);
                      const [image, setImage] = useState(null);
                      const [isPoll, setIsPoll] = useState(false);
                      const [pollOptions, setPollOptions] = useState(['','']);
                      const galleryRef = useRef(null);
                      const [showSensitiveInfo, setShowSensitiveInfo] = useState(false);
                      const [showIncognitoInfo, setShowIncognitoInfo] = useState(false);
                      useEffect(() => {
                          if (!isOpen) {
                              setTitle('');
                              setDetails('');
                              setSensitive(false);
                              setIncognito(false);
                              setImage(null);
                              setIsPoll(false);
                              setPollOptions(['', '']);
                              setShowSensitiveInfo(false);
                              setShowIncognitoInfo(false);
                          }
                      }, [isOpen]);
                      if (!isOpen) return null;
                      const validPoll = isPoll && pollOptions.filter(o => o.trim().length > 0).length >= 2;
                      // Require details (Tell us more) to be filled to share
                      const canShare = details.trim().length > 0;
                      const pickImage = (e) => {
                          const file = e.target.files && e.target.files[0];
                          if (!file) return;
                          const reader = new FileReader();
                          reader.onload = () => setImage({ type:'file', url: reader.result, source:'gallery' });
                          reader.readAsDataURL(file);
                          e.target.value = '';
                      };
                      const addOption = () => setPollOptions(prev => prev.length < 4 ? [...prev, ''] : prev);
                      const removeOption = (idx) => setPollOptions(prev => prev.length > 2 ? prev.filter((_,i)=>i!==idx) : prev);
                      const updateOption = (idx, val) => setPollOptions(prev => prev.map((v,i)=> i===idx ? val : v));
                      return (
                          <div className="fixed inset-0 bg-black/50 flex items-end justify-center z-50" onMouseDown={(ev)=>{ if (ev.target === ev.currentTarget) onClose(); }}>
                              <div className="bg-white w-full max-w-md rounded-t-3xl overflow-hidden">
                                  {/* Header */}
                                  <div className="flex items-center justify-between px-4 py-3 border-b border-gray-200">
                                      <button onClick={onClose} className="text-gray-600">Cancel</button>
                                      <div className="font-semibold">New post</div>
                                      <button
                                          onClick={() => onSubmit({ title: title.trim(), details: details.trim(), sensitive, incognito, image, poll: validPoll ? { options: pollOptions.filter(o=>o.trim()).map(text => ({ text, votes: 0 })) } : undefined })}
                                          disabled={!canShare}
                                          className={`font-semibold ${canShare ? 'text-share' : 'text-gray-300'}`}
                                      >
                                          {submitLabel}
                                      </button>
                                  </div>
                                  <div className="p-4 space-y-3 max-h-[65vh] overflow-y-auto">
                                      <div className="space-y-1">
                                          <label className="text-xs font-medium text-gray-600">Title</label>
                                          <input
                                              value={title}
                                              onChange={(e)=>setTitle(e.target.value)}
                                              placeholder="Title or question"
                                              className="w-full px-3 py-2 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary text-base placeholder:text-placeholder"
                                          />
                                      </div>
                                      <div className="space-y-1">
                                          <label className="text-xs font-medium text-gray-600">Tell us more</label>
                                          <textarea
                                              value={details}
                                              onChange={(e)=>setDetails(e.target.value)}
                                              placeholder="Tell us moreâ€¦"
                                              className="w-full px-3 py-2 rounded-xl bg-gray-50 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary text-sm placeholder:text-placeholder min-h-[120px]"
                                          />
                                      </div>
                                      {image && (
                                          <div className="relative bg-gray-100 rounded-xl overflow-hidden flex items-center justify-center">
                                              <img src={image.url} alt="Selected" className="w-full max-h-64 object-contain"/>
                                              <button onClick={()=>setImage(null)} className="absolute top-2 right-2 bg-white/80 rounded-full px-2">âœ•</button>
                                          </div>
                                      )}
                                  <div className="flex items-center space-x-3">
                                      <button
                                          onClick={()=> galleryRef.current && galleryRef.current.click()}
                                          aria-label="Add image"
                                          className="w-10 h-10 rounded-xl bg-secondary/10 text-secondary hover:bg-secondary/20 flex items-center justify-center transition-colors"
                                      >
                                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                              <path d="M4 7h3l2-2h6l2 2h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2z"/>
                                              <circle cx="12" cy="13" r="3"/>
                                          </svg>
                                      </button>
                                      <button
                                          onClick={()=> setIsPoll(v => !v)}
                                          aria-label="Add poll"
                                          aria-pressed={isPoll}
                                          className={`w-10 h-10 rounded-xl flex items-center justify-center transition-colors ${isPoll ? 'bg-secondary text-white' : 'bg-secondary/10 text-secondary hover:bg-secondary/20'}`}
                                      >
                                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round">
                                              <line x1="6" y1="20" x2="6" y2="10"/>
                                              <line x1="12" y1="20" x2="12" y2="6"/>
                                              <line x1="18" y1="20" x2="18" y2="14"/>
                                          </svg>
                                      </button>
                                  </div>
                                      <input ref={galleryRef} type="file" accept="image/*" className="hidden" onChange={pickImage} />

                                      {isPoll && (
                                          <div className="rounded-2xl border border-gray-200 p-3 space-y-2">
                                              {pollOptions.map((opt, idx) => (
                                                  <div key={idx} className="flex items-center space-x-2">
                                                      <input value={opt} onChange={(e)=> updateOption(idx, e.target.value)} placeholder={`Option ${idx+1}`} className="flex-1 px-3 py-2 rounded-xl bg-gray-50 focus:outline-none"/>
                                                      {pollOptions.length > 2 && (
                                                          <button onClick={()=> removeOption(idx)} className="text-gray-500">âœ•</button>
                                                      )}
                                                  </div>
                                              ))}
                                              {pollOptions.length < 4 && (
                                                  <button onClick={addOption} className="text-sm text-share">+ Add option</button>
                                              )}
                                          </div>
                                      )}

                                      <div className="rounded-2xl overflow-hidden border border-gray-200 divide-y">
                                          <label className="flex items-center justify-between px-4 py-3 text-sm">
                                              <span className="text-gray-800 flex items-center gap-2">Mark as sensitive <button type="button" onClick={()=>setShowSensitiveInfo(true)} className="text-gray-400 hover:text-gray-600" aria-label="What is sensitive?">?</button></span>
                                              <input type="checkbox" checked={sensitive} onChange={(e)=>setSensitive(e.target.checked)} />
                                          </label>
                                          <label className="flex items-center justify-between px-4 py-3 text-sm">
                                              <span className="text-gray-800 flex items-center gap-2">Post as incognito <button type="button" onClick={()=>setShowIncognitoInfo(true)} className="text-gray-400 hover:text-gray-600" aria-label="What is incognito?">?</button></span>
                                              <input type="checkbox" checked={incognito} onChange={(e)=>setIncognito(e.target.checked)} />
                                          </label>
                                      </div>
                                      <SimpleModal isOpen={showSensitiveInfo} onClose={()=>setShowSensitiveInfo(false)} title="About sensitive posts">
                                          <p className="text-sm text-gray-700">Use this for topics that may be disturbing or private. Sensitive posts are blurred with a notice. Viewers must acknowledge a disclaimer before seeing the content.</p>
                                      </SimpleModal>
                                      <SimpleModal isOpen={showIncognitoInfo} onClose={()=>setShowIncognitoInfo(false)} title="About incognito">
                                          <p className="text-sm text-gray-700">Incognito hides your name and username on this post. Admins may still see your account if required by policy or law.</p>
                                      </SimpleModal>
                                  </div>
                              </div>
                          </div>
                      );
                  };

                  // Edit Group Form (reusable inside GroupDetail)
                  const EditGroupForm = ({ group, onCancel, onSave, onPreviewCover, onAutoSaveCover }) => {
                      const [name, setName] = useState(group.name || '');
                      const [about, setAbout] = useState(group.about || group.description || '');
                      const [rules, setRules] = useState(group.rules || '');
                      const [isPrivate, setIsPrivate] = useState(!!group.isPrivate);
                      const [category, setCategory] = useState(group.category || 'Support');
                      const [color, setColor] = useState(group.color || 'bg-primary');
                      const [coverGradient, setCoverGradient] = useState(group.coverGradient || 'from-rose-400 via-pink-300 to-rose-200');
                      const [iconUrl, setIconUrl] = useState(group.iconUrl || null);
                      const iconRef = useRef(null);
                      const colors = ['bg-primary','bg-secondary','bg-accent','bg-emerald-200','bg-teal-200','bg-sky-200','bg-rose-200','bg-violet-200','bg-amber-200'];
                      const gradients = [
                          'from-rose-400 via-pink-300 to-rose-200',
                          'from-amber-400 via-orange-300 to-yellow-200',
                          'from-emerald-400 via-green-300 to-teal-200',
                          'from-sky-400 via-blue-300 to-indigo-200',
                          'from-violet-400 via-purple-300 to-fuchsia-200',
                          'from-pink-400 via-rose-300 to-red-200',
                          'from-cyan-400 via-blue-300 to-indigo-200',
                          'from-lime-400 via-green-300 to-emerald-200'
                      ];
                      useEffect(() => {
                          if (onPreviewCover) onPreviewCover(coverGradient);
                      }, [coverGradient, onPreviewCover]);
                      return (
                          <div className="p-4 space-y-4 max-h-[70vh] overflow-y-auto">
                              <label className="block text-sm font-medium text-gray-700">Name</label>
                              <input value={name} onChange={(e)=>setName(e.target.value)} className="w-full px-3 py-2 rounded-xl border border-gray-200 focus:outline-none"/>
                              <label className="block text-sm font-medium text-gray-700">About</label>
                              <textarea value={about} onChange={(e)=>setAbout(e.target.value)} rows={3} className="w-full px-3 py-2 rounded-xl border border-gray-200 focus:outline-none"/>
                              <label className="block text-sm font-medium text-gray-700">Rules</label>
                              <textarea value={rules} onChange={(e)=>setRules(e.target.value)} rows={3} className="w-full px-3 py-2 rounded-xl border border-gray-200 focus:outline-none"/>
                              <div className="flex items-center justify-between">
                                  <div>
                                      <div className="text-sm font-medium text-gray-700">Private Group</div>
                                      <div className="text-xs text-gray-500">Only invited members can join</div>
                                  </div>
                                  <button onClick={()=>setIsPrivate(v=>!v)} className={`relative inline-flex h-6 w-11 rounded-full ${isPrivate?'bg-primary':'bg-gray-200'}`}><span className={`inline-block h-5 w-5 bg-white rounded-full transform ${isPrivate?'translate-x-5':'translate-x-0'}`}></span></button>
                              </div>
                              <div>
                                  <div className="text-sm font-medium text-gray-700 mb-1">Category</div>
                                  <div className="flex flex-wrap gap-1">
                                      {['Support','Food','Local','Career','Sleep','Activities'].map(cat => (
                                          <button key={cat} onClick={()=>setCategory(cat)} className={`px-2 py-1 rounded-full text-xs ${category===cat?'bg-primary text-white':'bg-gray-100 text-gray-700'}`}>{cat}</button>
                                      ))}
                                  </div>
                              </div>
                              <div>
                                  <div className="text-sm font-medium text-gray-700 mb-1">Color</div>
                                  <div className="grid grid-cols-6 gap-2">
                                      {colors.map(c => (<button key={c} onClick={()=>setColor(c)} className={`aspect-square rounded-lg ${c} ${color===c?'ring-2 ring-gray-900':''}`} />))}
                                  </div>
                              </div>
                              <div>
                                  <div className="text-sm font-medium text-gray-700 mb-3">Cover Gradient</div>
                                  <div className="grid grid-cols-4 gap-3">
                                      {gradients.map(g => (
                                          <button
                                              key={g}
                                              onClick={()=> {
                                                  setCoverGradient(g);
                                                  onPreviewCover && onPreviewCover(g);
                                                  onAutoSaveCover && onAutoSaveCover(g);
                                              }}
                                              className={`h-12 rounded-xl border-2 transition-all hover:scale-105 ${coverGradient===g?'ring-2 ring-primary border-primary':'border-gray-200 hover:border-gray-300'}`}
                                          >
                                              <div className={`w-full h-full rounded-lg bg-gradient-to-br ${g}`} />
                                          </button>
                                      ))}
                                  </div>
                              </div>
                              <div>
                                  <div className="text-sm font-medium text-gray-700 mb-1">Icon</div>
                                  <div className={`w-12 h-12 ${color} rounded-xl overflow-hidden flex items-center justify-center`}>
                                      {iconUrl ? <img src={iconUrl} alt="icon" className="w-full h-full object-cover"/> : <div className="w-6 h-6 bg-white/20 rounded-full"></div>}
                                  </div>
                                  <button onClick={()=> iconRef.current && iconRef.current.click()} className="mt-2 text-sm text-share">Upload new icon</button>
                                  <input ref={iconRef} type="file" accept="image/*" className="hidden" onChange={(e)=>{ const f=e.target.files&&e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=> setIconUrl(r.result); r.readAsDataURL(f); e.target.value=''; }} />
                              </div>
                              <div className="flex items-center justify-end gap-2 border-t border-gray-100 pt-3">
                                  <button onClick={onCancel} className="px-3 py-2 rounded-lg bg-gray-100">Cancel</button>
                                  <button onClick={()=> onSave && onSave({ name, about, rules, isPrivate, category, color, coverGradient, iconUrl })} className="px-3 py-2 rounded-lg bg-primary text-white">Save</button>
                              </div>
                          </div>
                      );
                  };

                  // Group Event Modal
                  const GroupEventModal = ({ isOpen, onClose, onCreate, onSave, initial }) => {
                      const [title, setTitle] = useState('');
                      const [date, setDate] = useState('');
                      const [time, setTime] = useState('');
                      const [location, setLocation] = useState('');
                      const [description, setDescription] = useState('');
                      useEffect(() => {
                          if (isOpen) {
                              setTitle(initial?.title || '');
                              setDate(initial?.date || '');
                              setTime(initial?.time || '');
                              setLocation(initial?.location || '');
                              setDescription(initial?.description || '');
                          }
                      }, [isOpen, initial]);
                      if (!isOpen) return null;
                      const disabled = !title.trim() || !date || !time;
                      return (
                          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onMouseDown={(e)=>{ if (e.target === e.currentTarget) onClose(); }}>
                              <div className="bg-white rounded-3xl w-full max-w-lg mx-4 overflow-hidden">
                                  {/* Header */}
                                  <div className="bg-gradient-to-r from-primary/10 to-secondary/10 p-4 border-b border-gray-200">
                                      <div className="flex items-center justify-between">
                                          <button onClick={onClose} className="text-gray-600 hover:text-gray-800 transition-colors">
                                              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                                  <path d="M18 6L6 18M6 6l12 12"/>
                                              </svg>
                                          </button>
                                          <div className="flex items-center gap-2">
                                              <div className="w-8 h-8 bg-gradient-to-r from-primary to-secondary rounded-full flex items-center justify-center">
                                                  <span className="text-white text-sm">ðŸ“…</span>
                                              </div>
                                              <div className="font-semibold text-gray-900">{initial ? 'Edit Event' : 'Create Event'}</div>
                                          </div>
                                      <button
                                          onClick={()=> {
                                                  const payload = { title: title.trim(), date, time, location, description: description.trim() };
                                              if (initial && onSave) onSave({ ...initial, ...payload });
                                              else onCreate && onCreate(payload);
                                          }}
                                          disabled={disabled}
                                              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                                                  disabled
                                                      ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                                                      : 'bg-gradient-to-r from-primary to-secondary text-white hover:shadow-lg hover:shadow-primary/25'
                                              }`}
                                      >
                                          {initial ? 'Save' : 'Create'}
                                      </button>
                                  </div>

                                      </div>

                                  {/* Content */}
                                  <div className="p-6 space-y-4">
                                      {/* Event Title */}
                                      <div>
                                          <label className="block text-sm font-medium text-gray-700 mb-2">Event Title *</label>
                                          <input
                                              value={title}
                                              onChange={(e)=>setTitle(e.target.value)}
                                              placeholder="What's the event about?"
                                              className="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all"
                                          />
                                  </div>

                                      {/* Date & Time */}
                                      <div className="grid grid-cols-2 gap-3">
                                          <div>
                                              <label className="block text-sm font-medium text-gray-700 mb-2">Date *</label>
                                              <input
                                                  type="date"
                                                  value={date}
                                                  onChange={(e)=>setDate(e.target.value)}
                                                  className="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all"
                                              />
                                          </div>
                                          <div>
                                              <label className="block text-sm font-medium text-gray-700 mb-2">Time *</label>
                                              <input
                                                  type="time"
                                                  value={time}
                                                  onChange={(e)=>setTime(e.target.value)}
                                                  className="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all"
                                              />
                                          </div>
                                      </div>

                                      {/* Location */}
                                      <div>
                                          <label className="block text-sm font-medium text-gray-700 mb-2">Location</label>
                                          <input
                                              value={location}
                                              onChange={(e)=>setLocation(e.target.value)}
                                              placeholder="Where will it take place?"
                                              className="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all"
                                          />
                                      </div>

                                      {/* Description */}
                                      <div>
                                          <label className="block text-sm font-medium text-gray-700 mb-2">Event Description</label>
                                          <textarea
                                              value={description}
                                              onChange={(e)=>setDescription(e.target.value)}
                                              placeholder="Tell members more about this event..."
                                              rows={3}
                                              className="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all resize-none"
                                          />
                                      </div>
                                  </div>
                              </div>
                          </div>
                      );
                  };

                  // Render current view
                  const renderCurrentView = () => {
                      // If viewing a specific group, show group detail (but still show bottom nav)
                      if (currentGroupView) {
                          return (
                              <GroupDetailView
                                  group={currentGroupView}
                                  isAdmin={currentGroupView.ownerUsername === me.username}
                                  onBack={() => setCurrentGroupView(null)}
                                  me={me}
                                  users={users}
                                  groupPosts={groupPosts}
                                  setGroupPosts={setGroupPosts}
                                  onJoinGroup={(id, isLeaving) => handleJoinGroup(id, isLeaving)}
                                  isJoined={joinedGroups.includes(currentGroupView.id)}
                                  openNewPostInitially={groupShouldOpenPost}
                                  onOpenPostHandled={() => setGroupShouldOpenPost(false)}
                              />
                          );
                      }

                      switch (currentView) {
                          case 'tips':
                              return <TipsInsightsView tips={curatedTips} savedTips={savedContent.filter(item => item.type === 'tip')} onToggleSaveTip={handleToggleSaveTip} onSelectGroup={handleOpenGroupByRef} onExploreGroups={() => { StorageManager.save('headerTab', 'groups'); setCurrentView('community'); }} />;
                          case 'community':
                              return <CommunityView />;
                          case 'orbit':
                              return (
                                  <OrbitFooterView
                                      moodState={orbitMoodState}
                                      onSubmit={handleOrbitCheckIn}
                                      matchCandidate={orbitMatchCandidate}
                                      onMatchAccept={handleOrbitMatchAccept}
                                      onMatchSkip={handleOrbitMatchSkip}
                                      chatSession={orbitChatSession}
                                      onChatSend={handleOrbitChatSend}
                                      onChatEnd={handleOrbitChatEnd}
                                      onChatReport={handleOrbitChatReport}
                                      onChatClose={handleOrbitChatCloseView}
                                      moodFriends={moodFriends}
                                      moodGroups={moodGroups}
                                      supportMessages={supportMessages}
                                      userAchievements={userAchievements}
                                      moodPoints={moodPoints}
                                      userLevel={userLevel}
                                      onSendSupportMessage={sendSupportMessage}
                                      onJoinMoodGroup={joinMoodGroup}
                                      customMoods={customMoods}
                                      selectedTheme={selectedTheme}
                                      notificationSettings={notificationSettings}
                                      privacySettings={privacySettings}
                                      reminderTime={reminderTime}
                                      onAddCustomMood={addCustomMood}
                                      onUpdateTheme={updateTheme}
                                      onUpdateNotificationSetting={updateNotificationSetting}
                                      onUpdatePrivacySetting={updatePrivacySetting}
                                      onSetReminderTime={setReminderTime}
                                      activeGame={activeGame}
                                      activeMusic={activeMusic}
                                      activeMeditation={activeMeditation}
                                      activeExercise={activeExercise}
                                      onStartGame={startGame}
                                      onPlayMusic={playMusic}
                                      onStartMeditation={startMeditation}
                                      onStartExercise={startExercise}
                                      onStopActivity={stopActivity}
                                      moodReports={moodReports}
                                      moodMetrics={moodMetrics}
                                      correlationInsights={correlationInsights}
                                      reportHistory={reportHistory}
                                      onGenerateReport={generateReport}
                                      chatTheme={chatTheme}
                                      chatEmojis={chatEmojis}
                                      voiceMessages={voiceMessages}
                                      imageMessages={imageMessages}
                                      messageReactions={messageReactions}
                                      chatSettings={chatSettings}
                                      onUpdateChatTheme={updateChatTheme}
                                      onAddMessageReaction={addMessageReaction}
                                      onSendVoiceMessage={sendVoiceMessage}
                                      onSendImageMessage={sendImageMessage}
                                      onUpdateChatSetting={updateChatSetting}
                                      onGetMessageReactions={getMessageReactions}
                                      gamificationBadges={gamificationBadges}
                                      gamificationLevel={gamificationLevel}
                                      gamificationPoints={gamificationPoints}
                                      gamificationCompetitions={gamificationCompetitions}
                                      dailyChallenges={dailyChallenges}
                                      activeRewards={activeRewards}
                                      leaderboard={leaderboard}
                                      gamificationSettings={gamificationSettings}
                                      onAwardBadge={awardBadge}
                                      onJoinCompetition={joinCompetition}
                                      onUpdateDailyChallenge={updateDailyChallenge}
                                      onActivateReward={activateReward}
                                      onUpdateLeaderboard={updateLeaderboard}
                                      onUpdateGamificationSetting={updateGamificationSetting}
                                      calendarEvents={calendarEvents}
                                      currentWeather={currentWeather}
                                      activityTracking={activityTracking}
                                      socialMediaIntegrations={socialMediaIntegrations}
                                      healthIntegrations={healthIntegrations}
                                      moodCorrelations={moodCorrelations}
                                      integrationSettings={integrationSettings}
                                      onAddCalendarEvent={addCalendarEvent}
                                      onUpdateWeather={updateWeather}
                                      onUpdateActivityTracking={updateActivityTracking}
                                      onConnectSocialMedia={connectSocialMedia}
                                      onDisconnectSocialMedia={disconnectSocialMedia}
                                      onToggleMoodSharing={toggleMoodSharing}
                                      onConnectHealthApp={connectHealthApp}
                                      onDisconnectHealthApp={disconnectHealthApp}
                                      onUpdateMoodCorrelation={updateMoodCorrelation}
                                      onUpdateIntegrationSetting={updateIntegrationSetting}
                                      onSyncWithExternalData={syncWithExternalData}
                                  />
                              );
                          case 'shop':
                              return <ShopView coinCount={coinCount} setCoinCount={setCoinCount} />;
                          case 'profile':
                              return <ProfileView />;
                          default:
                              return <CommunityView />;
                      }
                  };

                  if (showSplash) {
                      return <SplashScreen />;
                  }

                  if (!isAuthenticated) {
                      return (
                          <AuthPage
                              onSuccess={(user)=>{ setMe(user); StorageManager.save('me', user); setIsAuthenticated(true); ToastManager.show(`Welcome, ${user.name.split(' ')[0]}!`, 'success'); }}
                              onGuest={()=>{ setIsAuthenticated(true); ToastManager.show('Continuing as guest', 'info'); }}
                          />
                      );
                  }

                  return (
                      <div className="max-w-md mx-auto bg-white min-h-screen relative">
                          {/* Header with Storage Status */}
                          <div className="bg-white h-16 flex items-center justify-between px-6 border-b border-gray-100">
                              <div className="flex items-center space-x-4">
                                  <div className="relative">
                                      <div className="w-14 h-14 bg-gray-100 rounded-2xl flex items-center justify-center shadow-lg border border-gray-200">
                                          <div className="w-10 h-10 bg-gradient-to-br from-primary to-secondary rounded-xl flex items-center justify-center">
                                              <svg className="w-6 h-6" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                  <ellipse cx="24" cy="24" rx="18" ry="10" stroke="white" strokeWidth="2" strokeOpacity="0.4" fill="none" transform="rotate(-15 24 24)"/>
                                                  <path d="M 24 6 Q 38 24 24 42 Q 10 24 24 6" stroke="white" strokeWidth="2.5" strokeOpacity="0.6" fill="none" strokeLinecap="round"/>
                                                  <circle cx="24" cy="24" r="9" fill="white" fillOpacity="0.95"/>
                                                  <circle cx="24" cy="24" r="6" fill="white" fillOpacity="0.7"/>
                                                  <circle cx="24" cy="24" r="3.5" fill="white"/>
                                              </svg>
                                          </div>
                                      </div>

                                  </div>
                                  <div>
                                      <h1 className="text-secondary text-3xl font-bold tracking-wide">Orbit</h1>
                                      <div className="flex items-center space-x-2">
                                      </div>
                                  </div>
                              </div>

                              {/* Header Icons */}
                              <div className="flex items-center space-x-1">
                                  <button
                                      onClick={() => setIsSearchModalOpen(true)}
                                      className="p-2 rounded-full hover:bg-gray-100 transition-colors"
                                  >
                                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6B7280" strokeWidth="2">
                                          <circle cx="11" cy="11" r="8"/>
                                          <path d="M21 21l-4.35-4.35"/>
                                      </svg>
                                  </button>

                                  <button
                                      onClick={() => setIsInboxOpen(true)}
                                      className="relative p-2 rounded-full hover:bg-gray-100 transition-colors"
                                      title="Shared with you"
                                  >
                                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6B7280" strokeWidth="2">
                                          <path d="M22 12l-8-5v10l8-5z"></path>
                                          <circle cx="6" cy="12" r="3"></circle>
                                      </svg>
                                      {sharedCount > 0 && (
                                          <span className="absolute -top-0.5 -right-0.5 bg-primary text-white text-[10px] leading-none px-1.5 py-0.5 rounded-full">{sharedCount}</span>
                                      )}
                                  </button>

                                  <button
                                      onClick={() => setIsSettingsModalOpen(true)}
                                      className="p-2 rounded-full hover:bg-gray-100 transition-colors"
                                  >
                                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6B7280" strokeWidth="2">
                                          <circle cx="12" cy="12" r="3"/>
                                          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                                      </svg>
                                  </button>
                              </div>
                          </div>

                          <main className="pb-24">
                              {renderCurrentView()}
                          </main>

                          {/* Floating Post CTA removed as requested */}

                          {/* Bottom Navigation */}
                          <BottomNavigation
                              currentView={currentView}
                              onViewChange={setCurrentView}
                          />

                          {/* Advanced Search Modal */}
                          <SearchModal
                              isOpen={isSearchModalOpen}
                              onClose={() => setIsSearchModalOpen(false)}
                          />

                          {/* Share Modal */}
                          <ShareModal
                              isOpen={isShareModalOpen}
                              onClose={() => setIsShareModalOpen(false)}
                              users={users.filter(u => u.username !== me.username)}
                              post={postToShare}
                              onConfirm={handleConfirmShare}
                          />

                          {/* Global New Post flow (Community) */}
                          {isGlobalNewPostOpen && (
                              <GroupNewPostModal
                                  isOpen={isGlobalNewPostOpen}
                                  onClose={() => setIsGlobalNewPostOpen(false)}
                                  submitLabel="Next"
                                  onSubmit={(payload)=>{ setPendingGroupPost(payload); setIsGlobalNewPostOpen(false); setIsPickGroupOpen(true); }}
                              />
                          )}

                          {isPickGroupOpen && (
                              <GroupPickerModal
                                  isOpen={isPickGroupOpen}
                                  onClose={()=>{ setIsPickGroupOpen(false); setPendingGroupPost(null); }}
                                  groups={allGroups.filter(g => joinedGroups.includes(g.id))}
                                  onConfirm={(gid)=>{
                                      if (!gid || !pendingGroupPost) { setIsPickGroupOpen(false); return; }
                                      const now = Date.now();
                                      const authorName = pendingGroupPost.incognito ? 'Incognito' : me.name;
                                      const authorInitial = (authorName && authorName[0]) ? authorName[0].toUpperCase() : 'U';
                                      const grp = allGroups.find(g => g.id === gid);
                                      const newPost = {
                                          id: now,
                                          groupId: gid,
                                          author: authorName,
                                          authorInitial,
                                          avatarColor: me.avatarColor || 'bg-primary',
                                          avatarUrl: me.avatarUrl || null,
                                          username: pendingGroupPost.incognito ? '@incognito' : me.username,
                                          ownerUsername: me.username,
                                          createdAt: now,
                                          time: new Date(now).toISOString(),
                                          content: pendingGroupPost.title + (pendingGroupPost.details ? `\n\n${pendingGroupPost.details}` : ''),
                                          image: pendingGroupPost.image || null,
                                          poll: pendingGroupPost.poll || null,
                                          groupName: grp?.name,
                                          groupIcon: grp?.image,
                                          likes: 0,
                                          comments: 0,
                                          sensitive: pendingGroupPost.sensitive || false
                                      };
                                      setGroupPosts(prev => { const copy = { ...(prev||{}) }; const arr = copy[gid] ? [...copy[gid]] : []; arr.unshift(newPost); copy[gid] = arr; StorageManager.save('groupPosts', copy); return copy; });
                                      setIsPickGroupOpen(false); setPendingGroupPost(null);
                                      ToastManager.show('Post created', 'success');
                                  }}
                              />
                          )}
                          {/* Inbox Modal */}
                          <InboxModal
                              isOpen={isInboxOpen}
                              onClose={() => setIsInboxOpen(false)}
                          />

                          {/* Fallback Global New Post for Group (ensures modal opens when tapping Post) */}
                          {groupNewPostFor && (
                              <GroupNewPostModal
                                  isOpen={!!groupNewPostFor}
                                  onClose={() => setGroupNewPostFor(null)}
                                  onSubmit={(payload) => {
                                      const group = groupNewPostFor;
                                      const now = Date.now();
                                      const authorName = payload.incognito ? 'Incognito' : me.name;
                                      const authorInitial = (authorName && authorName[0]) ? authorName[0].toUpperCase() : 'U';
                                      const newPost = {
                                          id: now,
                                          groupId: group.id,
                                          author: authorName,
                                          authorInitial,
                                          avatarColor: me.avatarColor || 'bg-primary',
                                          avatarUrl: me.avatarUrl || null,
                                          username: payload.incognito ? '@incognito' : me.username,
                                          ownerUsername: me.username,
                                          createdAt: now,
                                          time: new Date(now).toISOString(),
                                          title: payload.title || '',
                                          details: payload.details || '',
                                          content: payload.title + (payload.details ? `\n\n${payload.details}` : ''),
                                          image: payload.image || null,
                                          poll: payload.poll || null,
                                          groupName: group.name,
                                          groupIcon: group.image,
                                          likes: 0,
                                          comments: 0,
                                          sensitive: payload.sensitive || false
                                      };
                                      setGroupPosts(prev => {
                                          const copy = { ...(prev || {}) };
                                          const arr = copy[group.id] ? [...copy[group.id]] : [];
                                          arr.unshift(newPost);
                                          copy[group.id] = arr;
                                          StorageManager.save('groupPosts', copy);
                                          return copy;
                                      });
                                      setGroupNewPostFor(null);
                                  }}
                              />
                          )}

                          <SettingsModal
                              isOpen={isSettingsModalOpen}
                              onClose={() => setIsSettingsModalOpen(false)}
                              onOpenOrders={() => {
                                  setIsSettingsModalOpen(false);
                                  setIsOrdersOpen(true);
                              }}
                          />

                          {/* Enhanced Create Post Modal */}
                          <EnhancedCreatePostModal
                            isOpen={isCreatePostModalOpen}
                            onClose={() => setIsCreatePostModalOpen(false)}
                            onCreatePost={handleCreatePost}
                            onCoinEarned={handleCoinEarned}
                            currentUser={me}
                          />

                  {/* Enhanced Comment Modal */}
                  <EnhancedCommentModal
                      isOpen={isCommentModalOpen}
                      onClose={() => setIsCommentModalOpen(false)}
                      post={selectedPost}
                      onAddComment={handleAddComment}
                      onLikeComment={handleLikeComment}
                      onUserClick={handleUserClick}
                  />

                  {/* Chat Modal */}


                          {/* Delete Confirm Modal */}
                          <SimpleModal isOpen={isDeleteOpen} onClose={() => setIsDeleteOpen(false)} title="Delete Post">
                              <div className="space-y-4">
                                  <p className="text-sm text-gray-600">Are you sure you want to delete this post? This action cannot be undone.</p>
                                  <div className="bg-gray-50 p-3 rounded-lg text-sm text-gray-700 line-clamp-3">
                                      {postToDelete?.content || 'Post'}
                                  </div>
                                  <div className="flex items-center justify-end space-x-2">
                                      <button onClick={() => setIsDeleteOpen(false)} className="px-4 py-2 rounded-xl bg-gray-100 text-gray-700 hover:bg-gray-200">Cancel</button>
                                      <button onClick={() => handleDeletePost(postToDelete?.id)} className="px-4 py-2 rounded-xl bg-rose-500 text-white hover:bg-rose-600">Delete</button>
                                  </div>
                              </div>
                          </SimpleModal>

                          <SimpleModal isOpen={isDeleteGroupOpen} onClose={() => setIsDeleteGroupOpen(false)} title="Delete Group">
                              <div className="space-y-4">
                                  <p className="text-sm text-gray-600">Are you sure you want to delete this group? This will remove its posts, events and invites. This action cannot be undone.</p>
                                  <div className="bg-gray-50 p-3 rounded-lg text-sm text-gray-700 line-clamp-2">
                                      {groupToDelete?.name || 'Group'}
                                  </div>
                                  <div className="flex items-center justify-end space-x-2">
                                      <button onClick={() => setIsDeleteGroupOpen(false)} className="px-4 py-2 rounded-xl bg-gray-100 text-gray-700 hover:bg-gray-200">Cancel</button>
                                      <button onClick={() => handleDeleteGroup(groupToDelete?.id)} className="px-4 py-2 rounded-xl bg-rose-500 text-white hover:bg-rose-600">Delete</button>
                                  </div>
                              </div>
                          </SimpleModal>
                      </div>
                  );
              };

              const container = document.getElementById('root');
              const root = ReactDOM.createRoot(container);
              root.render(<App />);
    </script>
  </body>
</html>

